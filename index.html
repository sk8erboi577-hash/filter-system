<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>濾芯保養系統</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/water-filter.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    
    <style>
        /* 全局設定：字體與背景 */
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 100px; }
        
        /* 卡片與按鈕樣式 */
        .card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025); }
        
        /* 主按鈕：漸層藍色，加大 */
        .btn-primary { 
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); 
            color: white; padding: 18px; border-radius: 16px; 
            font-weight: 800; font-size: 1.25rem; 
            width: 100%; display: block; 
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25); 
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.97); }
        
        /* 懸浮按鈕 (FAB) */
        .fab { 
            position: fixed; bottom: 30px; right: 30px; 
            width: 72px; height: 72px; 
            background: linear-gradient(135deg, #2563eb, #1d4ed8); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; 
            box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.4); 
            z-index: 50; cursor: pointer; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }
        .fab .material-icons { font-size: 40px; }

        /* 輸入框通用樣式：巨大化 */
        input, textarea, select { 
            width: 100%; 
            padding: 18px; /* 極度加高 */
            border: 2px solid #e2e8f0; 
            border-radius: 16px; 
            margin-bottom: 16px; 
            font-size: 20px; /* 字體加大 */
            font-weight: 600;
            color: #1e293b;
            background-color: #f8fafc; 
            transition: all 0.2s;
        }
        input:focus, textarea:focus { border-color: #3b82f6; background-color: white; outline: none; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        label { font-size: 1.1rem; font-weight: 700; color: #64748b; margin-bottom: 8px; display: block; padding-left: 4px; }

        /* 特殊欄位修正 */
        .input-group-currency { position: relative; }
        .currency-symbol { position: absolute; top: 56px; left: 20px; font-size: 20px; font-weight: bold; color: #94a3b8; pointer-events: none; }
        .input-currency { padding-left: 65px !important; color: #16a34a; font-weight: 800; font-size: 24px; }

        /* 照片牆 */
        .photo-scroll-container { display: flex; gap: 12px; overflow-x: auto; padding: 4px; -webkit-overflow-scrolling: touch; }
        .photo-scroll-container::-webkit-scrollbar { display: none; }
        .photo-card-lg { width: 180px; height: 180px; flex-shrink: 0; border-radius: 16px; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .photo-grid { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; }
        .photo-thumb { width: 100px; height: 100px; object-fit: cover; border-radius: 14px; flex-shrink: 0; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* 詳情頁細節 */
        .detail-label { font-size: 1rem; color: #64748b; font-weight: 600; margin-bottom: 4px; }
        .detail-value { font-size: 1.35rem; color: #0f172a; line-height: 1.4; font-weight: 700; }
        .detail-row { display: flex; align-items: flex-start; margin-bottom: 24px; border-bottom: 1px solid #f1f5f9; padding-bottom: 16px; }
        .detail-icon { color: #94a3b8; margin-right: 16px; margin-top: 4px; font-size: 32px; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 999; flex-direction: column; }
    </style>
</head>
<body>

    <div id="page-list">
        <div class="bg-white pt-14 pb-6 px-6 sticky top-0 z-10 shadow-sm border-b border-gray-100">
            <h1 class="text-3xl font-black text-slate-800 flex items-center mb-5 tracking-tight">
                <span class="material-icons text-blue-600 mr-3 text-4xl">water_drop</span> 濾芯保養系統
            </h1>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-5 text-gray-400"><span class="material-icons text-3xl">search</span></span>
                <input type="text" id="search-input" placeholder="搜尋姓名、電話..." class="pl-16 mb-0 bg-slate-100 border-transparent focus:bg-white h-16 text-xl rounded-full">
            </div>
        </div>
        <div id="customer-list" class="p-5 max-w-2xl mx-auto space-y-4">
            <div class="text-center text-gray-400 mt-20">載入中...</div>
        </div>
        <div class="fab" onclick="showAddCustomerModal()"><span class="material-icons">add</span></div>
    </div>

    <div id="page-detail" class="hidden min-h-screen bg-slate-50">
        <div class="bg-white pt-12 pb-4 px-4 shadow-sm flex items-center sticky top-0 z-20 border-b border-slate-100">
            <button onclick="goBack()" class="p-3 mr-2 text-slate-600 rounded-full hover:bg-slate-100 active:bg-slate-200 transition-colors"><span class="material-icons text-3xl">arrow_back</span></button>
            <h2 id="detail-header-name" class="text-2xl font-bold flex-1 truncate text-slate-800">客戶詳情</h2>
            <button onclick="showEditCustomerModal()" class="text-blue-600 font-bold px-6 py-2 bg-blue-50 rounded-full text-lg active:bg-blue-100">編輯</button>
        </div>
        
        <div class="p-5 max-w-2xl mx-auto">
            <div id="customer-photos-container" class="photo-scroll-container mb-8"></div>

            <div class="card relative overflow-hidden">
                <h2 id="detail-name" class="text-4xl font-black text-slate-900 mb-3 text-center tracking-tight"></h2>
                <div class="text-center mb-8">
                    <a id="detail-phone-link" class="inline-flex items-center text-2xl font-mono text-blue-600 font-black bg-blue-50 px-8 py-3 rounded-full shadow-sm active:scale-95 transition-transform">
                        <span class="material-icons text-2xl mr-3">phone</span><span id="detail-phone"></span>
                    </a>
                </div>
                
                <div class="bg-slate-50 rounded-2xl p-6 space-y-2">
                    <div class="detail-row"><span class="material-icons detail-icon">event_available</span><div><span class="detail-label">安裝日期</span><span id="detail-install-date" class="detail-value text-blue-700"></span></div></div>
                    <div class="detail-row"><span class="material-icons detail-icon">location_on</span><div><span class="detail-label">安裝地址</span><span id="detail-address" class="detail-value"></span></div></div>
                    <div class="detail-row"><span class="material-icons detail-icon">settings</span><div class="flex-1"><span class="detail-label">機器型號</span><span id="detail-machine" class="detail-value"></span></div></div>
                    <div class="detail-row"><span class="material-icons detail-icon">filter_alt</span><div class="flex-1"><span class="detail-label">濾芯規格</span><span id="detail-filter" class="detail-value"></span></div></div>
                    <div id="note-container" class="detail-row hidden border-none mb-0 pb-0"><span class="material-icons detail-icon text-orange-400">sticky_note_2</span><div><span class="detail-label text-orange-600">備註事項</span><span id="detail-note" class="detail-value text-orange-800"></span></div></div>
                </div>
            </div>

            <div class="card bg-gradient-to-br from-blue-50 to-white border-2 border-blue-100">
                <h3 class="font-bold text-blue-800 mb-6 flex items-center text-2xl">
                    <span class="material-icons-outlined mr-3 text-3xl">post_add</span>新增保養紀錄
                </h3>
                
                <div class="mb-2"><label>保養日期</label><input type="date" id="record-date"></div>
                <div class="mb-2"><label>更換項目</label><input type="text" id="record-items" placeholder="例如: PP, 活性碳"></div>
                <div class="mb-2 input-group-currency">
                     <label>金額</label><span class="currency-symbol">NT$</span>
                    <input type="number" id="record-amount" placeholder="0" inputmode="numeric" class="input-currency">
                </div>
                <div class="mb-4"><label>備註</label><textarea id="record-note" placeholder="備註 (選填)" rows="3"></textarea></div>
                
                <div class="flex items-center justify-between mt-4 mb-6 p-5 bg-white rounded-2xl border-2 border-slate-100 shadow-sm active:bg-slate-50 transition-colors">
                    <label class="flex items-center gap-3 text-blue-600 font-bold cursor-pointer text-xl w-full">
                        <span class="material-icons text-4xl">add_a_photo</span>
                        <span>點擊拍照 / 選圖</span>
                        <input type="file" id="record-photo-input" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)">
                    </label>
                    <span id="record-photo-count" class="text-slate-400 bg-slate-100 px-4 py-2 rounded-full font-bold whitespace-nowrap">0 張</span>
                </div>
                <div id="new-record-photos" class="photo-grid mb-6"></div>
                <button onclick="saveRecord()" class="btn-primary shadow-lg shadow-blue-200">確認儲存紀錄</button>
            </div>

            <h3 class="font-bold text-slate-600 text-2xl mb-5 ml-2 mt-10 flex items-center"><span class="material-icons mr-2">history</span>歷史紀錄</h3>
            <div id="record-list" class="space-y-6"></div>
        </div>
    </div>

    <div id="customer-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 hidden z-50 flex items-end sm:items-center justify-center transition-opacity backdrop-blur-sm">
        <div class="bg-white rounded-t-[32px] sm:rounded-3xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto animate-slide-up shadow-2xl">
            
            <div class="w-16 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            
            <h2 id="modal-title" class="text-3xl font-black mb-8 text-center text-slate-800 tracking-tight">新增客戶資料</h2>
            <input type="hidden" id="cust-id">
            
            <div class="space-y-5">
                <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                    <div>
                        <label class="text-blue-800">客戶姓名 <span class="text-red-500">*</span></label>
                        <input type="text" id="cust-name" placeholder="請輸入姓名" class="border-blue-200 focus:border-blue-500 mb-4">
                    </div>
                    <div>
                        <label class="text-blue-800">電話號碼 <span class="text-red-500">*</span></label>
                        <input type="tel" id="cust-phone" placeholder="09xx-xxx-xxx" inputmode="tel" class="font-mono text-2xl border-blue-200 focus:border-blue-500 text-blue-700 font-black mb-0">
                    </div>
                </div>

                <div>
                    <label>安裝日期</label>
                    <input type="date" id="cust-install-date" class="font-mono">
                </div>

                <div>
                    <label>安裝地址</label>
                    <textarea id="cust-address" rows="2" placeholder="縣市/區域/街道..."></textarea>
                </div>
                
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label>機器型號</label><input type="text" id="cust-machine" placeholder="例: RO-500"></div>
                    <div><label>濾芯規格</label><input type="text" id="cust-filter" placeholder="例: 10吋通用"></div>
                </div>

                <div>
                    <label>備註事項</label>
                    <textarea id="cust-note" rows="2" placeholder="其他聯絡人、特殊需求..." class="bg-orange-50 border-orange-200 focus:border-orange-400 text-orange-900"></textarea>
                </div>

                <div class="border-3 border-dashed border-blue-200 bg-blue-50 rounded-2xl p-6 text-center hover:bg-blue-100 transition-colors cursor-pointer relative">
                    <label for="cust-photo-input" class="cursor-pointer block w-full h-full">
                        <span class="material-icons text-blue-400 text-5xl mb-2">add_photo_alternate</span>
                        <div class="text-blue-600 font-bold text-xl">點擊上傳機器照片</div>
                        <div class="text-blue-400 text-sm font-bold mt-1">支援多張照片選擇</div>
                        <input type="file" id="cust-photo-input" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
                    </label>
                    <div id="cust-photo-preview" class="photo-grid mt-4 justify-center"></div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8 pt-4 border-t border-slate-100">
                <button onclick="closeModal('customer-modal')" class="flex-1 bg-slate-100 text-slate-500 font-bold py-4 rounded-2xl text-xl hover:bg-slate-200">取消</button>
                <button onclick="saveCustomer()" class="flex-1 bg-blue-600 text-white font-bold py-4 rounded-2xl text-xl shadow-lg shadow-blue-200 active:scale-95 transition-transform">確認儲存</button>
            </div>
            <button id="btn-delete-customer" onclick="deleteCustomer()" class="w-full mt-4 text-red-500 text-lg font-bold py-3 hidden bg-red-50 rounded-2xl hover:bg-red-100">刪除此客戶資料</button>
        </div>
    </div>

    <div id="record-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 hidden z-50 flex items-end sm:items-center justify-center transition-opacity backdrop-blur-sm">
        <div class="bg-white rounded-t-[32px] sm:rounded-3xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto animate-slide-up shadow-2xl">
            <div class="w-16 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-3xl font-black mb-8 text-center text-slate-800">修改保養紀錄</h2>
            <input type="hidden" id="edit-record-id">
            <div class="space-y-4">
                <div><label>保養日期</label><input type="date" id="edit-record-date"></div>
                <div><label>更換項目</label><input type="text" id="edit-record-items" class="font-bold text-slate-800"></div>
                <div class="input-group-currency">
                    <label>金額</label><span class="currency-symbol">NT$</span>
                    <input type="number" id="edit-record-amount" inputmode="numeric" class="input-currency">
                </div>
                <div><label>備註</label><textarea id="edit-record-note" rows="3"></textarea></div>
                
                <div class="border-3 border-dashed border-slate-300 bg-slate-50 p-6 rounded-2xl text-center">
                    <label class="text-slate-600 font-bold block flex flex-col items-center cursor-pointer">
                        <span class="material-icons text-4xl mb-2 text-slate-400">add_a_photo</span>
                        <span class="text-lg">加傳照片 (原有照片會保留)</span>
                        <input type="file" id="edit-record-photo-input" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
                    </label>
                    <div id="edit-record-photo-preview" class="photo-grid mt-4 justify-center"></div>
                </div>
            </div>
            <div class="flex gap-4 mt-8 pt-4 border-t border-slate-100">
                <button onclick="closeModal('record-modal')" class="flex-1 bg-slate-100 text-slate-500 font-bold py-4 rounded-2xl text-xl">取消</button>
                <button onclick="saveEditedRecord()" class="flex-1 bg-blue-600 text-white font-bold py-4 rounded-2xl text-xl shadow-lg">儲存修改</button>
            </div>
        </div>
    </div>

    <div id="loading" class="loading-overlay hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center animate-bounce-small">
            <div class="animate-spin rounded-full h-16 w-16 border-[6px] border-blue-100 border-t-blue-600 mb-6"></div>
            <p class="text-slate-800 font-black text-2xl tracking-wide">資料同步中...</p>
        </div>
    </div>

    <script>
        // ⚠️⚠️⚠️ 記得換成你的 Apps Script 網址 ⚠️⚠️⚠️
        const API_URL = "https://script.google.com/macros/s/AKfycby0TrkaHnLe0UaZIGQ7DFKnq_1q_QbHWJsjxQ4YCstZ5i_U_OszwLnENXxUlSq_k_NT/exec"; 

        let customers = [];
        let currentCustomer = null;
        let selectedRecordPhotos = [];
        let selectedCustPhotos = [];
        let selectedEditRecordPhotos = [];

        window.onload = () => {
            fetchCustomers();
            document.getElementById('record-date').valueAsDate = new Date();
        };

        async function apiCall(action, payload = {}, method = 'POST') {
            showLoading(true);
            try {
                if (payload.phone) payload.phone = String(payload.phone);
                const url = method === 'GET' 
                    ? `${API_URL}?${new URLSearchParams({ action, ...payload })}` 
                    : API_URL;
                const options = method === 'GET' ? {} : { method: 'POST', body: JSON.stringify({ action, ...payload }) };
                const res = await fetch(url, options);
                return await res.json();
            } catch (e) { alert("連線錯誤: " + e.message); } finally { showLoading(false); }
        }

        async function fetchCustomers() {
            const data = await apiCall('getCustomers', {}, 'GET');
            if (Array.isArray(data)) { customers = data; renderList(customers); }
        }

        function renderList(list) {
            const container = document.getElementById('customer-list');
            container.innerHTML = '';
            if (list.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 mt-20 text-xl font-bold">沒有資料，請新增客戶</div>'; return; }
            list.forEach(c => {
                const div = document.createElement('div');
                div.className = 'card flex justify-between items-center cursor-pointer hover:bg-slate-50 active:scale-[0.98] transition-transform py-6';
                div.onclick = () => openDetail(c);
                div.innerHTML = `
                    <div class="flex items-center overflow-hidden">
                        <div class="w-16 h-16 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center font-black text-3xl mr-5 flex-shrink-0 shadow-sm">${c.name.charAt(0)}</div>
                        <div class="truncate">
                            <div class="font-bold text-2xl text-slate-800 truncate mb-1">${c.name}</div>
                            <div class="text-blue-600 font-mono font-bold text-xl">${c.phone}</div>
                        </div>
                    </div>
                    <span class="material-icons text-slate-300 text-4xl">chevron_right</span>`;
                container.appendChild(div);
            });
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderList(customers.filter(c => c.name.toLowerCase().includes(term) || String(c.phone).includes(term) || (c.note && c.note.toLowerCase().includes(term))));
        });

        async function openDetail(customer) {
            currentCustomer = customer;
            document.getElementById('page-list').classList.add('hidden');
            document.getElementById('page-detail').classList.remove('hidden');
            window.scrollTo(0, 0);

            document.getElementById('detail-header-name').innerText = customer.name;
            document.getElementById('detail-name').innerText = customer.name;
            document.getElementById('detail-phone').innerText = customer.phone;
            document.getElementById('detail-phone-link').href = `tel:${customer.phone}`;
            
            const dateEl = document.getElementById('detail-install-date');
            if (customer.installDate) {
                dateEl.innerText = customer.installDate.split('T')[0];
                dateEl.classList.remove('italic', 'text-gray-400');
            } else {
                dateEl.innerText = '未記錄日期';
                dateEl.classList.add('italic', 'text-gray-400');
            }

            setTextOrPlaceholder('detail-address', customer.address, '未填寫地址');
            setTextOrPlaceholder('detail-machine', customer.machine, '未填寫型號');
            setTextOrPlaceholder('detail-filter', customer.filter, '未填寫規格');
            
            const noteContainer = document.getElementById('note-container');
            if (customer.note) {
                document.getElementById('detail-note').innerText = customer.note;
                noteContainer.classList.remove('hidden');
            } else { noteContainer.classList.add('hidden'); }
            
            const photoContainer = document.getElementById('customer-photos-container');
            photoContainer.innerHTML = '';
            let photos = [];
            if (customer.photos && Array.isArray(customer.photos)) photos = customer.photos;
            else if (customer.photos && customer.photos.startsWith('[')) try { photos = JSON.parse(customer.photos); } catch(e) { photos = [customer.photos]; }
            else if (customer.photos) photos = [customer.photos];

            if (photos.length > 0) {
                photos.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url; img.className = 'photo-card-lg';
                    img.onclick = () => window.open(url, '_blank');
                    photoContainer.appendChild(img);
                });
                photoContainer.classList.remove('hidden');
            } else { photoContainer.innerHTML = '<div class="w-full text-center py-8 bg-slate-100 rounded-2xl text-slate-400 text-lg font-bold border-2 border-dashed border-slate-200">尚未上傳機器照片</div>'; }

            await fetchRecords(customer.id);
        }

        function setTextOrPlaceholder(id, value, placeholder) {
            const el = document.getElementById(id);
            if (value) { el.innerText = value; el.classList.remove('text-gray-400', 'italic'); }
            else { el.innerText = placeholder; el.classList.add('text-gray-400', 'italic'); }
        }

        function goBack() {
            document.getElementById('page-detail').classList.add('hidden');
            document.getElementById('page-list').classList.remove('hidden');
            currentCustomer = null;
            selectedRecordPhotos = [];
            renderRecordPhotoPreview();
        }

        async function fetchRecords(custId) {
            const listDiv = document.getElementById('record-list');
            listDiv.innerHTML = '<div class="text-center py-6 text-xl text-slate-500 font-bold">讀取紀錄中...</div>';
            const records = await apiCall('getRecords', { customerId: custId }, 'GET');
            listDiv.innerHTML = '';

            if (!records || records.length === 0) {
                listDiv.innerHTML = '<div class="text-center py-10 text-slate-400 text-xl font-bold">尚無保養紀錄</div>'; return;
            }

            records.forEach(r => {
                const photos = r.photos ? JSON.parse(r.photos) : [];
                const rData = JSON.stringify(r).replace(/"/g, '&quot;'); 
                
                const div = document.createElement('div');
                div.className = 'card border-l-[8px] border-blue-500 pl-6 shadow-md mb-6';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                        <div class="font-bold text-2xl text-slate-800">${r.date.split('T')[0]}</div>
                        <div class="flex items-center gap-2">
                            ${r.amount ? `<div class="text-green-600 font-bold font-mono text-3xl bg-green-50 px-3 py-1 rounded-lg">NT$${r.amount}</div>` : ''}
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="text-slate-500 text-lg font-bold mb-1">更換項目</div>
                        <div class="text-3xl font-black text-slate-900 leading-snug tracking-wide">${r.items}</div>
                    </div>
                    ${r.note ? `
                        <div class="mb-4 bg-orange-50 p-4 rounded-xl border border-orange-100">
                             <div class="text-orange-600 text-lg font-bold mb-1 flex items-center"><span class="material-icons mr-1">sticky_note_2</span>備註</div>
                             <div class="text-2xl font-bold text-slate-800 leading-relaxed">${r.note}</div>
                        </div>` : ''}
                    
                    ${photos.length > 0 ? `<div class="photo-grid mb-4 pt-2">${photos.map(url => `<img src="${url}" class="photo-thumb cursor-pointer border-2 border-white shadow-sm w-24 h-24" onclick="window.open('${url}')">`).join('')}</div>` : ''}
                    
                    <div class="flex justify-end gap-4 mt-2 pt-2">
                        <button onclick="openEditRecordModal('${rData}')" class="text-blue-600 text-xl font-bold flex items-center px-5 py-3 bg-blue-50 rounded-2xl hover:bg-blue-100 transition-colors">
                            <span class="material-icons text-2xl mr-2">edit</span>編輯
                        </button>
                        <button onclick="deleteRecord('${r.id}')" class="text-red-500 text-xl font-bold flex items-center px-5 py-3 bg-red-50 rounded-2xl hover:bg-red-100 transition-colors">
                            <span class="material-icons text-2xl mr-2">delete</span>刪除
                        </button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        // --- 編輯紀錄功能 ---
        function openEditRecordModal(recordStr) {
            const record = JSON.parse(recordStr);
            document.getElementById('edit-record-id').value = record.id;
            document.getElementById('edit-record-date').value = record.date.split('T')[0];
            document.getElementById('edit-record-items').value = record.items;
            document.getElementById('edit-record-amount').value = record.amount;
            document.getElementById('edit-record-note').value = record.note;
            selectedEditRecordPhotos = []; 
            document.getElementById('edit-record-photo-preview').innerHTML = '';
            document.getElementById('record-modal').classList.remove('hidden');
        }

        async function saveEditedRecord() {
            const id = document.getElementById('edit-record-id').value;
            const items = document.getElementById('edit-record-items').value;
            if (!items) return alert("請輸入項目");

            let photoUrls = [];
            if (selectedEditRecordPhotos.length > 0) {
                showLoading(true);
                for (let base64 of selectedEditRecordPhotos) {
                    const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                    if (res.status === 'success') photoUrls.push(res.url);
                }
            }

            const payload = {
                id: id,
                date: document.getElementById('edit-record-date').value,
                items: items,
                amount: document.getElementById('edit-record-amount').value,
                note: document.getElementById('edit-record-note').value,
                photos: photoUrls 
            };

            const res = await apiCall('updateRecord', payload);
            if (res.status === 'success') {
                alert("修改成功");
                closeModal('record-modal');
                fetchRecords(currentCustomer.id);
            } else { alert("修改失敗"); }
        }

        function handleEditRecordPhotoSelect(input) {
            const files = input.files; if (!files.length) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedEditRecordPhotos.push(res); renderPhotoList('edit-record-photo-preview', selectedEditRecordPhotos); });
                reader.readAsDataURL(file);
            });
            input.value = '';
        }

        // --- 通用 ---
        async function saveRecord() {
            if (!currentCustomer) return;
            const items = document.getElementById('record-items').value;
            if (!items) return alert("請輸入項目");

            let photoUrls = [];
            if (selectedRecordPhotos.length > 0) {
                showLoading(true);
                for (let base64 of selectedRecordPhotos) {
                    const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                    if (res.status === 'success') photoUrls.push(res.url);
                }
            }

            const payload = {
                customerId: currentCustomer.id,
                date: document.getElementById('record-date').value,
                items: items,
                amount: document.getElementById('record-amount').value,
                note: document.getElementById('record-note').value,
                photos: photoUrls
            };

            const res = await apiCall('addRecord', payload);
            if (res.status === 'success') {
                alert("新增成功");
                document.getElementById('record-items').value = '';
                document.getElementById('record-amount').value = '';
                document.getElementById('record-note').value = '';
                selectedRecordPhotos = [];
                renderRecordPhotoPreview();
                fetchRecords(currentCustomer.id);
                // Scroll to top of list
                document.getElementById('record-list').scrollIntoView({ behavior: 'smooth' });
            } else { alert("失敗"); }
        }

        async function deleteRecord(id) {
            if (confirm("確定刪除此紀錄？")) {
                await apiCall('deleteRecord', { id });
                fetchRecords(currentCustomer.id);
            }
        }

        function resizeImage(base64, maxWidth, callback) {
            const img = new Image(); img.src = base64;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width; let height = img.height;
                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', 0.8));
            };
        }

        function handleRecordPhotoSelect(input) {
            const files = input.files; if (!files.length) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedRecordPhotos.push(res); renderRecordPhotoPreview(); });
                reader.readAsDataURL(file);
            });
            input.value = '';
        }
        function renderRecordPhotoPreview() {
            renderPhotoList('new-record-photos', selectedRecordPhotos);
            document.getElementById('record-photo-count').innerText = selectedRecordPhotos.length + ' 張';
        }
        
        function handleCustPhotoSelect(input) {
            const files = input.files; if (!files.length) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedCustPhotos.push(res); renderPhotoList('cust-photo-preview', selectedCustPhotos); });
                reader.readAsDataURL(file);
            });
            input.value = '';
        }

        function renderPhotoList(divId, photoArray) {
            const div = document.getElementById(divId);
            div.innerHTML = photoArray.map((src, idx) => `
                <div class="relative flex-shrink-0"><img src="${src}" class="photo-thumb"><button onclick="removePhoto('${divId}', ${idx})" class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg shadow-md border-2 border-white">×</button></div>
            `).join('');
        }

        function removePhoto(divId, idx) {
            if (divId === 'new-record-photos') { selectedRecordPhotos.splice(idx, 1); renderRecordPhotoPreview(); }
            else if (divId === 'cust-photo-preview') { selectedCustPhotos.splice(idx, 1); renderPhotoList('cust-photo-preview', selectedCustPhotos); }
            else if (divId === 'edit-record-photo-preview') { selectedEditRecordPhotos.splice(idx, 1); renderPhotoList('edit-record-photo-preview', selectedEditRecordPhotos); }
        }

        function showAddCustomerModal() {
            document.getElementById('modal-title').innerText = '新增客戶';
            document.getElementById('cust-id').value = '';
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-phone').value = '';
            document.getElementById('cust-address').value = '';
            document.getElementById('cust-note').value = '';
            document.getElementById('cust-machine').value = '';
            document.getElementById('cust-filter').value = '';
            document.getElementById('cust-install-date').value = new Date().toISOString().split('T')[0];
            selectedCustPhotos = []; renderPhotoList('cust-photo-preview', []);
            document.getElementById('btn-delete-customer').classList.add('hidden');
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        function showEditCustomerModal() {
            if (!currentCustomer) return;
            document.getElementById('modal-title').innerText = '編輯資料';
            document.getElementById('cust-id').value = currentCustomer.id;
            document.getElementById('cust-name').value = currentCustomer.name;
            document.getElementById('cust-phone').value = currentCustomer.phone;
            document.getElementById('cust-address').value = currentCustomer.address;
            document.getElementById('cust-note').value = currentCustomer.note;
            document.getElementById('cust-machine').value = currentCustomer.machine;
            document.getElementById('cust-filter').value = currentCustomer.filter;
            document.getElementById('cust-install-date').value = currentCustomer.installDate ? currentCustomer.installDate.split('T')[0] : '';
            selectedCustPhotos = []; renderPhotoList('cust-photo-preview', []);
            document.getElementById('btn-delete-customer').classList.remove('hidden');
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        async function saveCustomer() {
            const id = document.getElementById('cust-id').value;
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            if (!name || !phone) return alert("姓名電話必填");

            let photoUrls = [];
            if (id && currentCustomer && currentCustomer.photos) {
                 if (Array.isArray(currentCustomer.photos)) photoUrls = [...currentCustomer.photos];
                 else try { photoUrls = JSON.parse(currentCustomer.photos); } catch(e) { photoUrls = [currentCustomer.photos]; }
            }
            if (selectedCustPhotos.length > 0) {
                showLoading(true);
                for (let base64 of selectedCustPhotos) {
                    const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                    if (res.status === 'success') photoUrls.push(res.url);
                }
            }

            const payload = {
                id: id, name: name, phone: phone,
                address: document.getElementById('cust-address').value,
                note: document.getElementById('cust-note').value,
                machine: document.getElementById('cust-machine').value,
                filter: document.getElementById('cust-filter').value,
                installDate: document.getElementById('cust-install-date').value,
                photos: photoUrls 
            };

            const action = id ? 'updateCustomer' : 'addCustomer';
            const res = await apiCall(action, payload);
            
            if (res.status === 'success') {
                alert("儲存成功"); closeModal('customer-modal'); fetchCustomers();
                if (id && currentCustomer) openDetail({ ...currentCustomer, ...payload, photos: photoUrls });
            } else { alert("失敗"); }
        }

        async function deleteCustomer() {
            if (confirm("確定刪除此客戶？")) {
                await apiCall('deleteCustomer', { id: document.getElementById('cust-id').value });
                alert("已刪除"); closeModal('customer-modal'); goBack(); fetchCustomers();
            }
        }

        function showLoading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }
        document.getElementById('customer-modal').addEventListener('click', e => { if (e.target.id === 'customer-modal') closeModal('customer-modal'); });
        document.getElementById('record-modal').addEventListener('click', e => { if (e.target.id === 'record-modal') closeModal('record-modal'); });
    </script>
</body>
</html>

