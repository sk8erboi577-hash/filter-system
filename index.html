<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>濾芯保養系統</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/water-filter.png" />

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            /* 奶茶色主題 + iOS Blue*/
            primary: "#007AFF",
            secondary: "#5856D6",
            beige: "#F5EFE7",
            milk: "#F0E7D8",
            latte: "#E8DCC5",
            textDark: "#3A3A3A",
            textGray: "#6F6F6F",
            borderLight: "#DDD9D2",
            card: "#FFFFFF",
          }
        }
      }
    }
  </script>

  <style>
    /* =============== 全域風格 =============== */
    html {
      font-size: 18px; /* 整體放大 1.2x */
    }

    body {
      background: #F5EFE7; /* 奶茶底色 */
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #3A3A3A;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 110px;
    }

    /* =============== iOS Navigation Bar =============== */
    .ios-nav-bar {
      position: sticky;
      top: 0;
      z-index: 50;
      padding-top: env(safe-area-inset-top);
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid #E5E5E5;
      height: 58px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-inline: 12px;
    }

    .ios-nav-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #3A3A3A;
      text-align: center;
      flex: 1;
    }

    .ios-nav-left,
    .ios-nav-right {
      width: 80px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .ios-nav-left span,
    .ios-nav-right span {
      color: #007AFF;
      font-size: 17px;
    }

    .ios-nav-left .material-icons {
      font-size: 20px;
      margin-right: 3px;
    }

    /* =============== 搜尋列 =============== */
    .search-bar {
      background: white;
      border-radius: 14px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      border: 1px solid #E6E2DA;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .search-bar input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 16px;
      padding-left: 8px;
      color: #3A3A3A;
    }
    .search-bar input:focus {
      outline: none;
    }

    /* =============== 客戶卡片（Dashboard 卡片） =============== */
    .dashboard-card {
      background: white;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid #E6E2DA;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      transition: 0.15s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-card:active {
      transform: scale(.98);
    }

    .dashboard-name {
      font-size: 19px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #3A3A3A;
    }

    .dashboard-meta {
      display: flex;
      gap: 12px;
      font-size: 14px;
      color: #6F6F6F;
      align-items: center;
      flex-wrap: wrap;
    }

    .dashboard-chevron .material-icons {
      color: #C1C1C1;
    }

    /* =============== 標籤顯示（於客戶卡片） =============== */
    .customer-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .tag-pill {
      background: #E8DCC5;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #5A4636;
      border: 1px solid #D9CBB6;
    }

    /* =============== Floating Add Button =============== */
    .fab {
      position: fixed;
      bottom: 26px;
      right: 26px;
      width: 64px;
      height: 64px;
      border-radius: 999px;
      background: #007AFF;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 12px 20px rgba(0,122,255,0.4);
      font-size: 32px;
      z-index: 50;
    }
  </style>
</head>

<body>

<!-- ====================== 首頁（客戶列表） ====================== -->
<div id="page-list">

  <!-- 搜尋區 -->
  <div class="p-4 pt-8 max-w-md mx-auto">
    <h1 class="text-2xl font-bold mb-3 text-[color:#3A3A3A]">濾芯保養系統</h1>

    <div class="search-bar">
      <span class="material-icons text-gray-400">search</span>
      <input id="search-input" type="text" placeholder="搜尋客戶名稱、電話、標籤..." />
    </div>
  </div>

  <!-- 客戶列表 -->
  <div id="customer-list" class="max-w-md mx-auto px-4 pb-24">
    <div class="text-center text-gray-400 mt-10">載入中...</div>
  </div>

  <!-- 新增按鈕 -->
  <div class="fab" onclick="showAddCustomerModal()">
    <span class="material-icons">add</span>
  </div>
</div>

  <!-- ====================== 客戶詳細頁 ====================== -->
<div id="page-detail" class="hidden">

  <!-- iOS Navigation Bar -->
  <div class="ios-nav-bar">
    <div class="ios-nav-left" onclick="goBack()">
      <span class="material-icons">arrow_back_ios</span>
      <span>返回</span>
    </div>

    <div class="ios-nav-title">客戶資料</div>

    <div class="ios-nav-right" onclick="showEditCustomerModal()">
      <span>編輯</span>
    </div>
  </div>

  <!-- 詳細內容 -->
  <div class="px-4 pb-10 max-w-md mx-auto">

    <!-- 照片卡片 -->
    <div class="mt-4 rounded-2xl bg-white p-4 shadow border border-[#E6E2DA]">
      <div id="customer-photos-container" style="display:flex; gap:10px; overflow-x:auto;"></div>
    </div>

    <!-- 基本資料 -->
    <div class="mt-5 bg-white rounded-2xl p-4 shadow border border-[#E6E2DA]">
      <h3 class="text-sm text-gray-500 tracking-widest font-bold mb-2">基本資料</h3>

      <div class="flex py-1"><span class="w-20 text-gray-500">姓名</span><span id="detail-name"></span></div>
      <div class="flex py-1">
        <span class="w-20 text-gray-500">電話</span>
        <a id="detail-phone-link" class="text-primary flex items-center">
          <span class="material-icons mr-1">phone</span>
          <span id="detail-phone"></span>
        </a>
      </div>
      <div class="flex py-1"><span class="w-20 text-gray-500">安裝日期</span><span id="detail-install-date"></span></div>
      <div class="flex py-1"><span class="w-20 text-gray-500">地址</span><span id="detail-address"></span></div>
      <div class="flex py-1"><span class="w-20 text-gray-500">機器</span><span id="detail-machine"></span></div>
      <div class="flex py-1"><span class="w-20 text-gray-500">濾芯</span><span id="detail-filter"></span></div>

      <div id="note-container" class="flex py-1 hidden">
        <span class="w-20 text-[#D97706]">備註</span>
        <span id="detail-note" class="text-[#D97706]"></span>
      </div>
    </div>

    <!-- 新增保養紀錄 -->
    <div class="mt-5 bg-white rounded-2xl p-4 shadow border border-[#E6E2DA]">
      <h3 class="text-sm text-gray-500 tracking-widest font-bold mb-3">新增保養紀錄</h3>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-gray-600">日期</label>
          <input id="record-date" type="date" class="w-full bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg p-2" />
        </div>
        <div>
          <label class="text-sm text-gray-600">金額</label>
          <input id="record-amount" type="number" class="w-full bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg p-2" placeholder="0" />
        </div>
      </div>

      <div class="mt-3">
        <label class="text-sm text-gray-600">更換項目</label>
        <input id="record-items" type="text" class="w-full bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg p-2" placeholder="例如：PP、活性碳" />
      </div>

      <div class="mt-3">
        <label class="text-sm text-gray-600">備註（選填）</label>
        <input id="record-note" type="text" class="w-full bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg p-2" />
      </div>

      <div class="mt-3 flex items-center gap-3">
        <label class="bg-[#F0E7D8] text-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center cursor-pointer">
          <span class="material-icons mr-1">camera_alt</span> 拍照
          <input id="record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)" />
        </label>
        <span id="record-photo-count" class="text-xs text-gray-400">0 張</span>
      </div>

      <div id="new-record-photos" class="flex gap-3 mt-3 overflow-x-auto"></div>

      <button onclick="saveRecord()" class="mt-4 w-full py-3 bg-primary text-white rounded-xl shadow text-lg font-semibold">
        儲存紀錄
      </button>
    </div>

    <!-- 歷史紀錄 -->
    <div class="mt-6">
      <h3 class="text-sm text-gray-500 tracking-widest font-bold mb-2">歷史紀錄</h3>

      <div id="record-list" class="relative pl-5">
        <!-- 這裡由 JS 建立 -->
      </div>
    </div>

  </div>
</div>

<!-- ====================== 新增／編輯 客戶 Modal ====================== -->
<div id="customer-modal" class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center">
  <div class="bg-white rounded-2xl w-full max-w-md h-[90vh] overflow-hidden shadow-xl flex flex-col">

    <!-- Modal Header -->
    <div class="px-4 py-3 border-b border-[#E6E2DA] bg-[#F9F7F2]">
      <div class="flex justify-between items-center">
        <button onclick="closeModal('customer-modal')" class="text-primary text-lg">取消</button>
        <h2 id="modal-title" class="text-lg font-semibold">新增客戶</h2>
        <button onclick="saveCustomer()" class="text-primary font-semibold text-lg">儲存</button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="p-4 space-y-4 overflow-y-auto">

      <input type="hidden" id="cust-id" />

      <div class="bg-white p-4 rounded-xl border border-[#E6E2DA] space-y-3">
        <div>
          <label>姓名 <span class="text-red-500">*</span></label>
          <input id="cust-name" type="text" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg" />
        </div>

        <div>
          <label>電話 <span class="text-red-500">*</span></label>
          <input id="cust-phone" type="tel" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg" />
        </div>

        <div>
          <label>安裝日期</label>
          <input id="cust-install-date" type="date" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg" />
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl border border-[#E6E2DA] space-y-3">
        <div>
          <label>地址</label>
          <input id="cust-address" type="text" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg" />
        </div>

        <div>
          <label>機器型號</label>
          <input id="cust-machine" type="text" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg" />
        </div>

        <div>
          <label>濾芯規格</label>
          <input id="cust-filter" type="text" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg" />
        </div>
      </div>

      <!-- 標籤系統 -->
      <div class="bg-white p-4 rounded-xl border border-[#E6E2DA]">
        <label class="block mb-2">標籤（可多選）</label>
        <div id="cust-tag-selector" class="tag-selector"></div>
      </div>

      <!-- 備註 -->
      <div class="bg-white p-4 rounded-xl border border-[#E6E2DA]">
        <label>備註</label>
        <textarea id="cust-note" rows="3" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg"></textarea>
      </div>

      <!-- 照片 -->
      <div class="bg-white p-4 rounded-xl border border-[#E6E2DA] text-center">
        <label class="text-primary font-medium cursor-pointer flex items-center justify-center">
          <span class="material-icons mr-2">add_photo_alternate</span>
          選擇機器照片
          <input id="cust-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)" />
        </label>

        <div id="cust-photo-preview" class="flex gap-3 overflow-x-auto mt-3"></div>
      </div>

      <!-- 刪除按鈕 -->
      <button id="btn-delete-customer" onclick="deleteCustomer()" class="w-full py-3 bg-red-50 text-red-500 rounded-xl border border-red-200 text-lg hidden">
        刪除此客戶
      </button>
    </div>
  </div>
</div>

<!-- ====================== 編輯保養紀錄 Modal ====================== -->
<div id="record-modal" class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center">
  <div class="bg-white rounded-2xl w-full max-w-md h-auto max-h-[90vh] overflow-hidden shadow-xl flex flex-col">

    <div class="px-4 py-3 border-b border-[#E6E2DA] bg-[#F9F7F2]">
      <div class="flex justify-between items-center">
        <button onclick="closeModal('record-modal')" class="text-primary text-lg">取消</button>
        <h2 class="text-lg font-semibold">修改紀錄</h2>
        <button onclick="saveEditedRecord()" class="text-primary font-semibold text-lg">完成</button>
      </div>
    </div>

    <div class="p-4 space-y-4 overflow-y-auto">

      <input type="hidden" id="edit-record-id" />

      <div class="bg-white p-4 rounded-xl border border-[#E6E2DA] space-y-3">
        <div>
          <label>日期</label>
          <input id="edit-record-date" type="date" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg" />
        </div>

        <div>
          <label>項目</label>
          <input id="edit-record-items" type="text" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg" />
        </div>

        <div>
          <label>金額</label>
          <input id="edit-record-amount" type="number" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg text-green-700 font-bold" />
        </div>

        <div>
          <label>備註</label>
          <textarea id="edit-record-note" rows="3" class="w-full p-2 bg-[#F9F7F2] border border-[#E6E2DA] rounded-lg"></textarea>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl border border-[#E6E2DA]">
        <label class="text-primary font-medium cursor-pointer flex items-center justify-center">
          <span class="material-icons mr-2">add_a_photo</span> 加傳照片
          <input id="edit-record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)" />
        </label>

        <div id="edit-record-photo-preview" class="flex gap-3 overflow-x-auto mt-3"></div>
      </div>

    </div>
  </div>
</div>

  <style>

/* =========================================================
   全域樣式（奶茶色主題）
   ========================================================= */

:root {
  --primary: #007AFF;
  --primary-light: #64A8FF;

  --milk-bg: #F5EFE7;   /* 奶灰背景 */
  --milk-card: #FFFFFF; /* 白卡片 */
  --milk-border: #E6E2DA; /* 奶茶邊框 */
  --milk-input: #F9F7F2; /* 奶茶底輸入框 */

  --text-main: #3A342E; 
  --text-secondary: #6E655C;
}

html {
  font-size: 18px;  /* 1.2x 放大 */
}

body {
  background: var(--milk-bg);
  color: var(--text-main);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
  padding-bottom: 100px;
}

/* =========================================================
   iOS Navigation Bar（避免擋住照片）
   ========================================================= */

.ios-nav-bar {
  position: sticky;
  top: 0;
  z-index: 30;
  padding: 12px 16px;
  padding-top: env(safe-area-inset-top, 16px);
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--milk-border);

  display: flex;
  justify-content: space-between;
  align-items: center;
}

.ios-nav-left,
.ios-nav-right {
  display: flex;
  align-items: center;
  gap: 4px;
  color: var(--primary);
  font-size: 16px;
  cursor: pointer;
}

.ios-nav-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-main);
}

/* =========================================================
   搜尋列
   ========================================================= */

.search-bar {
  background: #FFF;
  border-radius: 14px;
  padding: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  border: 1px solid var(--milk-border);
}

.search-bar input {
  border: none;
  background: transparent;
  width: 100%;
  font-size: 16px;
}
.search-bar input:focus {
  outline: none;
}

/* =========================================================
   客戶列表卡片
   ========================================================= */

.dashboard-card {
  background: var(--milk-card);
  border-radius: 18px;
  border: 1px solid var(--milk-border);
  padding: 16px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 6px 16px rgba(0,0,0,0.06);
  cursor: pointer;
  transition: 0.1s;
}

.dashboard-card:active {
  transform: scale(0.98);
}

.dashboard-name {
  font-size: 20px;
  font-weight: 700;
}

.dashboard-tag {
  display: inline-flex;
  align-items: center;
  background: #EFEDE7;
  border: 1px solid var(--milk-border);
  color: var(--text-secondary);
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 12px;
}

.dashboard-chevron {
  width: 32px;
  height: 32px;
  background: #F2F0EB;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.dashboard-chevron span {
  color: #9CA3AF;
  font-size: 18px;
}

/* =========================================================
   機器照片輪播
   ========================================================= */

.machine-photo-card img {
  width: 100%;
  height: 220px;
  object-fit: cover;
  border-radius: 16px;
}

/* =========================================================
   timeline（歷史保養紀錄）
   ========================================================= */

.timeline-item {
  position: relative;
  margin-bottom: 18px;
  padding-left: 20px;
}

.timeline-item::before {
  content: "";
  position: absolute;
  left: 9px;
  top: 0;
  bottom: -8px;
  width: 2px;
  background: var(--milk-border);
}

.timeline-dot {
  position: absolute;
  left: 4px;
  top: 8px;
  width: 12px;
  height: 12px;
  background: white;
  border: 3px solid var(--primary);
  border-radius: 50%;
}

.record-card {
  background: var(--milk-card);
  border: 1px solid var(--milk-border);
  padding: 14px;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.record-date {
  font-size: 15px;
  font-weight: 600;
}

.record-amount {
  color: #008A32;
  font-weight: 700;
}

/* =========================================================
   Modal（底部彈跳面板）
   ========================================================= */

#customer-modal,
#record-modal {
  backdrop-filter: blur(8px);
}

.sheet-body input,
.sheet-body textarea {
  background: var(--milk-input);
  border: 1px solid var(--milk-border);
  border-radius: 12px;
  padding: 10px;
  width: 100%;
  font-size: 16px;
}

/* =========================================================
   主按鈕
   ========================================================= */

button.btn-primary,
button.save-btn {
  background: var(--primary);
  border: none;
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  font-size: 18px;
  color: white;
  font-weight: 600;
  box-shadow: 0 8px 20px rgba(0,122,255,0.3);
}

/* =========================================================
   標籤系統（TAG）
   ========================================================= */

.tag-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tag {
  padding: 6px 12px;
  background: #EFEDE7;
  color: #5F564D;
  border: 1px solid var(--milk-border);
  border-radius: 999px;
  cursor: pointer;
  user-select: none;
  transition: 0.15s;
  font-size: 14px;
}

.tag.active {
  background: var(--primary);
  border-color: var(--primary);
  color: #FFF;
}

/* =========================================================
   照片縮圖
   ========================================================= */

.photo-thumb {
  width: 90px;
  height: 90px;
  border-radius: 12px;
  object-fit: cover;
  background: #E5E2DC;
  border: 1px solid var(--milk-border);
}

/* =========================================================
   Loading 遮罩
   ========================================================= */

.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(8px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
  flex-direction: column;
}
</style>

  <script>
/* =========================================================
   全域變數
   ========================================================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyIOBdYEHKOOS4TbG0abfyQWSOoll-RlkZvd08fU8_9VSMNQYgRSNmgeyg1IGUpquE/exec";

let customers = [];
let currentCustomer = null;
let selectedCustPhotos = [];
let selectedRecordPhotos = [];
let selectedEditRecordPhotos = [];
window.currentRecords = [];

/* =========================================================
   標籤選項（你可自由修改）
   ========================================================= */
const TAG_OPTIONS = [
  "廚下型",
  "飲水機",
  "全戶式",
  "工業商業",
  "售服",
  "其他"
];

/* =========================================================
   日期處理：完全避免扣一天問題
   ========================================================= */
function normalizeDateStr(value) {
  if (!value) return "";

  const str = String(value);

  // 已經是 yyyy-mm-dd → 直接回傳
  if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;

  // ISO 格式（含 T）→ 以本地時間轉換
  if (str.includes("T")) {
    const d = new Date(str);
    if (!isNaN(d)) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
  }

  // 其他格式 → 只取日期部分
  return str.split(/[ T]/)[0];
}

/* =========================================================
   API 呼叫
   ========================================================= */
async function apiCall(action, payload = {}, method = "POST") {
  try {
    showLoading(true);

    const url =
      method === "GET"
        ? `${API_URL}?${new URLSearchParams({ action, ...payload })}`
        : API_URL;

    const options =
      method === "GET"
        ? {}
        : { method: "POST", body: JSON.stringify({ action, ...payload }) };

    const res = await fetch(url, options);
    return await res.json();
  } catch (e) {
    console.log(e);
    alert("發生錯誤，請稍後重試");
    return null;
  } finally {
    showLoading(false);
  }
}

/* =========================================================
   初始載入
   ========================================================= */
window.onload = () => {
  fetchCustomers();
  if (document.getElementById("record-date")) {
    document.getElementById("record-date").valueAsDate = new Date();
  }
};

/* =========================================================
   取得客戶列表
   ========================================================= */
async function fetchCustomers() {
  const data = await apiCall("getCustomers", {}, "GET");

  if (!Array.isArray(data)) {
    document.getElementById("customer-list").innerHTML =
      `<div class="text-center text-gray-400 mt-20 text-sm">讀取失敗</div>`;
    return;
  }

  customers = data;
  renderList(customers);
}

/* =========================================================
   渲染客戶列表
   ========================================================= */
function renderList(list) {
  const container = document.getElementById("customer-list");
  container.innerHTML = "";

  if (!list || list.length === 0) {
    container.innerHTML =
      `<div class="text-center text-gray-400 mt-20 text-sm">暫無資料</div>`;
    return;
  }

  const wrapper = document.createElement("div");
  wrapper.className = "max-w-md mx-auto px-1 pt-2 space-y-3 pb-6";

  list.forEach((c) => {
    const lastText = c.lastRecordDate
      ? normalizeDateStr(c.lastRecordDate)
      : "尚無保養紀錄";

    const card = document.createElement("div");
    card.className = "dashboard-card";
    card.onclick = () => openDetail(c);

    card.innerHTML = `
      <div class="dashboard-main">
        <div class="dashboard-name truncate">${c.name}</div>

        <div class="dashboard-tag">${c.tags || "未分類"}</div>

        <div class="dashboard-meta">
          <span><span class="material-icons">phone_iphone</span>${c.phone}</span>
          <span><span class="material-icons">history</span>${lastText}</span>
        </div>

        ${c.note ? `<div class="subtle-text mt-1 line-clamp-1">備註：${c.note}</div>` : ""}
      </div>
      <div class="dashboard-chevron"><span class="material-icons">arrow_forward_ios</span></div>
    `;

    wrapper.appendChild(card);
  });

  container.appendChild(wrapper);
}

/* =========================================================
   搜尋功能
   ========================================================= */
document.getElementById("search-input").addEventListener("input", (e) => {
  const term = e.target.value.toLowerCase();
  renderList(
    customers.filter(
      (c) =>
        c.name.toLowerCase().includes(term) ||
        c.phone.includes(term) ||
        (c.note && c.note.toLowerCase().includes(term))
    )
  );
});

/* =========================================================
   打開詳細頁
   ========================================================= */
async function openDetail(customer) {
  currentCustomer = customer;

  document.getElementById("page-list").classList.add("hidden");
  document.getElementById("page-detail").classList.remove("hidden");
  window.scrollTo(0, 0);

  document.getElementById("detail-name").innerText = customer.name;
  document.getElementById("detail-phone").innerText = customer.phone;
  document.getElementById("detail-phone-link").href = `tel:${customer.phone}`;
  document.getElementById("detail-install-date").innerText =
    normalizeDateStr(customer.installDate) || "無紀錄";
  document.getElementById("detail-address").innerText = customer.address || "未填寫";
  document.getElementById("detail-machine").innerText = customer.machine || "未填寫";
  document.getElementById("detail-filter").innerText = customer.filter || "未填寫";

  if (customer.note) {
    document.getElementById("detail-note").innerText = customer.note;
    document.getElementById("note-container").classList.remove("hidden");
  } else {
    document.getElementById("note-container").classList.add("hidden");
  }

  // 顯示機器照片
  const photoContainer = document.getElementById("customer-photos-container");
  photoContainer.innerHTML = "";

  let photos = [];
  if (Array.isArray(customer.photos)) photos = customer.photos;
  else if (customer.photos) {
    try { photos = JSON.parse(customer.photos); }
    catch { photos = [customer.photos]; }
  }

  if (photos.length === 0) {
    photoContainer.innerHTML =
      `<div class="machine-photo-empty">無機器照片</div>`;
  } else {
    photos.forEach((url) => {
      const slide = document.createElement("div");
      slide.className = "machine-photo-slide";
      slide.innerHTML = `<img src="${url}" />`;
      slide.onclick = () => window.open(url);
      photoContainer.appendChild(slide);
    });
  }

  await fetchRecords(customer.id);
}

/* =========================================================
   返回列表
   ========================================================= */
function goBack() {
  document.getElementById("page-detail").classList.add("hidden");
  document.getElementById("page-list").classList.remove("hidden");
}

/* =========================================================
   歷史紀錄
   ========================================================= */
async function fetchRecords(custId) {
  const listDiv = document.getElementById("record-list");
  listDiv.innerHTML = `<div class="text-center py-4 text-gray-400">讀取中...</div>`;

  const records = await apiCall("getRecords", { customerId: custId }, "GET");

  if (!records || records.length === 0) {
    listDiv.innerHTML =
      `<div class="text-center py-6 text-gray-400 text-sm">尚無紀錄</div>`;
    updateLastRecordDate(custId, "");
    return;
  }

  records.sort((a, b) => new Date(a.date) - new Date(b.date));
  window.currentRecords = records;

  // 更新 lastRecordDate
  const last = normalizeDateStr(records[records.length - 1].date);
  updateLastRecordDate(custId, last);

  listDiv.innerHTML = "";
  records
    .slice()
    .reverse()
    .forEach((r) => {
      let photos = [];
      try { photos = Array.isArray(r.photos) ? r.photos : JSON.parse(r.photos || "[]"); }
      catch { photos = []; }

      const div = document.createElement("div");
      div.className = "timeline-item";

      div.innerHTML = `
        <div class="timeline-dot"></div>
        <div class="record-card">
          <div class="flex justify-between mb-1">
            <div class="record-date">${normalizeDateStr(r.date)}</div>
            <div class="record-amount">${r.amount ? "NT$" + r.amount : ""}</div>
          </div>

          <div class="record-items">${r.items}</div>
          ${r.note ? `<div class="record-note">${r.note}</div>` : ""}

          ${
            photos.length
              ? `<div class="flex gap-2 overflow-x-auto mt-2">
                   ${photos
                     .map(
                       (p) =>
                         `<img src="${p}" class="photo-thumb" onclick="window.open('${p}')">`
                     )
                     .join("")}
                 </div>`
              : ""
          }

          <div class="record-actions mt-2 flex justify-end gap-3">
            <button class="text-primary" onclick="openEditRecordModal('${r.id}')">編輯</button>
            <button class="text-red-500" onclick="deleteRecord('${r.id}')">刪除</button>
          </div>
        </div>
      `;
      listDiv.appendChild(div);
    });
}

/* =========================================================
   更新 lastRecordDate（首頁即時顯示）
   ========================================================= */
function updateLastRecordDate(custId, date) {
  const idx = customers.findIndex((c) => c.id == custId);
  if (idx !== -1) {
    customers[idx].lastRecordDate = date;
  }
  renderList(customers);
}

/* =========================================================
   編輯紀錄 Modal
   ========================================================= */
function openEditRecordModal(recordId) {
  const r = window.currentRecords.find((x) => x.id == recordId);
  if (!r) return alert("找不到紀錄");

  document.getElementById("edit-record-id").value = r.id;
  document.getElementById("edit-record-date").value = normalizeDateStr(r.date);
  document.getElementById("edit-record-items").value = r.items;
  document.getElementById("edit-record-amount").value = r.amount;
  document.getElementById("edit-record-note").value = r.note;

  selectedEditRecordPhotos = [];
  document.getElementById("edit-record-photo-preview").innerHTML = "";

  document.getElementById("record-modal").classList.remove("hidden");
}

/* =========================================================
   儲存編輯後的紀錄
   ========================================================= */
async function saveEditedRecord() {
  const id = document.getElementById("edit-record-id").value;
  const items = document.getElementById("edit-record-items").value.trim();
  if (!items) return alert("請輸入項目");

  let photoUrls = [];

  for (let b64 of selectedEditRecordPhotos) {
    const res = await apiCall("uploadImage", { base64: b64, type: "image/jpeg" });
    if (res?.status === "success") photoUrls.push(res.url);
  }

  const payload = {
    id,
    date: document.getElementById("edit-record-date").value,
    items,
    amount: document.getElementById("edit-record-amount").value,
    note: document.getElementById("edit-record-note").value,
    photos: photoUrls,
  };

  const res = await apiCall("updateRecord", payload);
  if (res?.status === "success") {
    closeModal("record-modal");
    await fetchRecords(currentCustomer.id);
  } else {
    alert("更新失敗");
  }
}

/* =========================================================
   新增保養紀錄
   ========================================================= */
async function saveRecord() {
  if (!currentCustomer) return;

  const items = document.getElementById("record-items").value.trim();
  if (!items) return alert("請輸入項目");

  let photoUrls = [];
  for (let b64 of selectedRecordPhotos) {
    const r = await apiCall("uploadImage", { base64: b64, type: "image/jpeg" });
    if (r?.status === "success") photoUrls.push(r.url);
  }

  const payload = {
    customerId: currentCustomer.id,
    date: document.getElementById("record-date").value,
    items,
    amount: document.getElementById("record-amount").value,
    note: document.getElementById("record-note").value,
    photos: photoUrls,
  };

  const res = await apiCall("addRecord", payload);
  if (res?.status === "success") {
    selectedRecordPhotos = [];
    document.getElementById("record-items").value = "";
    document.getElementById("record-amount").value = "";
    document.getElementById("record-note").value = "";
    renderRecordPhotoPreview();
    await fetchRecords(currentCustomer.id);
  } else {
    alert("新增失敗");
  }
}

/* =========================================================
   刪除紀錄
   ========================================================= */
async function deleteRecord(id) {
  if (!confirm("確定刪除此紀錄？")) return;
  await apiCall("deleteRecord", { id });
  await fetchRecords(currentCustomer.id);
}

/* =========================================================
   客戶照片選取
   ========================================================= */
function handleCustPhotoSelect(input) {
  const files = [...input.files];
  files.forEach((file) => {
    const reader = new FileReader();
    reader.onload = (e) =>
      resizeImage(e.target.result, 1000, (res) => {
        selectedCustPhotos.push(res);
        renderPhotoList("cust-photo-preview", selectedCustPhotos);
      });
    reader.readAsDataURL(file);
  });
  input.value = "";
}

/* =========================================================
   新增紀錄照片
   ========================================================= */
function handleRecordPhotoSelect(input) {
  const files = [...input.files];
  files.forEach((file) => {
    const reader = new FileReader();
    reader.onload = (e) =>
      resizeImage(e.target.result, 1000, (res) => {
        selectedRecordPhotos.push(res);
        renderRecordPhotoPreview();
      });
    reader.readAsDataURL(file);
  });
  input.value = "";
}

function renderRecordPhotoPreview() {
  renderPhotoList("new-record-photos", selectedRecordPhotos);
  document.getElementById("record-photo-count").innerText =
    `${selectedRecordPhotos.length} 張`;
}

/* =========================================================
   編輯紀錄照片選取
   ========================================================= */
function handleEditRecordPhotoSelect(input) {
  const files = [...input.files];
  files.forEach((file) => {
    const reader = new FileReader();
    reader.onload = (e) =>
      resizeImage(e.target.result, 1000, (res) => {
        selectedEditRecordPhotos.push(res);
        renderPhotoList("edit-record-photo-preview", selectedEditRecordPhotos);
      });
    reader.readAsDataURL(file);
  });
  input.value = "";
}

/* =========================================================
   通用照片渲染
   ========================================================= */
function renderPhotoList(divId, srcList) {
  const div = document.getElementById(divId);
  div.innerHTML = srcList
    .map(
      (src, idx) => `
      <div class="relative flex-shrink-0">
        <img src="${src}" class="photo-thumb" />
        <button class="absolute -top-1 -right-1 bg-black bg-opacity-50 text-white 
          w-5 h-5 rounded-full flex items-center justify-center text-xs"
          onclick="removePhoto('${divId}', ${idx})">×</button>
      </div>`
    )
    .join("");
}

function removePhoto(divId, idx) {
  if (divId === "cust-photo-preview") {
    selectedCustPhotos.splice(idx, 1);
  } else if (divId === "new-record-photos") {
    selectedRecordPhotos.splice(idx, 1);
  } else if (divId === "edit-record-photo-preview") {
    selectedEditRecordPhotos.splice(idx, 1);
  }
  renderPhotoList(divId, eval(divId.replace("-", "")));
}

/* =========================================================
   調整圖片大小
   ========================================================= */
function resizeImage(base64, maxWidth, callback) {
  const img = new Image();
  img.src = base64;
  img.onload = () => {
    let w = img.width;
    let h = img.height;
    if (w > maxWidth) {
      h = (h * maxWidth) / w;
      w = maxWidth;
    }
    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    canvas.getContext("2d").drawImage(img, 0, 0, w, h);
    callback(canvas.toDataURL("image/jpeg", 0.85));
  };
}

/* =========================================================
   新增客戶 Modal
   ========================================================= */
function showAddCustomerModal() {
  document.getElementById("modal-title").innerText = "新增客戶";
  document.getElementById("cust-id").value = "";
  document.getElementById("cust-name").value = "";
  document.getElementById("cust-phone").value = "";
  document.getElementById("cust-address").value = "";
  document.getElementById("cust-note").value = "";
  document.getElementById("cust-machine").value = "";
  document.getElementById("cust-filter").value = "";

  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth() + 1).padStart(2, "0");
  const d = String(today.getDate()).padStart(2, "0");
  document.getElementById("cust-install-date").value = `${y}-${m}-${d}`;

  selectedCustPhotos = [];
  renderPhotoList("cust-photo-preview", []);

  renderTagSelector("cust-tag-selector", []);
  document.getElementById("btn-delete-customer").classList.add("hidden");

  document.getElementById("customer-modal").classList.remove("hidden");
}

/* =========================================================
   編輯客戶 Modal
   ========================================================= */
function showEditCustomerModal() {
  if (!currentCustomer) return;

  document.getElementById("modal-title").innerText = "編輯客戶";
  document.getElementById("cust-id").value = currentCustomer.id;
  document.getElementById("cust-name").value = currentCustomer.name;
  document.getElementById("cust-phone").value = currentCustomer.phone;
  document.getElementById("cust-address").value = currentCustomer.address;
  document.getElementById("cust-note").value = currentCustomer.note;
  document.getElementById("cust-machine").value = currentCustomer.machine;
  document.getElementById("cust-filter").value = currentCustomer.filter;

  document.getElementById("cust-install-date").value =
    normalizeDateStr(currentCustomer.installDate);

  selectedCustPhotos = [];
  renderPhotoList("cust-photo-preview", []);

  renderTagSelector(
    "cust-tag-selector",
    currentCustomer.tags ? currentCustomer.tags.split(",") : []
  );

  document.getElementById("btn-delete-customer").classList.remove("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

/* =========================================================
   儲存客戶（新增＋編輯）
   ========================================================= */
async function saveCustomer() {
  const id = document.getElementById("cust-id").value;
  const name = document.getElementById("cust-name").value.trim();
  const phone = document.getElementById("cust-phone").value.trim();
  if (!name || !phone) return alert("姓名、電話必填");

  // 既有照片
  let photoUrls = [];
  if (id && currentCustomer?.photos) {
    try {
      photoUrls = Array.isArray(currentCustomer.photos)
        ? [...currentCustomer.photos]
        : JSON.parse(currentCustomer.photos);
    } catch {
      photoUrls = [];
    }
  }

  // 新增照片
  for (let b64 of selectedCustPhotos) {
    const r = await apiCall("uploadImage", { base64: b64, type: "image/jpeg" });
    if (r?.status === "success") photoUrls.push(r.url);
  }

  const payload = {
    id,
    name,
    phone,
    address: document.getElementById("cust-address").value,
    note: document.getElementById("cust-note").value,
    machine: document.getElementById("cust-machine").value,
    filter: document.getElementById("cust-filter").value,
    installDate: document.getElementById("cust-install-date").value,
    photos: photoUrls,
    tags: getSelectedTags("cust-tag-selector"),
  };

  const action = id ? "updateCustomer" : "addCustomer";
  const res = await apiCall(action, payload);

  if (res?.status === "success") {
    closeModal("customer-modal");
    await fetchCustomers();
    if (id) {
      currentCustomer = { ...currentCustomer, ...payload };
      openDetail(currentCustomer);
    }
  } else {
    alert("儲存失敗");
  }
}

/* =========================================================
   刪除客戶
   ========================================================= */
async function deleteCustomer() {
  if (!confirm("確定刪除此客戶？")) return;
  await apiCall("deleteCustomer", { id: currentCustomer.id });
  closeModal("customer-modal");
  goBack();
  fetchCustomers();
}

/* =========================================================
   標籤系統：渲染
   ========================================================= */
function renderTagSelector(containerId, selectedList = []) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  TAG_OPTIONS.forEach((tag) => {
    const div = document.createElement("div");
    div.className = "tag";
    div.dataset.tag = tag;
    div.innerText = tag;

    if (selectedList.includes(tag)) div.classList.add("active");

    div.onclick = () => div.classList.toggle("active");

    container.appendChild(div);
  });
}

/* =========================================================
   取得選中的標籤
   ========================================================= */
function getSelectedTags(containerId) {
  return [...document.querySelectorAll(`#${containerId} .tag.active`)]
    .map((el) => el.dataset.tag)
    .join(",");
}

/* =========================================================
   Modal 關閉
   ========================================================= */
function closeModal(id) {
  document.getElementById(id).classList.add("hidden");
}

/* =========================================================
   Loading
   ========================================================= */
function showLoading(show) {
  document.getElementById("loading").classList.toggle("hidden", !show);
}

</script>
