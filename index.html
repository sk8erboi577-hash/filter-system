<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>æ¿¾èŠ¯ä¿é¤Šç³»çµ±</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/water-filter.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007AFF',
            secondary: '#5856D6',
            success: '#34C759',
            danger: '#FF3B30',
            background: '#F2F2F7',
            card: '#FFFFFF',
            text: '#1C1C1E',
            subtext: '#8E8E93',
            border: '#D1D1D6'
          }
        }
      }
    }
  </script>
    <style>
    /* æ•´é«”æ”¾å¤§ç´„ 1.2 å€ */
    html{
      font-size:20px; /* åŸæœ¬ 18ï¼Œæ•´é«”å†æ”¾å¤§ä¸€é» */
    }

    body{
      background:#F2F2F7;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang TC","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      -webkit-tap-highlight-color:transparent;
      padding-bottom:110px;
      color:#1C1C1E;
    }
    #page-list,#page-detail{min-height:100vh;}

    /* é ‚éƒ¨åˆ— */
    .app-header{
      backdrop-filter:blur(18px);
      background:rgba(249,250,251,0.94);
      border-bottom:1px solid rgba(229,231,235,0.9);
    }
    .app-header h1{
      letter-spacing:0.02em;
      font-size:1.9rem; /* é¡¯ç¤ºæ¨™é¡Œå†æ”¾å¤§ä¸€é»ï¼Œè“‹æ‰ text-2xl */
    }

    /* æœå°‹åˆ— */
    .search-bar{
      background:#FFF;
      border-radius:14px;
      padding:9px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid #E5E7EB;
      box-shadow:0 1px 3px rgba(15,23,42,0.05);
    }
    .search-bar input{
      background:transparent;
      border:none;
      padding:0;
      height:36px;
      font-size:17px;  /* åŸ 15 */
      color:#111827;
      width:100%;
    }
    .search-bar input::placeholder{color:#9CA3AF;}
    .search-bar input:focus{outline:none;box-shadow:none;}

    /* Dashboard å¡ç‰‡ */
    .dashboard-card{
      background:#FFF;
      border-radius:18px;
      padding:18px 18px 16px; /* å¾®æ”¾å¤§ padding */
      box-shadow:0 7px 14px rgba(15,23,42,0.08);
      border:1px solid #E5E7EB;
      color:#111827;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      position:relative;
      overflow:hidden;
      transition:transform .12s;
    }
    .dashboard-card:active{transform:scale(.98);}
    .dashboard-main{flex:1;min-width:0;}
    .dashboard-name{
      font-size:22px;  /* åŸ 19 */
      font-weight:700;
      letter-spacing:.01em;
      margin-bottom:6px;
      color:#111827;
    }
    .dashboard-tag{
      display:inline-flex;
      align-items:center;
      height:26px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid #E5E7EB;
      background:#F3F4F6;
      font-size:14px;   /* åŸ 12 */
      font-weight:500;
      color:#4B5563;
      margin-bottom:8px;
      max-width:100%;
      white-space:nowrap;
    }
    .dashboard-tag-empty{
      border-color:transparent;
      background:transparent;
      color:transparent;
    }
    .dashboard-meta{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:15px;   /* åŸ 13 */
      color:#6B7280;
      flex-wrap:wrap;
    }
    .dashboard-meta span{
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .dashboard-meta .material-icons{font-size:18px;} /* åŸ 16 */
    .dashboard-chevron{
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      width:34px;
      height:34px;
      background:#F3F4F6;
      border:1px solid #E5E7EB;
      flex-shrink:0;
    }
    .dashboard-chevron .material-icons{font-size:19px;color:#9CA3AF;}
    .subtle-text{font-size:14px;color:#9CA3AF;}  /* åŸ 12 */

    /* è¼¸å…¥æ¡† */
    input,textarea,select{
      width:100%;
      padding:14px 14px;
      border:1px solid #D1D5DB;
      border-radius:12px;
      margin-bottom:12px;
      font-size:18px;   /* åŸ 16 */
      background:#F9FAFB;
      color:#111827;
      appearance:none;
      transition:border .2s,box-shadow .2s,background .2s;
    }
    input:focus,textarea:focus,select:focus{
      border-color:#007AFF;
      outline:none;
      box-shadow:0 0 0 3px rgba(0,122,255,.25);
      background:#FFF;
    }
    label{
      font-size:16px;   /* åŸ 13 */
      color:#6B7280;
      margin-bottom:4px;
      display:block;
      font-weight:500;
      letter-spacing:.02em;
    }

    /* ä¸»æŒ‰éˆ• */
    .btn-primary{
      background:linear-gradient(135deg,#0A84FF,#007AFF);
      color:#FFF;
      padding:15px;
      border-radius:16px;
      font-weight:600;
      font-size:19px;  /* åŸ 17 */
      width:100%;
      text-align:center;
      border:none;
      box-shadow:0 12px 24px rgba(37,99,235,.35);
      transition:transform .12s,box-shadow .12s,opacity .12s;
    }
    .btn-primary:active{
      transform:scale(.97) translateY(1px);
      opacity:.9;
      box-shadow:0 8px 16px rgba(37,99,235,.45);
    }

    /* FAB */
    .fab{
      position:fixed;
      right:22px;
      bottom:30px;
      width:70px;
      height:70px;
      border-radius:999px;
      background:linear-gradient(135deg,#0A84FF,#4F46E5);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#FFF;
      box-shadow:0 20px 30px rgba(37,99,235,.55);
      z-index:50;
      transition:transform .1s,box-shadow .1s;
    }
    .fab span.material-icons{font-size:34px;} /* åŸ 30 */
    .fab:active{
      transform:scale(.95) translateY(1px);
      box-shadow:0 12px 22px rgba(37,99,235,.65);
    }

    /* Loading */
    .loading-overlay{
      position:fixed;
      inset:0;
      background:rgba(249,250,251,.86);
      backdrop-filter:blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      flex-direction:column;
      color:#4B5563;
    }

    /* Detail header */
    .detail-header{
      background:rgba(249,250,251,.96);
      box-shadow:0 1px 0 rgba(229,231,235,.9);
    }
    .detail-header h2{
      font-size:1.35rem; /* æ¯” text-lg å†å¤§ä¸€é» */
    }

    /* ç…§ç‰‡å¡ç‰‡ */
    .machine-photo-card{
      background:#FFF;
      margin-top:-36px;
      margin-inline:auto;
      border-radius:22px;
      padding:12px;
      box-shadow:0 14px 28px rgba(15,23,42,.2);
      border:1px solid #E5E7EB;
      max-width:500px;
      position:relative;
      z-index:10;
    }
    #customer-photos-container{
      display:flex;
      gap:10px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      scrollbar-width:none;
    }
    #customer-photos-container::-webkit-scrollbar{display:none;}
    .machine-photo-slide{
      flex:0 0 100%;
      height:220px;
      border-radius:18px;
      overflow:hidden;
      background:#E5E7EB;
      scroll-snap-align:center;
      border:1px solid #E5E7EB;
    }
    .machine-photo-slide img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .machine-photo-empty{
      width:100%;
      height:220px;
      border-radius:18px;
      border:1px dashed #D1D5DB;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9CA3AF;
      font-size:16px; /* åŸ 14 */
      background:#F9FAFB;
    }

    .detail-section{max-width:540px;margin-inline:auto;margin-top:20px;}
    .detail-card{
      background:#FFF;
      border-radius:18px;
      padding:18px 18px 16px;
      margin-bottom:16px;
      border:1px solid #E5E7EB;
      box-shadow:0 5px 12px rgba(15,23,42,.06);
      color:#111827;
    }
    .detail-card h3{
      font-size:15px;  /* åŸ 13 */
      font-weight:700;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:#9CA3AF;
      margin-bottom:10px;
    }
    .detail-row{
      display:flex;
      gap:10px;
      font-size:17px;  /* åŸ 15 */
      padding:6px 0;
      color:#111827;
    }
    .detail-row label{
      font-size:15px;  /* åŸ 13 */
      color:#6B7280;
      margin-bottom:0;
      width:80px;
      flex-shrink:0;
    }
    .detail-note{color:#D97706;}

    /* Timeline */
    .timeline-wrapper{position:relative;padding-left:18px;}
    .timeline-wrapper::before{
      content:"";
      position:absolute;
      left:7px;
      top:8px;
      bottom:8px;
      width:2px;
      background:#E5E7EB;
    }
    .timeline-item{position:relative;margin-bottom:14px;}
    .timeline-dot{
      position:absolute;
      left:2px;
      top:12px;
      width:10px;
      height:10px;
      border-radius:999px;
      border:2px solid #0EA5E9;
      background:#FFF;
      box-shadow:0 0 0 3px rgba(59,130,246,.18);
    }
    .record-card{
      background:#FFF;
      border-radius:16px;
      padding:12px 12px 10px;
      border:1px solid #E5E7EB;
      box-shadow:0 3px 8px rgba(15,23,42,.06);
      color:#111827;
      margin-left:16px;
    }
    .record-card-header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:6px;
    }
    .record-date{
      font-size:16px;  /* åŸ 14 */
      font-weight:600;
      color:#374151;
    }
    .record-amount{
      font-size:16px;  /* åŸ 14 */
      font-weight:600;
      color:#16A34A;
    }
    .record-items{
      font-size:17px;  /* åŸ 15 */
      font-weight:500;
      margin-bottom:4px;
    }
    .record-note{
      font-size:16px;  /* åŸ 13 */
      color:#6B7280;
      background:#F9FAFB;
      border-radius:9px;
      padding:6px 9px;
      margin-bottom:6px;
    }
    .record-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      padding-top:6px;
      border-top:1px solid #E5E7EB;
      margin-top:4px;
      font-size:15px;  /* åŸ 13 */
    }
    .record-actions button{padding:4px 10px;border-radius:999px;}

    /* ç…§ç‰‡ç¸®åœ– */
    .photo-grid{
      display:flex;
      gap:9px;
      overflow-x:auto;
      padding:4px 0;
    }
    .photo-thumb{
      width:90px;
      height:90px;
      object-fit:cover;
      border-radius:11px;
      background:#F3F4F6;
      border:1px solid #E5E7EB;
    }

    /* Bottom sheet */
    .sheet-backdrop{
      background:rgba(17,24,39,.28);
      backdrop-filter:blur(10px);
    }
    .sheet{
      background:#FFF;
      border-radius:20px 20px 0 0;
      border-top:1px solid #E5E7EB;
      box-shadow:0 -14px 32px rgba(15,23,42,.4);
    }
    @media (min-width:640px){
      .sheet{border-radius:20px;max-width:440px;}
      #customer-modal,#record-modal{align-items:center;}
    }
    .sheet-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 16px 9px;
      border-bottom:1px solid #E5E7EB;
      background:#F9FAFB;
    }
    .sheet-grabber{
      width:42px;
      height:4px;
      border-radius:999px;
      background:#D1D5DB;
      margin:5px auto 8px;
    }
    .sheet-title{
      font-size:19px;  /* åŸ 17 */
      font-weight:600;
      color:#111827;
    }
    .sheet-btn-text{
      font-size:18px;  /* åŸ 16 */
      font-weight:500;
      color:#007AFF;
    }
    .sheet-body{
      padding:12px 18px 20px;
      overflow-y:auto;
      background:#F3F4F6;
    }
    .danger-btn{
      width:100%;
      padding:12px 0;
      border-radius:14px;
      background:#FEF2F2;
      color:#DC2626;
      border:1px solid #FECACA;
      font-size:17px; /* åŸ 15 */
      margin-top:4px;
    }
  </style>

</head>
<body>

  <!-- é¦–é  -->
  <div id="page-list">
    <div class="app-header sticky top-0 z-10">
      <div class="pt-10 pb-4 px-4 max-w-md mx-auto">
        <h1 class="text-2xl font-bold text-gray-900 mb-3">æ¿¾èŠ¯ä¿é¤Šç³»çµ±</h1>
        <div class="search-bar">
          <span class="material-icons text-gray-400" style="font-size:21px;">search</span>
          <input id="search-input" type="text" placeholder="æœå°‹å®¢æˆ¶åç¨±ã€é›»è©±æˆ–å‚™è¨»...">
        </div>
      </div>
    </div>

    <div id="customer-list" class="max-w-md mx-auto px-4 pt-4 pb-10">
      <div class="text-center text-gray-400 mt-20 text-sm">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="fab" onclick="showAddCustomerModal()">
      <span class="material-icons">add</span>
    </div>
  </div>

  <!-- è©³ç´°é  -->
  <div id="page-detail" class="hidden min-h-screen">
    <div class="detail-header pt-9 pb-3 px-2 flex items-center sticky top-0 z-20">
      <button onclick="goBack()" class="p-2 flex items-center text-primary">
        <span class="material-icons">arrow_back_ios</span>
        <span class="text-lg ml-1">è¿”å›</span>
      </button>
      <h2 class="text-lg font-semibold flex-1 text-center pr-12 text-gray-900">å®¢æˆ¶è³‡æ–™</h2>
      <button onclick="showEditCustomerModal()" class="font-medium text-lg px-2 text-primary">ç·¨è¼¯</button>
    </div>

    <div class="pb-4 px-4 max-w-md mx-auto">
      <div class="machine-photo-card">
        <div id="customer-photos-container"></div>
      </div>

      <div class="detail-section">
        <div class="detail-card">
          <h3>åŸºæœ¬è³‡æ–™</h3>
          <div class="detail-row">
            <label>å§“å</label>
            <span id="detail-name"></span>
          </div>
          <div class="detail-row">
            <label>é›»è©±</label>
            <span>
              <a id="detail-phone-link" class="inline-flex items-center text-primary text-base font-medium">
                <span class="material-icons mr-1 text-base">phone</span>
                <span id="detail-phone"></span>
              </a>
            </span>
          </div>
          <div class="detail-row">
            <label>å®‰è£æ—¥æœŸ</label>
            <span id="detail-install-date" class="text-gray-400 italic">ç„¡ç´€éŒ„</span>
          </div>
        </div>

        <div class="detail-card">
          <h3>è¨­å‚™è³‡è¨Š</h3>
          <div class="detail-row">
            <label>åœ°å€</label>
            <span id="detail-address"></span>
          </div>
          <div class="detail-row">
            <label>æ©Ÿå™¨</label>
            <span id="detail-machine"></span>
          </div>
          <div class="detail-row">
            <label>æ¿¾èŠ¯</label>
            <span id="detail-filter"></span>
          </div>
          <div id="note-container" class="detail-row hidden">
            <label class="detail-note">å‚™è¨»</label>
            <span id="detail-note" class="detail-note"></span>
          </div>
        </div>

        <div class="detail-card">
          <h3>æ–°å¢ä¿é¤Šç´€éŒ„</h3>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label>æ—¥æœŸ</label>
              <input type="date" id="record-date" class="mb-0 h-10">
            </div>
            <div>
              <label>é‡‘é¡</label>
              <div class="relative">
                <span class="absolute left-3 top-3 text-gray-400 text-sm">NT$</span>
                <input type="number" id="record-amount" class="pl-11 mb-0 h-10 text-green-600 font-bold" placeholder="0">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label>æ›´æ›é …ç›®</label>
            <input id="record-items" type="text" placeholder="ä¾‹å¦‚: PP, æ´»æ€§ç¢³" class="mb-0 h-10 font-medium">
          </div>
          <div class="mb-3">
            <label>å‚™è¨» (é¸å¡«)</label>
            <input id="record-note" type="text" class="mb-0 h-10">
          </div>
          <div class="flex items-center gap-3 mb-3">
            <label class="bg-gray-100 text-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center cursor-pointer active:bg-gray-200">
              <span class="material-icons mr-1 text-lg">camera_alt</span> æ‹ç…§
              <input id="record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)">
            </label>
            <span id="record-photo-count" class="text-xs text-gray-400">0 å¼µ</span>
          </div>
          <div id="new-record-photos" class="photo-grid mb-3"></div>
          <button class="btn-primary" onclick="saveRecord()">å„²å­˜ç´€éŒ„</button>
        </div>

        <div class="mt-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-xs font-bold text-gray-500 tracking-[0.18em] uppercase">æ­·å²ç´€éŒ„</h3>
          </div>
          <div id="record-list" class="timeline-wrapper"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- å®¢æˆ¶ modal -->
  <div id="customer-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
    <div class="sheet w-full max-w-md h-[90vh] overflow-hidden flex flex-col">
      <div class="sheet-grabber"></div>
      <div class="sheet-header">
        <button onclick="closeModal('customer-modal')" class="sheet-btn-text">å–æ¶ˆ</button>
        <h2 id="modal-title" class="sheet-title">æ–°å¢å®¢æˆ¶</h2>
        <button onclick="saveCustomer()" class="sheet-btn-text font-semibold">å„²å­˜</button>
      </div>
      <div class="sheet-body space-y-4">
        <input type="hidden" id="cust-id">
        <div class="space-y-3 bg-white rounded-xl p-3 shadow-sm">
          <div>
            <label>å§“å <span class="text-red-500">*</span></label>
            <input id="cust-name" type="text" class="mb-0">
          </div>
          <div>
            <label>é›»è©± <span class="text-red-500">*</span></label>
            <input id="cust-phone" type="tel" class="mb-0">
          </div>
          <div>
            <label>å®‰è£æ—¥æœŸ</label>
            <input id="cust-install-date" type="date" class="mb-0">
          </div>
        </div>

        <div class="space-y-3 bg-white rounded-xl p-3 shadow-sm">
          <div>
            <label>åœ°å€</label>
            <input id="cust-address" type="text" class="mb-0">
          </div>
          <div>
            <label>æ©Ÿå™¨å‹è™Ÿ</label>
            <input id="cust-machine" type="text" class="mb-0">
          </div>
          <div>
            <label>æ¿¾èŠ¯è¦æ ¼</label>
            <input id="cust-filter" type="text" class="mb-0">
          </div>
        </div>

        <div class="bg-white rounded-xl p-3 shadow-sm">
          <label>å‚™è¨»</label>
          <textarea id="cust-note" rows="2" class="mb-0"></textarea>
        </div>

        <div class="bg-white rounded-xl p-4 shadow-sm text-center">
          <label class="text-primary font-medium flex items-center justify-center cursor-pointer">
            <span class="material-icons mr-2">add_photo_alternate</span> é¸æ“‡æ©Ÿå™¨ç…§ç‰‡
            <input id="cust-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
          </label>
          <div id="cust-photo-preview" class="photo-grid mt-2 justify-center"></div>
        </div>

        <button id="btn-delete-customer" onclick="deleteCustomer()" class="danger-btn hidden">åˆªé™¤æ­¤å®¢æˆ¶</button>
      </div>
    </div>
  </div>

  <!-- ç´€éŒ„ modal -->
  <div id="record-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
    <div class="sheet w-full max-w-md h-auto max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sheet-grabber"></div>
      <div class="sheet-header">
        <button onclick="closeModal('record-modal')" class="sheet-btn-text">å–æ¶ˆ</button>
        <h2 class="sheet-title">ä¿®æ”¹ç´€éŒ„</h2>
        <button onclick="saveEditedRecord()" class="sheet-btn-text font-semibold">å®Œæˆ</button>
      </div>
      <div class="sheet-body space-y-4">
        <input type="hidden" id="edit-record-id">
        <div class="space-y-3 bg-white rounded-xl p-3 shadow-sm">
          <div>
            <label>æ—¥æœŸ</label>
            <input id="edit-record-date" type="date" class="mb-0">
          </div>
          <div>
            <label>é …ç›®</label>
            <input id="edit-record-items" type="text" class="mb-0 font-medium">
          </div>
          <div>
            <label>é‡‘é¡</label>
            <input id="edit-record-amount" type="number" class="mb-0 text-green-600 font-bold">
          </div>
          <div>
            <label>å‚™è¨»</label>
            <textarea id="edit-record-note" rows="2" class="mb-0"></textarea>
          </div>
        </div>

        <div class="bg-white rounded-xl p-3 shadow-sm">
          <label class="text-primary font-medium flex items-center justify-center cursor-pointer">
            <span class="material-icons mr-2">add_a_photo</span> åŠ å‚³ç…§ç‰‡
            <input id="edit-record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
          </label>
          <div id="edit-record-photo-preview" class="photo-grid mt-2 justify-center"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading-overlay hidden">
    <div class="animate-spin rounded-full h-9 w-9 border-4 border-gray-200 border-t-primary mb-3"></div>
    <p class="text-gray-600 font-medium text-sm">è™•ç†ä¸­...</p>
  </div>

  <script>
    // âš ï¸ è¨˜å¾—æ›æˆä½ çš„ API URL
    const API_URL = "https://script.google.com/macros/s/AKfycbzGwCR8SaiLE99cDt0I7wXBzIadQgOUFhOMXmRQaJsqksuvswo3f-UgQD0RWG8dJOEu/exec";

    let customers = [];
    let currentCustomer = null;
    let selectedRecordPhotos = [];
    let selectedCustPhotos = [];
    let selectedEditRecordPhotos = [];
    window.currentRecords = [];

    // çµ±ä¸€è™•ç†æ—¥æœŸå­—ä¸²ï¼šæ”¯æ´ "2025-02-01", "2025-01-31T16:00:00.000Z", "Sat Feb 01 2025 ..."
    function normalizeDateStr(value){
      if (!value) return '';
      const str = String(value);
      // è‹¥æœ‰ T æˆ– GMTï¼Œå…ˆç”¨ Date è§£ææˆã€Œç•¶åœ°æ™‚é–“ã€ï¼Œå†çµ„ yyyy-mm-dd
    // è‹¥å·²æ˜¯ yyyy-mm-ddï¼Œä¸å†è§£æï¼ˆé¿å…æ‰£ä¸€å¤©ï¼‰
if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
  return str;
}

// è‹¥æ ¼å¼å«æ™‚é–“ä½†å¯è§£æ â†’ ç”¨æœ¬åœ°æ™‚é–“æ ¼å¼åŒ–
if (str.includes('T') || str.includes('GMT')) {
  const d = new Date(str);
  if (!isNaN(d.getTime())) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }
}

      // å…¶ä»–æƒ…æ³ï¼šåªå–ç¬¬ä¸€æ®µï¼ˆé¿å…å¾Œé¢æœ‰æ™‚é–“ï¼‰
      return str.split(/[ T]/)[0];
    }

    window.onload = () => {
      fetchCustomers();
      const rd = document.getElementById('record-date');
      if (rd) rd.valueAsDate = new Date();
    };

    async function apiCall(action, payload = {}, method = 'POST') {
      showLoading(true);
      try {
        if (payload.phone) payload.phone = String(payload.phone);
        const url = method === 'GET'
          ? `${API_URL}?${new URLSearchParams({ action, ...payload })}`
          : API_URL;
        const options = method === 'GET'
          ? {}
          : { method: 'POST', body: JSON.stringify({ action, ...payload }) };
        const res = await fetch(url, options);
        return await res.json();
      } catch (e) {
        alert("é€£ç·šéŒ¯èª¤");
        return null;
      } finally {
        showLoading(false);
      }
    }

async function fetchCustomers() {
  const data = await apiCall('getCustomers', {}, 'GET');
  if (!Array.isArray(data)) {
    document.getElementById('customer-list').innerHTML =
      '<div class="text-center text-gray-400 mt-20 text-sm">è®€å–å¤±æ•—</div>';
    return;
  }

  customers = data;

  // ğŸ”¥ ä¸€é€²å…¥ç³»çµ±å°±æŠ“å‡ºæ‰€æœ‰å®¢æˆ¶çš„æœ€æ–°ä¿é¤Šç´€éŒ„ï¼ˆä½ è¦çš„åŠŸèƒ½ï¼‰
  for (let cust of customers) {
    const records = await apiCall('getRecords', { customerId: cust.id }, 'GET');

    if (Array.isArray(records) && records.length > 0) {
      // å–æœ€å¾Œä¸€ç­†ç´€éŒ„ï¼ˆæœ€æ–°ï¼‰
      const last = records[records.length - 1];
      cust.lastRecordDate = last.date ? normalizeDateStr(last.date) : '';
    } else {
      cust.lastRecordDate = ''; // æ²’ç´€éŒ„
    }
  }

  renderList(customers);
}



    function renderList(list) {
      const container = document.getElementById('customer-list');
      container.innerHTML = '';
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 mt-20 text-sm">æš«ç„¡è³‡æ–™</div>';
        return;
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'max-w-md mx-auto px-1 pt-2 space-y-3 pb-6';

      list.forEach(c => {
        const card = document.createElement('div');
        card.className = 'dashboard-card cursor-pointer';
        card.onclick = () => openDetail(c);

        const tagClass = (c.machine && String(c.machine).trim())
          ? 'dashboard-tag'
          : 'dashboard-tag dashboard-tag-empty';

        const lastText = c.lastRecordDate
          ? normalizeDateStr(c.lastRecordDate)
          : 'å°šç„¡ä¿é¤Šç´€éŒ„';

        card.innerHTML = `
          <div class="dashboard-main">
            <div class="dashboard-name truncate">${c.name || 'æœªå‘½åå®¢æˆ¶'}</div>
            <div class="${tagClass}">
              ${c.machine ? c.machine : 'ã€€'}
            </div>
            <div class="dashboard-meta">
              <span><span class="material-icons">phone_iphone</span>${c.phone || 'ç„¡é›»è©±'}</span>
              <span><span class="material-icons">history</span>${lastText}</span>
            </div>
            ${c.note ? `<div class="subtle-text mt-1 line-clamp-1">å‚™è¨»ï¼š${c.note}</div>` : ''}
          </div>
          <div class="dashboard-chevron">
            <span class="material-icons">arrow_forward_ios</span>
          </div>
        `;
        wrapper.appendChild(card);
      });

      container.appendChild(wrapper);
    }

    document.getElementById('search-input').addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      renderList(customers.filter(c =>
        (c.name && c.name.toLowerCase().includes(term)) ||
        (c.phone && String(c.phone).includes(term)) ||
        (c.note && c.note.toLowerCase().includes(term))
      ));
    });

    async function openDetail(customer) {
      currentCustomer = customer;
      document.getElementById('page-list').classList.add('hidden');
      document.getElementById('page-detail').classList.remove('hidden');
      window.scrollTo(0, 0);

      document.getElementById('detail-name').innerText = customer.name || '';
      document.getElementById('detail-phone').innerText = customer.phone || '';
      document.getElementById('detail-phone-link').href = customer.phone ? `tel:${customer.phone}` : 'javascript:void(0)';

      const dateEl = document.getElementById('detail-install-date');
      if (customer.installDate) {
        dateEl.textContent = normalizeDateStr(customer.installDate);
        dateEl.classList.remove('text-gray-400','italic');
      } else {
        dateEl.textContent = 'ç„¡ç´€éŒ„';
        dateEl.classList.add('text-gray-400','italic');
      }

      setText('detail-address', customer.address);
      setText('detail-machine', customer.machine);
      setText('detail-filter', customer.filter);

      const noteContainer = document.getElementById('note-container');
      if (customer.note) {
        document.getElementById('detail-note').innerText = customer.note;
        noteContainer.classList.remove('hidden');
      } else {
        noteContainer.classList.add('hidden');
      }

      // ç…§ç‰‡
      const photoContainer = document.getElementById('customer-photos-container');
      photoContainer.innerHTML = '';
      let photos = [];
      if (customer.photos && Array.isArray(customer.photos)) photos = customer.photos;
      else if (customer.photos && typeof customer.photos === 'string') {
        if (customer.photos.startsWith('[')) {
          try { photos = JSON.parse(customer.photos); } catch (e) { photos = [customer.photos]; }
        } else {
          photos = [customer.photos];
        }
      }

      if (photos.length > 0) {
        photos.forEach(url => {
          const slide = document.createElement('div');
          slide.className = 'machine-photo-slide cursor-pointer';
          slide.innerHTML = `<img src="${url}" alt="æ©Ÿå™¨ç…§ç‰‡">`;
          slide.onclick = () => window.open(url, '_blank');
          photoContainer.appendChild(slide);
        });
      } else {
        const empty = document.createElement('div');
        empty.className = 'machine-photo-empty';
        empty.innerText = 'ç„¡æ©Ÿå™¨ç…§ç‰‡';
        photoContainer.appendChild(empty);
      }

      await fetchRecords(customer.id);
      renderList(customers);
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (!value) {
        el.innerText = 'æœªå¡«å¯«';
        el.classList.add('text-gray-400','italic');
      } else {
        el.innerText = value;
        el.classList.remove('text-gray-400','italic');
      }
    }

    function goBack() {
      document.getElementById('page-detail').classList.add('hidden');
      document.getElementById('page-list').classList.remove('hidden');
      currentCustomer = null;
      selectedRecordPhotos = [];
      renderRecordPhotoPreview();
    }

    async function fetchRecords(custId) {
      const listDiv = document.getElementById('record-list');
      listDiv.innerHTML = '<div class="text-center py-4 text-sm text-gray-400">è®€å–ä¸­...</div>';

      const records = await apiCall('getRecords', { customerId: custId }, 'GET');
      listDiv.innerHTML = '';

      if (!records || records.length === 0) {
        listDiv.innerHTML = '<div class="text-center py-6 text-gray-400 text-sm">å°šç„¡ç´€éŒ„</div>';
        if (currentCustomer) currentCustomer.lastRecordDate = '';
        window.currentRecords = [];
        return;
      }

      records.sort((a, b) => new Date(a.date) - new Date(b.date)); // å…ˆå¾èˆŠåˆ°æ–°
      window.currentRecords = records;

      // æ›´æ–° currentCustomer çš„ lastRecordDateï¼ˆå–æœ€å¾Œä¸€ç­†ï¼‰
      const last = records[records.length - 1];
      if (currentCustomer && last && last.date) {
        currentCustomer.lastRecordDate = normalizeDateStr(last.date);
      }
// ğŸ”¥ åŒæ­¥æ›´æ–° customers[] è£¡çš„å°æ‡‰å®¢æˆ¶è³‡æ–™
const idx = customers.findIndex(c => c.id == currentCustomer.id);
if (idx !== -1) {
  customers[idx].lastRecordDate = currentCustomer.lastRecordDate;
}
      // å†ç”±æ–°åˆ°èˆŠç•« timelineï¼Œæ¯”è¼ƒé †çœ¼
      records.slice().reverse().forEach(r => {
        let photos = [];
        if (r.photos) {
          if (Array.isArray(r.photos)) photos = r.photos;
          else {
            try { photos = JSON.parse(r.photos); } catch (e) { photos = []; }
          }
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'timeline-item';

        const dot = document.createElement('div');
        dot.className = 'timeline-dot';

        const card = document.createElement('div');
        card.className = 'record-card';

        const dateStr = r.date ? normalizeDateStr(r.date) : '';

        card.innerHTML = `
          <div class="record-card-header">
            <div class="record-date">${dateStr}</div>
            ${r.amount ? `<div class="record-amount">NT$${r.amount}</div>` : ''}
          </div>
          <div class="record-items">${r.items || ''}</div>
          ${r.note ? `<div class="record-note">å‚™è¨»ï¼š${r.note}</div>` : ''}
          ${photos.length > 0 ? `
            <div class="photo-grid mb-1">
              ${photos.map(url => `
                <img src="${url}" class="photo-thumb cursor-pointer" onclick="window.open('${url}','_blank')">
              `).join('')}
            </div>
          ` : ''}
          <div class="record-actions">
            <button class="text-primary hover:bg-gray-100" onclick="openEditRecordModal('${r.id}')">ç·¨è¼¯</button>
            <button class="text-red-500 hover:bg-red-50" onclick="deleteRecord('${r.id}')">åˆªé™¤</button>
          </div>
        `;

        wrapper.appendChild(dot);
        wrapper.appendChild(card);
        listDiv.appendChild(wrapper);
      });
    }

    function openEditRecordModal(recordId) {
      const record = window.currentRecords.find(r => String(r.id) === String(recordId));
      if (!record) {
        alert('æ‰¾ä¸åˆ°ç´€éŒ„');
        return;
      }

      document.getElementById('edit-record-id').value = record.id || '';
      document.getElementById('edit-record-date').value =
        record.date ? normalizeDateStr(record.date) : '';
      document.getElementById('edit-record-items').value = record.items || '';
      document.getElementById('edit-record-amount').value = record.amount || '';
      document.getElementById('edit-record-note').value = record.note || '';

      selectedEditRecordPhotos = [];
      document.getElementById('edit-record-photo-preview').innerHTML = '';

      document.getElementById('record-modal').classList.remove('hidden');
    }

    async function saveEditedRecord() {
      const id = document.getElementById('edit-record-id').value;
      const items = document.getElementById('edit-record-items').value.trim();
      if (!items) {
        alert('è«‹è¼¸å…¥é …ç›®');
        return;
      }

      let photoUrls = [];
      if (selectedEditRecordPhotos.length > 0) {
        for (let base64 of selectedEditRecordPhotos) {
          const res = await apiCall('uploadImage', { base64, type: 'image/jpeg' });
          if (res && res.status === 'success') photoUrls.push(res.url);
        }
      }

      const payload = {
        id,
        date: document.getElementById('edit-record-date').value,
        items,
        amount: document.getElementById('edit-record-amount').value,
        note: document.getElementById('edit-record-note').value,
        photos: photoUrls
      };

      const res = await apiCall('updateRecord', payload);
      if (res && res.status === 'success') {
        closeModal('record-modal');
        if (currentCustomer) {
          await fetchRecords(currentCustomer.id);
          renderList(customers);
        }
      } else {
        alert('æ›´æ–°å¤±æ•—');
      }
    }

    function handleEditRecordPhotoSelect(input) {
      const files = input.files;
      if (!files.length) return;
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 1024, res => {
          selectedEditRecordPhotos.push(res);
          renderPhotoList('edit-record-photo-preview', selectedEditRecordPhotos);
        });
        reader.readAsDataURL(file);
      });
      input.value = '';
    }

    async function saveRecord() {
      if (!currentCustomer) return;
      const items = document.getElementById('record-items').value.trim();
      if (!items) {
        alert('è«‹è¼¸å…¥é …ç›®');
        return;
      }

      let photoUrls = [];
      if (selectedRecordPhotos.length > 0) {
        for (let base64 of selectedRecordPhotos) {
          const res = await apiCall('uploadImage', { base64, type: 'image/jpeg' });
          if (res && res.status === 'success') photoUrls.push(res.url);
        }
      }

      const payload = {
        customerId: currentCustomer.id,
        date: document.getElementById('record-date').value,
        items,
        amount: document.getElementById('record-amount').value,
        note: document.getElementById('record-note').value,
        photos: photoUrls
      };

      const res = await apiCall('addRecord', payload);
      if (res && res.status === 'success') {
        document.getElementById('record-items').value = '';
        document.getElementById('record-amount').value = '';
        document.getElementById('record-note').value = '';
        selectedRecordPhotos = [];
        renderRecordPhotoPreview();
        await fetchRecords(currentCustomer.id);
        renderList(customers);
      } else {
        alert('æ–°å¢å¤±æ•—');
      }
    }

    async function deleteRecord(id) {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) return;
      await apiCall('deleteRecord', { id });
      if (currentCustomer) {
        await fetchRecords(currentCustomer.id);
        renderList(customers);
      }
    }

    function resizeImage(base64, maxWidth, callback) {
      const img = new Image();
      img.src = base64;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        callback(canvas.toDataURL('image/jpeg', 0.8));
      };
    }

    function handleRecordPhotoSelect(input) {
      const files = input.files;
      if (!files.length) return;
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 1024, res => {
          selectedRecordPhotos.push(res);
          renderRecordPhotoPreview();
        });
        reader.readAsDataURL(file);
      });
      input.value = '';
    }

    function renderRecordPhotoPreview() {
      renderPhotoList('new-record-photos', selectedRecordPhotos);
      document.getElementById('record-photo-count').innerText =
        `${selectedRecordPhotos.length} å¼µ`;
    }

    function handleCustPhotoSelect(input) {
      const files = input.files;
      if (!files.length) return;
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 1024, res => {
          selectedCustPhotos.push(res);
          renderPhotoList('cust-photo-preview', selectedCustPhotos);
        });
        reader.readAsDataURL(file);
      });
      input.value = '';
    }

    function renderPhotoList(divId, arr) {
      const div = document.getElementById(divId);
      div.innerHTML = arr.map((src, idx) => `
        <div class="relative flex-shrink-0">
          <img src="${src}" class="photo-thumb">
          <button class="absolute -top-1 -right-1 bg-gray-700 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"
            onclick="removePhoto('${divId}', ${idx})">Ã—</button>
        </div>
      `).join('');
    }

    function removePhoto(divId, idx) {
      if (divId === 'new-record-photos') {
        selectedRecordPhotos.splice(idx, 1);
        renderRecordPhotoPreview();
      } else if (divId === 'cust-photo-preview') {
        selectedCustPhotos.splice(idx, 1);
        renderPhotoList('cust-photo-preview', selectedCustPhotos);
      } else if (divId === 'edit-record-photo-preview') {
        selectedEditRecordPhotos.splice(idx, 1);
        renderPhotoList('edit-record-photo-preview', selectedEditRecordPhotos);
      }
    }

    function showAddCustomerModal() {
      document.getElementById('modal-title').innerText = 'æ–°å¢å®¢æˆ¶';
      document.getElementById('cust-id').value = '';
      document.getElementById('cust-name').value = '';
      document.getElementById('cust-phone').value = '';
      document.getElementById('cust-address').value = '';
      document.getElementById('cust-note').value = '';
      document.getElementById('cust-machine').value = '';
      document.getElementById('cust-filter').value = '';
const d = new Date();
const y = d.getFullYear();
const m = String(d.getMonth() + 1).padStart(2, '0');
const day = String(d.getDate()).padStart(2, '0');
document.getElementById('cust-install-date').value = `${y}-${m}-${day}`;

      selectedCustPhotos = [];
      renderPhotoList('cust-photo-preview', []);
      document.getElementById('btn-delete-customer').classList.add('hidden');
      document.getElementById('customer-modal').classList.remove('hidden');
    }

    function showEditCustomerModal() {
      if (!currentCustomer) return;
      document.getElementById('modal-title').innerText = 'ç·¨è¼¯è³‡æ–™';
      document.getElementById('cust-id').value = currentCustomer.id;
      document.getElementById('cust-name').value = currentCustomer.name || '';
      document.getElementById('cust-phone').value = currentCustomer.phone || '';
      document.getElementById('cust-address').value = currentCustomer.address || '';
      document.getElementById('cust-note').value = currentCustomer.note || '';
      document.getElementById('cust-machine').value = currentCustomer.machine || '';
      document.getElementById('cust-filter').value = currentCustomer.filter || '';
      document.getElementById('cust-install-date').value =
        currentCustomer.installDate ? normalizeDateStr(currentCustomer.installDate) : '';
      selectedCustPhotos = [];
      renderPhotoList('cust-photo-preview', []);
      document.getElementById('btn-delete-customer').classList.remove('hidden');
      document.getElementById('customer-modal').classList.remove('hidden');
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    async function saveCustomer() {
      const id = document.getElementById('cust-id').value;
      const name = document.getElementById('cust-name').value.trim();
      const phone = document.getElementById('cust-phone').value.trim();
      if (!name || !phone) {
        alert('å§“åã€é›»è©±å¿…å¡«');
        return;
      }

      let photoUrls = [];
      if (id && currentCustomer && currentCustomer.photos) {
        if (Array.isArray(currentCustomer.photos)) photoUrls = [...currentCustomer.photos];
        else {
          try { photoUrls = JSON.parse(currentCustomer.photos); }
          catch (e) { photoUrls = [currentCustomer.photos]; }
        }
      }
      if (selectedCustPhotos.length > 0) {
        for (let base64 of selectedCustPhotos) {
          const res = await apiCall('uploadImage', { base64, type: 'image/jpeg' });
          if (res && res.status === 'success') photoUrls.push(res.url);
        }
      }

      const payload = {
        id,
        name,
        phone,
        address: document.getElementById('cust-address').value,
        note: document.getElementById('cust-note').value,
        machine: document.getElementById('cust-machine').value,
        filter: document.getElementById('cust-filter').value,
        installDate: document.getElementById('cust-install-date').value,
        photos: photoUrls
      };

      const action = id ? 'updateCustomer' : 'addCustomer';
      const res = await apiCall(action, payload);
      if (res && res.status === 'success') {
        closeModal('customer-modal');
        await fetchCustomers();
        if (id && currentCustomer) {
          currentCustomer = { ...currentCustomer, ...payload };
          openDetail(currentCustomer);
        }
      } else {
        alert('å„²å­˜å¤±æ•—');
      }
    }

    async function deleteCustomer() {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å®¢æˆ¶ï¼Ÿ')) return;
      await apiCall('deleteCustomer', { id: document.getElementById('cust-id').value });
      closeModal('customer-modal');
      goBack();
      fetchCustomers();
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    document.getElementById('customer-modal').addEventListener('click', e => {
      if (e.target.id === 'customer-modal') closeModal('customer-modal');
    });
    document.getElementById('record-modal').addEventListener('click', e => {
      if (e.target.id === 'record-modal') closeModal('record-modal');
    });
  </script>
</body>
</html>




