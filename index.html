<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>æ¿¾èŠ¯ä¿é¤Šç³»çµ±</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --primary: #007AFF;
      --primary-light: #64A8FF;
      --milk-bg: #F5EFE7;
      --milk-card: #FFFFFF;
      --milk-border: #E6E2DA;
      --milk-input: #F9F7F2;
      --text-main: #3A342E;
      --text-secondary: #6E655C;
    }

    html { font-size: 18px; }
    body {
      background: var(--milk-bg);
      margin: 0;
      padding-bottom: 100px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC",
        Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-main);
    }

    /* iOS Navigation Bar */
    .ios-nav-bar {
      position: sticky; top: 0; padding: 12px 16px; padding-top: env(safe-area-inset-top, 16px);
      background: rgba(255,255,255,0.95); backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--milk-border); z-index: 50;
      display:flex; justify-content:space-between; align-items:center;
    }
    .ios-nav-left, .ios-nav-right { display:flex; align-items:center; color:var(--primary); font-size:17px; gap:4px; cursor:pointer; font-weight: 500; }
    .ios-nav-title { font-size:18px; font-weight:700; color:var(--text-main); }

    /* æœå°‹åˆ— */
    .search-bar {
      background: #FFF; border-radius: 14px; padding: 12px; display:flex; align-items:center; gap:8px; border:1px solid var(--milk-border);
    }
    .search-bar input { width:100%; border:none; background:transparent; font-size:18px; outline:none; }

    /* ç¯©é¸å™¨ */
    .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; margin-top: 12px; -webkit-overflow-scrolling: touch; }
    .filter-scroll::-webkit-scrollbar { display: none; }
    .filter-chip {
      padding: 8px 16px; background: #EFEDE7; border: 1px solid var(--milk-border);
      border-radius: 20px; font-size: 15px; color: var(--text-secondary);
      white-space: nowrap; cursor: pointer; transition: all 0.2s;
    }
    .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }

    /* å¡ç‰‡é€šç”¨ */
    .card {
      background: var(--milk-card); border-radius: 18px; border:1px solid var(--milk-border);
      padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    /* é¦–é åˆ—è¡¨å¡ç‰‡ */
    .dashboard-card {
      background: var(--milk-card); border-radius: 18px; border:1px solid var(--milk-border);
      padding: 18px 16px; display:flex; justify-content:space-between; align-items:center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04); cursor:pointer; transition:.12s; margin-bottom: 12px;
    }
    .dashboard-card:active { transform:scale(.98); background-color: #FAFAFA; }
    .dashboard-name { font-size: 22px; font-weight: 700; color: #333; margin-bottom: 4px; }
    .dashboard-tag { display:inline-flex; padding: 4px 10px; background: #EFEDE7; border-radius: 99px; font-size: 13px; color: #666; margin-right: 6px; }
    .dashboard-chevron { color: #CCC; }

    /* Timeline */
    .timeline-item { position:relative; margin-bottom: 24px; padding-left: 24px; }
    .timeline-item::before { content:""; position:absolute; left: 10px; top:0; bottom:-10px; width: 2px; background: var(--milk-border); }
    .timeline-dot { position:absolute; left: 5px; top: 10px; width: 12px; height: 12px; background: white; border: 3px solid var(--primary); border-radius: 50%; }

    /* è¼¸å…¥æ¡† */
    input, textarea, select {
        width: 100%; padding: 16px; border: 1px solid #CCC; border-radius: 12px;
        font-size: 18px; background-color: #FAFAFA; margin-top: 6px; margin-bottom: 16px;
        -webkit-appearance: none; appearance: none;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--primary); background-color: #FFF; outline: none; box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
    label { font-size: 15px; font-weight: 600; color: #666; margin-left: 4px; }

    /* å¿«é€ŸæŒ‰éˆ• */
    .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; margin-top: -8px; }
    .item-chip {
        padding: 8px 14px; background-color: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB;
        border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer;
    }
    .item-chip:active { background-color: #2196F3; color: white; }

    /* é‡‘é¡è¼¸å…¥æ¡†ä¿®æ­£ */
    .currency-wrap { position: relative; }
    .currency-symbol { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); margin-top: -5px; font-size: 18px; font-weight: bold; color: #888; pointer-events: none; }
    .currency-input { padding-left: 60px !important; color: #16a34a; font-weight: bold; font-size: 20px; }

    /* æŒ‰éˆ• */
    .btn-primary {
        background-color: var(--primary); color: white; padding: 16px; border-radius: 14px;
        font-size: 18px; font-weight: 700; width: 100%; display: block; text-align: center;
        box-shadow: 0 4px 10px rgba(0,122,255,0.3);
    }
    .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
    .btn-danger {
        background-color: #FEF2F2; color: #EF4444; border: 1px solid #FECACA;
        padding: 14px; border-radius: 14px; font-size: 16px; font-weight: 600; width: 100%; margin-top: 20px;
    }

    /* Modal */
    .sheet-backdrop { background: rgba(0,0,0,0.5); backdrop-filter:blur(3px); position: fixed; inset: 0; z-index: 100; display: flex; justify-content: center; align-items: flex-end; }
    .sheet { background: #FFF; width: 100%; max-width: 600px; height: 90vh; border-radius: 24px 24px 0 0; display: flex; flex-direction: column; overflow: hidden; }
    .sheet-header { padding: 16px 20px; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; align-items: center; background: #FFF; }
    .sheet-body { padding: 20px; overflow-y: auto; background: #F9FAFB; flex: 1; }

    /* ç…§ç‰‡ */
    .photo-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px; }
    .photo-thumb { width: 90px; height: 90px; border-radius: 12px; object-fit: cover; border: 1px solid #EEE; }

    .loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.8); backdrop-filter:blur(5px); display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:999; }
    .hidden { display: none !important; }
    
    .toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 17px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
    .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
  </style>
</head>

<body>

<div id="page-list" class="min-h-screen">
  <div class="pt-10 pb-4 px-4 max-w-md mx-auto bg-white/80 sticky top-0 z-10 backdrop-blur-md border-b border-gray-100">
    <div class="flex justify-between items-center mb-4">
        <div class="text-3xl font-bold text-gray-800 tracking-tight">æ¿¾èŠ¯ä¿é¤Šç³»çµ±</div>
        <button onclick="fetchCustomers()" class="w-10 h-10 bg-white rounded-full shadow-sm border border-gray-100 flex items-center justify-center text-blue-600 active:scale-90 active:bg-blue-50 transition-all">
          <span class="material-icons">refresh</span>
        </button>
    </div>
    <div class="search-bar">
      <span class="material-icons text-gray-400">search</span>
      <input id="search-input" type="text" placeholder="æœå°‹å®¢æˆ¶åç¨±ã€é›»è©±æˆ–å‚™è¨»â€¦">
    </div>
    <div id="filter-container" class="filter-scroll"></div>
  </div>

  <div id="customer-list" class="max-w-md mx-auto px-4 pt-4 pb-24">
    <div class="text-center text-gray-400 mt-20">è¼‰å…¥ä¸­â€¦</div>
  </div>

  <div class="fixed right-6 bottom-8 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-xl text-4xl cursor-pointer z-40 active:scale-90 transition-transform" onclick="showAddCustomerModal()">
    <span class="material-icons" style="font-size: 32px;">add</span>
  </div>
</div>

<div id="page-detail" class="hidden min-h-screen bg-gray-50">
  <div class="ios-nav-bar">
    <div class="ios-nav-left" onclick="goBack()"><span class="material-icons">arrow_back_ios</span>è¿”å›</div>
    <div class="ios-nav-title">å®¢æˆ¶è³‡æ–™</div>
    <div class="ios-nav-right" onclick="showEditCustomerModal()">ç·¨è¼¯</div>
  </div>

  <div class="pb-8 px-4 max-w-md mx-auto pt-4">
    
    <div class="card relative overflow-hidden">
        <div class="flex justify-between items-start">
            <div>
                <h2 id="detail-name" class="text-3xl font-bold text-gray-900 mb-1"></h2>
                <div id="detail-tags-display" class="flex gap-2 mb-3 flex-wrap"></div>
            </div>
            <a id="detail-phone-link" class="bg-green-100 text-green-700 p-3 rounded-full">
                <span class="material-icons">call</span>
            </a>
        </div>
        
        <div class="space-y-3 mt-2">
            <div class="flex border-b border-gray-100 pb-2">
                <span class="text-gray-500 w-24 flex-shrink-0">é›»è©±</span>
                <span id="detail-phone" class="font-mono text-lg font-medium text-gray-800"></span>
            </div>
            <div class="flex border-b border-gray-100 pb-2 items-center justify-between">
                <div class="flex">
                    <span class="text-gray-500 w-24 flex-shrink-0">åœ°å€</span>
                    <span id="detail-address" class="text-gray-800"></span>
                </div>
                <a id="detail-map-link" target="_blank" class="hidden text-blue-600 bg-blue-50 px-3 py-1 rounded-lg text-sm font-bold flex items-center">
                    <span class="material-icons text-base mr-1">near_me</span>å°èˆª
                </a>
            </div>
            <div class="flex border-b border-gray-100 pb-2">
                <span class="text-gray-500 w-24 flex-shrink-0">æ©Ÿå™¨</span>
                <span id="detail-machine" class="text-gray-800"></span>
            </div>
            <div class="flex border-b border-gray-100 pb-2">
                <span class="text-gray-500 w-24 flex-shrink-0">æ¿¾èŠ¯</span>
                <span id="detail-filter" class="text-gray-800"></span>
            </div>
            <div class="flex border-b border-gray-100 pb-2">
                <span class="text-gray-500 w-24 flex-shrink-0">é€±æœŸ</span>
                <span id="detail-cycle" class="text-blue-600 font-bold"></span>
            </div>
            <div id="note-container" class="hidden bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                <div class="text-yellow-700 text-xs font-bold mb-1">å‚™è¨»</div>
                <div id="detail-note" class="text-gray-800"></div>
            </div>
        </div>

        <div class="mt-4">
            <div class="text-xs text-gray-400 font-bold mb-2">æ©Ÿå™¨ç…§ç‰‡</div>
            <div id="customer-photos-container" class="flex gap-3 overflow-x-auto"></div>
        </div>
    </div>

    <div class="card border-2 border-blue-100 bg-blue-50/50">
        <h3 class="font-bold text-lg text-blue-800 mb-4 flex items-center">
            <span class="material-icons mr-2">post_add</span>æ–°å¢ä¿é¤Šç´€éŒ„
        </h3>
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label>æ—¥æœŸ</label>
                <input type="date" id="record-date">
            </div>
            <div>
                <label>é‡‘é¡</label>
                <div class="currency-wrap">
                    <span class="currency-symbol">NT$</span>
                    <input type="number" id="record-amount" class="currency-input" placeholder="0">
                </div>
            </div>
        </div>

        <label>æ›´æ›é …ç›®</label>
        <input type="text" id="record-items" placeholder="ä¾‹å¦‚: PP, æ´»æ€§ç¢³">
        <div id="new-record-item-chips" class="chip-container"></div>

        <label>å‚™è¨»</label>
        <input type="text" id="record-note" placeholder="é¸å¡«">

        <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-gray-200 mt-2 mb-4">
            <label class="flex items-center text-blue-600 font-bold cursor-pointer">
                <span class="material-icons mr-2 text-2xl">camera_alt</span> æ‹ç…§
                <input type="file" id="record-photo-input" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)">
            </label>
            <span id="record-photo-count" class="text-sm text-gray-400">0 å¼µ</span>
        </div>
        <div id="new-record-photos" class="photo-grid mb-4"></div>

        <button onclick="saveRecord()" class="btn-primary shadow-lg">ç¢ºèªå„²å­˜ç´€éŒ„</button>
    </div>

    <h3 class="font-bold text-gray-500 text-sm ml-1 mb-3 mt-6">æ­·å²ä¿é¤Šç´€éŒ„</h3>
    <div id="record-list"></div>

  </div>
</div>

<div id="customer-modal" class="sheet-backdrop hidden">
  <div class="sheet">
    <div class="sheet-header">
      <button onclick="closeModal('customer-modal')" class="text-gray-500 text-lg">å–æ¶ˆ</button>
      <h2 id="modal-title" class="text-lg font-bold">æ–°å¢å®¢æˆ¶</h2>
      <button onclick="saveCustomer()" class="text-blue-600 font-bold text-lg">å„²å­˜</button>
    </div>
    <div class="sheet-body">
      <input type="hidden" id="cust-id">
      
      <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100">
          <label>å§“å <span class="text-red-500">*</span></label>
          <input type="text" id="cust-name">
          
          <label>é›»è©± <span class="text-red-500">*</span></label>
          <input type="tel" id="cust-phone" class="font-mono text-xl">
          
          <label>åˆ†é¡æ¨™ç±¤</label>
          <div id="cust-tag-selector" class="tag-selector mb-4"></div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100">
          <label>ä¿é¤Šé€±æœŸ</label>
          <select id="cust-cycle">
              <option value="">æœªè¨­å®š</option>
              <option value="3">3 å€‹æœˆ</option>
              <option value="6">6 å€‹æœˆ</option>
              <option value="9">9 å€‹æœˆ</option>
              <option value="12">1 å¹´</option>
              <option value="24">2 å¹´</option>
          </select>
          
          <label>å®‰è£æ—¥æœŸ</label>
          <input type="date" id="cust-install-date">

          <label>åœ°å€</label>
          <textarea id="cust-address" rows="2"></textarea>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100">
          <label>æ©Ÿå™¨å‹è™Ÿ</label>
          <input type="text" id="cust-machine">
          <label>æ¿¾èŠ¯è¦æ ¼</label>
          <input type="text" id="cust-filter">
          <label>å‚™è¨»</label>
          <textarea id="cust-note" rows="2"></textarea>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100 text-center">
          <label class="text-blue-600 font-bold flex items-center justify-center cursor-pointer p-4 border-2 border-dashed border-blue-100 rounded-xl">
              <span class="material-icons mr-2">add_photo_alternate</span> ä¸Šå‚³æ©Ÿå™¨ç…§ç‰‡
              <input type="file" id="cust-photo-input" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
          </label>
          <div id="cust-photo-preview" class="photo-grid mt-4 justify-center"></div>
      </div>
      
      <button id="btn-delete-customer" onclick="deleteCustomer()" class="btn-danger hidden">åˆªé™¤æ­¤å®¢æˆ¶</button>
      <div class="h-20"></div>
    </div>
  </div>
</div>

<div id="record-modal" class="sheet-backdrop hidden">
  <div class="sheet">
    <div class="sheet-header">
      <button onclick="closeModal('record-modal')" class="text-gray-500 text-lg">å–æ¶ˆ</button>
      <h2 class="text-lg font-bold">ä¿®æ”¹ç´€éŒ„</h2>
      <button onclick="saveEditedRecord()" class="text-blue-600 font-bold text-lg">å®Œæˆ</button>
    </div>
    <div class="sheet-body">
      <input type="hidden" id="edit-record-id">
      
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
          <label>æ—¥æœŸ</label>
          <input type="date" id="edit-record-date">
          
          <label>é …ç›®</label>
          <input type="text" id="edit-record-items">
          <div id="edit-record-item-chips" class="chip-container"></div>

          <label>é‡‘é¡</label>
          <div class="currency-wrap">
              <span class="currency-symbol">NT$</span>
              <input type="number" id="edit-record-amount" class="currency-input">
          </div>

          <label>å‚™è¨»</label>
          <textarea id="edit-record-note" rows="2"></textarea>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mt-4">
          <label class="text-blue-600 font-bold flex items-center justify-center cursor-pointer p-4 border-2 border-dashed border-blue-100 rounded-xl">
              <span class="material-icons mr-2">add_a_photo</span> åŠ å‚³ç…§ç‰‡
              <input type="file" id="edit-record-photo-input" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
          </label>
          <div id="edit-record-photo-preview" class="photo-grid mt-4 justify-center"></div>
      </div>
      <div class="h-20"></div>
    </div>
  </div>
</div>

<div id="loading" class="loading-overlay hidden">
  <div class="bg-white p-6 rounded-3xl shadow-2xl flex flex-col items-center">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-100 border-t-blue-600 mb-4"></div>
    <p class="text-gray-600 font-bold text-lg">è™•ç†ä¸­...</p>
  </div>
</div>
<div id="toast" class="toast"></div>

<script>
// âš ï¸âš ï¸âš ï¸ è¨˜å¾—æ›æˆä½ çš„ Apps Script ç¶²å€ âš ï¸âš ï¸âš ï¸
const API_URL = "https://script.google.com/macros/s/AKfycbyOzg78yqgVwWkKkQM2V67Gmaicrh-ilnZ5SZ1FXq449cO4iO1nU46i5tO1xiyVZ9s/exec";

// æ¨™ç±¤ & å¸¸ç”¨é …ç›®
const TAG_OPTIONS = ["å…¨éƒ¨", "å»šä¸‹å‹", "é£²æ°´æ©Ÿ", "å…¨æˆ¶å¼", "å·¥æ¥­å•†æ¥­", "å”®æœ", "å…¶ä»–"];
const ITEM_OPTIONS = ["PP", "UDFC","CTO","UDFR", "ROè†œ","å¤§T", "å°T", "ä¿é¤Š","ä»£æ›´æ›", "ç¶­ä¿®"];

let currentFilter = "å…¨éƒ¨";
let customers = [];
let currentCustomer = null;
let selectedCustPhotos = [];
let selectedRecordPhotos = [];
let selectedEditRecordPhotos = [];
window.currentRecords = [];

function normalizeDateStr(v){
  if (!v) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const d = new Date(v);
  if (!isNaN(d)) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  return v.split(" ")[0];
}

async function apiCall(action, payload={}, method="POST"){
  showLoading(true);
  try {
    const url = method==="GET" ? `${API_URL}?${new URLSearchParams({action, ...payload})}` : API_URL;
    const res = await fetch(url, {
      method,
      body: method==="POST" ? JSON.stringify({action, ...payload}) : null
    });
    return await res.json();
  } catch(e){
    alert("é€£ç·šéŒ¯èª¤");
    return null;
  } finally {
    showLoading(false);
  }
}

async function fetchCustomers(){
  const data = await apiCall("getCustomers", {}, "GET");
  if (!Array.isArray(data)){
    document.getElementById("customer-list").innerHTML = `<div class="text-center text-gray-400 mt-20">è®€å–å¤±æ•—</div>`;
    return;
  }
  customers = data;
  renderFilterBar();
  renderList(customers);
}

function renderFilterBar() {
    const container = document.getElementById("filter-container");
    if(!container) return;
    container.innerHTML = TAG_OPTIONS.map(tag => 
        `<div class="filter-chip ${tag === currentFilter ? 'active' : ''}" onclick="filterByTag('${tag}')">${tag}</div>`
    ).join('');
}

function filterByTag(tag) {
    currentFilter = tag;
    renderFilterBar(); 
    renderList(customers);
}

function renderItemChips(containerId, inputId) {
    const container = document.getElementById(containerId);
    if(!container) return;
    container.innerHTML = ITEM_OPTIONS.map(item => 
        `<div class="item-chip" onclick="addItemToInput('${inputId}', '${item}')">${item}</div>`
    ).join('');
}

function addItemToInput(inputId, itemText) {
    const input = document.getElementById(inputId);
    if (input.value) {
        input.value += `, ${itemText}`;
    } else {
        input.value = itemText;
    }
}

function renderList(list){
  const container = document.getElementById("customer-list");
  container.innerHTML = "";

  let filtered = list;
  if (currentFilter !== "å…¨éƒ¨") {
      filtered = filtered.filter(c => c.tags && c.tags.includes(currentFilter));
  }
  
  const searchTerm = document.getElementById("search-input").value.toLowerCase();
  if (searchTerm) {
      filtered = filtered.filter(c => 
        c.name.toLowerCase().includes(searchTerm) || 
        c.phone.includes(searchTerm) || 
        (c.note && c.note.toLowerCase().includes(searchTerm))
      );
  }

  // æ’åºï¼šæœ‰éœ€è¦ä¿é¤Šçš„æ’å‰é¢
  filtered.sort((a, b) => {
      const statusA = getServiceStatus(a.lastRecordDate, a.cycle).score;
      const statusB = getServiceStatus(b.lastRecordDate, b.cycle).score;
      return statusB - statusA;
  });

  if (!filtered.length){
    container.innerHTML = `<div class="text-center text-gray-400 mt-20">æš«ç„¡è³‡æ–™</div>`;
    return;
  }

  const wrap = document.createElement("div");
  wrap.className = "space-y-3";

  filtered.forEach(c=>{
    const status = getServiceStatus(c.lastRecordDate, c.cycle);
    const last = c.lastRecordDate ? normalizeDateStr(c.lastRecordDate) : "å°šç„¡ä¿é¤Šç´€éŒ„";
    const machine = c.machine || "æœªå¡«å¯«æ©Ÿå‹";

    let cardClass = "dashboard-card border-l-4";
    let statusHtml = "";
    let dateClass = "text-gray-400";
    
    if (status.type === 'overdue') {
        cardClass += " border-l-red-500 bg-red-50/30"; 
        statusHtml = `<span class="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded font-bold ml-2">âš ï¸ éæœŸ ${status.days} å¤©</span>`;
        dateClass = "text-red-500 font-bold";
    } else if (status.type === 'soon') {
        cardClass += " border-l-yellow-500 bg-yellow-50/30";
        statusHtml = `<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-0.5 rounded font-bold ml-2">â³ å‰© ${status.days} å¤©</span>`;
        dateClass = "text-yellow-600 font-bold";
    } else {
        cardClass += " border-l-transparent hover:border-l-primary";
        dateClass = c.lastRecordDate ? "text-green-600 font-bold" : "text-gray-400";
    }

    const card = document.createElement("div");
    card.className = cardClass;
    card.onclick = ()=> openDetail(c);

    card.innerHTML = `
      <div class="grow">
        <div class="dashboard-name truncate flex items-center">
            ${c.name}
            ${statusHtml}
        </div>
        <div class="flex gap-2 flex-wrap my-1 text-sm text-secondary">
          ${c.tags ? c.tags.split(",").map(t=>`<div class="dashboard-tag">${t}</div>`).join("") : ""}
        </div>
        <div class="text-sm text-secondary mt-1 font-medium flex items-center gap-1 text-gray-500">
           <span class="material-icons text-sm">settings</span>${machine}
        </div>
        <div class="text-sm text-secondary flex gap-4 mt-2 justify-between items-center pr-2">
          <span class="flex items-center gap-1 font-mono text-lg text-gray-700"><span class="material-icons text-sm">phone_iphone</span>${c.phone}</span>
          <div class="text-right">
             <div class="text-xs text-gray-400">ä¸Šæ¬¡ä¿é¤Š</div>
             <div class="${dateClass}">${last}</div>
          </div>
        </div>
      </div>
      <div class="dashboard-chevron"><span class="material-icons">arrow_forward_ios</span></div>
    `;
    wrap.appendChild(card);
  });
  container.appendChild(wrap);
}

function getServiceStatus(lastDateStr, cycleMonths) {
    if (!lastDateStr || !cycleMonths) return { type: 'normal', score: 1 };
    const lastDate = new Date(lastDateStr);
    const nextDate = new Date(lastDate);
    nextDate.setMonth(nextDate.getMonth() + parseInt(cycleMonths));
    const today = new Date();
    today.setHours(0,0,0,0);
    const diffTime = nextDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays < 0) return { type: 'overdue', days: Math.abs(diffDays), score: 3 }; 
    else if (diffDays <= 14) return { type: 'soon', days: diffDays, score: 2 }; 
    else return { type: 'normal', days: diffDays, score: 1 }; 
}

document.getElementById("search-input").addEventListener("input", e=>{
  renderList(customers);
});

async function openDetail(c){
  currentCustomer = c;
  document.getElementById("page-list").classList.add("hidden");
  document.getElementById("page-detail").classList.remove("hidden");
  window.scrollTo(0,0);

  document.getElementById("detail-name").innerText = c.name;
  document.getElementById("detail-phone").innerText = c.phone;
  document.getElementById("detail-phone-link").href = `tel:${c.phone}`;
  document.getElementById("detail-install-date").innerText = c.installDate ? normalizeDateStr(c.installDate) : "ç„¡ç´€éŒ„";
  
  const cycleText = c.cycle ? `${c.cycle} å€‹æœˆ` : "æœªè¨­å®š";
  document.getElementById("detail-cycle").innerText = cycleText;

  const addr = c.address || "";
  document.getElementById("detail-address").innerText = addr || "æœªå¡«å¯«";
  const mapLink = document.getElementById("detail-map-link");
  if (addr) {
      mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
      mapLink.classList.remove("hidden");
  } else {
      mapLink.classList.add("hidden");
  }

  document.getElementById("detail-machine").innerText = c.machine || "æœªå¡«å¯«";
  document.getElementById("detail-filter").innerText = c.filter || "æœªå¡«å¯«";

  const tagBox = document.getElementById("detail-tags");
  tagBox.innerHTML = c.tags ? c.tags.split(",").map(t=>`<div class="dashboard-tag">${t}</div>`).join("") : `<span class="text-secondary">æœªè¨­å®š</span>`;

  if (c.note){
    document.getElementById("detail-note").innerText = c.note;
    document.getElementById("note-container").classList.remove("hidden");
  } else {
    document.getElementById("note-container").classList.add("hidden");
  }

  const photoDiv = document.getElementById("customer-photos-container");
  photoDiv.innerHTML = "";
  let photos = [];
  if (Array.isArray(c.photos)) photos = c.photos;
  else if (typeof c.photos==="string" && c.photos.startsWith("[")) { try { photos = JSON.parse(c.photos); } catch {} }
  
  if (photos.length){
    photos.forEach(url=>{
      const img = document.createElement("img"); img.src = url; img.className = "photo-thumb cursor-pointer flex-shrink-0";
      img.onclick = ()=>window.open(url); photoDiv.appendChild(img);
    });
  } else { photoDiv.innerHTML = `<div class="text-secondary text-sm p-2">ç„¡ç…§ç‰‡</div>`; }

  await fetchRecords(c.id);
}

function goBack(){
  document.getElementById("page-detail").classList.add("hidden");
  document.getElementById("page-list").classList.remove("hidden");
  renderList(customers); // å›ä¾†æ™‚æ›´æ–°åˆ—è¡¨ï¼ˆä¾‹å¦‚æ’åºï¼‰
}

async function fetchRecords(id){
  const box = document.getElementById("record-list");
  box.innerHTML = `<div class="text-center text-secondary py-4">è®€å–ä¸­â€¦</div>`;
  const records = await apiCall("getRecords", {customerId:id}, "GET");
  if (!records.length){ box.innerHTML = `<div class="text-secondary text-center py-4">å°šç„¡ç´€éŒ„</div>`; return; }
  window.currentRecords = records;
  box.innerHTML = "";
  records.sort((a,b)=>new Date(b.date)-new Date(a.date));
  
  records.forEach(r=>{
    const photos = Array.isArray(r.photos) ? r.photos : [];
    const rData = JSON.stringify(r).replace(/"/g, '"'); 
    
    // è¨ˆç®—ä¸‹æ¬¡ä¿é¤Šæ—¥ (å¦‚æœæœ‰é€±æœŸ)
    let nextDateStr = "";
    if (currentCustomer.cycle) {
         const recordDate = new Date(r.date);
         recordDate.setMonth(recordDate.getMonth() + parseInt(currentCustomer.cycle));
         nextDateStr = `${recordDate.getFullYear()}/${String(recordDate.getMonth()+1).padStart(2,'0')}/${String(recordDate.getDate()).padStart(2,'0')}`;
    }

    const item = document.createElement("div"); item.className = "timeline-item";
    item.innerHTML = `
      <div class="timeline-dot"></div>
      <div class="record-card">
        <div class="flex justify-between mb-3 border-b border-gray-100 pb-2">
          <div class="record-date text-xl text-gray-800">${normalizeDateStr(r.date)}</div>
          <div class="record-amount text-xl">${r.amount ? "NT$"+r.amount : ""}</div>
        </div>
        
        <div class="mb-3">
             <div class="text-gray-400 text-xs mb-1">é …ç›®</div>
             <div class="font-bold text-gray-900 text-2xl leading-snug">${r.items}</div>
        </div>

        ${r.note ? `
            <div class="mb-3 bg-gray-50 p-3 rounded-lg border border-gray-100">
                <div class="text-gray-400 text-xs mb-1">å‚™è¨»</div>
                <div class="text-gray-700 text-lg">${r.note}</div>
            </div>` : ""}
            
        ${photos.length ? `<div class="flex gap-2 overflow-x-auto mb-3 pt-2 border-t border-gray-50">${photos.map(p=>`<img class="photo-thumb cursor-pointer" src="${p}" onclick="window.open('${p}')">`).join("")}</div>` : ""}
        
        <div class="flex justify-end gap-3 mt-2 pt-2 border-t border-gray-50 items-center">
          <button onclick='copyLineReport(${JSON.stringify(JSON.stringify(r))})' class="text-green-600 bg-green-50 px-4 py-2 rounded-lg font-bold text-base flex items-center mr-auto">
             <span class="material-icons text-lg mr-1">chat</span>LINEå›å ±
          </button>

          <button onclick="openEditRecordModal('${rData}')" class="text-blue-600 bg-blue-50 px-4 py-2 rounded-lg font-bold text-base">ç·¨è¼¯</button>
          <button onclick="deleteRecord('${r.id}')" class="text-red-500 bg-red-50 px-4 py-2 rounded-lg font-bold text-base">åˆªé™¤</button>
        </div>
      </div>`;
    box.appendChild(item);
  });
}

// âœ¨âœ¨âœ¨ LINE å›å ±åŠŸèƒ½é‚è¼¯ âœ¨âœ¨âœ¨
function copyLineReport(recordJson) {
    const r = JSON.parse(recordJson);
    const c = currentCustomer;
    
    // è¨ˆç®—ä¸‹æ¬¡ä¿é¤Šæ—¥
    let nextDateStr = "æœªè¨­å®šé€±æœŸ";
    if (c.cycle) {
         const recordDate = new Date(r.date);
         recordDate.setMonth(recordDate.getMonth() + parseInt(c.cycle));
         nextDateStr = `${recordDate.getFullYear()}/${String(recordDate.getMonth()+1).padStart(2,'0')}/${String(recordDate.getDate()).padStart(2,'0')}`;
    }

    const text = `ğŸ’§ *æ¿¾èŠ¯ä¿é¤Šå®Œæˆé€šçŸ¥*\n\n` +
                 `è¦ªæ„›çš„ *${c.name}* æ‚¨å¥½ï¼š\n` +
                 `æ„Ÿè¬æ‚¨ä½¿ç”¨æˆ‘å€‘çš„ä¿é¤Šæœå‹™ï¼\n\n` +
                 `ğŸ“… ä¿é¤Šæ—¥æœŸï¼š${normalizeDateStr(r.date)}\n` +
                 `ğŸ›  æ›´æ›é …ç›®ï¼š${r.items}\n` +
                 `ğŸ’° æœ¬å–®é‡‘é¡ï¼šNT$${r.amount || 0}\n` +
                 (r.note ? `ğŸ“ å‚™è¨»äº‹é …ï¼š${r.note}\n` : "") +
                 `â³ é è¨ˆä¸‹æ¬¡ä¿é¤Šï¼š${nextDateStr}\n\n` +
                 `ç¥æ‚¨ç”¨æ°´æ„‰å¿«ï¼å¦‚æœ‰å•é¡Œè«‹éš¨æ™‚è¯ç¹«ã€‚`;

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showToast("å·²è¤‡è£½ï¼è«‹è²¼ä¸Š LINE");
        }).catch(err => {
            alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
        });
    } else {
        // å‚™ç”¨è¤‡è£½æ³• (é‡å°èˆŠç€è¦½å™¨)
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        showToast("å·²è¤‡è£½ï¼è«‹è²¼ä¸Š LINE");
    }
}

function openEditRecordModal(recordStr){
  const r = JSON.parse(recordStr);
  document.getElementById("edit-record-id").value = r.id;
  document.getElementById("edit-record-date").value = normalizeDateStr(r.date);
  document.getElementById("edit-record-items").value = r.items;
  document.getElementById("edit-record-amount").value = r.amount || "";
  document.getElementById("edit-record-note").value = r.note || "";
  selectedEditRecordPhotos = [];
  document.getElementById("edit-record-photo-preview").innerHTML = "";
  renderItemChips("edit-record-item-chips", "edit-record-items"); // åˆå§‹åŒ–æŒ‰éˆ•
  document.getElementById("record-modal").classList.remove("hidden");
}

async function saveEditedRecord(){
  const id = document.getElementById("edit-record-id").value;
  const items = document.getElementById("edit-record-items").value.trim();
  const date = document.getElementById("edit-record-date").value;
  if (!items){ alert("è«‹è¼¸å…¥é …ç›®"); return; }
  let photoUrls = [];
  for (let base64 of selectedEditRecordPhotos){
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }
  const payload = {
    id, date, items,
    amount: document.getElementById("edit-record-amount").value,
    note: document.getElementById("edit-record-note").value,
    photos: photoUrls
  };
  const res = await apiCall("updateRecord", payload);
  if (res?.status==="success"){
    closeModal("record-modal"); await fetchRecords(currentCustomer.id); renderList(customers);
  }
}

async function saveRecord(){
  if (!currentCustomer) return;
  const items = document.getElementById("record-items").value.trim();
  if (!items){ alert("è«‹è¼¸å…¥é …ç›®"); return; }
  let photoUrls = [];
  for (let base64 of selectedRecordPhotos){
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }
  const payload = {
    customerId: currentCustomer.id,
    date: document.getElementById("record-date").value,
    items,
    amount: document.getElementById("record-amount").value,
    note: document.getElementById("record-note").value,
    photos: photoUrls
  };
  const res = await apiCall("addRecord", payload);
  if (res?.status==="success"){
    showToast("å„²å­˜æˆåŠŸ");
    selectedRecordPhotos = [];
    document.getElementById("new-record-photos").innerHTML = "";
    document.getElementById("record-items").value=""; document.getElementById("record-amount").value=""; document.getElementById("record-note").value="";
    await fetchRecords(currentCustomer.id);
  }
}

async function deleteRecord(id){
  if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
  await apiCall("deleteRecord", {id});
  await fetchRecords(currentCustomer.id);
}

function showAddCustomerModal(){
  document.getElementById("modal-title").innerText = "æ–°å¢å®¢æˆ¶";
  document.getElementById("cust-id").value = "";
  document.getElementById("cust-name").value = "";
  document.getElementById("cust-phone").value = "";
  document.getElementById("cust-address").value = "";
  document.getElementById("cust-note").value = "";
  document.getElementById("cust-machine").value = "";
  document.getElementById("cust-filter").value = "";
  document.getElementById("cust-cycle").value = ""; // æ¸…ç©ºé€±æœŸ
  const d = new Date(); document.getElementById("cust-install-date").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  selectedCustPhotos = []; document.getElementById("cust-photo-preview").innerHTML = "";
  renderTagSelector("cust-tag-selector", []);
  document.getElementById("btn-delete-customer").classList.add("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

function showEditCustomerModal(){
  const c = currentCustomer;
  document.getElementById("modal-title").innerText = "ç·¨è¼¯è³‡æ–™";
  document.getElementById("cust-id").value = c.id;
  document.getElementById("cust-name").value = c.name;
  document.getElementById("cust-phone").value = c.phone;
  document.getElementById("cust-address").value = c.address || "";
  document.getElementById("cust-note").value = c.note || "";
  document.getElementById("cust-machine").value = c.machine || "";
  document.getElementById("cust-filter").value = c.filter || "";
  document.getElementById("cust-cycle").value = c.cycle || ""; // è¼‰å…¥é€±æœŸ
  document.getElementById("cust-install-date").value = c.installDate ? normalizeDateStr(c.installDate) : "";
  selectedCustPhotos = []; document.getElementById("cust-photo-preview").innerHTML = "";
  renderTagSelector("cust-tag-selector", c.tags ? c.tags.split(",") : []);
  document.getElementById("btn-delete-customer").classList.remove("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

async function saveCustomer(){
  const id = document.getElementById("cust-id").value;
  const name = document.getElementById("cust-name").value.trim();
  const phone = document.getElementById("cust-phone").value.trim();
  if (!name || !phone){ alert("å§“åã€é›»è©±å¿…å¡«"); return; }
  let photoUrls = [];
  if (id && currentCustomer?.photos){
    if (Array.isArray(currentCustomer.photos)) photoUrls = [...currentCustomer.photos];
    else try { photoUrls = JSON.parse(currentCustomer.photos); } catch { photoUrls = []; }
  }
  for (let base64 of selectedCustPhotos){
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }
  const tags = getSelectedTags("cust-tag-selector");
  const payload = {
    id, name, phone,
    address: document.getElementById("cust-address").value,
    note: document.getElementById("cust-note").value,
    machine: document.getElementById("cust-machine").value,
    filter: document.getElementById("cust-filter").value,
    installDate: document.getElementById("cust-install-date").value,
    cycle: document.getElementById("cust-cycle").value,
    photos: photoUrls, tags
  };
  const act = id ? "updateCustomer" : "addCustomer";
  const res = await apiCall(act, payload);
  if (res?.status==="success"){
    showToast("å„²å­˜æˆåŠŸ");
    closeModal("customer-modal"); await fetchCustomers();
    if(id && currentCustomer) openDetail({...currentCustomer, ...payload, photos: photoUrls});
  }
}

async function deleteCustomer(){
  if (!confirm("ç¢ºå®šåˆªé™¤æ­¤å®¢æˆ¶ï¼Ÿ")) return;
  const id = document.getElementById("cust-id").value;
  await apiCall("deleteCustomer", {id});
  closeModal("customer-modal"); goBack(); fetchCustomers();
}

function renderTagSelector(containerId, selected=[]){
  const box = document.getElementById(containerId); box.innerHTML = "";
  TAG_OPTIONS.forEach(t=>{
    const div = document.createElement("div"); div.className = "tag" + (selected.includes(t) ? " active" : "");
    div.dataset.tag = t; div.innerText = t; div.onclick = ()=> div.classList.toggle("active");
    box.appendChild(div);
  });
}
function getSelectedTags(containerId){ return [...document.querySelectorAll(`#${containerId} .tag.active`)].map(x=>x.dataset.tag).join(","); }

function handleCustPhotoSelect(input){ handlePhotoSelect(input, selectedCustPhotos, "cust-photo-preview"); }
function handleRecordPhotoSelect(input){ handlePhotoSelect(input, selectedRecordPhotos, "new-record-photos", "record-photo-count"); }
function handleEditRecordPhotoSelect(input){ handlePhotoSelect(input, selectedEditRecordPhotos, "edit-record-photo-preview"); }

function handlePhotoSelect(input, arr, previewId, countId){
  [...input.files].forEach(file=>{
    const reader = new FileReader();
    reader.onload = e => resizeImage(e.target.result, 900, out=>{
      arr.push(out); renderPreview(previewId, arr);
      if(countId) document.getElementById(countId).innerText = `${arr.length} å¼µ`;
    });
    reader.readAsDataURL(file);
  });
}
function renderPreview(id, arr){ document.getElementById(id).innerHTML = arr.map(src => `<img class="photo-thumb" src="${src}">`).join(""); }
function resizeImage(base64, maxW, cb){
  const img = new Image(); img.src = base64;
  img.onload = ()=>{
    let w = img.width, h = img.height; if (w > maxW){ h *= maxW/w; w = maxW; }
    const c = document.createElement("canvas"); c.width = w; c.height = h;
    c.getContext("2d").drawImage(img,0,0,w,h); cb(c.toDataURL("image/jpeg",0.8));
  };
}

function closeModal(id){ document.getElementById(id).classList.add("hidden"); }
document.getElementById("customer-modal").addEventListener("click", e=>{ if (e.target.id==="customer-modal") closeModal("customer-modal"); });
document.getElementById("record-modal").addEventListener("click", e=>{ if (e.target.id==="record-modal") closeModal("record-modal"); });
function showLoading(show){ document.getElementById("loading").classList.toggle("hidden", !show); }
function showToast(message) {
    const x = document.getElementById("toast"); x.innerText = message; x.className = "toast show";
    setTimeout(function(){ x.className = "toast"; }, 3000);
}

window.onload = () => {
  fetchCustomers();
  const rd = document.getElementById("record-date");
  if (rd){ const d = new Date(); rd.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  renderItemChips("new-record-item-chips", "record-items");
  renderItemChips("edit-record-item-chips", "edit-record-items");
};
</script>

</body>
</html>
