<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>æ¿¾èŠ¯ä¿é¤Šç³»çµ±</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --primary: #007AFF;
      --primary-light: #64A8FF;
      --milk-bg: #F5EFE7;
      --milk-card: #FFFFFF;
      --milk-border: #E6E2DA;
      --milk-input: #F9F7F2;
      --text-main: #3A342E;
      --text-secondary: #6E655C;
      --nav-bg: #F5EFE7;
      --chip-bg: #EFEDE7;
    }

    body.dark-mode {
      --primary: #0A84FF;
      --primary-light: #64A8FF;
      --milk-bg: #121212;
      --milk-card: #1C1C1E;
      --milk-border: #2C2C2E;
      --milk-input: #2C2C2E;
      --text-main: #F2F2F7;
      --text-secondary: #8E8E93;
      --nav-bg: #121212;
      --chip-bg: #2C2C2E;
    }

    body.dark-mode .bg-white { background-color: var(--milk-card) !important; color: var(--text-main); }
    body.dark-mode .bg-gray-50 { background-color: #000000 !important; }
    body.dark-mode .text-navy-900 { color: var(--text-main) !important; }
    body.dark-mode .text-gray-700 { color: #D1D1D6 !important; }
    body.dark-mode .text-gray-800 { color: #E5E5EA !important; }
    body.dark-mode input, body.dark-mode textarea, body.dark-mode select {
        background-color: var(--milk-input) !important;
        border-color: var(--milk-border) !important;
        color: var(--text-main) !important;
    }

    html { font-size: 18px; }
    body {
      background: var(--milk-bg);
      margin: 0;
      padding-bottom: 100px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-main);
      transition: background 0.3s, color 0.3s;
    }

    /* é ‚éƒ¨å°èˆªåˆ— */
    .ios-nav-bar {
      position: sticky; top: 0; 
      padding: 12px 16px; 
      padding-top: max(16px, env(safe-area-inset-top));
      background: var(--nav-bg); 
      border-bottom: 1px solid var(--milk-border); 
      z-index: 100;
      display:flex; justify-content:space-between; align-items:center;
      transition: background 0.3s;
      height: auto; min-height: 60px;
    }
    .ios-nav-left, .ios-nav-right { display:flex; align-items:center; color:var(--primary); font-size:16px; gap:4px; cursor:pointer; }
    .ios-nav-title { font-size:18px; font-weight:600; color:var(--text-main); }

    .search-bar {
      background: var(--milk-card); border-radius: 14px; padding: 10px; display:flex; align-items:center; gap:8px; border:1px solid var(--milk-border);
    }
    .search-bar input { width:100%; border:none; background:transparent; font-size:16px; outline:none; color: var(--text-main); }

    /* å„€è¡¨æ¿ */
    .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .stat-card {
      background: var(--milk-card); padding: 12px; border-radius: 16px; border: 1px solid var(--milk-border);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: 0.2s;
    }
    .stat-card:active { transform: scale(0.97); opacity: 0.8; }
    .stat-card.active-filter { border: 2px solid var(--primary); background: var(--milk-input); }
    .stat-value { font-size: 24px; font-weight: 800; line-height: 1.2; color: var(--text-main); }
    .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
    .text-red-alert { color: #ff453a !important; }
    .text-orange-alert { color: #ff9f0a !important; }

    /* åˆ†é¡æ¨™é¡Œ */
    .section-header {
        font-size: 14px; font-weight: 700; color: var(--text-secondary);
        padding: 16px 4px 8px 4px; margin: 0; display: flex; align-items: center;
        position: relative; z-index: 10;
        animation: slideUpFade 0.4s ease-out forwards;
    }
    .section-header::after { content: ""; flex: 1; height: 1px; background: var(--milk-border); margin-left: 10px; }

    .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; margin-top: 12px; -webkit-overflow-scrolling: touch; }
    .filter-scroll::-webkit-scrollbar { display: none; }
    .filter-chip {
      padding: 6px 14px; background: var(--chip-bg); border: 1px solid var(--milk-border);
      border-radius: 20px; font-size: 14px; color: var(--text-secondary);
      white-space: nowrap; cursor: pointer; transition: all 0.2s;
    }
    .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }

    /* å¡ç‰‡æ¨£å¼ */
    .dashboard-card {
      background: var(--milk-card); border-radius: 18px; border:1px solid var(--milk-border);
      padding: 16px 14px 12px 14px; 
      display:flex; flex-direction: column; 
      box-shadow:0 6px 16px rgba(0,0,0,0.06); cursor:pointer; transition:.12s;
      position: relative; overflow: hidden; 
      z-index: 1; 
      opacity: 0; transform: translateY(20px);
    }
    @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-enter { animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .dashboard-card:active { transform:scale(.97); }
    .card-content-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    
    .dashboard-name { font-size:20px; font-weight:700; color: var(--text-main); }
    .dashboard-tag {
      display:inline-flex; padding:3px 10px; background:var(--chip-bg); border:1px solid var(--milk-border);
      border-radius:999px; font-size:12px; color:var(--text-secondary); margin:4px 0;
    }
    .dashboard-chevron { width:32px; height:32px; background:var(--milk-input); border-radius:50%; display:flex; align-items:center; justify-content:center; color: var(--text-secondary); }

    /* è† å›Šç‹€æŒ‰éˆ• */
    .action-btn-pill {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 8px 16px; border-radius: 99px; font-size: 14px; font-weight: 600;
        gap: 6px; text-decoration: none; transition: transform 0.1s, background 0.2s;
        border: 1px solid rgba(0,0,0,0.05);
    }
    .action-btn-pill:active { transform: scale(0.95); }
    body.dark-mode .action-btn-pill { border-color: rgba(255,255,255,0.1); }

    .progress-track { height: 4px; width: 100%; background: #F2F2F7; border-radius: 2px; margin-top: 12px; overflow: hidden; display: flex; }
    body.dark-mode .progress-track { background: #3a3a3c; }
    .progress-bar { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
    .bar-green { background-color: #30D158; }
    .bar-yellow { background-color: #FF9F0A; }
    .bar-red { background-color: #FF453A; }

    .timeline-item { position:relative; margin-bottom:18px; padding-left:20px; }
    .timeline-item::before { content:""; position:absolute; left:9px; top:0; bottom:-8px; width:2px; background:var(--milk-border); }
    .timeline-dot { position:absolute; left:4px; top:8px; width:12px; height:12px; background:var(--milk-card); border:3px solid var(--primary); border-radius:50%; }
    .record-card { background:var(--milk-card); border:1px solid var(--milk-border); padding:14px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
    .record-date { font-weight:600; color: var(--text-main); }
    .record-amount { color:#30D158; font-weight:700; }

    .tag-selector, .chip-container { display:flex; flex-wrap:wrap; gap:8px; }
    .tag, .item-chip {
      padding:6px 12px; background:var(--chip-bg); border:1px solid var(--milk-border);
      border-radius:999px; font-size:14px; cursor:pointer; transition:0.15s;
      user-select:none; color:var(--text-secondary);
    }
    .tag.active { background:var(--primary); color: white; border-color:var(--primary); font-weight: 600; }
    .item-chip { background-color: rgba(10, 132, 255, 0.15); color: var(--primary); border-color: var(--primary-light); font-weight: 600; margin-top: 4px; }
    .item-chip:active { background-color: var(--primary); color: white; }

    .photo-thumb { width:90px; height:90px; object-fit:cover; border-radius:12px; border:1px solid var(--milk-border); background:#E5E2DC; }

    .loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.65); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:999; }
    body.dark-mode .loading-overlay { background:rgba(0,0,0,0.65); }

    .sheet-backdrop { background: rgba(0,0,0,0.4); backdrop-filter:blur(2px); }
    .sheet { background: var(--milk-card); max-height: 90vh; display: flex; flex-direction: column; color: var(--text-main); }
    .sheet-grabber { width: 40px; height: 5px; background: #E0E0E0; border-radius: 99px; margin: 10px auto 0; }
    body.dark-mode .sheet-grabber { background: #48484A; }
    .sheet-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-bottom: 1px solid var(--milk-border); }
    .sheet-title { font-weight: 700; font-size: 18px; color: var(--text-main); }
    .sheet-btn-text { color: var(--primary); font-size: 16px; }
    .sheet-body { padding: 16px; overflow-y: auto; background-color: var(--milk-bg); }
      
    input, textarea, select { -webkit-appearance: none; appearance: none; }
    .hidden { display: none !important; }
    .danger-btn { width: 100%; color: #ff453a; background: rgba(255, 69, 58, 0.15); padding: 12px; border-radius: 12px; font-weight: 600; margin-top: 10px; }

    .toast {
      visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 17px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
    }
    .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    
    .photo-wrapper { position: relative; display: inline-block; margin-right: 8px; flex-shrink: 0; }
    .photo-thumb-edit { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid var(--milk-border); }
    .btn-remove-photo {
      position: absolute; top: -6px; right: -6px;
      background: #ff453a; color: white;
      border-radius: 50%; width: 22px; height: 22px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
    }
    
    .btn-line {
      background-color: #30D158; color: white;
      border: none; padding: 6px 12px; border-radius: 99px;
      font-size: 13px; font-weight: 600; display: inline-flex; align-items: center;
      gap: 4px; cursor: pointer; text-decoration: none;
    }
    .btn-line:active { background-color: #24a544; }
    
    .finish-modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
      display: flex; align-items: center; justify-content: center;
    }

    /* Lightbox ä¿®æ­£ç‰ˆ */
    .lightbox-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .lightbox-overlay.active { opacity: 1; pointer-events: auto; }
    .lightbox-img { max-width: 100vw; max-height: 100vh; object-fit: contain; }
    .lightbox-close {
        position: absolute; top: 20px; right: 20px; color: white;
        background: rgba(255,255,255,0.2); border-radius: 50%;
        width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
        font-size: 30px; cursor: pointer; z-index: 3001; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .lightbox-close:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
    
    .theme-toggle, .tool-toggle {
        padding: 8px; border-radius: 50%; background: var(--milk-input); color: var(--text-secondary);
        display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--milk-border);
    }

    .fab-btn {
        position: fixed; right: 24px; width: 56px; height: 56px; border-radius: 50%;
        background: var(--primary); color: white;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; z-index: 40;
        transition: transform 0.2s, opacity 0.3s; border: none;
    }
    .fab-btn:active { transform: scale(0.95); }

    #btn-add-customer { bottom: 30px; }
    #scroll-to-top { bottom: 100px; opacity: 0; pointer-events: none; transform: translateY(10px); }
    #scroll-to-top.show { opacity: 1; pointer-events: auto; transform: translateY(0); }

    /* PIN é–å®šç•«é¢ CSS */
    #pin-lock-overlay {
        position: fixed; inset: 0; z-index: 9999;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: opacity 0.3s, visibility 0.3s;
    }
    body.dark-mode #pin-lock-overlay { background: rgba(0, 0, 0, 0.85); }
    
    .pin-title { font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-main); }
    .pin-dots { display: flex; gap: 16px; margin-bottom: 40px; }
    .pin-dot {
        width: 14px; height: 14px; border-radius: 50%;
        border: 1px solid var(--text-secondary); transition: all 0.2s;
    }
    .pin-dot.filled { background: var(--text-main); border-color: var(--text-main); }
    .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px 32px; }
    .pin-btn {
        width: 72px; height: 72px; border-radius: 50%;
        background: var(--milk-card); border: 1px solid var(--milk-border);
        font-size: 28px; font-weight: 500; color: var(--text-main);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: background 0.1s; user-select: none;
    }
    .pin-btn:active { background: var(--milk-input); }
    .pin-btn.transparent { background: transparent; border: none; font-size: 16px; }
    .shake-anim { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }
    .unlocked { opacity: 0; visibility: hidden; pointer-events: none; }

    /* å·¥å…·ç®± CSS */
    .tool-section-title { font-size: 14px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
    .tool-row { display: flex; gap: 12px; margin-bottom: 16px; }
    .tool-input-group { flex: 1; }
    .tool-input-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .tool-input { width: 100%; padding: 10px; border-radius: 12px; border: 1px solid var(--milk-border); background: var(--milk-input); font-size: 16px; color: var(--text-main); font-weight: 600; text-align: center; }
    .result-box { background: rgba(0, 122, 255, 0.1); border: 1px solid var(--primary); padding: 12px; border-radius: 12px; color: var(--primary); font-weight: 600; text-align: center; margin-top: 8px; font-size: 15px; line-height: 1.5; }
    body.dark-mode .result-box { background: rgba(10, 132, 255, 0.2); color: var(--primary-light); }
    
    .qr-container { background: white; padding: 20px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; margin-bottom: 12px; border: 1px solid #eee; }
    .qr-img { width: 180px; height: 180px; object-fit: contain; margin-bottom: 16px; }
    
    /* Toggle Switch CSS */
    .toggle-checkbox:checked { right: 0; border-color: #10B981; }
    .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
    .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
    .toggle-label { width: 44px; height: 24px; background-color: #E5E7EB; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.2s ease-in-out; }
    .toggle-label:before { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background-color: white; border-radius: 50%; transition: transform 0.2s ease-in-out; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

  </style>
</head>

<body>

<div id="pin-lock-overlay">
    <div class="pin-title" id="pin-status">è«‹è¼¸å…¥å¯†ç¢¼è§£é–</div>
    <div class="pin-dots" id="pin-dots">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="pin-pad">
        <div class="pin-btn" onclick="enterPin('1')">1</div>
        <div class="pin-btn" onclick="enterPin('2')">2</div>
        <div class="pin-btn" onclick="enterPin('3')">3</div>
        <div class="pin-btn" onclick="enterPin('4')">4</div>
        <div class="pin-btn" onclick="enterPin('5')">5</div>
        <div class="pin-btn" onclick="enterPin('6')">6</div>
        <div class="pin-btn" onclick="enterPin('7')">7</div>
        <div class="pin-btn" onclick="enterPin('8')">8</div>
        <div class="pin-btn" onclick="enterPin('9')">9</div>
        <div class="pin-btn transparent"></div>
        <div class="pin-btn" onclick="enterPin('0')">0</div>
        <div class="pin-btn transparent" onclick="enterPin('del')" style="font-size:18px">åˆªé™¤</div>
    </div>
</div>

<div id="tools-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col rounded-t-2xl sm:rounded-2xl">
    <div class="sheet-grabber"></div>
    <div class="sheet-header">
      <h2 class="sheet-title flex items-center"><span class="material-icons mr-2">construction</span>å·¥ç¨‹å¸«å·¥å…·ç®±</h2>
      <button onclick="document.getElementById('tools-modal').classList.add('hidden')" class="sheet-btn-text">é—œé–‰</button>
    </div>
    <div class="sheet-body space-y-6 bg-gray-50 pb-10">
        
        <div>
            <div class="tool-section-title">å®¢æœèˆ‡æ”¶æ¬¾ (çµæ¡ˆç¥å™¨)</div>
            <div class="bg-white rounded-xl p-5 shadow-sm flex flex-col items-center">
                <div class="mb-4 text-center">
                    <div class="text-sm text-gray-500 mb-2">æƒæåŠ å…¥å®˜æ–¹ LINE</div>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://line.me/ti/p/sk8erboi577" class="w-40 h-40 object-contain border border-gray-100 rounded-lg mx-auto">
                </div>
                
                <div class="w-full h-[1px] bg-gray-100 my-4"></div>
                <div class="w-full">
                    <div class="text-xs text-gray-400 mb-1">æ”¶æ¬¾å¸³è™Ÿ (é»æ“Šè¤‡è£½)</div>
                    <div onclick="copyBankInfo()" class="bg-gray-50 border border-gray-200 rounded-lg p-3 flex justify-between items-center cursor-pointer active:bg-gray-100">
                        <div>
                            <div class="text-xs text-gray-500">æ¸£æ‰“éŠ€è¡Œ (052)</div>
                            <div class="font-mono font-bold text-lg text-gray-700 tracking-wide">03420-000777561</div>
                        </div>
                        <span class="material-icons text-gray-400">content_copy</span>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <div class="tool-section-title">ç¨…é¡è¨ˆç®— (5%)</div>
            <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
                <div class="flex gap-2 items-center mb-2">
                    <div class="flex-1">
                        <div class="tool-input-label">æœªç¨…é‡‘é¡</div>
                        <input type="number" id="tax-exclude" class="tool-input text-blue-600" placeholder="è¼¸å…¥æœªç¨…" oninput="calcTax('exclude')">
                    </div>
                    <div class="text-gray-400 pt-4">â•</div>
                    <div class="w-24">
                        <div class="tool-input-label">ç¨…é‡‘</div>
                        <div id="tax-val" class="tool-input bg-gray-100 text-gray-500">0</div>
                    </div>
                </div>
                <div class="flex gap-2 items-center">
                    <div class="text-gray-400 pt-4">ğŸŸ°</div>
                    <div class="flex-1">
                        <div class="tool-input-label">å«ç¨…ç¸½é¡</div>
                        <input type="number" id="tax-include" class="tool-input text-green-600 font-bold" placeholder="è¼¸å…¥å«ç¨…" oninput="calcTax('include')">
                    </div>
                </div>
            </div>
        </div>

        <div>
            <div class="tool-section-title">è»Ÿæ°´è¨­å®šä¸€æ¢é¾ (å«è£œæ°´è¨ˆæ™‚)</div>
            <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
                
                <div class="tool-row mb-0">
                    <div class="tool-input-group"><div class="tool-input-label">æ¨¹è„‚é‡ (å…¬å‡)</div><input type="number" id="soft-resin" class="tool-input" placeholder="50" oninput="calculateSoftWater()"></div>
                    <div class="tool-input-group"><div class="tool-input-label">åŸæ°´ç¡¬åº¦ (PPM)</div><input type="number" id="soft-ppm" class="tool-input" placeholder="200" oninput="calculateSoftWater()"></div>
                </div>
                
                <div class="tool-row mb-0 mt-3">
                    <div class="tool-input-group" style="flex: 0.8;">
                        <div class="tool-input-label">è¨ˆç®—åŸºæº–</div>
                        <select id="usage-mode" class="tool-input" onchange="calculateSoftWater()" style="padding: 10px 4px; font-size: 14px;">
                            <option value="people">äººæ•¸ä¼°ç®— (250L/äºº)</option>
                            <option value="manual">æ¯æ—¥ç”¨æ°´ (å…¬å‡)</option>
                            <option value="bill">æ°´è²»å–®åº¦æ•¸ (2å€‹æœˆ)</option>
                        </select>
                    </div>
                    <div class="tool-input-group">
                        <div class="tool-input-label">æ•¸å€¼</div>
                        <input type="number" id="usage-val" class="tool-input" placeholder="è¼¸å…¥äººæ•¸/åº¦æ•¸" oninput="calculateSoftWater()">
                    </div>
                </div>

                <div class="flex justify-between items-center py-2 px-1">
                    <span class="text-sm font-medium text-gray-700">å•Ÿç”¨å®‰å…¨ä¿‚æ•¸ (9æŠ˜)</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="soft-safe-mode" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked onchange="calculateSoftWater()"/>
                        <label for="soft-safe-mode" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>

                <div id="soft-result" class="hidden space-y-3">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <div class="flex justify-between items-center mb-1"><span class="text-sm text-gray-600">å†ç”Ÿé€±æœŸ (å¤©)</span><span class="font-bold text-blue-700" id="res-days">-</span></div>
                        <div class="flex justify-between items-center mb-1"><span class="text-sm text-gray-600">å¯ç”¨æ°´é‡</span><span class="font-bold text-blue-700" id="res-water">-</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-600">å»ºè­°åŠ é¹½é‡</span><span class="font-bold text-blue-700" id="res-salt">-</span></div>
                        <div class="flex justify-between items-center mt-1 border-t border-blue-200 pt-1"><span class="text-sm text-gray-600">éœ€è£œæ°´é‡ (é¹½æ¡¶)</span><span class="font-bold text-red-600" id="res-refill-vol">-</span></div>
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div class="text-xs font-bold text-gray-500 mb-2 uppercase">3åˆ†ç®¡æµé€Ÿå¯¦æ¸¬ & è£œæ°´æ™‚é–“</div>
                        <div class="flex gap-2 items-end mb-2">
                            <div class="flex-1">
                                <div class="tool-input-label">é‡æ¯æ¥æ°´ (cc)</div>
                                <input type="number" id="flow-cc" class="tool-input" placeholder="è¼¸å…¥ccæ•¸" oninput="calcFlowRate()">
                            </div>
                            <button id="btn-timer" onclick="toggleTimer()" class="h-[46px] px-4 rounded-xl font-bold text-white bg-blue-500 shadow active:scale-95 transition-all w-24">é–‹å§‹</button>
                        </div>
                        <div class="text-center text-sm text-gray-400 mb-2" id="timer-display">00.00 ç§’</div>
                        <div class="flex justify-between items-center bg-white p-2 rounded border border-gray-200">
                            <span class="text-sm text-gray-600">å¯¦æ¸¬æµé€Ÿ</span>
                            <span class="font-bold text-gray-800" id="res-flow-rate">- L/min</span>
                        </div>
                        <div class="mt-2 text-center bg-red-100 text-red-700 p-2 rounded-lg font-bold border border-red-200">
                            è£œæ°´è¨­å®šï¼š<span id="final-time" class="text-xl">0</span> åˆ†é˜
                        </div>
                    </div>

                    <details class="p-2 bg-gray-100 rounded text-xs text-gray-500">
                       <summary class="cursor-pointer font-bold text-blue-600">æŸ¥çœ‹è©³ç´°è¨ˆç®—å…¬å¼ â–¾</summary>
                       <div class="mt-2 space-y-1" id="formula-detail">
                          </div>
                    </details>
                </div>
            </div>
        </div>

        <div>
            <div class="tool-section-title">å–®ä½æ›ç®—</div>
            <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
                
                <div class="tool-row mb-0">
                    <div class="tool-input-group"><div class="tool-input-label">å£“åŠ› (psi)</div><input type="number" id="conv-psi" class="tool-input" oninput="convertUnit('psi')"></div>
                    <div class="flex items-center text-gray-400">â†”</div>
                    <div class="tool-input-group"><div class="tool-input-label">å£“åŠ› (kg/cmÂ²)</div><input type="number" id="conv-kg" class="tool-input" oninput="convertUnit('kg')"></div>
                </div>

                <div>
                    <div class="tool-input-label">æµé‡æ›ç®— (è¼¸å…¥ GPD)</div>
                    <div class="flex gap-2">
                        <input type="number" id="conv-gpd" class="tool-input w-1/3" placeholder="GPD" oninput="convertUnit('gpd')">
                        <div class="flex-1 space-y-1">
                            <div class="bg-gray-100 p-2 rounded text-center text-sm"><span id="res-lpm" class="font-bold text-gray-800">-</span> L/min</div>
                            <div class="bg-gray-100 p-2 rounded text-center text-sm"><span id="res-gpm" class="font-bold text-gray-800">-</span> GPM</div>
                        </div>
                    </div>
                </div>

                <div class="tool-row mb-0 mt-3">
                    <div class="tool-input-group"><div class="tool-input-label">é•·åº¦ (è‹±å‹)</div><input type="number" id="conv-inch" class="tool-input" oninput="convertUnit('inch')"></div>
                    <div class="flex items-center text-gray-400">â†”</div>
                    <div class="tool-input-group"><div class="tool-input-label">é•·åº¦ (cm)</div><input type="number" id="conv-cm" class="tool-input" oninput="convertUnit('cm')"></div>
                </div>

                <div class="tool-row mb-0 mt-3 pt-3 border-t border-gray-100">
                    <div class="tool-input-group">
                        <div class="tool-input-label">é›»é˜»ç‡ (MÎ©Â·cm)</div>
                        <input type="number" id="conv-mohm" class="tool-input" placeholder="18.2" oninput="convertUnit('mohm')">
                    </div>
                    <div class="flex items-center text-gray-400 px-2">â†”</div>
                    <div class="tool-input-group">
                        <div class="tool-input-label">å°é›»åº¦ (Î¼S/cm)</div>
                        <input type="number" id="conv-us" class="tool-input" placeholder="0.055" oninput="convertUnit('us')">
                    </div>
                </div>

            </div>
        </div>

        <div>
            <div class="tool-section-title">ç¾å ´ç­†è¨˜ (è‡ªå‹•å­˜æª”)</div>
            <div class="bg-white rounded-xl p-4 shadow-sm space-y-4">
                <div>
                    <div class="tool-input-label">ğŸ“ æ–‡å­—å‚™å¿˜éŒ„</div>
                    <textarea id="tool-memo" class="tool-textarea w-full p-3 border rounded-lg bg-yellow-50" rows="3" placeholder="éš¨æ‰‹è¨˜..." oninput="saveMemo()"></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <div class="tool-input-label">ğŸ¨ æ‰‹ç¹ªè‰åœ–</div>
                        <div class="flex gap-2">
                             <button onclick="setPenColor('#000000')" class="w-8 h-8 rounded-full bg-black border-2 border-gray-200"></button>
                             <button onclick="setPenColor('#EF4444')" class="w-8 h-8 rounded-full bg-red-500 border-2 border-gray-200"></button>
                             <button onclick="setPenColor('#F97316')" class="w-8 h-8 rounded-full bg-orange-500 border-2 border-gray-200"></button>
                             <button onclick="setPenColor('#EAB308')" class="w-8 h-8 rounded-full bg-yellow-500 border-2 border-gray-200"></button>
                             <button onclick="setPenColor('#22C55E')" class="w-8 h-8 rounded-full bg-green-500 border-2 border-gray-200"></button>
                             <button onclick="setPenColor('#3B82F6')" class="w-8 h-8 rounded-full bg-blue-500 border-2 border-gray-200"></button>
                        </div>
                    </div>
                    <div class="relative w-full h-96">
                        <button onclick="clearCanvas()" class="absolute top-2 right-2 text-xs bg-gray-200 px-3 py-1 rounded-full text-gray-600 font-bold shadow-sm z-10">æ¸…ç©º</button>
                        <canvas id="tool-canvas" class="w-full h-full border-2 border-gray-300 rounded-xl bg-white shadow-inner" style="touch-action: none;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="h-10"></div>
    </div> </div> </div> <div id="page-list" class="min-h-screen transition-colors duration-300">
  <div class="ios-nav-bar">
    <div class="flex items-center gap-2">
        <div class="text-xl font-bold ml-1">æ¿¾èŠ¯ä¿é¤Šç³»çµ±</div>
    </div>
    <div class="flex gap-2">
        <button class="tool-toggle" onclick="document.getElementById('tools-modal').classList.remove('hidden'); initCanvas();">
            <span class="material-icons">construction</span>
        </button>
        <button class="theme-toggle" onclick="toggleDarkMode()">
            <span id="theme-icon" class="material-icons">dark_mode</span>
        </button>
    </div>
  </div>

  <div class="pt-4 px-4 max-w-md mx-auto">
    <div class="stats-container">
      <div id="card-overdue" class="stat-card" onclick="toggleDashboardFilter('overdue')">
        <div id="stat-overdue-val" class="stat-value text-red-alert">0</div>
        <div class="stat-label">ğŸ”´ é€¾æœŸæœªä¿é¤Š</div>
      </div>
      <div id="card-month" class="stat-card" onclick="toggleDashboardFilter('month')">
        <div id="stat-month-val" class="stat-value text-orange-alert">0</div>
        <div class="stat-label">ğŸŸ¡ æœ¬æœˆéœ€ä¿é¤Š</div>
      </div>
    </div>

    <div class="search-bar">
      <span class="material-icons text-gray-400">search</span>
      <input id="search-input" type="text" placeholder="æœå°‹å®¢æˆ¶åç¨±ã€é›»è©±ã€åœ°å€æˆ–å‚™è¨»â€¦" oninput="renderList(customers)">
    </div>
    <div id="filter-container" class="filter-scroll"></div>
  </div>

  <div id="customer-list" class="max-w-md mx-auto px-4 pt-2 pb-20">
    <div class="text-center text-gray-400 mt-20">è¼‰å…¥ä¸­â€¦</div>
  </div>

  <button id="scroll-to-top" class="fab-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
      <span class="material-icons">arrow_upward</span>
  </button>

  <button id="btn-add-customer" class="fab-btn" onclick="showAddCustomerModal()">
    <span class="material-icons">add</span>
  </button>
</div>

<div id="page-detail" class="hidden min-h-screen">
  <div class="ios-nav-bar">
    <div class="ios-nav-left" onclick="goBack()">
      <span class="material-icons">arrow_back_ios</span> è¿”å›
    </div>
    <div class="ios-nav-title">å®¢æˆ¶è³‡æ–™</div>
    <div class="ios-nav-right" onclick="showEditCustomerModal()">ç·¨è¼¯</div>
  </div>
  <div class="pb-4 px-4 max-w-md mx-auto">
    <div class="mt-4 mb-4"><div id="customer-photos-container" class="flex gap-3 overflow-x-auto"></div></div>
    <div class="record-card mb-4">
      <div class="font-bold mb-2 text-gray-500 text-xs tracking-widest">åŸºæœ¬è³‡æ–™</div>
      <div class="flex py-1"><span class="w-20 text-secondary">å§“å</span><span id="detail-name"></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">é›»è©±</span><span><a id="detail-phone-link" class="text-blue-600 font-medium flex items-center"><span class="material-icons mr-1 text-base">phone</span><span id="detail-phone"></span></a></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">å®‰è£æ—¥æœŸ</span><span id="detail-install-date" class="text-gray-400 italic">ç„¡ç´€éŒ„</span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">ç´¯ç©æ¶ˆè²»</span><span id="detail-total-spend" class="font-bold text-primary">è¨ˆç®—ä¸­...</span></div>
      <div class="flex py-1 items-start"><span class="w-20 text-secondary pt-1">æ¨™ç±¤</span><div id="detail-tags" class="flex flex-wrap gap-2 flex-1"></div></div>
      <div class="flex py-1"><span class="w-20 text-secondary">ä¿é¤Šé€±æœŸ</span><span id="detail-cycle" class="text-gray-800"></span></div>
    </div>
    <div class="record-card mb-4">
      <div class="font-bold mb-2 text-gray-500 text-xs tracking-widest">è¨­å‚™è³‡è¨Š</div>
      <div class="flex py-1 items-center">
        <span class="w-20 text-secondary flex-shrink-0">åœ°å€</span>
        <div class="flex-1 flex items-center justify-between"><span id="detail-address"></span><a id="detail-map-link" target="_blank" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-sm font-bold flex items-center ml-2 hidden no-underline"><span class="material-icons text-base mr-1">near_me</span>å°èˆª</a></div>
      </div>
      <div class="flex py-1"><span class="w-20 text-secondary">æ©Ÿå™¨</span><span id="detail-machine"></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">æ¿¾èŠ¯</span><span id="detail-filter"></span></div>
      <div id="note-container" class="flex py-1 hidden"><span class="w-20 text-secondary">å‚™è¨»</span><span id="detail-note"></span></div>
    </div>
    <div class="record-card mb-4">
      <div class="font-bold mb-3 text-gray-500 text-xs tracking-widest">æ–°å¢ä¿é¤Šç´€éŒ„</div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div><div class="text-secondary text-sm mb-1">æ—¥æœŸ</div><input type="date" id="record-date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2"></div>
        <div><div class="text-secondary text-sm mb-1">é‡‘é¡</div><input type="number" id="record-amount" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2" placeholder="0"></div>
      </div>
      <div id="new-record-price-chips" class="chip-container mb-3"></div>
      <div class="mb-3">
        <div class="text-secondary text-sm mb-1">æ›´æ›é …ç›®</div><input id="record-items" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2" placeholder="ä¾‹å¦‚ï¼šPPã€æ´»æ€§ç¢³"><div id="new-record-item-chips" class="chip-container"></div>
      </div>
      <div class="mb-3">
        <div class="text-secondary text-sm mb-1">å‚™è¨»</div><input id="record-note" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2" placeholder="å‚™è¨»..."><div id="new-record-note-chips" class="chip-container mt-2"></div>
      </div>
      <div class="flex gap-3 mb-3 items-center">
        <label class="bg-gray-100 text-blue-600 px-3 py-1 rounded cursor-pointer flex items-center font-medium"><span class="material-icons mr-1">camera_alt</span>æ‹ç…§<input id="record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)"></label><span id="record-photo-count" class="text-sm text-secondary">0 å¼µ</span>
      </div>
      <div id="new-record-photos" class="flex gap-2 overflow-x-auto mb-3"></div>
      <button class="w-full bg-blue-600 text-white rounded-xl py-3 text-lg font-semibold shadow active:scale-95 transition-transform" onclick="saveRecord()">å„²å­˜ç´€éŒ„</button>
    </div>
    <div><div class="font-bold text-gray-500 text-xs tracking-widest mb-2">æ­·å²ç´€éŒ„</div><div id="record-list" class="mt-3"></div></div>
  </div>
</div>

<div id="customer-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col rounded-t-2xl sm:rounded-2xl">
    <div class="sheet-grabber"></div>
    <div class="sheet-header"><button onclick="closeModal('customer-modal')" class="sheet-btn-text">å–æ¶ˆ</button><h2 id="modal-title" class="sheet-title">æ–°å¢å®¢æˆ¶</h2><button onclick="saveCustomer()" class="sheet-btn-text font-semibold">å„²å­˜</button></div>
    <div class="sheet-body space-y-4 bg-gray-50">
      <input type="hidden" id="cust-id">
      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div><label>å§“å <span class="text-red-500">*</span></label><input id="cust-name" type="text" class="w-full p-2 border rounded"></div>
        <div><label>é›»è©± <span class="text-red-500">*</span></label><input id="cust-phone" type="tel" class="w-full p-2 border rounded"></div>
        <div><label>å®‰è£æ—¥æœŸ</label><input id="cust-install-date" type="date" class="w-full p-2 border rounded"></div>
      </div>
      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div><label>ä¿é¤Šé€±æœŸ</label><select id="cust-cycle" class="w-full p-2 border rounded bg-white"><option value="">æœªè¨­å®š</option><option value="3">3 å€‹æœˆ</option><option value="6">6 å€‹æœˆ</option><option value="9">9 å€‹æœˆ</option><option value="12">1 å¹´</option><option value="24">2 å¹´</option></select></div>
        <div><label>åœ°å€</label><input id="cust-address" type="text" class="w-full p-2 border rounded"></div>
        <div><label>æ©Ÿå™¨å‹è™Ÿ</label><input id="cust-machine" type="text" class="w-full p-2 border rounded"></div>
        <div><label>æ¿¾èŠ¯è¦æ ¼</label><input id="cust-filter" type="text" class="w-full p-2 border rounded"></div>
      </div>
      <div class="space-y-2 bg-white rounded-xl p-4 shadow-sm"><label>æ¨™ç±¤ï¼ˆå¯å¤šé¸ï¼‰</label><div id="cust-tag-selector" class="tag-selector"></div></div>
      <div class="bg-white rounded-xl p-4 shadow-sm"><label>å‚™è¨»</label><textarea id="cust-note" rows="2" class="w-full p-2 border rounded"></textarea></div>
      <div class="bg-white rounded-xl p-4 shadow-sm text-center"><label class="text-blue-600 font-medium flex items-center justify-center cursor-pointer p-2 border-2 border-dashed border-blue-200 rounded-lg"><span class="material-icons mr-2">add_photo_alternate</span> é¸æ“‡æ©Ÿå™¨ç…§ç‰‡<input id="cust-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)"></label><div id="cust-photo-preview" class="flex gap-2 overflow-x-auto mt-2 justify-center"></div></div>
      <button id="btn-delete-customer" onclick="deleteCustomer()" class="danger-btn hidden">åˆªé™¤æ­¤å®¢æˆ¶</button>
      <div class="h-10"></div>
    </div>
  </div>
</div>

<div id="record-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col rounded-t-2xl sm:rounded-2xl">
    <div class="sheet-grabber"></div>
    <div class="sheet-header"><button onclick="closeModal('record-modal')" class="sheet-btn-text">å–æ¶ˆ</button><h2 class="sheet-title">ä¿®æ”¹ç´€éŒ„</h2><button onclick="saveEditedRecord()" class="sheet-btn-text font-semibold">å®Œæˆ</button></div>
    <div class="sheet-body space-y-4 bg-gray-50">
      <input type="hidden" id="edit-record-id">
      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div><label>æ—¥æœŸ</label><input id="edit-record-date" type="date" class="w-full p-2 border rounded"></div>
        <div><label>é …ç›®</label><input id="edit-record-items" type="text" class="w-full p-2 border rounded font-medium"><div id="edit-record-item-chips" class="chip-container"></div></div>
        <div><label>é‡‘é¡</label><input id="edit-record-amount" type="number" class="w-full p-2 border rounded text-green-600 font-bold"></div>
        <div id="edit-record-price-chips" class="chip-container mb-3"></div>
        <div><label>å‚™è¨»</label><textarea id="edit-record-note" rows="2" class="w-full p-2 border rounded"></textarea><div id="edit-record-note-chips" class="chip-container mt-2"></div></div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm"><label class="text-blue-600 font-medium flex items-center justify-center cursor-pointer p-2 border-2 border-dashed border-blue-200 rounded-lg"><span class="material-icons mr-2">add_a_photo</span> åŠ å‚³ç…§ç‰‡<input id="edit-record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)"></label><div id="edit-record-photo-preview" class="photo-grid mt-2 justify-center flex gap-2 overflow-x-auto"></div></div>
      <div class="h-10"></div>
    </div>
  </div>
</div>

<div id="lightbox" class="lightbox-overlay" onclick="closeLightbox()">
    <div class="lightbox-close" onclick="closeLightbox()">Ã—</div>
    <img id="lightbox-img" class="lightbox-img" src="" onclick="event.stopPropagation()">
</div>

<script>
// âš ï¸âš ï¸âš ï¸ è«‹å‹™å¿…ç¢ºèªé€™è£¡æ˜¯ä½ æœ€æ–°çš„ Google Apps Script ç¶²å€ âš ï¸âš ï¸âš ï¸
const API_URL = "https://script.google.com/macros/s/AKfycbyOzg78yqgVwWkKkQM2V67Gmaicrh-ilnZ5SZ1FXq449cO4iO1nU46i5tO1xiyVZ9s/exec";

// æ¨™ç±¤é¸é …
const TAG_OPTIONS = ["å…¨éƒ¨", "å»šä¸‹å‹", "é£²æ°´æ©Ÿ", "å…¨æˆ¶å¼", "å·¥æ¥­å•†æ¥­", "å”®æœ", "å…¶ä»–"];
// å¸¸ç”¨ç¶­ä¿®é …ç›®
const ITEM_OPTIONS = ["PP", "UDFC","CTO","UDFR", "ROè†œ","å¤§T", "å°T", "ä¿é¤Š","ä»£æ›´æ›", "ç¶­ä¿®"];
// å¸¸ç”¨å‚™è¨»é¸é …
const NOTE_OPTIONS = ["æ°´å£“æ­£å¸¸", "ç®¡ç·šæ›´æ–°", "æ›´æ›æ¥é ­", "æ¼æ°´è™•ç†", "ç„¡äººåœ¨å®¶", "å®¢æˆ¶æŒ‡å®šæ™‚é–“"];
// å¸¸ç”¨é‡‘é¡é¸é …
const PRICE_OPTIONS = ["500", "1000", "1800", "2500", "3500"];

// ğŸ”‘ æ‚¨çš„ç™»å…¥å¯†ç¢¼
const LOGIN_PIN = "8888";

let currentFilter = "å…¨éƒ¨";
let dashboardFilter = null; 

let customers = [];
let currentCustomer = null;

let selectedCustPhotos = [];
let selectedRecordPhotos = [];
let selectedEditRecordPhotos = [];

window.currentRecords = [];

let lastScrollY = 0;

let existingCustPhotos = [];
let existingRecordPhotos = [];

// âœ¨ è¤‡è£½éŠ€è¡Œå¸³è™Ÿ
function copyBankInfo() {
    const acc = "03420-000777561"; 
    navigator.clipboard.writeText(acc).then(() => {
        showToast("å¸³è™Ÿå·²è¤‡è£½");
    }).catch(err => {
        alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
    });
}

// âœ¨ PIN é–å®šé‚è¼¯
let currentPinInput = "";
function checkLogin() {
    if (sessionStorage.getItem("isUnlocked") === "true") {
        document.getElementById("pin-lock-overlay").classList.add("unlocked");
    }
}
function enterPin(val) {
    if (val === 'del') {
        currentPinInput = currentPinInput.slice(0, -1);
    } else if (currentPinInput.length < 4) {
        currentPinInput += val;
    }
    updatePinDots();
    
    if (currentPinInput.length === 4) {
        setTimeout(verifyPin, 100);
    }
}
function updatePinDots() {
    const dots = document.querySelectorAll(".pin-dot");
    dots.forEach((dot, idx) => {
        if (idx < currentPinInput.length) dot.classList.add("filled");
        else dot.classList.remove("filled");
    });
}
function verifyPin() {
    if (currentPinInput === LOGIN_PIN) {
        sessionStorage.setItem("isUnlocked", "true");
        document.getElementById("pin-lock-overlay").classList.add("unlocked");
        currentPinInput = ""; 
    } else {
        const dotsBox = document.getElementById("pin-dots");
        dotsBox.classList.add("shake-anim");
        document.getElementById("pin-status").innerText = "å¯†ç¢¼éŒ¯èª¤";
        document.getElementById("pin-status").style.color = "#ff453a";
        setTimeout(() => {
            currentPinInput = "";
            updatePinDots();
            dotsBox.classList.remove("shake-anim");
            document.getElementById("pin-status").innerText = "è«‹è¼¸å…¥å¯†ç¢¼è§£é–";
            document.getElementById("pin-status").style.color = "var(--text-main)";
        }, 500);
    }
}

// âœ¨ ä¸»é¡Œè¨­å®š
function checkTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-icon').innerText = 'light_mode';
    }
}
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    document.getElementById('theme-icon').innerText = isDark ? 'light_mode' : 'dark_mode';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

// âœ¨ ç¨…é¡è¨ˆç®—å™¨
function calcTax(type) {
    const rate = 0.05; // ç¨…ç‡ 5%
    const excludeInput = document.getElementById("tax-exclude");
    const includeInput = document.getElementById("tax-include");
    const taxDisplay = document.getElementById("tax-val");

    if (type === 'exclude') {
        const v = parseFloat(excludeInput.value);
        if (!isNaN(v)) {
            const tax = Math.round(v * rate);
            taxDisplay.innerText = tax;
            includeInput.value = v + tax;
        } else {
            taxDisplay.innerText = "0";
            includeInput.value = "";
        }
    } else {
        const v = parseFloat(includeInput.value);
        if (!isNaN(v)) {
            const exclude = Math.round(v / (1 + rate));
            const tax = v - exclude;
            taxDisplay.innerText = tax;
            excludeInput.value = exclude;
        } else {
            taxDisplay.innerText = "0";
            excludeInput.value = "";
        }
    }
}

// âœ¨ å‚™å¿˜éŒ„ (è‡ªå‹•å­˜æª”)
function saveMemo() {
    const val = document.getElementById("tool-memo").value;
    localStorage.setItem("toolMemo", val);
}
function loadMemo() {
    const val = localStorage.getItem("toolMemo");
    if(val) document.getElementById("tool-memo").value = val;
}

// âœ¨ æ‰‹ç¹ªç•«å¸ƒ
let isDrawing = false;
let canvas, ctx;
let lastX = 0;
let lastY = 0;

function initCanvas() {
    canvas = document.getElementById("tool-canvas");
    if(!canvas) return;
    
    if(canvas.width !== canvas.offsetWidth) {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
    }
    
    ctx = canvas.getContext("2d");
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    ctx.lineWidth = 2;
    
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
        isDrawing = true;
    }, {passive: false});

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if(!isDrawing) return;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    }, {passive: false});
    
    canvas.addEventListener('touchend', () => isDrawing = false);
}

function startDrawing(e) {
    isDrawing = true;
    [lastX, lastY] = [e.offsetX, e.offsetY];
}

function draw(e) {
    if (!isDrawing) return;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    [lastX, lastY] = [e.offsetX, e.offsetY];
}

function stopDrawing() { isDrawing = false; }
function setPenColor(color) { if(ctx) ctx.strokeStyle = color; }
function clearCanvas() { if(ctx && canvas) ctx.clearRect(0, 0, canvas.width, canvas.height); }

// âœ¨ è£œæ°´è¨ˆæ™‚å™¨
let timerInterval;
let timerStartTime;
let isTiming = false;

function toggleTimer() {
    const btn = document.getElementById("btn-timer");
    const display = document.getElementById("timer-display");
    
    if(!isTiming) {
        isTiming = true;
        btn.innerText = "åœæ­¢";
        btn.classList.remove("bg-blue-500");
        btn.classList.add("bg-red-500");
        timerStartTime = Date.now();
        timerInterval = setInterval(() => {
            const diff = Date.now() - timerStartTime;
            const sec = (diff / 1000).toFixed(2);
            display.innerText = `${sec} ç§’`;
        }, 50);
    } else {
        isTiming = false;
        clearInterval(timerInterval);
        btn.innerText = "é–‹å§‹";
        btn.classList.remove("bg-red-500");
        btn.classList.add("bg-blue-500");
        calcFlowRate();
    }
}

function calcFlowRate() {
    const ccInput = document.getElementById("flow-cc");
    const timeText = document.getElementById("timer-display").innerText;
    const seconds = parseFloat(timeText);
    const cc = parseFloat(ccInput.value);
    
    if(seconds > 0 && cc > 0) {
        const liters = cc / 1000;
        const minutes = seconds / 60;
        const flowRate = liters / minutes;
        
        document.getElementById("res-flow-rate").innerText = `${flowRate.toFixed(2)} L/min`;
        
        const requiredWaterText = document.getElementById("res-refill-vol").innerText;
        const requiredWater = parseFloat(requiredWaterText);
        
        if(!isNaN(requiredWater)) {
             const refillTime = requiredWater / flowRate;
             document.getElementById("final-time").innerText = refillTime.toFixed(1);
        }
    }
}

// âœ¨ å·¥å…·ç®±é‚è¼¯
function calculateSoftWater() {
    const ppm = parseFloat(document.getElementById("soft-ppm").value);
    const resin = parseFloat(document.getElementById("soft-resin").value);
    
    const mode = document.getElementById("usage-mode").value;
    const val = parseFloat(document.getElementById("usage-val").value);

    if (!ppm || !resin || !val) {
        document.getElementById("soft-result").classList.add("hidden");
        return;
    }

    const isSafeMode = document.getElementById("soft-safe-mode").checked;

    // 1. ç¸½äº¤æ›èƒ½åŠ› (50000 ä¿‚æ•¸)
    const capacityTotal = resin * 50000; 
    
    // 2. æœ‰æ•ˆäº¤æ›é‡ (æ˜¯å¦æ‰“9æŠ˜)
    const effectiveCapacity = isSafeMode ? capacityTotal * 0.9 : capacityTotal;

    // 3. å¯ç”¨æ°´é‡ (å…¬å‡ & å™¸)
    const waterLiters = effectiveCapacity / ppm;
    const waterTons = waterLiters / 1000;

    // 4. æ¯æ—¥ç”¨æ°´ (å¤šç¨®æ¨¡å¼)
    let dailyUsage = 0;
    let usageText = ""; 

    if (mode === 'people') {
        dailyUsage = val * 250;
        usageText = `${val}äºº x 250L`;
    } else if (mode === 'manual') {
        dailyUsage = val;
        usageText = `è‡ªè¨‚ ${val}L`;
    } else if (mode === 'bill') {
        dailyUsage = (val * 1000) / 60;
        usageText = `æ°´è²»å–® ${val}åº¦ (ç´„ ${dailyUsage.toFixed(0)}L/æ—¥)`;
    }

    // 5. å¯ç”¨å¤©æ•¸
    const theoreticalDays = waterLiters / dailyUsage;
    
    // 6. å†ç”Ÿé€±æœŸ (æ‰£ä¸€å¤©å®‰å…¨å€¼)
    let cycle = Math.floor(theoreticalDays) - 1;
    if(cycle < 1) cycle = 1;
    
    // 7. è€—é¹½é‡ (kg)
    const saltKg = resin * 0.15;
    
    // 8. éœ€è£œæ°´é‡ (å…¬å‡)
    const refillWaterL = saltKg / 0.3;

    document.getElementById("res-days").innerText = cycle; 
    document.getElementById("res-water").innerText = `${waterTons.toFixed(1)} å™¸`;
    document.getElementById("res-salt").innerText = `${saltKg.toFixed(2)} kg`;
    document.getElementById("res-refill-vol").innerText = refillWaterL.toFixed(1);

    document.getElementById("soft-result").classList.remove("hidden");
    
    let formulaHtml = `<p>1. ç¸½äº¤æ›èƒ½åŠ› = æ¨¹è„‚ ${resin}L x 50,000 = ${capacityTotal.toLocaleString()} PPM</p>`;
    
    if(isSafeMode) {
         formulaHtml += `<p>2. å®‰å…¨äº¤æ›é‡ (9æŠ˜) = ${capacityTotal.toLocaleString()} x 0.9 = ${effectiveCapacity.toLocaleString()} PPM</p>`;
    } else {
         formulaHtml += `<p>2. äº¤æ›é‡ (ä¸æ‰“æŠ˜) = ${effectiveCapacity.toLocaleString()} PPM</p>`;
    }

    formulaHtml += `
        <p>3. å¯ç”¨æ°´é‡ = ${effectiveCapacity.toLocaleString()} Ã· ${ppm} = ${waterLiters.toFixed(0)} L (${waterTons.toFixed(2)} å™¸)</p>
        <p>4. æ¯æ—¥ç”¨æ°´ = ${usageText} = ${dailyUsage.toFixed(0)} L</p>
        <p>5. å†ç”Ÿé€±æœŸ = ${waterLiters.toFixed(0)} Ã· ${dailyUsage.toFixed(0)} = ${theoreticalDays.toFixed(1)} å¤© (æ¸›1å¤©å®‰å…¨å€¼ = ${cycle} å¤©)</p>
        <p>6. è€—é¹½é‡ = ${resin}L x 0.15 = ${saltKg.toFixed(2)} kg</p>
        <p>7. è£œæ°´é‡ = ${saltKg.toFixed(2)}kg Ã· 0.3 = ${refillWaterL.toFixed(1)} L</p>
    `;
    
    document.getElementById("formula-detail").innerHTML = formulaHtml;

    calcFlowRate(); 
}

function convertUnit(type) {
    if(type === 'psi') {
        const v = document.getElementById("conv-psi").value;
        document.getElementById("conv-kg").value = v ? (v * 0.0703).toFixed(2) : "";
    } else if (type === 'kg') {
        const v = document.getElementById("conv-kg").value;
        document.getElementById("conv-psi").value = v ? (v * 14.22).toFixed(1) : "";
    } else if (type === 'gpd') {
        const v = parseFloat(document.getElementById("conv-gpd").value);
        if(v) {
            const lpm = (v * 3.785 / 1440).toFixed(2);
            const gpm = (v / 1440).toFixed(2);
            document.getElementById("res-lpm").innerText = lpm;
            document.getElementById("res-gpm").innerText = gpm;
        } else {
            document.getElementById("res-lpm").innerText = "-";
            document.getElementById("res-gpm").innerText = "-";
        }
    } else if (type === 'inch') {
        const v = document.getElementById("conv-inch").value;
        document.getElementById("conv-cm").value = v ? (v * 2.54).toFixed(2) : "";
    } else if (type === 'cm') {
        const v = document.getElementById("conv-cm").value;
        document.getElementById("conv-inch").value = v ? (v / 2.54).toFixed(2) : "";
    }
    // âœ¨ 4. é›»é˜»ç‡ (MÎ©) â†” å°é›»åº¦ (Î¼S)
    else if (type === 'mohm') {
        const v = parseFloat(document.getElementById("conv-mohm").value);
        if (v > 0) {
            document.getElementById("conv-us").value = (1 / v).toFixed(4);
        } else {
            document.getElementById("conv-us").value = "";
        }
    }
    else if (type === 'us') {
        const v = parseFloat(document.getElementById("conv-us").value);
        if (v > 0) {
            document.getElementById("conv-mohm").value = (1 / v).toFixed(2);
        } else {
            document.getElementById("conv-mohm").value = "";
        }
    }
}

// ---------------------------
// æ ¸å¿ƒé‚è¼¯å€
// ---------------------------

function normalizeDateStr(v){
  if (!v) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const d = new Date(v);
  if (!isNaN(d)) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  return v.split(" ")[0];
}

async function apiCall(action, payload={}, method="POST"){
  if(!document.getElementById("loading").classList.contains("hidden") && document.getElementById("loading-text").innerText.includes("ä¸Šå‚³")) {
  } else {
      showLoading(true, "è™•ç†ä¸­â€¦");
  }
  
  try {
    const url = method==="GET" ? `${API_URL}?${new URLSearchParams({action, ...payload})}` : API_URL;
    const res = await fetch(url, {
      method,
      body: method==="POST" ? JSON.stringify({action, ...payload}) : null
    });
    const json = await res.json();
    return json;
  } catch(e){
    alert("é€£ç·šéŒ¯èª¤");
    return null;
  } finally {
    if(!payload.photos && action !== "uploadImage") { 
        showLoading(false); 
    }
  }
}

async function fetchCustomers(){
  const data = await apiCall("getCustomers", {}, "GET");
  const list = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : null);

  if (!list){
    document.getElementById("customer-list").innerHTML =
      `<div class="text-center text-gray-400 mt-20">è®€å–å¤±æ•—</div>`;
    return;
  }

  customers = list;
  updateDashboard(customers); 
  renderFilterBar();
  renderList(customers);
}


function updateDashboard(list) {
  let overdueCount = 0;
  let thisMonthCount = 0;
  const currentMonth = new Date().getMonth();

  list.forEach(c => {
    const status = getServiceStatus(c.lastRecordDate, c.cycle);
    if (status.type === 'overdue') {
      overdueCount++;
    } else {
      const nextD = new Date(status.nextDate);
      if (nextD.getMonth() === currentMonth) {
        thisMonthCount++;
      }
    }
  });

  document.getElementById("stat-overdue-val").innerText = overdueCount;
  document.getElementById("stat-month-val").innerText = thisMonthCount;
}

function toggleDashboardFilter(type) {
    const overdueCard = document.getElementById("card-overdue");
    const monthCard = document.getElementById("card-month");

    if (dashboardFilter === type) {
        dashboardFilter = null;
        overdueCard.classList.remove("active-filter");
        monthCard.classList.remove("active-filter");
    } else {
        dashboardFilter = type;
        overdueCard.classList.remove("active-filter");
        monthCard.classList.remove("active-filter");
        
        if (type === 'overdue') overdueCard.classList.add("active-filter");
        if (type === 'month') monthCard.classList.add("active-filter");
    }
    renderList(customers);
}


function renderFilterBar() {
    const container = document.getElementById("filter-container");
    container.innerHTML = TAG_OPTIONS.map(tag => 
        `<div class="filter-chip ${tag === currentFilter ? 'active' : ''}" onclick="filterByTag('${tag}')">${tag}</div>`
    ).join('');
}

function filterByTag(tag) {
    currentFilter = tag;
    dashboardFilter = null;
    document.getElementById("card-overdue").classList.remove("active-filter");
    document.getElementById("card-month").classList.remove("active-filter");

    renderFilterBar(); 
    renderList(customers);
}

function renderItemChips(containerId, inputId) {
    const container = document.getElementById(containerId);
    container.innerHTML = ITEM_OPTIONS.map(item => 
        `<div class="item-chip" onclick="addItemToInput('${inputId}', '${item}')">${item}</div>`
    ).join('');
}

function renderNoteChips(containerId, inputId) {
    const container = document.getElementById(containerId);
    container.innerHTML = NOTE_OPTIONS.map(item => 
        `<div class="item-chip" onclick="addItemToInput('${inputId}', '${item}')">${item}</div>`
    ).join('');
}

function renderPriceChips(containerId, inputId) {
    const container = document.getElementById(containerId);
    container.innerHTML = PRICE_OPTIONS.map(price => 
        `<div class="item-chip" onclick="setPriceInput('${inputId}', '${price}')">$${price}</div>`
    ).join('');
}

function setPriceInput(inputId, price) {
    document.getElementById(inputId).value = price;
}

function addItemToInput(inputId, itemText) {
    const input = document.getElementById(inputId);
    if (input.value) {
        input.value += `, ${itemText}`;
    } else {
        input.value = itemText;
    }
}

function sendLineReminder(e, name, nextDate) {
  if(e) e.stopPropagation(); 
  
  const text = `è¦ªæ„›çš„ ${name} æ‚¨å¥½ï¼š%0D%0A` +
               `æ‚¨çš„éæ¿¾å™¨è¨­å‚™é è¨ˆæ–¼ ${nextDate} éœ€è¦é€²è¡Œä¿é¤Šæ›´æ›ã€‚%0D%0A` +
               `ç‚ºäº†ç¢ºä¿é£²æ°´å“è³ªï¼Œå»ºè­°æ‚¨è¿‘æœŸå®‰æ’æ™‚é–“ã€‚%0D%0A` +
               `è‹¥éœ€é ç´„è«‹ç›´æ¥å›è¦†æ­¤è¨Šæ¯ï¼Œè¬è¬ï¼`;
               
  window.location.href = `https://line.me/R/msg/text/?${text}`;
}

function sendLineReport(name, date, items, amount, nextDate) {
  const text = `ã€ä¿é¤Šå®Œå·¥é€šçŸ¥ã€‘%0D%0A` +
               `è¦ªæ„›çš„ ${name} æ‚¨å¥½ï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒï¼%0D%0A` +
               `------------------%0D%0A` +
               `ğŸ“… æ—¥æœŸï¼š${date}%0D%0A` +
               `ğŸ› ï¸ é …ç›®ï¼š${items}%0D%0A` +
               `ğŸ’° é‡‘é¡ï¼š${amount} å…ƒ%0D%0A` +
               `------------------%0D%0A` +
               `ä¸‹æ¬¡ä¿é¤Šé è¨ˆï¼š${nextDate}%0D%0A` +
               `é™„ä¸Šæœ¬æ¬¡ä¿é¤Šç…§ç‰‡ä¾›æ‚¨ç•™å­˜ã€‚`;

  window.location.href = `https://line.me/R/msg/text/?${text}`;
}

function renderList(list){
  const container = document.getElementById("customer-list");
  container.innerHTML = "";

  let filtered = list;
  
  if (currentFilter !== "å…¨éƒ¨") {
      filtered = filtered.filter(c => c.tags && c.tags.includes(currentFilter));
  }
   
  const searchTerm = document.getElementById("search-input").value.toLowerCase();
  if (searchTerm) {
      filtered = filtered.filter(c => 
        c.name.toLowerCase().includes(searchTerm) || 
        c.phone.includes(searchTerm) || 
        (c.address && c.address.includes(searchTerm)) || 
        (c.note && c.note.toLowerCase().includes(searchTerm))
      );
  }

  if (dashboardFilter === 'overdue') {
      filtered = filtered.filter(c => getServiceStatus(c.lastRecordDate, c.cycle).type === 'overdue');
  } else if (dashboardFilter === 'month') {
      const currentMonth = new Date().getMonth();
      filtered = filtered.filter(c => {
          const status = getServiceStatus(c.lastRecordDate, c.cycle);
          if (status.type === 'overdue') return false; 
          return new Date(status.nextDate).getMonth() === currentMonth;
      });
  }

  filtered.sort((a, b) => {
      const statusA = getServiceStatus(a.lastRecordDate, a.cycle).score;
      const statusB = getServiceStatus(b.lastRecordDate, b.cycle).score;
      return statusB - statusA; 
  });

  if (!filtered.length){
    container.innerHTML = `<div class="text-center text-gray-400 mt-20">æš«ç„¡è³‡æ–™</div>`;
    return;
  }

  const isSearching = searchTerm || dashboardFilter;
  
  const groups = { overdue: [], soon: [], normal: [] };
  
  if (!isSearching) {
      filtered.forEach(c => {
          const type = getServiceStatus(c.lastRecordDate, c.cycle).type;
          if (type === 'overdue') groups.overdue.push(c);
          else if (type === 'soon') groups.soon.push(c);
          else groups.normal.push(c);
      });
      
      renderSection(container, "ğŸ”´ é€¾æœŸæœªä¿é¤Š", groups.overdue);
      renderSection(container, "ğŸŸ¡ å³å°‡åˆ°æœŸ (14å¤©å…§)", groups.soon);
      renderSection(container, "ğŸŸ¢ æ­£å¸¸", groups.normal);
  } else {
      renderSection(container, "", filtered);
  }
}

function renderSection(container, title, items) {
    if (items.length === 0) return;

    if (title) {
        const header = document.createElement("div");
        header.className = "section-header";
        header.innerText = `${title} (${items.length})`;
        container.appendChild(header);
    }

    const wrap = document.createElement("div");
    wrap.className = "space-y-3";

    items.forEach((c, index) => {
        const status = getServiceStatus(c.lastRecordDate, c.cycle);
        const last = c.lastRecordDate ? normalizeDateStr(c.lastRecordDate) : "å°šç„¡ç´€éŒ„";
        const machine = c.machine || "æœªå¡«å¯«æ©Ÿå‹";

        let cardClass = "dashboard-card border-l-4 animate-enter"; // âœ¨ åŠ ä¸Šå‹•ç•« class
        let statusHtml = "";
        let btnHtml = ""; 
        let progressHtml = ""; 

        let progressWidth = 0;
        let progressColor = "bar-green";
        
        if (c.cycle && c.lastRecordDate) {
            const today = new Date();
            const lastDate = new Date(c.lastRecordDate);
            const cycleDays = c.cycle * 30; 
            const daysPassed = (today - lastDate) / (1000 * 60 * 60 * 24);
            
            progressWidth = Math.min((daysPassed / cycleDays) * 100, 100);
            
            if (status.type === 'overdue') {
                progressColor = "bar-red";
                progressWidth = 100; 
            } else if (status.type === 'soon') {
                progressColor = "bar-yellow";
            }
            
            progressHtml = `<div class="progress-track"><div class="progress-bar ${progressColor}" style="width: ${progressWidth}%"></div></div>`;
        }

        if (status.type === 'overdue') {
            cardClass += " border-l-red-500 bg-red-50/30"; 
            statusHtml = `<div class="text-red-600 font-bold text-sm bg-red-100 px-2 py-1 rounded-md flex items-center">
                            <span class="material-icons text-sm mr-1">warning</span>éæœŸ ${status.days} å¤©
                          </div>`;
            btnHtml = `<button class="btn-line ml-2 flex-shrink-0" onclick="sendLineReminder(event, '${c.name}', '${status.nextDate}')">
                         <span class="material-icons text-sm">chat</span> æé†’
                       </button>`;

        } else if (status.type === 'soon') {
            cardClass += " border-l-yellow-500 bg-yellow-50/30";
            statusHtml = `<div class="text-yellow-700 font-bold text-sm bg-yellow-100 px-2 py-1 rounded-md flex items-center">
                            <span class="material-icons text-sm mr-1">schedule</span>å‰© ${status.days} å¤©
                          </div>`;
             btnHtml = `<button class="btn-line ml-2 flex-shrink-0" onclick="sendLineReminder(event, '${c.name}', '${status.nextDate}')">
                         <span class="material-icons text-sm">chat</span> æé†’
                       </button>`;
        } else {
            cardClass += " border-l-transparent hover:border-l-primary";
            if (c.cycle) {
                 statusHtml = `<div class="text-gray-400 text-xs">ä¸‹æ¬¡: ${status.nextDate}</div>`;
            }
        }

        const mapUrl = c.address ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address)}` : null;
        const mapBtn = mapUrl ? `<a href="${mapUrl}" target="_blank" onclick="event.stopPropagation()" class="action-btn-pill text-blue-600 bg-blue-50 ml-3"><span class="material-icons text-lg">near_me</span> å°èˆª</a>` : "";
        const phoneBtn = `<a href="tel:${c.phone}" onclick="event.stopPropagation()" class="action-btn-pill text-green-600 bg-green-50"><span class="material-icons text-lg">phone</span> é›»è©±</a>`;

        const card = document.createElement("div");
        card.className = cardClass;
        card.style.animationDelay = `${index * 0.05}s`; 
        card.onclick = ()=> openDetail(c);

        card.innerHTML = `
          <div class="card-content-row grow min-w-0 mb-1">
            <div class="flex items-center gap-2 min-w-0 flex-1">
                <div class="dashboard-name truncate text-navy-900 leading-tight">${c.name}</div>
                ${btnHtml} 
            </div>
            <div class="flex-shrink-0 ml-2">
                ${statusHtml} 
            </div>
          </div>

          <div class="flex gap-2 flex-wrap my-1 text-sm text-secondary">
            ${c.tags ? c.tags.split(",").map(t=>`<div class="dashboard-tag">${t}</div>`).join("") : ""}
          </div>

          <div class="card-content-row mt-1">
             <div class="text-sm text-secondary font-medium flex items-center gap-1 min-w-0">
                <span class="material-icons text-base text-gray-400">settings</span>
                <span class="truncate">${machine}</span>
             </div>
             <div class="text-right flex-shrink-0">
                 <div class="text-xs text-gray-400">ä¸Šæ¬¡ä¿é¤Š</div>
                 <div class="font-medium ${status.type === 'overdue' ? 'text-red-500' : 'text-gray-700'}">${last}</div>
             </div>
          </div>
          
          <div class="card-content-row mt-3">
             <div class="flex items-center">
                ${phoneBtn}
                ${mapBtn}
             </div>
             <div class="dashboard-chevron"><span class="material-icons">arrow_forward_ios</span></div>
          </div>

          ${progressHtml} 
        `;
        wrap.appendChild(card);
    });

    container.appendChild(wrap);
}

function getServiceStatus(lastDateStr, cycleMonths) {
    if (!lastDateStr || !cycleMonths) return { type: 'normal', score: 1 };
    
    const lastDate = new Date(lastDateStr);
    const nextDate = new Date(lastDate);
    nextDate.setMonth(nextDate.getMonth() + parseInt(cycleMonths));
    
    const today = new Date();
    today.setHours(0,0,0,0);
    
    const diffTime = nextDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const nextDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth()+1).padStart(2,'0')}-${String(nextDate.getDate()).padStart(2,'0')}`;

    if (diffDays < 0) {
        return { type: 'overdue', days: Math.abs(diffDays), nextDate: nextDateStr, score: 3 }; 
    } else if (diffDays <= 14) {
        return { type: 'soon', days: diffDays, nextDate: nextDateStr, score: 2 }; 
    } else {
        return { type: 'normal', days: diffDays, nextDate: nextDateStr, score: 1 }; 
    }
}

async function openDetail(c){
  lastScrollY = window.scrollY; 
  
  currentCustomer = c;
  document.getElementById("page-list").classList.add("hidden");
  document.getElementById("page-detail").classList.remove("hidden");
  window.scrollTo(0,0);

  document.getElementById("detail-name").innerText = c.name;
  document.getElementById("detail-phone").innerText = c.phone;
  document.getElementById("detail-phone-link").href = `tel:${c.phone}`;
  document.getElementById("detail-install-date").innerText = c.installDate ? normalizeDateStr(c.installDate) : "ç„¡ç´€éŒ„";
  document.getElementById("detail-total-spend").innerText = "è¨ˆç®—ä¸­...";

  const cycleText = c.cycle ? `${c.cycle} å€‹æœˆ` : "æœªè¨­å®š";
  document.getElementById("detail-cycle").innerText = cycleText;

  const addr = c.address || "";
  document.getElementById("detail-address").innerText = addr || "æœªå¡«å¯«";
  const mapLink = document.getElementById("detail-map-link");
  if (addr) {
      mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
      mapLink.classList.remove("hidden");
  } else {
      mapLink.classList.add("hidden");
  }

  document.getElementById("detail-machine").innerText = c.machine || "æœªå¡«å¯«";
  document.getElementById("detail-filter").innerText = c.filter || "æœªå¡«å¯«";

  const tagBox = document.getElementById("detail-tags");
  tagBox.innerHTML = c.tags ? c.tags.split(",").map(t=>`<div class="dashboard-tag">${t}</div>`).join("") : `<span class="text-secondary">æœªè¨­å®š</span>`;

  if (c.note){
    document.getElementById("detail-note").innerText = c.note;
    document.getElementById("note-container").classList.remove("hidden");
  } else {
    document.getElementById("note-container").classList.add("hidden");
  }

  const photoDiv = document.getElementById("customer-photos-container");
  photoDiv.innerHTML = "";
  let photos = [];
  if (Array.isArray(c.photos)) photos = c.photos;
  else if (typeof c.photos==="string" && c.photos.startsWith("[")) { try { photos = JSON.parse(c.photos); } catch {} }
   
  if (photos.length){
    photos.forEach(url=>{
      const img = document.createElement("img"); img.src = url; img.className = "photo-thumb cursor-pointer";
      img.onclick = ()=>openLightbox(url); 
      photoDiv.appendChild(img);
    });
  } else { photoDiv.innerHTML = `<div class="text-secondary text-sm">ç„¡ç…§ç‰‡</div>`; }

  await fetchRecords(c.id);
}

function goBack(){
  document.getElementById("page-detail").classList.add("hidden");
  document.getElementById("page-list").classList.remove("hidden");
  window.scrollTo(0, lastScrollY);
}

async function fetchRecords(id){
  const box = document.getElementById("record-list");
  box.innerHTML = `<div class="text-center text-secondary py-4">è®€å–ä¸­â€¦</div>`;
  const records = await apiCall("getRecords", {customerId:id}, "GET");
  if (!records.length){ 
      box.innerHTML = `<div class="text-secondary">å°šç„¡ç´€éŒ„</div>`; 
      document.getElementById("detail-total-spend").innerText = "NT$0 (0æ¬¡)"; 
      return; 
  }
  window.currentRecords = records;
  box.innerHTML = "";
  records.sort((a,b)=>new Date(b.date)-new Date(a.date));
  
  let total = 0;
  records.forEach(r => { total += parseInt(r.amount) || 0; });
  document.getElementById("detail-total-spend").innerText = `NT$${total.toLocaleString()} (å…± ${records.length} æ¬¡)`;
   
  records.forEach(r=>{
    const photos = Array.isArray(r.photos) ? r.photos : [];
    const item = document.createElement("div"); item.className = "timeline-item";
    item.innerHTML = `
      <div class="timeline-dot"></div>
      <div class="record-card">
        <div class="flex justify-between mb-2">
          <div class="record-date">${normalizeDateStr(r.date)}</div>
          <div class="record-amount">${r.amount ? "NT$"+r.amount : ""}</div>
        </div>
        <div class="font-medium mb-1">${r.items}</div>
        ${r.note ? `<div class="text-secondary text-sm mb-2">å‚™è¨»ï¼š${r.note}</div>` : ""}
        ${photos.length ? `<div class="flex gap-2 overflow-x-auto mb-2">${photos.map(p=>`<img class="photo-thumb cursor-pointer" src="${p}" onclick="openLightbox('${p}')">`).join("")}</div>` : ""}
        <div class="flex justify-end gap-3 text-primary mt-2 text-sm">
          <span class="cursor-pointer" onclick="openEditRecordModal('${r.id}')">ç·¨è¼¯</span>
          <span class="text-red-600 cursor-pointer" onclick="deleteRecord('${r.id}')">åˆªé™¤</span>
        </div>
      </div>`;
    box.appendChild(item);
  });
}

// âœ¨ ä¿®å¾©ï¼šè£œå›ç…§ç‰‡ç›¸é—œåŠŸèƒ½
function openLightbox(url){
  document.getElementById("lightbox-img").src = url;
  document.getElementById("lightbox").classList.add("active");
}

function closeLightbox(){
  document.getElementById("lightbox").classList.remove("active");
}

function renderPhotoEditor(containerId, existing, newPhotos, type){
  const box = document.getElementById(containerId);
  box.innerHTML = "";
  
  existing.forEach((url, idx) => {
    const div = document.createElement("div");
    div.className = "photo-wrapper";
    div.innerHTML = `<img src="${url}" class="photo-thumb-edit"><div class="btn-remove-photo" onclick="removeExistingPhoto('${type}', ${idx})">Ã—</div>`;
    box.appendChild(div);
  });
  
  newPhotos.forEach((base64, idx) => {
    const div = document.createElement("div");
    div.className = "photo-wrapper";
    div.innerHTML = `<img src="${base64}" class="photo-thumb-edit"><div class="btn-remove-photo" onclick="removeNewPhoto('${type}', ${idx})">Ã—</div>`;
    box.appendChild(div);
  });
}

function removeExistingPhoto(type, idx){
  if(type==='cust') { existingCustPhotos.splice(idx, 1); renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust'); } 
  else { existingRecordPhotos.splice(idx, 1); renderPhotoEditor("edit-record-photo-preview", existingRecordPhotos, selectedEditRecordPhotos, 'record'); }
}

function removeNewPhoto(type, idx){
  if(type==='cust') { selectedCustPhotos.splice(idx, 1); renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust'); } 
  else { selectedEditRecordPhotos.splice(idx, 1); renderPhotoEditor("edit-record-photo-preview", existingRecordPhotos, selectedEditRecordPhotos, 'record'); }
}

function openEditRecordModal(id){
  const r = window.currentRecords.find(x=>x.id==id);
  if (!r){ alert("æ‰¾ä¸åˆ°ç´€éŒ„"); return; }
  document.getElementById("edit-record-id").value = r.id;
  document.getElementById("edit-record-date").value = normalizeDateStr(r.date);
  document.getElementById("edit-record-items").value = r.items;
  document.getElementById("edit-record-amount").value = r.amount || "";
  document.getElementById("edit-record-note").value = r.note || "";
   
  existingRecordPhotos = [];
  if (r.photos && Array.isArray(r.photos)) { existingRecordPhotos = [...r.photos]; }
  selectedEditRecordPhotos = [];
  renderPhotoEditor("edit-record-photo-preview", existingRecordPhotos, selectedEditRecordPhotos, 'record');

  document.getElementById("record-modal").classList.remove("hidden");
}

async function saveEditedRecord(){
  const id = document.getElementById("edit-record-id").value;
  const items = document.getElementById("edit-record-items").value.trim();
  const date = document.getElementById("edit-record-date").value;
  if (!items){ alert("è«‹è¼¸å…¥é …ç›®"); return; }
   
  let photoUrls = [...existingRecordPhotos]; 
  let uploadedCount = 0;
  const totalUpload = selectedEditRecordPhotos.length;
  if(totalUpload > 0) showLoading(true, `æº–å‚™ä¸Šå‚³ ${totalUpload} å¼µç…§ç‰‡...`);

  for (let base64 of selectedEditRecordPhotos){
    uploadedCount++;
    showLoading(true, `æ­£åœ¨ä¸Šå‚³ç…§ç‰‡ (${uploadedCount}/${totalUpload})...`);
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }

  showLoading(true, "å„²å­˜è³‡æ–™ä¸­...");
  const payload = { id, date, items, amount: document.getElementById("edit-record-amount").value, note: document.getElementById("edit-record-note").value, photos: photoUrls };
  const res = await apiCall("updateRecord", payload);
  showLoading(false);

  if (res?.status==="success"){ closeModal("record-modal"); await fetchRecords(currentCustomer.id); renderList(customers); }
}

async function saveRecord(){
  if (!currentCustomer) return;
  const items = document.getElementById("record-items").value.trim();
  if (!items){ alert("è«‹è¼¸å…¥é …ç›®"); return; }
  
  let photoUrls = [];
  let uploadedCount = 0;
  const totalUpload = selectedRecordPhotos.length;
  if(totalUpload > 0) showLoading(true, `æº–å‚™ä¸Šå‚³ ${totalUpload} å¼µç…§ç‰‡...`);

  for (let base64 of selectedRecordPhotos){
    uploadedCount++;
    showLoading(true, `æ­£åœ¨ä¸Šå‚³ç…§ç‰‡ (${uploadedCount}/${totalUpload})...`);
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }

  showLoading(true, "å„²å­˜è³‡æ–™ä¸­...");
  const payload = { customerId: currentCustomer.id, date: document.getElementById("record-date").value, items, amount: document.getElementById("record-amount").value, note: document.getElementById("record-note").value, photos: photoUrls };
  const res = await apiCall("addRecord", payload);
  showLoading(false);

  if (res?.status==="success"){
    selectedRecordPhotos = [];
    document.getElementById("new-record-photos").innerHTML = "";
    document.getElementById("record-items").value=""; 
    document.getElementById("record-amount").value=""; 
    document.getElementById("record-note").value="";
    document.getElementById("record-photo-count").innerText = "0 å¼µ";

    await fetchRecords(currentCustomer.id);
    await fetchCustomers(); 

    let nextDateStr = "æœªè¨­å®š";
    if (currentCustomer.cycle) { const status = getServiceStatus(payload.date, currentCustomer.cycle); nextDateStr = status.nextDate; }
    
    setTimeout(() => {
        if(confirm("âœ… ç´€éŒ„å·²å„²å­˜ï¼\n\nè¦å‚³é€ã€Œå®Œå·¥çµæ¡ˆå ±å‘Šã€çµ¦å®¢æˆ¶å—ï¼Ÿ\n(å°‡é–‹å•Ÿ LINE è‡ªå‹•è²¼ä¸Šæ–‡å­—)")) {
            sendLineReport( currentCustomer.name, payload.date, payload.items, payload.amount, nextDateStr );
        } else { showToast("å„²å­˜æˆåŠŸ"); }
    }, 100);
  }
}

async function deleteRecord(id){
  if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
  await apiCall("deleteRecord", {id});
  await fetchRecords(currentCustomer.id);
}

async function saveCustomer(){
  const id = document.getElementById("cust-id").value;
  const name = document.getElementById("cust-name").value.trim();
  const phone = document.getElementById("cust-phone").value.trim();
   
  if (!name || !phone){ alert("å§“åã€é›»è©±å¿…å¡«"); return; }

  let safeExisting = Array.isArray(existingCustPhotos) ? existingCustPhotos : [];
  let photoUrls = [...safeExisting]; 
  let uploadedCount = 0;
  const totalUpload = selectedCustPhotos.length;
  if(totalUpload > 0) showLoading(true, `æº–å‚™ä¸Šå‚³ ${totalUpload} å¼µç…§ç‰‡...`);

  for (let base64 of selectedCustPhotos){
    uploadedCount++;
    showLoading(true, `æ­£åœ¨ä¸Šå‚³ç…§ç‰‡ (${uploadedCount}/${totalUpload})...`);
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status === "success") { photoUrls.push(res.url); }
  }

  showLoading(true, "å„²å­˜è³‡æ–™ä¸­...");
  const tags = getSelectedTags("cust-tag-selector");
  const payload = { id, name, phone, address: document.getElementById("cust-address").value, note: document.getElementById("cust-note").value, machine: document.getElementById("cust-machine").value, filter: document.getElementById("cust-filter").value, installDate: document.getElementById("cust-install-date").value, cycle: document.getElementById("cust-cycle").value, photos: photoUrls, tags };
  const act = id ? "updateCustomer" : "addCustomer";
  const res = await apiCall(act, payload);
  showLoading(false);
   
  if (res?.status === "success"){
    showToast("å„²å­˜æˆåŠŸ");
    closeModal("customer-modal"); 
    await fetchCustomers();
    if(id && currentCustomer) { openDetail({...currentCustomer, ...payload, photos: photoUrls}); }
  } else { alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦"); }
}

function showAddCustomerModal(){
  document.getElementById("modal-title").innerText = "æ–°å¢å®¢æˆ¶";
  document.getElementById("cust-id").value = "";
  document.getElementById("cust-name").value = "";
  document.getElementById("cust-phone").value = "";
  document.getElementById("cust-address").value = "";
  document.getElementById("cust-note").value = "";
  document.getElementById("cust-machine").value = "";
  document.getElementById("cust-filter").value = "";
  document.getElementById("cust-cycle").value = ""; 
  const d = new Date();
  document.getElementById("cust-install-date").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  selectedCustPhotos = []; existingCustPhotos = []; renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust');
  renderTagSelector("cust-tag-selector", []);
  document.getElementById("btn-delete-customer").classList.add("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}
    
function showEditCustomerModal(){
  const c = currentCustomer;
  document.getElementById("modal-title").innerText = "ç·¨è¼¯è³‡æ–™";
  document.getElementById("cust-id").value = c.id;
  document.getElementById("cust-name").value = c.name;
  document.getElementById("cust-phone").value = c.phone;
  document.getElementById("cust-address").value = c.address || "";
  document.getElementById("cust-note").value = c.note || "";
  document.getElementById("cust-machine").value = c.machine || "";
  document.getElementById("cust-filter").value = c.filter || "";
  document.getElementById("cust-cycle").value = c.cycle || "";
  document.getElementById("cust-install-date").value = c.installDate ? normalizeDateStr(c.installDate) : "";
  existingCustPhotos = [];
  if (c.photos) { if (Array.isArray(c.photos)) existingCustPhotos = [...c.photos]; else try { existingCustPhotos = JSON.parse(c.photos); } catch { existingCustPhotos = []; } }
  selectedCustPhotos = []; 
  renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust');
  renderTagSelector("cust-tag-selector", c.tags ? c.tags.split(",") : []);
  document.getElementById("btn-delete-customer").classList.remove("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

async function deleteCustomer(){
  if (!confirm("ç¢ºå®šåˆªé™¤æ­¤å®¢æˆ¶ï¼Ÿ")) return;
  await apiCall("deleteCustomer", {id: document.getElementById("cust-id").value});
  closeModal("customer-modal"); goBack(); fetchCustomers();
}

function renderTagSelector(containerId, selected=[]){
  const box = document.getElementById(containerId); box.innerHTML = "";
  TAG_OPTIONS.forEach(t=>{
    const div = document.createElement("div"); div.className = "tag" + (selected.includes(t) ? " active" : "");
    div.dataset.tag = t; div.innerText = t; div.onclick = ()=> div.classList.toggle("active");
    box.appendChild(div);
  });
}
function getSelectedTags(containerId){ return [...document.querySelectorAll(`#${containerId} .tag.active`)].map(x=>x.dataset.tag).join(","); }

function handleCustPhotoSelect(input){ handlePhotoSelect(input, selectedCustPhotos, null, null, () => { renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust'); }); }
function handleRecordPhotoSelect(input){ handlePhotoSelect(input, selectedRecordPhotos, "new-record-photos", "record-photo-count"); }
function handleEditRecordPhotoSelect(input){ handlePhotoSelect(input, selectedEditRecordPhotos, null, null, () => { renderPhotoEditor("edit-record-photo-preview", existingRecordPhotos, selectedEditRecordPhotos, 'record'); }); }

function handlePhotoSelect(input, arr, previewId, countId, callback){
  [...input.files].forEach(file=>{
    const reader = new FileReader();
    reader.onload = e => resizeImage(e.target.result, 900, out=>{
      arr.push(out); 
      if (previewId) { renderPreview(previewId, arr); } else if (callback) { callback(); }
      if(countId) document.getElementById(countId).innerText = `${arr.length} å¼µ`;
    });
    reader.readAsDataURL(file);
  });
  input.value = ""; 
}
    
function renderPreview(id, arr){ 
    document.getElementById(id).innerHTML = arr.map(src => `<img class="photo-thumb" src="${src}" onclick="openLightbox('${src}')">`).join(""); 
}

function resizeImage(base64, maxW, cb){
  const img = new Image(); img.src = base64;
  img.onload = ()=>{
    let w = img.width, h = img.height; if (w > maxW){ h *= maxW/w; w = maxW; }
    const c = document.createElement("canvas"); c.width = w; c.height = h;
    c.getContext("2d").drawImage(img,0,0,w,h); cb(c.toDataURL("image/jpeg",0.8));
  };
}

function closeModal(id){ document.getElementById(id).classList.add("hidden"); }
document.getElementById("customer-modal").addEventListener("click", e=>{ if (e.target.id==="customer-modal") closeModal("customer-modal"); });
document.getElementById("record-modal").addEventListener("click", e=>{ if (e.target.id==="record-modal") closeModal("record-modal"); });

function showLoading(show, text="è™•ç†ä¸­â€¦"){ 
    const loader = document.getElementById("loading");
    document.getElementById("loading-text").innerText = text;
    loader.classList.toggle("hidden", !show); 
}

function showToast(message) {
    const x = document.getElementById("toast"); x.innerText = message; x.className = "toast show";
    setTimeout(function(){ x.className = "toast"; }, 3000);
}

window.onload = () => {
  checkLogin(); // âœ¨ å•Ÿå‹•æª¢æŸ¥
  checkTheme();
  loadMemo(); 
  fetchCustomers(); 
  initCanvas(); 

  const rd = document.getElementById("record-date");
  if (rd){ const d = new Date(); rd.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  
  renderItemChips("new-record-item-chips", "record-items");
  renderNoteChips("new-record-note-chips", "record-note"); 
  renderPriceChips("new-record-price-chips", "record-amount"); 
  renderPriceChips("edit-record-price-chips", "edit-record-amount");

  renderItemChips("edit-record-item-chips", "edit-record-items");
  renderNoteChips("edit-record-note-chips", "edit-record-note"); 
};
</script>

</body>
</html>
