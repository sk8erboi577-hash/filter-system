<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>濾芯保養系統</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/water-filter.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      /* 深藍色主色調 */
      --primary: #0F3460;       /* 深藍 (Navy) */
      --primary-light: #16213E; /* 更深的藍 */
      --accent: #E94560;        /* 點綴色 (可選) */
      
      --bg-color: #F5F7FA;      /* 淺灰背景，讓深藍更突出 */
      --card-bg: #FFFFFF;
      
      --text-main: #1A1A1A;
      --text-sub: #666666;
      
      --border-radius: 16px;    /* 現代感大圓角 */
    }

    body {
      background-color: var(--bg-color);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding-bottom: 120px; /* 底部留白給 FAB */
      color: var(--text-main);
      -webkit-tap-highlight-color: transparent;
    }

    /* === 導覽列 === */
    .nav-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #E5E7EB;
      padding-top: env(safe-area-inset-top, 20px);
      padding-bottom: 12px;
      padding-left: 20px;
      padding-right: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .nav-title {
      font-size: 22px;
      font-weight: 800;
      color: var(--primary);
      letter-spacing: 0.5px;
    }
    .nav-btn {
      color: var(--primary);
      font-weight: 600;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    /* === 卡片樣式 (寬鬆、陰影) === */
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04); /* 柔和陰影 */
      border: 1px solid rgba(0,0,0,0.02);
    }

    /* === 輸入框 (大、清楚) === */
    .input-group { margin-bottom: 20px; }
    .input-label {
      display: block;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-sub);
      margin-bottom: 8px;
      margin-left: 4px;
    }
    input, select, textarea {
      width: 100%;
      padding: 16px;
      font-size: 17px;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      background: #F8FAFC;
      color: var(--text-main);
      transition: all 0.2s;
      appearance: none;
    }
    input:focus, textarea:focus {
      border-color: var(--primary);
      background: #FFF;
      outline: none;
      box-shadow: 0 0 0 4px rgba(15, 52, 96, 0.1);
    }

    /* === 按鈕 (深藍色、大) === */
    .btn-primary {
      background-color: var(--primary);
      color: white;
      padding: 16px;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      width: 100%;
      box-shadow: 0 4px 12px rgba(15, 52, 96, 0.3);
      transition: transform 0.1s;
    }
    .btn-primary:active { transform: scale(0.97); }

    .btn-danger {
      background-color: #FFF;
      color: #EF4444;
      border: 2px solid #FEE2E2;
      padding: 14px;
      border-radius: 14px;
      font-weight: 600;
      width: 100%;
      margin-top: 12px;
    }

    /* === FAB 懸浮按鈕 === */
    .fab {
      position: fixed;
      bottom: 40px;
      right: 30px;
      width: 64px;
      height: 64px;
      background-color: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      box-shadow: 0 8px 24px rgba(15, 52, 96, 0.4);
      z-index: 100;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.9); }

    /* === 列表項目 (寬鬆) === */
    .list-item {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      cursor: pointer;
    }
    .list-avatar {
      width: 50px; height: 50px;
      background: #E0E7FF;
      color: var(--primary);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 800;
      margin-right: 16px;
    }

    /* === 照片牆 === */
    .photo-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 4px;
      padding-bottom: 12px;
    }
    .photo-thumb {
      width: 100px; height: 100px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid #E2E8F0;
      flex-shrink: 0;
    }

    /* === Modal (彈出視窗) === */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: flex; align-items: flex-end; /* 手機版從下面滑出 */
      justify-content: center;
    }
    .modal-content {
      background: #FFF;
      width: 100%;
      max-width: 600px;
      height: 90vh; /* 佔據 90% 高度 */
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      display: flex; flex-direction: column;
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #F1F5F9;
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    /* === Loading === */
    .loading-overlay {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.8);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 999;
    }
    
    /* 隱藏元素 */
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="page-list" class="min-h-screen">
  <div class="nav-header">
    <div class="nav-title flex items-center">
      <span class="material-icons mr-2">water_drop</span>
      濾芯保養系統
    </div>
  </div>

  <div class="px-5 pt-6 pb-2 max-w-md mx-auto">
    <div class="relative">
      <span class="absolute left-4 top-4 text-gray-400">
        <span class="material-icons">search</span>
      </span>
      <input type="text" id="search-input" placeholder="搜尋客戶、電話..." 
             style="padding-left: 48px; border-radius: 99px; background: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
    </div>
  </div>

  <div id="customer-list" class="px-5 pt-4 pb-20 max-w-md mx-auto">
    <div class="text-center text-gray-400 mt-20">載入中...</div>
  </div>

  <div class="fab" onclick="showAddCustomerModal()">
    <span class="material-icons" style="font-size: 32px;">add</span>
  </div>
</div>

<div id="page-detail" class="hidden min-h-screen bg-gray-50">
  <div class="nav-header">
    <div class="nav-btn" onclick="goBack()">
      <span class="material-icons">arrow_back_ios</span>返回
    </div>
    <div class="nav-title" style="font-size: 18px;">客戶資料</div>
    <div class="nav-btn" onclick="showEditCustomerModal()">編輯</div>
  </div>

  <div class="p-5 max-w-md mx-auto space-y-6">
    
    <div class="card relative overflow-hidden">
      <div class="text-center mb-6">
        <h2 id="detail-name" class="text-3xl font-black text-gray-900 mb-2"></h2>
        <a id="detail-phone-link" class="inline-flex items-center justify-center bg-blue-50 text-blue-700 px-6 py-2 rounded-full font-bold text-lg">
          <span class="material-icons mr-2 text-xl">call</span>
          <span id="detail-phone"></span>
        </a>
      </div>

      <div class="flex justify-between items-center border-b border-gray-100 pb-4 mb-4">
        <span class="text-gray-500 font-bold">安裝日期</span>
        <span id="detail-install-date" class="text-xl font-bold text-gray-800"></span>
      </div>

      <div class="mb-4">
        <span class="text-gray-500 font-bold block mb-1">地址</span>
        <span id="detail-address" class="text-lg text-gray-800 font-medium"></span>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <span class="text-gray-500 font-bold block mb-1">機器</span>
          <span id="detail-machine" class="text-gray-800"></span>
        </div>
        <div>
          <span class="text-gray-500 font-bold block mb-1">濾芯</span>
          <span id="detail-filter" class="text-gray-800"></span>
        </div>
      </div>

      <div id="note-container" class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 hidden">
        <span class="text-yellow-700 font-bold block mb-1 flex items-center"><span class="material-icons text-sm mr-1">sticky_note_2</span>備註</span>
        <span id="detail-note" class="text-gray-800"></span>
      </div>

      <div class="mt-6">
        <span class="text-gray-500 font-bold block mb-3">機器照片</span>
        <div id="customer-photos-container" class="photo-scroll"></div>
      </div>
    </div>

    <div class="card" style="background: var(--primary); color: white;">
      <h3 class="font-bold text-xl mb-4 flex items-center">
        <span class="material-icons mr-2">post_add</span>新增紀錄
      </h3>
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label style="color: #A0AEC0;">日期</label>
          <input type="date" id="record-date" style="background: rgba(255,255,255,0.1); border: none; color: white;">
        </div>
        <div>
          <label style="color: #A0AEC0;">金額</label>
          <input type="number" id="record-amount" placeholder="0" 
                 style="background: rgba(255,255,255,0.1); border: none; color: #4ADE80; font-weight: bold;">
        </div>
      </div>

      <div class="mb-4">
        <label style="color: #A0AEC0;">更換項目</label>
        <input type="text" id="record-items" placeholder="例如: PP, 活性碳" 
               style="background: rgba(255,255,255,0.1); border: none; color: white;">
      </div>

      <div class="mb-4">
        <label style="color: #A0AEC0;">備註</label>
        <input type="text" id="record-note" placeholder="選填" 
               style="background: rgba(255,255,255,0.1); border: none; color: white;">
      </div>

      <div class="flex items-center gap-3 mb-6">
        <label class="bg-white/20 px-4 py-2 rounded-lg cursor-pointer flex items-center text-white font-bold hover:bg-white/30 transition">
          <span class="material-icons mr-2">camera_alt</span> 拍照
          <input type="file" id="record-photo-input" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)">
        </label>
        <span id="record-photo-count" class="text-gray-300 text-sm">未選照片</span>
      </div>
      <div id="new-record-photos" class="photo-scroll mb-4"></div>

      <button class="btn-primary" style="background: white; color: var(--primary);" onclick="saveRecord()">儲存紀錄</button>
    </div>

    <div>
      <h3 class="text-xl font-bold text-gray-700 mb-4 ml-1">歷史紀錄</h3>
      <div id="record-list" class="space-y-4"></div>
    </div>

  </div>
</div>

<div id="customer-modal" class="modal-backdrop hidden">
  <div class="modal-content">
    <div class="modal-header">
      <span class="nav-btn text-gray-500" onclick="closeModal('customer-modal')">取消</span>
      <span class="nav-title">新增客戶</span>
      <span class="nav-btn" onclick="saveCustomer()">儲存</span>
    </div>
    
    <div class="modal-body space-y-5">
      <input type="hidden" id="cust-id">
      
      <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
        <div class="input-group mb-0">
          <label class="input-label text-blue-800">姓名 <span class="text-red-500">*</span></label>
          <input type="text" id="cust-name" class="border-blue-200">
        </div>
        <div class="input-group mb-0 mt-4">
          <label class="input-label text-blue-800">電話 <span class="text-red-500">*</span></label>
          <input type="tel" id="cust-phone" class="border-blue-200 font-mono text-xl font-bold">
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">安裝日期</label>
        <input type="date" id="cust-install-date">
      </div>

      <div class="input-group">
        <label class="input-label">地址</label>
        <textarea id="cust-address" rows="2"></textarea>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="input-group">
          <label class="input-label">機器型號</label>
          <input type="text" id="cust-machine">
        </div>
        <div class="input-group">
          <label class="input-label">濾芯規格</label>
          <input type="text" id="cust-filter">
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">備註</label>
        <textarea id="cust-note" rows="2"></textarea>
      </div>

      <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:bg-gray-50 transition">
        <label class="cursor-pointer block w-full h-full">
          <span class="material-icons text-4xl text-gray-300 mb-2">add_photo_alternate</span>
          <div class="text-gray-600 font-bold">上傳機器照片</div>
          <input type="file" id="cust-photo-input" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
        </label>
        <div id="cust-photo-preview" class="photo-scroll mt-4 justify-center"></div>
      </div>

      <button id="btn-delete-customer" onclick="deleteCustomer()" class="btn-danger hidden">刪除此客戶</button>
      <div class="h-10"></div>
    </div>
  </div>
</div>

<div id="record-modal" class="modal-backdrop hidden">
  <div class="modal-content">
    <div class="modal-header">
      <span class="nav-btn text-gray-500" onclick="closeModal('record-modal')">取消</span>
      <span class="nav-title">修改紀錄</span>
      <span class="nav-btn" onclick="saveEditedRecord()">完成</span>
    </div>
    <div class="modal-body space-y-4">
      <input type="hidden" id="edit-record-id">
      
      <div class="input-group">
        <label class="input-label">日期</label>
        <input type="date" id="edit-record-date">
      </div>
      <div class="input-group">
        <label class="input-label">更換項目</label>
        <input type="text" id="edit-record-items" class="font-bold">
      </div>
      <div class="input-group">
        <label class="input-label">金額</label>
        <input type="number" id="edit-record-amount" class="text-green-600 font-bold text-xl">
      </div>
      <div class="input-group">
        <label class="input-label">備註</label>
        <textarea id="edit-record-note" rows="2"></textarea>
      </div>

      <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center">
        <label class="cursor-pointer">
          <span class="material-icons text-3xl text-gray-400">add_a_photo</span>
          <div class="text-sm font-bold text-gray-500 mt-1">加傳照片</div>
          <input type="file" id="edit-record-photo-input" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
        </label>
        <div id="edit-record-photo-preview" class="photo-scroll mt-3 justify-center"></div>
      </div>
    </div>
  </div>
</div>

<div id="loading" class="loading-overlay hidden">
  <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-100 border-t-blue-800 mb-4"></div>
    <p class="text-gray-600 font-bold text-lg">處理中...</p>
  </div>
</div>

<script>
// ⚠️⚠️⚠️ 記得換成你的 Apps Script 網址 ⚠️⚠️⚠️
const API_URL = "https://script.google.com/macros/s/AKfycbyIOBdYEHKOOS4TbG0abfyQWSOoll-RlkZvd08fU8_9VSMNQYgRSNmgeyg1IGUpquE/exec";

let customers = [];
let currentCustomer = null;
let selectedRecordPhotos = [];
let selectedCustPhotos = [];
let selectedEditRecordPhotos = [];

window.onload = () => {
    fetchCustomers();
    document.getElementById('record-date').valueAsDate = new Date();
};

async function apiCall(action, payload = {}, method = 'POST') {
    showLoading(true);
    try {
        if (payload.phone) payload.phone = String(payload.phone);
        const url = method === 'GET' 
            ? `${API_URL}?${new URLSearchParams({ action, ...payload })}` 
            : API_URL;
        const options = method === 'GET' ? {} : { method: 'POST', body: JSON.stringify({ action, ...payload }) };
        const res = await fetch(url, options);
        return await res.json();
    } catch (e) { alert("連線錯誤"); } finally { showLoading(false); }
}

async function fetchCustomers() {
    const data = await apiCall('getCustomers', {}, 'GET');
    if (Array.isArray(data)) { customers = data; renderList(customers); }
}

function renderList(list) {
    const container = document.getElementById('customer-list');
    container.innerHTML = '';
    if (list.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 mt-20">暫無資料</div>'; return; }
    
    list.forEach(c => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.onclick = () => openDetail(c);
        div.innerHTML = `
            <div class="list-avatar">${c.name.charAt(0)}</div>
            <div class="flex-1">
                <div class="font-bold text-xl text-gray-900">${c.name}</div>
                <div class="text-gray-500 font-mono">${c.phone}</div>
            </div>
            <span class="material-icons text-gray-300">chevron_right</span>
        `;
        container.appendChild(div);
    });
}

document.getElementById('search-input').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    renderList(customers.filter(c => c.name.toLowerCase().includes(term) || String(c.phone).includes(term) || (c.note && c.note.toLowerCase().includes(term))));
});

async function openDetail(customer) {
    currentCustomer = customer;
    document.getElementById('page-list').classList.add('hidden');
    document.getElementById('page-detail').classList.remove('hidden');
    window.scrollTo(0, 0);

    document.getElementById('detail-name').innerText = customer.name;
    document.getElementById('detail-phone').innerText = customer.phone;
    document.getElementById('detail-phone-link').href = `tel:${customer.phone}`;
    
    const dateEl = document.getElementById('detail-install-date');
    if (customer.installDate) {
        dateEl.innerText = customer.installDate.split('T')[0];
        dateEl.classList.remove('italic', 'text-gray-400');
    } else {
        dateEl.innerText = '未記錄';
        dateEl.classList.add('italic', 'text-gray-400');
    }

    setText('detail-address', customer.address);
    setText('detail-machine', customer.machine);
    setText('detail-filter', customer.filter);
    
    const noteContainer = document.getElementById('note-container');
    if (customer.note) {
        document.getElementById('detail-note').innerText = customer.note;
        noteContainer.classList.remove('hidden');
    } else { noteContainer.classList.add('hidden'); }
    
    const photoContainer = document.getElementById('customer-photos-container');
    photoContainer.innerHTML = '';
    let photos = [];
    if (customer.photos && Array.isArray(customer.photos)) photos = customer.photos;
    else if (customer.photos && customer.photos.startsWith('[')) try { photos = JSON.parse(customer.photos); } catch(e) { photos = [customer.photos]; }
    else if (customer.photos) photos = [customer.photos];

    if (photos.length > 0) {
        photos.forEach(url => {
            const img = document.createElement('img');
            img.src = url; img.className = 'photo-thumb cursor-pointer';
            img.onclick = () => window.open(url, '_blank');
            photoContainer.appendChild(img);
        });
    } else {
        photoContainer.innerHTML = '<div class="text-gray-400 text-sm">無照片</div>';
    }

    await fetchRecords(customer.id);
}

function setText(id, value) {
    const el = document.getElementById(id);
    if (value) { el.innerText = value; el.classList.remove('text-gray-400', 'italic'); }
    else { el.innerText = '未填寫'; el.classList.add('text-gray-400', 'italic'); }
}

function goBack() {
    document.getElementById('page-detail').classList.add('hidden');
    document.getElementById('page-list').classList.remove('hidden');
    currentCustomer = null;
    selectedRecordPhotos = [];
    renderRecordPhotoPreview();
}

async function fetchRecords(custId) {
    const listDiv = document.getElementById('record-list');
    listDiv.innerHTML = '<div class="text-center py-6 text-gray-400">讀取中...</div>';
    const records = await apiCall('getRecords', { customerId: custId }, 'GET');
    listDiv.innerHTML = '';

    if (!records || records.length === 0) {
        listDiv.innerHTML = '<div class="text-center py-6 text-gray-400">尚無紀錄</div>'; return;
    }

    records.forEach(r => {
        const photos = r.photos ? JSON.parse(r.photos) : [];
        const rData = JSON.stringify(r).replace(/"/g, '&quot;'); 
        
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-100">
                <div class="font-bold text-xl text-gray-900">${r.date.split('T')[0]}</div>
                ${r.amount ? `<div class="text-green-600 font-bold font-mono text-xl">NT$${r.amount}</div>` : ''}
            </div>
            
            <div class="mb-3">
                <div class="text-gray-400 text-xs font-bold uppercase mb-1">更換項目</div>
                <div class="text-2xl font-black text-gray-800 leading-tight">${r.items}</div>
            </div>
            
            ${r.note ? `
                <div class="mb-3 bg-gray-50 p-3 rounded-lg">
                     <span class="font-bold text-gray-500 text-xs">備註：</span>
                     <span class="text-gray-700 font-medium">${r.note}</span>
                </div>` : ''}
            
            ${photos.length > 0 ? `<div class="photo-scroll mb-3">${photos.map(url => `<img src="${url}" class="photo-thumb cursor-pointer" onclick="window.open('${url}')">`).join('')}</div>` : ''}
            
            <div class="flex justify-end gap-3 mt-2">
                <button onclick="openEditRecordModal('${rData}')" class="text-blue-600 font-bold px-3 py-2 bg-blue-50 rounded-lg text-sm">編輯</button>
                <button onclick="deleteRecord('${r.id}')" class="text-red-500 font-bold px-3 py-2 bg-red-50 rounded-lg text-sm">刪除</button>
            </div>
        `;
        listDiv.appendChild(div);
    });
}

function openEditRecordModal(recordStr) {
    const record = JSON.parse(recordStr);
    document.getElementById('edit-record-id').value = record.id;
    document.getElementById('edit-record-date').value = record.date.split('T')[0];
    document.getElementById('edit-record-items').value = record.items;
    document.getElementById('edit-record-amount').value = record.amount;
    document.getElementById('edit-record-note').value = record.note;
    selectedEditRecordPhotos = []; 
    document.getElementById('edit-record-photo-preview').innerHTML = '';
    document.getElementById('record-modal').classList.remove('hidden');
}

async function saveEditedRecord() {
    const id = document.getElementById('edit-record-id').value;
    const items = document.getElementById('edit-record-items').value;
    if (!items) return alert("請輸入項目");

    let photoUrls = [];
    if (selectedEditRecordPhotos.length > 0) {
        showLoading(true);
        for (let base64 of selectedEditRecordPhotos) {
            const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
            if (res.status === 'success') photoUrls.push(res.url);
        }
    }

    const payload = {
        id: id,
        date: document.getElementById('edit-record-date').value,
        items: items,
        amount: document.getElementById('edit-record-amount').value,
        note: document.getElementById('edit-record-note').value,
        photos: photoUrls 
    };

    const res = await apiCall('updateRecord', payload);
    if (res.status === 'success') {
        closeModal('record-modal');
        fetchRecords(currentCustomer.id);
    } else { alert("修改失敗"); }
}

function handleEditRecordPhotoSelect(input) {
    const files = input.files; if (!files.length) return;
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedEditRecordPhotos.push(res); renderPhotoList('edit-record-photo-preview', selectedEditRecordPhotos); });
        reader.readAsDataURL(file);
    });
    input.value = '';
}

async function saveRecord() {
    if (!currentCustomer) return;
    const items = document.getElementById('record-items').value;
    if (!items) return alert("請輸入項目");

    let photoUrls = [];
    if (selectedRecordPhotos.length > 0) {
        showLoading(true);
        for (let base64 of selectedRecordPhotos) {
            const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
            if (res.status === 'success') photoUrls.push(res.url);
        }
    }

    const payload = {
        customerId: currentCustomer.id,
        date: document.getElementById('record-date').value,
        items: items,
        amount: document.getElementById('record-amount').value,
        note: document.getElementById('record-note').value,
        photos: photoUrls
    };

    const res = await apiCall('addRecord', payload);
    if (res.status === 'success') {
        document.getElementById('record-items').value = '';
        document.getElementById('record-amount').value = '';
        document.getElementById('record-note').value = '';
        selectedRecordPhotos = [];
        renderRecordPhotoPreview();
        fetchRecords(currentCustomer.id);
        document.getElementById('record-list').scrollIntoView({ behavior: 'smooth' });
    } else { alert("失敗"); }
}

async function deleteRecord(id) {
    if (confirm("確定刪除此紀錄？")) {
        await apiCall('deleteRecord', { id });
        fetchRecords(currentCustomer.id);
    }
}

function resizeImage(base64, maxWidth, callback) {
    const img = new Image(); img.src = base64;
    img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width; let height = img.height;
        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        callback(canvas.toDataURL('image/jpeg', 0.8));
    };
}

function handleRecordPhotoSelect(input) {
    const files = input.files; if (!files.length) return;
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedRecordPhotos.push(res); renderRecordPhotoPreview(); });
        reader.readAsDataURL(file);
    });
    input.value = '';
}
function renderRecordPhotoPreview() {
    renderPhotoList('new-record-photos', selectedRecordPhotos);
    document.getElementById('record-photo-count').innerText = selectedRecordPhotos.length ? selectedRecordPhotos.length + ' 張' : '未選照片';
}

function handleCustPhotoSelect(input) {
    const files = input.files; if (!files.length) return;
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedCustPhotos.push(res); renderPhotoList('cust-photo-preview', selectedCustPhotos); });
        reader.readAsDataURL(file);
    });
    input.value = '';
}

function renderPhotoList(divId, photoArray) {
    const div = document.getElementById(divId);
    div.innerHTML = photoArray.map((src, idx) => `
        <div class="relative flex-shrink-0"><img src="${src}" class="photo-thumb"><button onclick="removePhoto('${divId}', ${idx})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-sm">×</button></div>
    `).join('');
}

function removePhoto(divId, idx) {
    if (divId === 'new-record-photos') { selectedRecordPhotos.splice(idx, 1); renderRecordPhotoPreview(); }
    else if (divId === 'cust-photo-preview') { selectedCustPhotos.splice(idx, 1); renderPhotoList('cust-photo-preview', selectedCustPhotos); }
    else if (divId === 'edit-record-photo-preview') { selectedEditRecordPhotos.splice(idx, 1); renderPhotoList('edit-record-photo-preview', selectedEditRecordPhotos); }
}

function showAddCustomerModal() {
    document.getElementById('modal-title').innerText = '新增客戶';
    document.getElementById('cust-id').value = '';
    document.getElementById('cust-name').value = '';
    document.getElementById('cust-phone').value = '';
    document.getElementById('cust-address').value = '';
    document.getElementById('cust-note').value = '';
    document.getElementById('cust-machine').value = '';
    document.getElementById('cust-filter').value = '';
    document.getElementById('cust-install-date').value = new Date().toISOString().split('T')[0];
    selectedCustPhotos = []; renderPhotoList('cust-photo-preview', []);
    document.getElementById('btn-delete-customer').classList.add('hidden');
    document.getElementById('customer-modal').classList.remove('hidden');
}

function showEditCustomerModal() {
    if (!currentCustomer) return;
    document.getElementById('modal-title').innerText = '編輯資料';
    document.getElementById('cust-id').value = currentCustomer.id;
    document.getElementById('cust-name').value = currentCustomer.name;
    document.getElementById('cust-phone').value = currentCustomer.phone;
    document.getElementById('cust-address').value = currentCustomer.address;
    document.getElementById('cust-note').value = currentCustomer.note;
    document.getElementById('cust-machine').value = currentCustomer.machine;
    document.getElementById('cust-filter').value = currentCustomer.filter;
    document.getElementById('cust-install-date').value = currentCustomer.installDate ? currentCustomer.installDate.split('T')[0] : '';
    selectedCustPhotos = []; renderPhotoList('cust-photo-preview', []);
    document.getElementById('btn-delete-customer').classList.remove('hidden');
    document.getElementById('customer-modal').classList.remove('hidden');
}

function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

async function saveCustomer() {
    const id = document.getElementById('cust-id').value;
    const name = document.getElementById('cust-name').value;
    const phone = document.getElementById('cust-phone').value;
    if (!name || !phone) return alert("姓名電話必填");

    let photoUrls = [];
    if (id && currentCustomer && currentCustomer.photos) {
            if (Array.isArray(currentCustomer.photos)) photoUrls = [...currentCustomer.photos];
            else try { photoUrls = JSON.parse(currentCustomer.photos); } catch(e) { photoUrls = [currentCustomer.photos]; }
    }
    if (selectedCustPhotos.length > 0) {
        showLoading(true);
        for (let base64 of selectedCustPhotos) {
            const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
            if (res.status === 'success') photoUrls.push(res.url);
        }
    }

    const payload = {
        id: id, name: name, phone: phone,
        address: document.getElementById('cust-address').value,
        note: document.getElementById('cust-note').value,
        machine: document.getElementById('cust-machine').value,
        filter: document.getElementById('cust-filter').value,
        installDate: document.getElementById('cust-install-date').value,
        photos: photoUrls 
    };

    const action = id ? 'updateCustomer' : 'addCustomer';
    const res = await apiCall(action, payload);
    
    if (res.status === 'success') {
        closeModal('customer-modal'); fetchCustomers();
        if (id && currentCustomer) openDetail({ ...currentCustomer, ...payload, photos: photoUrls });
    } else { alert("失敗"); }
}

async function deleteCustomer() {
    if (confirm("確定刪除此客戶？")) {
        await apiCall('deleteCustomer', { id: document.getElementById('cust-id').value });
        closeModal('customer-modal'); goBack(); fetchCustomers();
    }
}

function showLoading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }
document.getElementById('customer-modal').addEventListener('click', e => { if (e.target.id === 'customer-modal') closeModal('customer-modal'); });
document.getElementById('record-modal').addEventListener('click', e => { if (e.target.id === 'record-modal') closeModal('record-modal'); });
</script>
</body>
</html>
