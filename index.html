<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>濾芯保養系統</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --primary: #007AFF;
      --primary-light: #64A8FF;
      --milk-bg: #F5EFE7;
      --milk-card: #FFFFFF;
      --milk-border: #E6E2DA;
      --milk-input: #F9F7F2;
      --text-main: #3A342E;
      --text-secondary: #6E655C;
    }

    html { font-size: 18px; }
    body {
      background: var(--milk-bg);
      margin: 0;
      padding-bottom: 100px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC",
        Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-main);
    }

    /* iOS Navigation Bar */
    .ios-nav-bar {
      position: sticky;
      top: 0;
      padding: 12px 16px;
      padding-top: env(safe-area-inset-top, 16px);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--milk-border);
      z-index: 50;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .ios-nav-left, .ios-nav-right {
      display:flex;
      align-items:center;
      color:var(--primary);
      font-size:16px;
      gap:4px;
      cursor:pointer;
    }
    .ios-nav-title {
      font-size:18px;
      font-weight:600;
      color:var(--text-main);
    }

    /* 搜尋列 */
    .search-bar {
      background: #FFF;
      border-radius: 14px;
      padding: 10px;
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--milk-border);
    }
    .search-bar input {
      width:100%;
      border:none;
      background:transparent;
      font-size:16px;
    }
    .search-bar input:focus { outline:none; }

    /* 篩選器樣式 */
    .filter-scroll {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 4px 0;
      margin-top: 12px;
      -webkit-overflow-scrolling: touch;
    }
    .filter-scroll::-webkit-scrollbar { display: none; }
    .filter-chip {
      padding: 6px 14px;
      background: #EFEDE7;
      border: 1px solid var(--milk-border);
      border-radius: 20px;
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      font-weight: 600;
    }

    /* 列表卡片 */
    .dashboard-card {
      background: var(--milk-card);
      border-radius: 18px;
      border:1px solid var(--milk-border);
      padding:16px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 6px 16px rgba(0,0,0,0.06);
      cursor:pointer;
      transition:.12s;
    }
    .dashboard-card:active { transform:scale(.97); }

    .dashboard-name { font-size:20px; font-weight:700; }

    .dashboard-tag {
      display:inline-flex;
      padding:3px 10px;
      background:#EFEDE7;
      border:1px solid var(--milk-border);
      border-radius:999px;
      font-size:12px;
      color:var(--text-secondary);
      margin:4px 0;
    }

    .dashboard-chevron {
      width:32px; height:32px;
      background:#F2F0EB;
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
    }

    /* Timeline（保養紀錄） */
    .timeline-item {
      position:relative;
      margin-bottom:18px;
      padding-left:20px;
    }
    .timeline-item::before {
      content:"";
      position:absolute;
      left:9px; top:0; bottom:-8px;
      width:2px;
      background:var(--milk-border);
    }
    .timeline-dot {
      position:absolute;
      left:4px; top:8px;
      width:12px; height:12px;
      background:white;
      border:3px solid var(--primary);
      border-radius:50%;
    }
    .record-card {
      background:var(--milk-card);
      border:1px solid var(--milk-border);
      padding:14px;
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
    }
    .record-date { font-weight:600; }
    .record-amount { color:#008A32; font-weight:700; }

    /* 標籤與按鈕樣式 */
    .tag-selector, .chip-container { display:flex; flex-wrap:wrap; gap:8px; }
    .tag, .item-chip {
      padding:6px 12px;
      background:#EFEDE7;
      border:1px solid var(--milk-border);
      border-radius:999px;
      font-size:14px;
      cursor:pointer;
      transition:0.15s;
      user-select:none;
      color:#5F564D;
    }
    .tag.active {
      background:var(--primary);
      border-color:var(--primary);
      color:white;
    }
    .item-chip {
        background-color: #E3F2FD;
        color: #1565C0;
        border-color: #BBDEFB;
        font-weight: 600;
        margin-top: 4px;
    }
    .item-chip:active {
        background-color: #2196F3;
        color: white;
    }

    /* 照片 */
    .photo-thumb {
      width:90px; height:90px; object-fit:cover;
      border-radius:12px;
      border:1px solid var(--milk-border);
      background:#E5E2DC;
    }

    /* Loading */
    .loading-overlay {
      position:fixed; inset:0;
      background:rgba(255,255,255,0.65);
      backdrop-filter:blur(8px);
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; z-index:999;
    }

    /* Sheet / Modal */
    .sheet-backdrop { background: rgba(0,0,0,0.4); backdrop-filter:blur(2px); }
    .sheet { background: #fff; max-height: 90vh; display: flex; flex-direction: column; }
    .sheet-grabber { width: 40px; height: 5px; background: #E0E0E0; border-radius: 99px; margin: 10px auto 0; }
    .sheet-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-bottom: 1px solid #eee; }
    .sheet-title { font-weight: 700; font-size: 18px; }
    .sheet-btn-text { color: var(--primary); font-size: 16px; }
    .sheet-body { padding: 16px; overflow-y: auto; }
    
    /* 隱藏原生樣式 */
    input, textarea, select { -webkit-appearance: none; appearance: none; }
    .hidden { display: none !important; }
    .danger-btn { width: 100%; color: #ff3b30; background: #fff0f0; padding: 12px; border-radius: 12px; font-weight: 600; margin-top: 10px; }

    /* Toast */
    .toast {
      visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 17px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
    }
    .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
  </style>
</head>

<body>

<div id="page-list" class="min-h-screen">
  <div class="pt-10 pb-4 px-4 max-w-md mx-auto">
    <div class="flex justify-between items-center mb-4">
        <div class="text-3xl font-bold text-gray-800 tracking-tight">濾芯保養系統</div>
        <button onclick="fetchCustomers()" class="w-10 h-10 bg-white rounded-full shadow-sm border border-gray-100 flex items-center justify-center text-blue-600 active:scale-90 active:bg-blue-50 transition-all">
          <span class="material-icons">refresh</span>
        </button>
    </div>

    <div class="search-bar">
      <span class="material-icons text-gray-400">search</span>
      <input id="search-input" type="text" placeholder="搜尋客戶名稱、電話或備註…">
    </div>
    
    <div id="filter-container" class="filter-scroll"></div>
  </div>

  <div id="customer-list" class="max-w-md mx-auto px-4 pt-2 pb-20">
    <div class="text-center text-gray-400 mt-20">載入中…</div>
  </div>

  <div class="fixed right-6 bottom-8 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-xl text-3xl cursor-pointer z-40" onclick="showAddCustomerModal()">
    <span class="material-icons">add</span>
  </div>
</div>

<div id="page-detail" class="hidden min-h-screen">
  <div class="ios-nav-bar">
    <div class="ios-nav-left" onclick="goBack()">
      <span class="material-icons">arrow_back_ios</span> 返回
    </div>
    <div class="ios-nav-title">客戶資料</div>
    <div class="ios-nav-right" onclick="showEditCustomerModal()">編輯</div>
  </div>

  <div class="pb-4 px-4 max-w-md mx-auto">
    <div class="mt-4 mb-4">
      <div id="customer-photos-container" class="flex gap-3 overflow-x-auto"></div>
    </div>

    <div class="record-card mb-4">
      <div class="font-bold mb-2 text-gray-500 text-xs tracking-widest">基本資料</div>
      <div class="flex py-1"><span class="w-20 text-secondary">姓名</span><span id="detail-name"></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">電話</span><span><a id="detail-phone-link" class="text-blue-600 font-medium flex items-center"><span class="material-icons mr-1 text-base">phone</span><span id="detail-phone"></span></a></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">安裝日期</span><span id="detail-install-date" class="text-gray-400 italic">無紀錄</span></div>
      <div class="flex py-1 items-start"><span class="w-20 text-secondary pt-1">標籤</span><div id="detail-tags" class="flex flex-wrap gap-2 flex-1"></div></div>
      <div class="flex py-1"><span class="w-20 text-secondary">保養週期</span><span id="detail-cycle" class="text-gray-800"></span></div>
    </div>

    <div class="record-card mb-4">
      <div class="font-bold mb-2 text-gray-500 text-xs tracking-widest">設備資訊</div>
      
      <div class="flex py-1 items-center">
        <span class="w-20 text-secondary flex-shrink-0">地址</span>
        <div class="flex-1 flex items-center justify-between">
           <span id="detail-address"></span>
           <a id="detail-map-link" target="_blank" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-sm font-bold flex items-center ml-2 hidden no-underline">
              <span class="material-icons text-base mr-1">near_me</span>導航
           </a>
        </div>
      </div>

      <div class="flex py-1"><span class="w-20 text-secondary">機器</span><span id="detail-machine"></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">濾芯</span><span id="detail-filter"></span></div>
      <div id="note-container" class="flex py-1 hidden"><span class="w-20 text-secondary">備註</span><span id="detail-note"></span></div>
    </div>

    <div class="record-card mb-4">
      <div class="font-bold mb-3 text-gray-500 text-xs tracking-widest">新增保養紀錄</div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div><div class="text-secondary text-sm mb-1">日期</div><input type="date" id="record-date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2"></div>
        <div><div class="text-secondary text-sm mb-1">金額</div><input type="number" id="record-amount" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2" placeholder="0"></div>
      </div>
      <div class="mb-3">
        <div class="text-secondary text-sm mb-1">更換項目</div>
        <input id="record-items" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2" placeholder="例如：PP、活性碳">
        <div id="new-record-item-chips" class="chip-container"></div>
      </div>
      <div class="mb-3"><div class="text-secondary text-sm mb-1">備註</div><input id="record-note" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2"></div>
      
      <div class="flex gap-3 mb-3 items-center">
        <label class="bg-gray-100 text-blue-600 px-3 py-1 rounded cursor-pointer flex items-center font-medium">
          <span class="material-icons mr-1">camera_alt</span>拍照
          <input id="record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)">
        </label>
        <span id="record-photo-count" class="text-sm text-secondary">0 張</span>
      </div>
      <div id="new-record-photos" class="flex gap-2 overflow-x-auto mb-3"></div>
      <button class="w-full bg-blue-600 text-white rounded-xl py-3 text-lg font-semibold shadow active:scale-95 transition-transform" onclick="saveRecord()">儲存紀錄</button>
    </div>

    <div>
      <div class="font-bold text-gray-500 text-xs tracking-widest mb-2">歷史紀錄</div>
      <div id="record-list" class="mt-3"></div>
    </div>
  </div>
</div>

<div id="customer-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col rounded-t-2xl sm:rounded-2xl">
    <div class="sheet-grabber"></div>
    <div class="sheet-header">
      <button onclick="closeModal('customer-modal')" class="sheet-btn-text">取消</button>
      <h2 id="modal-title" class="sheet-title">新增客戶</h2>
      <button onclick="saveCustomer()" class="sheet-btn-text font-semibold">儲存</button>
    </div>
    <div class="sheet-body space-y-4 bg-gray-50">
      <input type="hidden" id="cust-id">
      
      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div><label>姓名 <span class="text-red-500">*</span></label><input id="cust-name" type="text" class="w-full p-2 border rounded"></div>
        <div><label>電話 <span class="text-red-500">*</span></label><input id="cust-phone" type="tel" class="w-full p-2 border rounded"></div>
        <div><label>安裝日期</label><input id="cust-install-date" type="date" class="w-full p-2 border rounded"></div>
      </div>

      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div><label>地址</label><input id="cust-address" type="text" class="w-full p-2 border rounded"></div>
        <div><label>機器型號</label><input id="cust-machine" type="text" class="w-full p-2 border rounded"></div>
        <div><label>濾芯規格</label><input id="cust-filter" type="text" class="w-full p-2 border rounded"></div>
      </div>

      <div class="space-y-2 bg-white rounded-xl p-4 shadow-sm">
        <label>分類標籤</label>
        <div id="cust-tag-selector" class="tag-selector mb-3"></div>
        
        <label>保養週期</label>
        <select id="cust-cycle" class="w-full p-2 border rounded bg-white mt-1">
            <option value="">未設定</option>
            <option value="3">3 個月</option>
            <option value="6">6 個月</option>
            <option value="9">9 個月</option>
            <option value="12">1 年</option>
            <option value="24">2 年</option>
        </select>
      </div>

      <div class="bg-white rounded-xl p-4 shadow-sm">
        <label>備註</label>
        <textarea id="cust-note" rows="2" class="w-full p-2 border rounded"></textarea>
      </div>

      <div class="bg-white rounded-xl p-4 shadow-sm text-center">
        <label class="text-blue-600 font-medium flex items-center justify-center cursor-pointer p-2 border-2 border-dashed border-blue-200 rounded-lg">
          <span class="material-icons mr-2">add_photo_alternate</span> 選擇機器照片
          <input id="cust-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
        </label>
        <div id="cust-photo-preview" class="photo-grid mt-2 justify-center flex gap-2 overflow-x-auto"></div>
      </div>

      <button id="btn-delete-customer" onclick="deleteCustomer()" class="danger-btn hidden">刪除此客戶</button>
      <div class="h-10"></div>
    </div>
  </div>
</div>

<div id="record-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col rounded-t-2xl sm:rounded-2xl">
    <div class="sheet-grabber"></div>
    <div class="sheet-header">
      <button onclick="closeModal('record-modal')" class="sheet-btn-text">取消</button>
      <h2 class="sheet-title">修改紀錄</h2>
      <button onclick="saveEditedRecord()" class="sheet-btn-text font-semibold">完成</button>
    </div>
    <div class="sheet-body space-y-4 bg-gray-50">
      <input type="hidden" id="edit-record-id">
      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div><label>日期</label><input id="edit-record-date" type="date" class="w-full p-2 border rounded"></div>
        <div>
          <label>項目</label>
          <input id="edit-record-items" type="text" class="w-full p-2 border rounded font-medium">
          <div id="edit-record-item-chips" class="chip-container"></div>
        </div>
        <div><label>金額</label><input id="edit-record-amount" type="number" class="w-full p-2 border rounded text-green-600 font-bold"></div>
        <div><label>備註</label><textarea id="edit-record-note" rows="2" class="w-full p-2 border rounded"></textarea></div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm">
        <label class="text-blue-600 font-medium flex items-center justify-center cursor-pointer p-2 border-2 border-dashed border-blue-200 rounded-lg">
          <span class="material-icons mr-2">add_a_photo</span> 加傳照片
          <input id="edit-record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
        </label>
        <div id="edit-record-photo-preview" class="photo-grid mt-2 justify-center flex gap-2 overflow-x-auto"></div>
      </div>
      <div class="h-10"></div>
    </div>
  </div>
</div>

<div id="loading" class="loading-overlay hidden">
  <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-300 border-t-blue-600"></div>
  <p class="mt-3 text-secondary">處理中…</p>
</div>
<div id="toast" class="toast"></div>

<script>
// ⚠️⚠️⚠️ 記得換成你的 Apps Script 網址 ⚠️⚠️⚠️
const API_URL = "https://script.google.com/macros/s/AKfycbyOzg78yqgVwWkKkQM2V67Gmaicrh-ilnZ5SZ1FXq449cO4iO1nU46i5tO1xiyVZ9s/exec";

// 標籤選項
const TAG_OPTIONS = ["全部", "廚下型", "飲水機", "全戶式", "工業商業", "售服", "其他"];
// 常用維修項目
const ITEM_OPTIONS = ["PP", "UDFC","CTO","UDFR", "RO膜","大T", "小T", "保養","代更換", "維修"];

let currentFilter = "全部";

let customers = [];
let currentCustomer = null;

let selectedCustPhotos = [];
let selectedRecordPhotos = [];
let selectedEditRecordPhotos = [];

window.currentRecords = [];

function normalizeDateStr(v){
  if (!v) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const d = new Date(v);
  if (!isNaN(d)) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  return v.split(" ")[0];
}

async function apiCall(action, payload={}, method="POST"){
  showLoading(true);
  try {
    const url = method==="GET" ? `${API_URL}?${new URLSearchParams({action, ...payload})}` : API_URL;
    const res = await fetch(url, {
      method,
      body: method==="POST" ? JSON.stringify({action, ...payload}) : null
    });
    return await res.json();
  } catch(e){
    alert("連線錯誤");
    return null;
  } finally {
    showLoading(false);
  }
}

async function fetchCustomers(){
  const data = await apiCall("getCustomers", {}, "GET");
  if (!Array.isArray(data)){
    document.getElementById("customer-list").innerHTML =
      `<div class="text-center text-gray-400 mt-20">讀取失敗</div>`;
    return;
  }
  customers = data;
  renderFilterBar();
  renderList(customers);
}

function renderFilterBar() {
    const container = document.getElementById("filter-container");
    container.innerHTML = TAG_OPTIONS.map(tag => 
        `<div class="filter-chip ${tag === currentFilter ? 'active' : ''}" onclick="filterByTag('${tag}')">${tag}</div>`
    ).join('');
}

function filterByTag(tag) {
    currentFilter = tag;
    renderFilterBar(); 
    renderList(customers);
}

function renderItemChips(containerId, inputId) {
    const container = document.getElementById(containerId);
    container.innerHTML = ITEM_OPTIONS.map(item => 
        `<div class="item-chip" onclick="addItemToInput('${inputId}', '${item}')">${item}</div>`
    ).join('');
}

function addItemToInput(inputId, itemText) {
    const input = document.getElementById(inputId);
    if (input.value) {
        input.value += `, ${itemText}`;
    } else {
        input.value = itemText;
    }
}

// ✨✨✨ 列表渲染 (含排序與過期提示) ✨✨✨
function renderList(list){
  const container = document.getElementById("customer-list");
  container.innerHTML = "";

  let filtered = list;
  if (currentFilter !== "全部") {
      filtered = filtered.filter(c => c.tags && c.tags.includes(currentFilter));
  }
  
  const searchTerm = document.getElementById("search-input").value.toLowerCase();
  if (searchTerm) {
      filtered = filtered.filter(c => 
        c.name.toLowerCase().includes(searchTerm) || 
        c.phone.includes(searchTerm) || 
        (c.note && c.note.toLowerCase().includes(searchTerm))
      );
  }

  // 自動排序：根據保養狀態 (過期優先 > 即將到期 > 正常)
  filtered.sort((a, b) => {
      const statusA = getServiceStatus(a.lastRecordDate, a.cycle).score;
      const statusB = getServiceStatus(b.lastRecordDate, b.cycle).score;
      return statusB - statusA;
  });

  if (!filtered.length){
    container.innerHTML = `<div class="text-center text-gray-400 mt-20">暫無資料</div>`;
    return;
  }

  const wrap = document.createElement("div");
  wrap.className = "space-y-3";

  filtered.forEach(c=>{
    // 計算保養狀態
    const status = getServiceStatus(c.lastRecordDate, c.cycle);
    const last = c.lastRecordDate ? normalizeDateStr(c.lastRecordDate) : "尚無紀錄";
    const machine = c.machine || "未填寫機型";

    // 卡片樣式判斷
    let cardClass = "dashboard-card border-l-4";
    let statusHtml = "";
    let dateClass = "text-gray-400";
    
    if (status.type === 'overdue') {
        cardClass += " border-l-red-500 bg-red-50/30"; 
        statusHtml = `<span class="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded font-bold ml-2">⚠️ 過期 ${status.days} 天</span>`;
        dateClass = "text-red-500 font-bold";
    } else if (status.type === 'soon') {
        cardClass += " border-l-yellow-500 bg-yellow-50/30";
        statusHtml = `<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-0.5 rounded font-bold ml-2">⏳ 剩 ${status.days} 天</span>`;
        dateClass = "text-yellow-600 font-bold";
    } else {
        cardClass += " border-l-transparent hover:border-l-primary";
        dateClass = c.lastRecordDate ? "text-green-600 font-bold" : "text-gray-400";
    }

    const card = document.createElement("div");
    card.className = cardClass;
    card.onclick = ()=> openDetail(c);

    card.innerHTML = `
      <div class="grow">
        <div class="dashboard-name truncate flex items-center">
            ${c.name}
            ${statusHtml}
        </div>

        <div class="flex gap-2 flex-wrap my-1 text-sm text-secondary">
          ${c.tags ? c.tags.split(",").map(t=>`<div class="dashboard-tag">${t}</div>`).join("") : ""}
        </div>

        <div class="text-sm text-secondary mt-1 font-medium flex items-center gap-1 text-gray-500">
           <span class="material-icons text-sm">settings</span>${machine}
        </div>

        <div class="text-sm text-secondary flex gap-4 mt-2 justify-between items-center pr-2">
          <span class="flex items-center gap-1 font-mono text-lg text-gray-700"><span class="material-icons text-sm">phone_iphone</span>${c.phone}</span>
          <div class="text-right">
             <div class="text-xs text-gray-400">上次保養</div>
             <div class="${dateClass}">${last}</div>
          </div>
        </div>
      </div>
      <div class="dashboard-chevron"><span class="material-icons">arrow_forward_ios</span></div>
    `;
    wrap.appendChild(card);
  });
  container.appendChild(wrap);
}

// ✨✨✨ 狀態計算函式 ✨✨✨
function getServiceStatus(lastDateStr, cycleMonths) {
    if (!lastDateStr || !cycleMonths) return { type: 'normal', score: 1 };
    
    const lastDate = new Date(lastDateStr);
    const nextDate = new Date(lastDate);
    nextDate.setMonth(nextDate.getMonth() + parseInt(cycleMonths));
    
    const today = new Date();
    today.setHours(0,0,0,0);
    
    const diffTime = nextDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays < 0) {
        return { type: 'overdue', days: Math.abs(diffDays), score: 3 }; 
    } else if (diffDays <= 14) {
        return { type: 'soon', days: diffDays, score: 2 }; 
    } else {
        return { type: 'normal', days: diffDays, score: 1 }; 
    }
}

document.getElementById("search-input").addEventListener("input", e=>{
  renderList(customers);
});

async function openDetail(c){
  currentCustomer = c;
  document.getElementById("page-list").classList.add("hidden");
  document.getElementById("page-detail").classList.remove("hidden");
  window.scrollTo(0,0);

  document.getElementById("detail-name").innerText = c.name;
  document.getElementById("detail-phone").innerText = c.phone;
  document.getElementById("detail-phone-link").href = `tel:${c.phone}`;
  document.getElementById("detail-install-date").innerText = c.installDate ? normalizeDateStr(c.installDate) : "無紀錄";
  
  const cycleText = c.cycle ? `${c.cycle} 個月` : "未設定";
  document.getElementById("detail-cycle").innerText = cycleText;

  const addr = c.address || "";
  document.getElementById("detail-address").innerText = addr || "未填寫";
  const mapLink = document.getElementById("detail-map-link");
  if (addr) {
      mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
      mapLink.classList.remove("hidden");
  } else {
      mapLink.classList.add("hidden");
  }

  document.getElementById("detail-machine").innerText = c.machine || "未填寫";
  document.getElementById("detail-filter").innerText = c.filter || "未填寫";

  const tagBox = document.getElementById("detail-tags");
  tagBox.innerHTML = c.tags ? c.tags.split(",").map(t=>`<div class="dashboard-tag">${t}</div>`).join("") : `<span class="text-secondary">未設定</span>`;

  if (c.note){
    document.getElementById("detail-note").innerText = c.note;
    document.getElementById("note-container").classList.remove("hidden");
  } else {
    document.getElementById("note-container").classList.add("hidden");
  }

  const photoDiv = document.getElementById("customer-photos-container");
  photoDiv.innerHTML = "";
  let photos = [];
  if (Array.isArray(c.photos)) photos = c.photos;
  else if (typeof c.photos==="string" && c.photos.startsWith("[")) { try { photos = JSON.parse(c.photos); } catch {} }
  
  if (photos.length){
    photos.forEach(url=>{
      const img = document.createElement("img"); img.src = url; img.className = "photo-thumb cursor-pointer flex-shrink-0";
      img.onclick = ()=>window.open(url); photoDiv.appendChild(img);
    });
  } else { photoDiv.innerHTML = `<div class="text-secondary text-sm p-2">無照片</div>`; }

  await fetchRecords(c.id);
}

function goBack(){
  document.getElementById("page-detail").classList.add("hidden");
  document.getElementById("page-list").classList.remove("hidden");
  // 重新渲染列表以更新狀態
  renderList(customers);
}

async function fetchRecords(id){
  const box = document.getElementById("record-list");
  box.innerHTML = `<div class="text-center text-secondary py-4">讀取中…</div>`;
  const records = await apiCall("getRecords", {customerId:id}, "GET");
  if (!records.length){ box.innerHTML = `<div class="text-secondary text-center py-4">尚無紀錄</div>`; return; }
  window.currentRecords = records;
  box.innerHTML = "";
  records.sort((a,b)=>new Date(b.date)-new Date(a.date));
  
  records.forEach(r=>{
    const photos = Array.isArray(r.photos) ? r.photos : [];
    const rData = JSON.stringify(r).replace(/"/g, '"'); 
    const item = document.createElement("div"); item.className = "timeline-item";
    item.innerHTML = `
      <div class="timeline-dot"></div>
      <div class="record-card">
        <div class="flex justify-between mb-3 border-b border-gray-100 pb-2">
          <div class="record-date text-xl text-gray-800">${normalizeDateStr(r.date)}</div>
          <div class="record-amount text-xl">${r.amount ? "NT$"+r.amount : ""}</div>
        </div>
        
        <div class="mb-3">
             <div class="text-gray-400 text-xs mb-1">項目</div>
             <div class="font-bold text-gray-900 text-2xl leading-snug">${r.items}</div>
        </div>

        ${r.note ? `
            <div class="mb-3 bg-gray-50 p-3 rounded-lg border border-gray-100">
                <div class="text-gray-400 text-xs mb-1">備註</div>
                <div class="text-gray-700 text-lg">${r.note}</div>
            </div>` : ""}
            
        ${photos.length ? `<div class="flex gap-2 overflow-x-auto mb-3 pt-2 border-t border-gray-50">${photos.map(p=>`<img class="photo-thumb cursor-pointer" src="${p}" onclick="window.open('${p}')">`).join("")}</div>` : ""}
        
        <div class="flex justify-end gap-3 mt-2 pt-2">
          <button onclick="openEditRecordModal('${rData}')" class="text-blue-600 bg-blue-50 px-4 py-2 rounded-lg font-bold text-base">編輯</button>
          <button onclick="deleteRecord('${r.id}')" class="text-red-500 bg-red-50 px-4 py-2 rounded-lg font-bold text-base">刪除</button>
        </div>
      </div>`;
    box.appendChild(item);
  });
}

function openEditRecordModal(recordStr){
  const r = JSON.parse(recordStr);
  document.getElementById("edit-record-id").value = r.id;
  document.getElementById("edit-record-date").value = normalizeDateStr(r.date);
  document.getElementById("edit-record-items").value = r.items;
  document.getElementById("edit-record-amount").value = r.amount || "";
  document.getElementById("edit-record-note").value = r.note || "";
  selectedEditRecordPhotos = [];
  document.getElementById("edit-record-photo-preview").innerHTML = "";
  document.getElementById("record-modal").classList.remove("hidden");
}

async function saveEditedRecord(){
  const id = document.getElementById("edit-record-id").value;
  const items = document.getElementById("edit-record-items").value.trim();
  const date = document.getElementById("edit-record-date").value;
  if (!items){ alert("請輸入項目"); return; }
  let photoUrls = [];
  for (let base64 of selectedEditRecordPhotos){
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }
  const payload = {
    id, date, items,
    amount: document.getElementById("edit-record-amount").value,
    note: document.getElementById("edit-record-note").value,
    photos: photoUrls
  };
  const res = await apiCall("updateRecord", payload);
  if (res?.status==="success"){
    closeModal("record-modal"); await fetchRecords(currentCustomer.id); renderList(customers);
  }
}

async function saveRecord(){
  if (!currentCustomer) return;
  const items = document.getElementById("record-items").value.trim();
  if (!items){ alert("請輸入項目"); return; }
  let photoUrls = [];
  for (let base64 of selectedRecordPhotos){
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }
  const payload = {
    customerId: currentCustomer.id,
    date: document.getElementById("record-date").value,
    items,
    amount: document.getElementById("record-amount").value,
    note: document.getElementById("record-note").value,
    photos: photoUrls
  };
  const res = await apiCall("addRecord", payload);
  if (res?.status==="success"){
    showToast("儲存成功");
    selectedRecordPhotos = [];
    document.getElementById("new-record-photos").innerHTML = "";
    document.getElementById("record-items").value=""; document.getElementById("record-amount").value=""; document.getElementById("record-note").value="";
    await fetchRecords(currentCustomer.id);
  }
}

async function deleteRecord(id){
  if (!confirm("確定刪除？")) return;
  await apiCall("deleteRecord", {id});
  await fetchRecords(currentCustomer.id);
}

function showAddCustomerModal(){
  document.getElementById("modal-title").innerText = "新增客戶";
  document.getElementById("cust-id").value = "";
  document.getElementById("cust-name").value = "";
  document.getElementById("cust-phone").value = "";
  document.getElementById("cust-address").value = "";
  document.getElementById("cust-note").value = "";
  document.getElementById("cust-machine").value = "";
  document.getElementById("cust-filter").value = "";
  document.getElementById("cust-cycle").value = ""; // 清空週期
  const d = new Date(); document.getElementById("cust-install-date").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  selectedCustPhotos = []; document.getElementById("cust-photo-preview").innerHTML = "";
  renderTagSelector("cust-tag-selector", []);
  document.getElementById("btn-delete-customer").classList.add("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

function showEditCustomerModal(){
  const c = currentCustomer;
  document.getElementById("modal-title").innerText = "編輯資料";
  document.getElementById("cust-id").value = c.id;
  document.getElementById("cust-name").value = c.name;
  document.getElementById("cust-phone").value = c.phone;
  document.getElementById("cust-address").value = c.address || "";
  document.getElementById("cust-note").value = c.note || "";
  document.getElementById("cust-machine").value = c.machine || "";
  document.getElementById("cust-filter").value = c.filter || "";
  document.getElementById("cust-cycle").value = c.cycle || ""; // 載入週期
  document.getElementById("cust-install-date").value = c.installDate ? normalizeDateStr(c.installDate) : "";
  selectedCustPhotos = []; document.getElementById("cust-photo-preview").innerHTML = "";
  renderTagSelector("cust-tag-selector", c.tags ? c.tags.split(",") : []);
  document.getElementById("btn-delete-customer").classList.remove("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

async function saveCustomer(){
  const id = document.getElementById("cust-id").value;
  const name = document.getElementById("cust-name").value.trim();
  const phone = document.getElementById("cust-phone").value.trim();
  if (!name || !phone){ alert("姓名、電話必填"); return; }
  let photoUrls = [];
  if (id && currentCustomer?.photos){
    if (Array.isArray(currentCustomer.photos)) photoUrls = [...currentCustomer.photos];
    else try { photoUrls = JSON.parse(currentCustomer.photos); } catch(e) { photoUrls = [currentCustomer.photos]; }
  }
  for (let base64 of selectedCustPhotos){
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }
  const tags = getSelectedTags("cust-tag-selector");
  const payload = {
    id, name, phone,
    address: document.getElementById("cust-address").value,
    note: document.getElementById("cust-note").value,
    machine: document.getElementById("cust-machine").value,
    filter: document.getElementById("cust-filter").value,
    installDate: document.getElementById("cust-install-date").value,
    cycle: document.getElementById("cust-cycle").value,
    photos: photoUrls, tags
  };
  const act = id ? "updateCustomer" : "addCustomer";
  const res = await apiCall(act, payload);
  if (res?.status==="success"){
    showToast("儲存成功");
    closeModal("customer-modal"); await fetchCustomers();
    if(id && currentCustomer) openDetail({...currentCustomer, ...payload, photos: photoUrls});
  }
}

async function deleteCustomer(){
  if (!confirm("確定刪除此客戶？")) return;
  const id = document.getElementById("cust-id").value;
  await apiCall("deleteCustomer", {id});
  closeModal("customer-modal"); goBack(); fetchCustomers();
}

function renderTagSelector(containerId, selected=[]){
  const box = document.getElementById(containerId); box.innerHTML = "";
  TAG_OPTIONS.forEach(t=>{
    const div = document.createElement("div"); div.className = "tag" + (selected.includes(t) ? " active" : "");
    div.dataset.tag = t; div.innerText = t; div.onclick = ()=> div.classList.toggle("active");
    box.appendChild(div);
  });
}
function getSelectedTags(containerId){ return [...document.querySelectorAll(`#${containerId} .tag.active`)].map(x=>x.dataset.tag).join(","); }

function handleCustPhotoSelect(input){ handlePhotoSelect(input, selectedCustPhotos, "cust-photo-preview"); }
function handleRecordPhotoSelect(input){ handlePhotoSelect(input, selectedRecordPhotos, "new-record-photos", "record-photo-count"); }
function handleEditRecordPhotoSelect(input){ handlePhotoSelect(input, selectedEditRecordPhotos, "edit-record-photo-preview"); }

function handlePhotoSelect(input, arr, previewId, countId){
  [...input.files].forEach(file=>{
    const reader = new FileReader();
    reader.onload = e => resizeImage(e.target.result, 900, out=>{
      arr.push(out); renderPreview(previewId, arr);
      if(countId) document.getElementById(countId).innerText = `${arr.length} 張`;
    });
    reader.readAsDataURL(file);
  });
}
function renderPreview(id, arr){ document.getElementById(id).innerHTML = arr.map(src => `<img class="photo-thumb" src="${src}">`).join(""); }
function resizeImage(base64, maxW, cb){
  const img = new Image(); img.src = base64;
  img.onload = ()=>{
    let w = img.width, h = img.height; if (w > maxW){ h *= maxW/w; w = maxW; }
    const c = document.createElement("canvas"); c.width = w; c.height = h;
    c.getContext("2d").drawImage(img,0,0,w,h); cb(c.toDataURL("image/jpeg",0.8));
  };
}

function closeModal(id){ document.getElementById(id).classList.add("hidden"); }
document.getElementById("customer-modal").addEventListener("click", e=>{ if (e.target.id==="customer-modal") closeModal("customer-modal"); });
document.getElementById("record-modal").addEventListener("click", e=>{ if (e.target.id==="record-modal") closeModal("record-modal"); });
function showLoading(show){ document.getElementById("loading").classList.toggle("hidden", !show); }
function showToast(message) {
    const x = document.getElementById("toast"); x.innerText = message; x.className = "toast show";
    setTimeout(function(){ x.className = "toast"; }, 3000);
}

window.onload = () => {
  fetchCustomers();
  const rd = document.getElementById("record-date");
  if (rd){ const d = new Date(); rd.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  renderItemChips("new-record-item-chips", "record-items");
  renderItemChips("edit-record-item-chips", "edit-record-items");
};
</script>

</body>
</html>
