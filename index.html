<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>濾芯保養系統</title>

    <!-- iOS App-style settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/water-filter.png">

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config: font-size enlarged 1.2x + color system -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007AFF',
                        secondary: '#5856D6',
                        success: '#34C759',
                        danger: '#FF3B30',
                        iosbg: '#F2F2F7',
                        card: '#FFFFFF',
                        text: '#1C1C1E',
                        subtext: '#8E8E93',
                        border: '#C6C6C8'
                    },
                    fontSize: {
                        sm: "1.05rem",
                        base: "1.2rem",
                        lg: "1.44rem",
                        xl: "1.728rem",
                        "2xl": "2.074rem",
                        "3xl": "2.488rem"
                    }
                }
            }
        }
    </script>

    <style>
        /* Global enlarged UI scale */
        html { font-size: 1.2rem; }

        body {
            background-color: #F2F2F7;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 120px;
            color: #1C1C1E;
        }

        /* Card style (Layout C) */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }

        /* Enlarged Input Style */
        input, textarea, select {
            width: 100%;
            padding: 16px;
            border: 1px solid #C6C6C8;
            border-radius: 12px;
            background: white;
            font-size: 1.2rem;
        }

        input:focus, textarea:focus {
            border-color: #007AFF;
            outline: none;
        }

        /* iOS Solid Primary Button */
        .btn-primary {
            background-color: #007AFF;
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
        }

        /* FAB enlarged */
        .fab {
            position: fixed;
            bottom: 32px;
            right: 28px;
            width: 72px;
            height: 72px;
            background: #007AFF;
            border-radius: 50%;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size: 2rem;
            box-shadow: 0 4px 14px rgba(0,122,255,0.35);
        }

        /* Photo thumbnail */
        .photo-thumb {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid #E5E5EA;
        }
    </style>
</head>
<body>

<!-- ============================= -->
<!-- BODY PART 1 : HEADER + SEARCH -->
<!-- ============================= -->

<!-- iOS-style Header -->
<div class="bg-white/90 backdrop-blur-md sticky top-0 z-20 border-b border-gray-200">
    <div class="pt-12 pb-4 px-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-900">濾芯保養系統</h1>
    </div>

    <!-- Search Bar -->
    <div class="px-6 pb-4">
        <div class="relative">
            <input id="search-input" type="text"
                placeholder="搜尋客戶..."
                class="w-full bg-gray-200 rounded-xl pl-12 pr-4 py-4 text-base text-gray-900 placeholder-gray-500 focus:outline-none">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 material-icons text-xl">search</span>
        </div>
    </div>
</div>

<!-- Customer List Container -->
<div id="customer-list" class="px-4 pt-6 pb-20">
    <div class="text-center text-gray-400 text-base mt-16">載入中...</div>
</div>

<!-- FAB Add Customer -->
<div class="fab" onclick="showAddCustomerModal()">
    <span class="material-icons">add</span>
</div>


<!-- ============================= -->
<!-- BODY PART 2 : CUSTOMER DETAIL -->
<!-- ============================= -->

<div id="page-detail" class="hidden bg-iosbg min-h-screen">

    <!-- Detail Header -->
    <div class="bg-white/90 backdrop-blur-md sticky top-0 z-20 border-b border-gray-200 flex items-center px-4 py-4">
        <button onclick="goBack()" class="flex items-center text-primary text-lg font-semibold">
            <span class="material-icons text-xl mr-1">arrow_back_ios</span> 返回
        </button>

        <h2 class="flex-1 text-center text-xl font-bold text-gray-900">客戶資料</h2>

        <button onclick="showEditCustomerModal()" class="text-primary text-lg font-semibold">
            編輯
        </button>
    </div>

    <!-- Detail Content -->
    <div class="px-5 pt-6 pb-24 space-y-6 max-w-xl mx-auto">

        <!-- Photo Carousel -->
        <div class="card p-0 overflow-hidden shadow-sm">
            <div id="customer-photos-container"
                class="w-full h-56 bg-gray-200 flex overflow-x-auto snap-x snap-mandatory">
                <!-- filled dynamically -->
            </div>

            <div class="p-5">
                <h2 id="detail-name" class="text-2xl font-bold text-gray-900"></h2>

                <a id="detail-phone-link"
                   class="flex items-center text-primary text-lg font-semibold mt-1">
                    <span class="material-icons mr-1 text-xl">phone</span>
                    <span id="detail-phone"></span>
                </a>

                <!-- Information List -->
                <div class="mt-4 space-y-3 text-base">

                    <div class="flex border-t border-gray-200 pt-4">
                        <span class="text-subtext w-24 flex-shrink-0">安裝日期</span>
                        <span id="detail-install-date" class="text-gray-900 font-medium"></span>
                    </div>

                    <div class="flex border-t border-gray-200 pt-4">
                        <span class="text-subtext w-24 flex-shrink-0">地址</span>
                        <span id="detail-address" class="text-gray-900"></span>
                    </div>

                    <div class="flex border-t border-gray-200 pt-4">
                        <span class="text-subtext w-24 flex-shrink-0">機器</span>
                        <span id="detail-machine" class="text-gray-900"></span>
                    </div>

                    <div class="flex border-t border-gray-200 pt-4">
                        <span class="text-subtext w-24 flex-shrink-0">濾芯</span>
                        <span id="detail-filter" class="text-gray-900"></span>
                    </div>

                    <div id="note-container"
                         class="flex border-t border-gray-200 pt-4 hidden">
                        <span class="text-orange-500 font-semibold w-24 flex-shrink-0">備註</span>
                        <span id="detail-note" class="text-gray-900"></span>
                    </div>

                </div>
            </div>
        </div>

        <!-- Add Maintenance Record -->
        <div class="card">
            <h3 class="text-lg font-bold text-gray-900 mb-4">新增保養紀錄</h3>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-subtext text-sm mb-1 block">日期</label>
                    <input type="date" id="record-date">
                </div>

                <div>
                    <label class="text-subtext text-sm mb-1 block">金額</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">NT$</span>
                        <input id="record-amount"
                               type="number"
                               class="pl-14 font-bold text-green-600"
                               placeholder="0">
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="text-subtext text-sm mb-1 block">更換項目</label>
                <input id="record-items" type="text" placeholder="例如: PP、活性碳">
            </div>

            <div class="mb-4">
                <label class="text-subtext text-sm mb-1 block">備註（選填）</label>
                <input id="record-note" type="text">
            </div>

            <div class="flex items-center gap-4 mb-4">
                <label class="flex items-center bg-gray-200 text-primary font-semibold px-4 py-2 rounded-xl cursor-pointer">
                    <span class="material-icons mr-2">camera_alt</span> 拍照
                    <input id="record-photo-input"
                           type="file"
                           accept="image/*"
                           multiple
                           class="hidden"
                           onchange="handleRecordPhotoSelect(this)">
                </label>
                <span id="record-photo-count" class="text-subtext text-sm">0 張</span>
            </div>

            <div id="new-record-photos" class="flex gap-3 overflow-x-auto py-2"></div>

            <button onclick="saveRecord()" class="btn-primary w-full mt-2">
                儲存紀錄
            </button>
        </div>

        <!-- History Records -->
        <div>
            <h3 class="text-subtext font-bold text-base mb-2">歷史紀錄</h3>
            <div id="record-list" class="space-y-4"></div>
        </div>

    </div>
</div>


<!-- ============================= -->
<!-- BODY PART 3 : MODALS          -->
<!-- ============================= -->

<!-- Customer Modal -->
<div id="customer-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center">
  <div class="bg-iosbg w-full max-w-xl rounded-t-3xl p-6 space-y-6 max-h-[90vh] overflow-y-auto">

    <div class="flex justify-between items-center">
      <button onclick="closeModal('customer-modal')" class="text-primary text-lg font-semibold">取消</button>
      <h2 id="modal-title" class="text-xl font-bold text-gray-900">新增客戶</h2>
      <button onclick="saveCustomer()" class="text-primary text-lg font-bold">儲存</button>
    </div>

    <input type="hidden" id="cust-id">

    <div class="card space-y-4">
      <div>
        <label class="text-subtext text-sm mb-1 block">姓名 *</label>
        <input id="cust-name" type="text">
      </div>
      <div>
        <label class="text-subtext text-sm mb-1 block">電話 *</label>
        <input id="cust-phone" type="tel">
      </div>
      <div>
        <label class="text-subtext text-sm mb-1 block">安裝日期</label>
        <input id="cust-install-date" type="date">
      </div>
    </div>

    <div class="card space-y-4">
      <div>
        <label class="text-subtext text-sm mb-1 block">地址</label>
        <input id="cust-address" type="text">
      </div>
      <div>
        <label class="text-subtext text-sm mb-1 block">機器型號</label>
        <input id="cust-machine" type="text">
      </div>
      <div>
        <label class="text-subtext text-sm mb-1 block">濾芯規格</label>
        <input id="cust-filter" type="text">
      </div>
      <div>
        <label class="text-subtext text-sm mb-1 block">備註</label>
        <textarea id="cust-note" rows="2"></textarea>
      </div>
    </div>

    <div class="card text-center space-y-3">
      <label class="flex justify-center items-center text-primary font-semibold cursor-pointer">
        <span class="material-icons mr-2">add_photo_alternate</span>
        選擇機器照片
        <input id="cust-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
      </label>
      <div id="cust-photo-preview" class="flex gap-3 overflow-x-auto"></div>
    </div>

    <button id="btn-delete-customer"
            onclick="deleteCustomer()"
            class="w-full bg-white text-danger font-semibold py-4 rounded-xl hidden">
      刪除此客戶
    </button>

  </div>
</div>


<!-- Edit Record Modal -->
<div id="record-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center">
  <div class="bg-iosbg w-full max-w-xl rounded-t-3xl p-6 space-y-6 max-h-[90vh] overflow-y-auto">

    <div class="flex justify-between items-center">
      <button onclick="closeModal('record-modal')" class="text-primary text-lg font-semibold">取消</button>
      <h2 class="text-xl font-bold text-gray-900">修改紀錄</h2>
      <button onclick="saveEditedRecord()" class="text-primary text-lg font-bold">完成</button>
    </div>

    <input type="hidden" id="edit-record-id">

    <div class="card space-y-4">
      <div>
        <label class="text-subtext text-sm mb-1 block">日期</label>
        <input id="edit-record-date" type="date">
      </div>
      <div>
        <label class="text-subtext text-sm mb-1 block">項目</label>
        <input id="edit-record-items" type="text">
      </div>
      <div>
        <label class="text-subtext text-sm mb-1 block">金額</label>
        <input id="edit-record-amount" type="number" class="text-green-600 font-bold">
      </div>
      <div>
        <label class="text-subtext text-sm mb-1 block">備註</label>
        <textarea id="edit-record-note" rows="2"></textarea>
      </div>
    </div>

    <div class="card text-center space-y-3">
      <label class="flex justify-center items-center text-primary font-semibold cursor-pointer">
        <span class="material-icons mr-2">add_a_photo</span>
        加傳照片
        <input id="edit-record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
      </label>
      <div id="edit-record-photo-preview" class="flex gap-3 overflow-x-auto"></div>
    </div>

  </div>
</div>


<!-- ============================= -->
<!-- SCRIPT PART 1 : CORE LOGIC    -->
<!-- ============================= -->

<script>
/* -----------------------------------
   Global State
----------------------------------- */
let customers = [];
let currentCustomer = null;
let selectedRecordPhotos = [];
let selectedCustPhotos = [];
let selectedEditRecordPhotos = [];
let currentRecords = [];

/* -----------------------------------
   API Helper
----------------------------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbzGwCR8SaiLE99cDt0I7wXBzIadQgOUFhOMXmRQaJsqksuvswo3f-UgQD0RWG8dJOEu/exec";

async function apiCall(action, payload = {}, method = "POST") {
    try {
        const url = method === "GET"
            ? `${API_URL}?${new URLSearchParams({ action, ...payload })}`
            : API_URL;

        const options = method === "GET"
            ? {}
            : { method: "POST", body: JSON.stringify({ action, ...payload }) };

        const res = await fetch(url, options);
        return await res.json();
    } catch (e) {
        alert("連線錯誤");
        console.error(e);
    }
}

/* -----------------------------------
   Date utilities — FIX SAFARI BUG
----------------------------------- */
function formatDateString(dateStr) {
    // Always return yyyy-mm-dd without timezone shifting
    return dateStr;
}

/* -----------------------------------
   Init
----------------------------------- */
window.onload = () => {
    fetchCustomers();
    document.getElementById("record-date").valueAsDate = new Date();
};

/* -----------------------------------
   Fetch Customers
----------------------------------- */
async function fetchCustomers() {
    const data = await apiCall("getCustomers", {}, "GET");
    if (Array.isArray(data)) {
        customers = data;
        renderList(customers);
    }
}

/* -----------------------------------
   Render Customer List
----------------------------------- */
function renderList(list) {
    const container = document.getElementById("customer-list");
    container.innerHTML = "";

    if (list.length === 0) {
        container.innerHTML = `<div class='text-center text-gray-400 mt-20 text-lg'>沒有資料</div>`;
        return;
    }

    list.forEach(c => {
        const div = document.createElement("div");
        div.className = "card px-4 py-5 cursor-pointer";
        div.onclick = () => openDetail(c);
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-xl font-bold text-gray-900">${c.name}</div>
                    <div class="text-base text-subtext">${c.phone}</div>
                </div>
                <span class="material-icons text-gray-400 text-3xl">chevron_right</span>
            </div>
        `;
        container.appendChild(div);
    });
}

/* -----------------------------------
   Search
----------------------------------- */
document.getElementById("search-input").addEventListener("input", (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = customers.filter(c =>
        c.name.toLowerCase().includes(term) ||
        String(c.phone).includes(term)
    );
    renderList(filtered);
});

</script>

<!-- ============================= -->
<!-- SCRIPT PART 2 : DETAIL LOGIC  -->
<!-- ============================= -->

<script>
/* -----------------------------------
   Open Customer Detail
----------------------------------- */
async function openDetail(customer) {
    currentCustomer = customer;

    document.getElementById("page-list").classList.add("hidden");
    document.getElementById("page-detail").classList.remove("hidden");
    window.scrollTo(0, 0);

    // Basic Info
    document.getElementById("detail-name").innerText = customer.name;
    document.getElementById("detail-phone").innerText = customer.phone;
    document.getElementById("detail-phone-link").href = `tel:${customer.phone}`;

    // Install Date (no timezone parsing)
    const installDate = customer.installDate || "";
    document.getElementById("detail-install-date").innerText =
        installDate ? installDate : "未填寫";

    // Other fields
    setText("detail-address", customer.address);
    setText("detail-machine", customer.machine);
    setText("detail-filter", customer.filter);

    if (customer.note) {
        document.getElementById("detail-note").innerText = customer.note;
        document.getElementById("note-container").classList.remove("hidden");
    } else {
        document.getElementById("note-container").classList.add("hidden");
    }

    // Photos
    loadCustomerPhotos(customer);

    // Load records
    await fetchRecords(customer.id);
}

/* -----------------------------------
   Safe Text Setter
----------------------------------- */
function setText(id, value) {
    const el = document.getElementById(id);
    if (!value) {
        el.innerText = "未填寫";
        el.className = "text-gray-400 italic";
    } else {
        el.innerText = value;
        el.className = "text-gray-900";
    }
}

/* -----------------------------------
   Load Customer Photos
----------------------------------- */
function loadCustomerPhotos(c) {
    const box = document.getElementById("customer-photos-container");
    box.innerHTML = "";

    let photos = [];
    if (Array.isArray(c.photos)) photos = c.photos;
    else if (typeof c.photos === "string" && c.photos.startsWith("[")) {
        try { photos = JSON.parse(c.photos); } catch {}
    }

    if (photos.length === 0) {
        box.innerHTML = `
            <div class="w-full h-full flex items-center justify-center text-subtext text-lg">
                無機器照片
            </div>`;
        return;
    }

    photos.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.className = "w-auto h-full flex-shrink-0 object-cover cursor-pointer";
        img.onclick = () => window.open(url, "_blank");
        box.appendChild(img);
    });
}

/* -----------------------------------
   Fetch Records
----------------------------------- */
async function fetchRecords(customerId) {
    const container = document.getElementById("record-list");
    container.innerHTML = `
        <div class='text-center text-subtext py-6 text-lg'>讀取中...</div>
    `;

    const records = await apiCall("getRecords", { customerId }, "GET");
    currentRecords = records || [];

    container.innerHTML = "";

    if (!records || records.length === 0) {
        container.innerHTML = `
            <div class='text-center text-subtext py-6 text-lg'>尚無紀錄</div>
        `;
        return;
    }

    records.forEach(r => {
        const div = document.createElement("div");
        div.className = "card space-y-3";

        const photos = Array.isArray(r.photos) ? r.photos : [];

        div.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="text-xl font-bold text-gray-900">${r.date}</div>
                <div class="text-green-600 font-bold text-xl">
                    ${r.amount ? "NT$" + r.amount : ""}
                </div>
            </div>

            <div class="text-lg font-semibold text-gray-900">${r.items}</div>

            ${r.note ? `<div class="text-base text-subtext bg-gray-100 p-3 rounded-xl">
                備註：${r.note}
            </div>` : ""}

            <div class="flex gap-3 overflow-x-auto">
                ${photos
                    .map(url => `<img src="${url}" class="photo-thumb cursor-pointer" onclick="window.open('${url}')">`)
                    .join("")}
            </div>

            <div class="flex justify-end gap-6 pt-2 border-t border-gray-200">
                <button class="edit-record-btn text-primary text-lg font-semibold" data-id="${r.id}">
                    編輯
                </button>
                <button class="delete-record-btn text-danger text-lg font-semibold" data-id="${r.id}">
                    刪除
                </button>
            </div>
        `;

        container.appendChild(div);
    });

    bindRecordButtons();
}

/* -----------------------------------
   Bind Edit/Delete Buttons (Fix)
----------------------------------- */
function bindRecordButtons() {
    document.querySelectorAll(".edit-record-btn").forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.id;
            const rec = currentRecords.find(r => r.id == id);
            openEditRecordModal(rec);
        };
    });

    document.querySelectorAll(".delete-record-btn").forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.id;
            deleteRecord(id);
        };
    });
}

</script>

<!-- ============================= -->
<!-- SCRIPT PART 3 : RECORD & CUSTOMER CRUD -->
<!-- ============================= -->

<script>
/* -----------------------------------
   Resize Image Utility
----------------------------------- */
function resizeImage(base64, maxWidth = 1000, callback) {
    const img = new Image();
    img.src = base64;
    img.onload = () => {
        let w = img.width;
        let h = img.height;
        if (w > maxWidth) {
            h = h * (maxWidth / w);
            w = maxWidth;
        }
        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);
        callback(canvas.toDataURL("image/jpeg", 0.8));
    };
}

/* -----------------------------------
   Save New Record
----------------------------------- */
async function saveRecord() {
    if (!currentCustomer) return alert("沒有客戶");

    const items = document.getElementById("record-items").value.trim();
    if (!items) return alert("請輸入項目");

    const dateVal = document.getElementById("record-date").value;
    const payload = {
        customerId: currentCustomer.id,
        date: dateVal,
        items: items,
        amount: document.getElementById("record-amount").value,
        note: document.getElementById("record-note").value,
        photos: []
    };

    for (let base64 of selectedRecordPhotos) {
        const upload = await apiCall("uploadImage", { base64, type: "image/jpeg" });
        if (upload.status === "success") payload.photos.push(upload.url);
    }

    const res = await apiCall("addRecord", payload);
    if (res.status === "success") {
        selectedRecordPhotos = [];
        document.getElementById("record-items").value = "";
        document.getElementById("record-amount").value = "";
        document.getElementById("record-note").value = "";
        fetchRecords(currentCustomer.id);
    }
}

/* -----------------------------------
   Open Edit Record Modal
----------------------------------- */
function openEditRecordModal(r) {
    document.getElementById("edit-record-id").value = r.id;
    document.getElementById("edit-record-date").value = r.date;
    document.getElementById("edit-record-items").value = r.items;
    document.getElementById("edit-record-amount").value = r.amount;
    document.getElementById("edit-record-note").value = r.note;

    selectedEditRecordPhotos = [];
    document.getElementById("edit-record-photo-preview").innerHTML = "";

    document.getElementById("record-modal").classList.remove("hidden");
}

/* -----------------------------------
   Save Edited Record
----------------------------------- */
async function saveEditedRecord() {
    const id = document.getElementById("edit-record-id").value;
    const payload = {
        id: id,
        date: document.getElementById("edit-record-date").value,
        items: document.getElementById("edit-record-items").value,
        amount: document.getElementById("edit-record-amount").value,
        note: document.getElementById("edit-record-note").value,
        photos: []
    };

    for (let base64 of selectedEditRecordPhotos) {
        const upload = await apiCall("uploadImage", { base64, type: "image/jpeg" });
        if (upload.status === "success") payload.photos.push(upload.url);
    }

    const res = await apiCall("updateRecord", payload);
    if (res.status === "success") {
        document.getElementById("record-modal").classList.add("hidden");
        fetchRecords(currentCustomer.id);
    }
}

/* -----------------------------------
   Delete Record
----------------------------------- */
async function deleteRecord(id) {
    if (!confirm("確定刪除？")) return;
    await apiCall("deleteRecord", { id });
    fetchRecords(currentCustomer.id);
}

/* -----------------------------------
   Show Add Customer Modal
----------------------------------- */
function showAddCustomerModal() {
    document.getElementById("modal-title").innerText = "新增客戶";

    document.getElementById("cust-id").value = "";
    document.getElementById("cust-name").value = "";
    document.getElementById("cust-phone").value = "";
    document.getElementById("cust-address").value = "";
    document.getElementById("cust-note").value = "";
    document.getElementById("cust-machine").value = "";
    document.getElementById("cust-filter").value = "";
    document.getElementById("cust-install-date").value = "";

    selectedCustPhotos = [];
    document.getElementById("cust-photo-preview").innerHTML = "";

    document.getElementById("btn-delete-customer").classList.add("hidden");
    document.getElementById("customer-modal").classList.remove("hidden");
}

/* -----------------------------------
   Show Edit Customer Modal
----------------------------------- */
function showEditCustomerModal() {
    if (!currentCustomer) return;

    document.getElementById("modal-title").innerText = "編輯客戶";
    document.getElementById("cust-id").value = currentCustomer.id;
    document.getElementById("cust-name").value = currentCustomer.name;
    document.getElementById("cust-phone").value = currentCustomer.phone;
    document.getElementById("cust-address").value = currentCustomer.address;
    document.getElementById("cust-note").value = currentCustomer.note;
    document.getElementById("cust-machine").value = currentCustomer.machine;
    document.getElementById("cust-filter").value = currentCustomer.filter;
    document.getElementById("cust-install-date").value = currentCustomer.installDate || "";

    selectedCustPhotos = [];
    document.getElementById("cust-photo-preview").innerHTML = "";

    document.getElementById("btn-delete-customer").classList.remove("hidden");
    document.getElementById("customer-modal").classList.remove("hidden");
}

/* -----------------------------------
   Save Customer (New or Update)
----------------------------------- */
async function saveCustomer() {
    const id = document.getElementById("cust-id").value;

    const payload = {
        id,
        name: document.getElementById("cust-name").value.trim(),
        phone: document.getElementById("cust-phone").value,
        address: document.getElementById("cust-address").value,
        note: document.getElementById("cust-note").value,
        machine: document.getElementById("cust-machine").value,
        filter: document.getElementById("cust-filter").value,
        installDate: document.getElementById("cust-install-date").value,
        photos: []
    };

    if (!payload.name || !payload.phone) {
        return alert("姓名與電話必填");
    }

    for (let base64 of selectedCustPhotos) {
        const upload = await apiCall("uploadImage", { base64, type: "image/jpeg" });
        if (upload.status === "success") payload.photos.push(upload.url);
    }

    const action = id ? "updateCustomer" : "addCustomer";
    const res = await apiCall(action, payload);

    if (res.status === "success") {
        document.getElementById("customer-modal").classList.add("hidden");
        fetchCustomers();
    }
}

/* -----------------------------------
   Delete Customer
----------------------------------- */
async function deleteCustomer() {
    const id = document.getElementById("cust-id").value;
    if (!confirm("確定刪除客戶？")) return;

    await apiCall("deleteCustomer", { id });

    document.getElementById("customer-modal").classList.add("hidden");
    document.getElementById("page-detail").classList.add("hidden");
    document.getElementById("page-list").classList.remove("hidden");

    fetchCustomers();
}
</script>

<!-- ============================= -->
<!-- SCRIPT PART 4 : UI UTILITIES -->
<!-- ============================= -->

<script>
/* -----------------------------------
   Smooth Fade In / Fade Out
----------------------------------- */
function fadeIn(el, duration = 180) {
    el.style.opacity = 0;
    el.style.display = "flex";
    el.style.transition = `opacity ${duration}ms ease`;
    requestAnimationFrame(() => { el.style.opacity = 1; });
}

function fadeOut(el, duration = 180) {
    el.style.opacity = 1;
    el.style.transition = `opacity ${duration}ms ease`;
    requestAnimationFrame(() => {
        el.style.opacity = 0;
        setTimeout(() => { el.style.display = "none"; }, duration);
    });
}

/* -----------------------------------
   Loading Overlay (Auto-Managed)
----------------------------------- */
const loadingEl = document.getElementById("loading");

function showLoading(show) {
    if (show) fadeIn(loadingEl);
    else fadeOut(loadingEl);
}

/* Wrap all API calls */
async function api(action, payload = {}, method = "POST") {
    showLoading(true);
    try { return await apiCall(action, payload, method); }
    finally { showLoading(false); }
}

/* -----------------------------------
   Modal Open / Close Animations
----------------------------------- */
function openModal(id) {
    const modal = document.getElementById(id);
    const panel = modal.querySelector(".modal-panel");

    fadeIn(modal);
    panel.style.transform = "translateY(40px)";
    panel.style.opacity = 0;

    requestAnimationFrame(() => {
        panel.style.transition = "all 220ms ease";
        panel.style.transform = "translateY(0)";
        panel.style.opacity = 1;
    });
}

function closeModal(id) {
    const modal = document.getElementById(id);
    const panel = modal.querySelector(".modal-panel");

    panel.style.transform = "translateY(40px)";
    panel.style.opacity = 0;

    setTimeout(() => fadeOut(modal), 180);
}

/* Close on background click */
document.querySelectorAll(".modal").forEach(modal => {
    modal.addEventListener("click", e => {
        if (e.target.classList.contains("modal")) closeModal(modal.id);
    });
});

/* -----------------------------------
   Utility Helpers
----------------------------------- */
function safe(v, d = "") { return v === undefined || v === null ? d : v; }

function lockScroll() { document.body.style.overflow = "hidden"; }
function unlockScroll() { document.body.style.overflow = ""; }

/* -----------------------------------
   Fix iOS Date Issue
----------------------------------- */
function todayString() {
    const d = new Date();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${d.getFullYear()}-${mm}-${dd}`;
}
document.getElementById("record-date").value = todayString();

/* -----------------------------------
   Enhanced Image Compression
----------------------------------- */
function compressImage(base64, cb) {
    resizeImage(base64, 1100, cb);
}
</script>
