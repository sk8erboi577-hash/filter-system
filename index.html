<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¿¾èŠ¯ä¿é¤Šç³»çµ±</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/water-filter.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    
    <style>
        /* å…¨å±€è¨­å®š */
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 100px; }
        .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; padding: 12px; border-radius: 12px; font-weight: 600; text-align: center; width: 100%; display: block; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.98); }
        
        /* âœ¨ ç¾åŒ–å¾Œçš„ FAB æŒ‰éˆ• (ä¿®æ­£ä¸æ­£ã€ä¸ç¾è§€çš„å•é¡Œ) */
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 64px; height: 64px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center; /* ç¢ºä¿åœ–ç¤ºçµ•å°ç½®ä¸­ */
            color: white;
            box-shadow: 0 15px 25px -5px rgba(37, 99, 235, 0.4), 0 8px 10px -6px rgba(37, 99, 235, 0.2);
            z-index: 50; cursor: pointer;
            transition: all 0.2s ease;
        }
        .fab:active { transform: scale(0.95); box-shadow: 0 5px 10px -3px rgba(37, 99, 235, 0.4); }
        .fab .material-icons { font-size: 36px; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 999; flex-direction: column; backdrop-filter: blur(2px); }
        .hidden { display: none !important; }
        input, textarea, select { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 12px; font-size: 16px; background-color: #f8fafc; transition: border-color 0.2s; }
        input:focus, textarea:focus { border-color: #3b82f6; outline: none; background-color: white; }
        .photo-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .photo-thumb { width: 90px; height: 90px; object-fit: cover; border-radius: 12px; flex-shrink: 0; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* è©³æƒ…é å„ªåŒ– */
        .detail-label { font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 2px; display: block; }
        .detail-value { font-size: 1.1rem; color: #1e293b; line-height: 1.5; }
        .detail-row { display: flex; align-items: flex-start; margin-bottom: 16px; border-bottom: 1px solid #f1f5f9; padding-bottom: 12px; }
        .detail-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .detail-icon { color: #94a3b8; margin-right: 12px; margin-top: 2px; }
    </style>
</head>
<body>

    <div id="page-list">
        <div class="bg-white pt-12 pb-4 px-6 sticky top-0 z-10 shadow-sm">
            <h1 class="text-2xl font-bold text-left mb-4 text-gray-800 flex items-center">
                <span class="material-icons text-blue-600 mr-2">water_drop</span>
                æ¿¾èŠ¯ä¿é¤Šç³»çµ±
            </h1>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                    <span class="material-icons">search</span>
                </span>
                <input type="text" id="search-input" placeholder="æœå°‹å§“åã€é›»è©±æˆ–å‚™è¨»..." class="pl-12 mb-0 bg-gray-100 border-none focus:bg-white focus:ring-2 focus:ring-blue-100">
            </div>
        </div>
        <div id="customer-list" class="p-4 max-w-2xl mx-auto">
            <div class="text-center text-gray-400 mt-20 flex flex-col items-center">
                <span class="material-icons-outlined text-6xl mb-4 text-gray-300">account_circle</span>
                <p>è¼‰å…¥å®¢æˆ¶è³‡æ–™ä¸­...</p>
            </div>
        </div>
        <div class="fab" onclick="showAddCustomerModal()">
            <span class="material-icons">add</span>
        </div>
    </div>

    <div id="page-detail" class="hidden min-h-screen bg-gray-50">
        <div class="bg-white pt-10 pb-3 px-4 shadow-sm flex items-center sticky top-0 z-20">
            <button onclick="goBack()" class="p-2 mr-1 text-gray-600 rounded-full hover:bg-gray-100"><span class="material-icons">arrow_back</span></button>
            <h2 id="detail-header-name" class="text-lg font-bold flex-1 truncate">å®¢æˆ¶è©³æƒ…</h2>
            <button onclick="showEditCustomerModal()" class="text-blue-600 font-bold px-4 py-1 rounded-full bg-blue-50 hover:bg-blue-100">ç·¨è¼¯</button>
        </div>
        
        <div class="p-4 max-w-2xl mx-auto">
            <div class="card relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-10 -mr-10 text-blue-50 opacity-50">
                    <span class="material-icons" style="font-size: 150px;">water_drop</span>
                </div>
                
                <div class="flex flex-col items-center relative z-10 mb-6">
                    <div id="customer-install-photo" class="w-32 h-32 bg-gray-200 rounded-2xl shadow-md overflow-hidden cursor-pointer mb-4 bg-center bg-cover border-4 border-white"></div>
                    <h2 id="detail-name" class="text-3xl font-bold text-gray-900 mb-1"></h2>
                    <a id="detail-phone-link" class="text-xl font-mono text-blue-600 font-bold bg-blue-50 px-4 py-1 rounded-full flex items-center">
                        <span class="material-icons text-sm mr-2">phone</span>
                        <span id="detail-phone"></span>
                    </a>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-5 space-y-4 relative z-10">
                    <div class="detail-row">
                        <span class="material-icons detail-icon">home</span>
                        <div><span class="detail-label">å®‰è£åœ°å€</span><span id="detail-address" class="detail-value"></span></div>
                    </div>
                    <div class="detail-row">
                         <span class="material-icons detail-icon">settings</span>
                         <div class="flex-1"><span class="detail-label">æ©Ÿå™¨å‹è™Ÿ</span><span id="detail-machine" class="detail-value"></span></div>
                    </div>
                    <div class="detail-row">
                        <span class="material-icons detail-icon">filter_alt</span>
                        <div class="flex-1"><span class="detail-label">æ¿¾èŠ¯è¦æ ¼</span><span id="detail-filter" class="detail-value"></span></div>
                     </div>
                    <div id="note-container" class="detail-row hidden">
                        <span class="material-icons detail-icon text-orange-400">sticky_note_2</span>
                        <div><span class="detail-label text-orange-600">å‚™è¨»äº‹é …</span><span id="detail-note" class="detail-value text-orange-800 font-medium"></span></div>
                    </div>
                </div>
            </div>

            <div class="card bg-gradient-to-br from-blue-50 to-white border border-blue-100">
                <h3 class="font-bold text-blue-800 mb-4 flex items-center text-lg">
                    <span class="material-icons-outlined mr-2">post_add</span>
                    æ–°å¢ä¿é¤Šç´€éŒ„
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="record-date" class="col-span-2">
                    <input type="text" id="record-items" placeholder="æ›´æ›é …ç›® (å¦‚: PP, æ´»æ€§ç¢³)" class="col-span-2 font-bold">
                    <div class="relative col-span-2">
                         <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-500 font-bold">NT$</span>
                        <input type="number" id="record-amount" placeholder="é‡‘é¡" inputmode="numeric" class="pl-14 text-lg font-mono font-bold text-green-600">
                    </div>
                    <textarea id="record-note" placeholder="å‚™è¨» (é¸å¡«)" rows="2" class="col-span-2 mb-0"></textarea>
                </div>
                
                <div class="flex items-center justify-between mt-4 mb-4 p-3 bg-white rounded-xl border border-gray-100">
                    <label class="flex items-center gap-2 text-blue-600 font-bold cursor-pointer">
                        <span class="material-icons text-3xl">add_a_photo</span>
                        <span>æ‹ç…§è¨˜éŒ„</span>
                        <input type="file" id="record-photo-input" accept="image/*" multiple class="hidden" onchange="handlePhotoSelect(this)">
                    </label>
                    <span id="photo-count" class="text-sm text-gray-400 bg-gray-100 px-3 py-1 rounded-full">æœªé¸æ“‡ç…§ç‰‡</span>
                </div>
                <div id="new-record-photos" class="photo-grid mb-4"></div>

                <button onclick="saveRecord()" class="btn-primary text-lg py-3 shadow-lg shadow-blue-200">ç¢ºèªå„²å­˜ç´€éŒ„</button>
            </div>

            <div class="flex items-center mb-4 mt-8">
                <span class="material-icons text-gray-400 mr-2">history</span>
                <h3 class="font-bold text-gray-700 text-lg">æ­·å²ç´€éŒ„</h3>
            </div>
            <div id="record-list" class="space-y-4">
                </div>
        </div>
    </div>

    <div id="customer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end sm:items-center justify-center transition-opacity">
        <div class="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-center text-gray-800">æ–°å¢å®¢æˆ¶</h2>
            <input type="hidden" id="cust-id">
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-gray-600 pl-1 mb-1 block">å®¢æˆ¶å§“å <span class="text-red-500">*</span></label>
                    <input type="text" id="cust-name" placeholder="è«‹è¼¸å…¥å§“å" class="mb-0">
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-600 pl-1 mb-1 block">é›»è©±è™Ÿç¢¼ <span class="text-red-500">*</span></label>
                    <input type="tel" id="cust-phone" placeholder="09xx-xxx-xxx" inputmode="tel" class="mb-0 font-mono text-lg">
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-600 pl-1 mb-1 block">å®‰è£åœ°å€</label>
                    <textarea id="cust-address" rows="2" placeholder="ç¸£å¸‚/å€åŸŸ/è¡—é“..." class="mb-0"></textarea>
                </div>
                
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold text-gray-600 pl-1 mb-1 block">æ©Ÿå™¨å‹è™Ÿ</label>
                        <input type="text" id="cust-machine" placeholder="ä¾‹å¦‚: RO-500" class="mb-0">
                    </div>
                    <div>
                        <label class="text-sm font-bold text-gray-600 pl-1 mb-1 block">æ¿¾èŠ¯è¦æ ¼</label>
                        <input type="text" id="cust-filter" placeholder="ä¾‹å¦‚: 10å‹é€šç”¨" class="mb-0">
                    </div>
                </div>

                <div>
                    <label class="text-sm font-bold text-gray-600 pl-1 mb-1 block">å‚™è¨»äº‹é …</label>
                    <textarea id="cust-note" rows="2" placeholder="å…¶ä»–è¯çµ¡äººã€ç‰¹æ®Šéœ€æ±‚..." class="mb-0 bg-orange-50 border-orange-100 focus:border-orange-300"></textarea>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300">
                    <label class="text-sm font-bold text-gray-600 mb-3 block flex items-center">
                        <span class="material-icons text-gray-400 mr-1">image</span>
                        æ›´æ–°å®‰è£ç…§ç‰‡
                    </label>
                    <input type="file" id="cust-photo-input" accept="image/*" class="mb-0 bg-white">
                </div>
            </div>
            
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200">å–æ¶ˆ</button>
                <button onclick="saveCustomer()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-700">ç¢ºèªå„²å­˜</button>
            </div>
            <button id="btn-delete-customer" onclick="deleteCustomer()" class="w-full mt-4 text-red-500 text-sm font-bold py-2 bg-red-50 rounded-xl hidden hover:bg-red-100">åˆªé™¤æ­¤å®¢æˆ¶è³‡æ–™</button>
        </div>
    </div>

    <div id="loading" class="loading-overlay hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600 mb-4"></div>
            <p class="text-gray-800 font-bold text-lg">è³‡æ–™åŒæ­¥ä¸­...</p>
            <p class="text-gray-500 text-sm mt-2">è«‹ç¨å€™ç‰‡åˆ»</p>
        </div>
    </div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è«‹å‹™å¿…ç¢ºèªé€™è£¡æ˜¯ä½ æœ€æ–°çš„ Google Apps Script ç¶²å€ (ä»¥ /exec çµå°¾) âš ï¸âš ï¸âš ï¸
        const API_URL = "https://script.google.com/macros/s/AKfycby0TrkaHnLe0UaZIGQ7DFKnq_1q_QbHWJsjxQ4YCstZ5i_U_OszwLnENXxUlSq_k_NT/exec"; 

        let customers = [];
        let currentCustomer = null;
        let selectedPhotos = [];

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            fetchCustomers();
            document.getElementById('record-date').valueAsDate = new Date();
        };

        // --- API å‘¼å« ---
        async function apiCall(action, payload = {}, method = 'POST') {
            showLoading(true);
            try {
                // å¦‚æœ payload ä¸­æœ‰ phoneï¼Œç¢ºä¿å®ƒæ˜¯å­—ä¸²
                if (payload.phone) payload.phone = String(payload.phone);
                
                if (method === 'GET') {
                    const query = new URLSearchParams({ action, ...payload }).toString();
                    const res = await fetch(`${API_URL}?${query}`);
                    return await res.json();
                } else {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action, ...payload })
                    });
                    return await res.json();
                }
            } catch (e) {
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤è¨Šæ¯: " + e.message);
                console.error(e);
            } finally {
                showLoading(false);
            }
        }

        // --- å®¢æˆ¶åˆ—è¡¨åŠŸèƒ½ ---
        async function fetchCustomers() {
            const data = await apiCall('getCustomers', {}, 'GET');
            if (Array.isArray(data)) {
                customers = data;
                renderList(customers);
            } else {
                 document.getElementById('customer-list').innerHTML = '<div class="text-center text-red-500 mt-10 font-bold">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
            }
        }

        function renderList(list) {
            const container = document.getElementById('customer-list');
            container.innerHTML = '';
            
            if (list.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 mt-20 flex flex-col items-center">
                        <span class="material-icons-outlined text-6xl mb-4 text-gray-200">folder_off</span>
                        <p class="font-bold text-lg text-gray-500">ç›®å‰æ²’æœ‰å®¢æˆ¶è³‡æ–™</p>
                        <p class="text-sm mt-2">é»æ“Šå³ä¸‹è§’çš„æŒ‰éˆ•æ–°å¢ç¬¬ä¸€ä½å®¢æˆ¶</p>
                    </div>`;
                return;
            }

            list.forEach(c => {
                const div = document.createElement('div');
                div.className = 'card flex justify-between items-center active:scale-[0.98] transition-transform cursor-pointer hover:bg-gray-50 pr-4 py-5';
                div.onclick = () => openDetail(c);
                div.innerHTML = `
                    <div class="flex items-center overflow-hidden">
                        <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xl mr-4 flex-shrink-0">
                            ${c.name.charAt(0)}
                        </div>
                        <div class="truncate">
                            <div class="font-bold text-xl text-gray-800 truncate mb-1">${c.name}</div>
                            <div class="text-blue-600 font-mono font-bold flex items-center">
                                <span class="material-icons text-sm mr-1">phone</span>
                                ${c.phone}
                            </div>
                            ${c.note ? `<div class="text-orange-500 text-sm mt-2 flex items-center truncate"><span class="material-icons text-sm mr-1">sticky_note_2</span>${c.note}</div>` : ''}
                        </div>
                    </div>
                    <span class="material-icons text-gray-300">chevron_right</span>
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(term) || 
                String(c.phone).includes(term) ||
                (c.note && c.note.toLowerCase().includes(term)) ||
                (c.address && c.address.toLowerCase().includes(term))
            );
            renderList(filtered);
        });

        // --- è©³æƒ…é åŠŸèƒ½ (æ’ç‰ˆæ›´æ–°) ---
        async function openDetail(customer) {
            currentCustomer = customer;
            document.getElementById('page-list').classList.add('hidden');
            document.getElementById('page-detail').classList.remove('hidden');
            window.scrollTo(0, 0);

            // å¡«å…¥è³‡æ–™
            document.getElementById('detail-header-name').innerText = customer.name;
            document.getElementById('detail-name').innerText = customer.name;
            document.getElementById('detail-phone').innerText = customer.phone;
            document.getElementById('detail-phone-link').href = `tel:${customer.phone}`;
            
            setTextOrPlaceholder('detail-address', customer.address, 'æœªå¡«å¯«åœ°å€');
            setTextOrPlaceholder('detail-machine', customer.machine, 'æœªå¡«å¯«å‹è™Ÿ');
            setTextOrPlaceholder('detail-filter', customer.filter, 'æœªå¡«å¯«è¦æ ¼');
            
            const noteContainer = document.getElementById('note-container');
            if (customer.note) {
                document.getElementById('detail-note').innerText = customer.note;
                noteContainer.classList.remove('hidden');
            } else {
                noteContainer.classList.add('hidden');
            }
            
            const photoDiv = document.getElementById('customer-install-photo');
            if (customer.photo) {
                photoDiv.style.backgroundImage = `url('${customer.photo}')`;
                photoDiv.onclick = () => window.open(customer.photo, '_blank');
                photoDiv.classList.remove('bg-gray-200');
            } else {
                photoDiv.style.backgroundImage = 'none';
                photoDiv.classList.add('bg-gray-200');
                photoDiv.innerHTML = '<span class="material-icons text-gray-400 text-4xl flex items-center justify-center h-full">image_not_supported</span>';
                photoDiv.onclick = null;
            }

            // è¼‰å…¥ç´€éŒ„
            await fetchRecords(customer.id);
        }

        function setTextOrPlaceholder(id, value, placeholder) {
            const el = document.getElementById(id);
            if (value) {
                el.innerText = value;
                el.classList.remove('text-gray-400', 'italic');
            } else {
                el.innerText = placeholder;
                el.classList.add('text-gray-400', 'italic');
            }
        }

        function goBack() {
            document.getElementById('page-detail').classList.add('hidden');
            document.getElementById('page-list').classList.remove('hidden');
            currentCustomer = null;
            document.getElementById('record-items').value = '';
            document.getElementById('record-amount').value = '';
            document.getElementById('record-note').value = '';
            selectedPhotos = [];
            renderPhotoPreview();
        }

        // --- ç´€éŒ„åŠŸèƒ½ ---
        async function fetchRecords(custId) {
            const listDiv = document.getElementById('record-list');
            listDiv.innerHTML = `
                <div class="card flex items-center justify-center py-8 text-blue-600 font-bold">
                    <div class="animate-spin rounded-full h-6 w-6 border-2 border-blue-200 border-t-blue-600 mr-3"></div>
                    è®€å–ç´€éŒ„ä¸­...
                </div>`;
            
            const records = await apiCall('getRecords', { customerId: custId }, 'GET');
            listDiv.innerHTML = '';

            if (!records || records.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center py-10 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                        <span class="material-icons-outlined text-5xl text-gray-300 mb-3">history_edu</span>
                        <p class="text-gray-500 font-bold">å°šç„¡ä¿é¤Šç´€éŒ„</p>
                        <p class="text-sm text-gray-400 mt-1">è«‹åœ¨ä¸Šæ–¹æ–°å¢ç¬¬ä¸€ç­†ç´€éŒ„</p>
                    </div>`;
                return;
            }

            records.forEach(r => {
                const photos = r.photos ? JSON.parse(r.photos) : [];
                const div = document.createElement('div');
                div.className = 'card border-l-[6px] border-blue-500 pl-5 relative overflow-hidden';
                
                // æ ¼å¼åŒ–æ—¥æœŸ
                const dateObj = new Date(r.date);
                const dateStr = `${dateObj.getFullYear()}/${(dateObj.getMonth()+1).toString().padStart(2,'0')}/${dateObj.getDate().toString().padStart(2,'0')}`;

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center">
                             <span class="material-icons text-blue-500 mr-2">event</span>
                             <div class="font-bold text-xl text-gray-800">${dateStr}</div>
                        </div>
                        ${r.amount ? `<div class="text-green-600 font-bold font-mono text-xl bg-green-50 px-3 py-1 rounded-lg">NT$${r.amount}</div>` : ''}
                    </div>
                    <div class="mb-3">
                        <div class="text-gray-500 text-sm font-bold mb-1">æ›´æ›é …ç›®</div>
                        <div class="text-gray-800 font-bold text-lg bg-gray-50 p-3 rounded-xl">${r.items}</div>
                    </div>
                    ${r.note ? `
                        <div class="mb-3">
                             <div class="text-gray-500 text-sm font-bold mb-1">å‚™è¨»</div>
                             <div class="text-gray-600 bg-orange-50 p-3 rounded-xl text-sm">${r.note}</div>
                        </div>` : ''}
                    
                    ${photos.length > 0 ? `
                        <div class="mt-4">
                            <div class="text-gray-500 text-sm font-bold mb-2 flex items-center"><span class="material-icons text-sm mr-1">photo_library</span>ç¾å ´ç…§ç‰‡ (${photos.length})</div>
                            <div class="photo-grid">
                                ${photos.map(url => `<img src="${url}" class="photo-thumb cursor-pointer" onclick="window.open('${url}')">`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div class="text-right mt-4 pt-3 border-t border-gray-100">
                        <button onclick="deleteRecord('${r.id}')" class="text-red-500 text-sm font-bold px-3 py-1 rounded-full hover:bg-red-50 flex items-center ml-auto">
                            <span class="material-icons text-sm mr-1">delete</span>åˆªé™¤ç´€éŒ„
                        </button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        async function saveRecord() {
            if (!currentCustomer) return;
            const items = document.getElementById('record-items').value;
            if (!items) return alert("è«‹è¼¸å…¥æ›´æ›é …ç›®");

            let photoUrls = [];
            if (selectedPhotos.length > 0) {
                showLoading(true);
                for (let base64 of selectedPhotos) {
                    const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                    if (res.status === 'success') {
                        photoUrls.push(res.url);
                    }
                }
            }

            const payload = {
                customerId: currentCustomer.id,
                date: document.getElementById('record-date').value,
                items: items,
                amount: document.getElementById('record-amount').value,
                note: document.getElementById('record-note').value,
                photos: photoUrls
            };

            const res = await apiCall('addRecord', payload);
            if (res.status === 'success') {
                alert("ğŸ‰ ç´€éŒ„æ–°å¢æˆåŠŸï¼");
                document.getElementById('record-items').value = '';
                document.getElementById('record-amount').value = '';
                document.getElementById('record-note').value = '';
                selectedPhotos = [];
                renderPhotoPreview();
                fetchRecords(currentCustomer.id);
                // æ»¾å‹•åˆ°ç´€éŒ„åˆ—è¡¨
                document.getElementById('record-list').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert("æ–°å¢å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
            }
        }

        async function deleteRecord(id) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ(ç„¡æ³•å¾©åŸ)")) return;
            await apiCall('deleteRecord', { id });
            fetchRecords(currentCustomer.id);
        }

        // --- ç…§ç‰‡è™•ç† ---
        function handlePhotoSelect(input) {
            const files = input.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    resizeImage(e.target.result, 1024, (resizedBase64) => { // ç¨å¾®æé«˜è§£æåº¦åˆ° 1024
                        selectedPhotos.push(resizedBase64);
                        renderPhotoPreview();
                    });
                };
                reader.readAsDataURL(file);
            });
            input.value = '';
        }

        function renderPhotoPreview() {
            const div = document.getElementById('new-record-photos');
            const countSpan = document.getElementById('photo-count');
            div.innerHTML = '';
            countSpan.innerText = selectedPhotos.length ? `å·²é¸æ“‡ ${selectedPhotos.length} å¼µ` : 'æœªé¸æ“‡ç…§ç‰‡';
            countSpan.className = selectedPhotos.length ? "text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded-full font-bold" : "text-sm text-gray-400 bg-gray-100 px-3 py-1 rounded-full";
            
            selectedPhotos.forEach((src, idx) => {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'relative flex-shrink-0 animate-fade-in';
                imgContainer.innerHTML = `
                    <img src="${src}" class="photo-thumb">
                    <button onclick="removePhoto(${idx})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md border-2 border-white">
                        <span class="material-icons text-sm">close</span>
                    </button>
                `;
                div.appendChild(imgContainer);
            });
        }

        function removePhoto(idx) {
            selectedPhotos.splice(idx, 1);
            renderPhotoPreview();
        }

        function resizeImage(base64, maxWidth, callback) {
            const img = new Image();
            img.src = base64;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', 0.8)); 
            };
        }

        // --- Modal ç›¸é—œ ---
        function showAddCustomerModal() {
            document.getElementById('modal-title').innerText = 'æ–°å¢å®¢æˆ¶';
            document.getElementById('cust-id').value = '';
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-phone').value = '';
            document.getElementById('cust-address').value = '';
            document.getElementById('cust-note').value = '';
            document.getElementById('cust-machine').value = '';
            document.getElementById('cust-filter').value = '';
            document.getElementById('cust-photo-input').value = '';
            document.getElementById('btn-delete-customer').classList.add('hidden');
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        function showEditCustomerModal() {
            if (!currentCustomer) return;
            document.getElementById('modal-title').innerText = 'ç·¨è¼¯è³‡æ–™';
            document.getElementById('cust-id').value = currentCustomer.id;
            document.getElementById('cust-name').value = currentCustomer.name;
            document.getElementById('cust-phone').value = currentCustomer.phone;
            document.getElementById('cust-address').value = currentCustomer.address;
            document.getElementById('cust-note').value = currentCustomer.note;
            document.getElementById('cust-machine').value = currentCustomer.machine;
            document.getElementById('cust-filter').value = currentCustomer.filter;
            document.getElementById('btn-delete-customer').classList.remove('hidden');
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('customer-modal').classList.add('hidden');
        }

        async function saveCustomer() {
            const id = document.getElementById('cust-id').value;
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;

            if (!name || !phone) {
                alert("å§“åå’Œé›»è©±ç‚ºå¿…å¡«æ¬„ä½ï¼");
                return;
            }

            const photoInput = document.getElementById('cust-photo-input');
            let photoUrl = "";
            if (photoInput.files.length > 0) {
                showLoading(true);
                const file = photoInput.files[0];
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resizeImage(e.target.result, 1024, resolve);
                    reader.readAsDataURL(file);
                });
                const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                if (res.status === 'success') photoUrl = res.url;
            }

            const payload = {
                id: id,
                name: name,
                phone: phone, // é€™è£¡æœƒæ˜¯å­—ä¸² "09xxxxxxxx"
                address: document.getElementById('cust-address').value,
                note: document.getElementById('cust-note').value,
                machine: document.getElementById('cust-machine').value,
                filter: document.getElementById('cust-filter').value,
                photo: photoUrl || (currentCustomer ? currentCustomer.photo : "")
            };

            const action = id ? 'updateCustomer' : 'addCustomer';
            const res = await apiCall(action, payload);
            
            if (res.status === 'success') {
                alert("ğŸ‰ å®¢æˆ¶è³‡æ–™å„²å­˜æˆåŠŸï¼");
                closeModal();
                fetchCustomers();
                if (id && currentCustomer) {
                    openDetail({ ...currentCustomer, ...payload }); 
                }
            } else {
                alert("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
            }
        }

        async function deleteCustomer() {
            if (!confirm("ğŸ”¥ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶åŠå…¶æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
            const id = document.getElementById('cust-id').value;
            await apiCall('deleteCustomer', { id });
            alert("å®¢æˆ¶å·²åˆªé™¤ã€‚");
            closeModal();
            goBack();
            fetchCustomers();
        }

        function showLoading(show) {
            const el = document.getElementById('loading');
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        document.getElementById('customer-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('customer-modal')) {
                closeModal();
            }
        });
    </script>
</body>
</html>
