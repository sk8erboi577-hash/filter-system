<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¿¾èŠ¯ä¿é¤Šç³»çµ±</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¿¾èŠ¯ä¿é¤Š">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/water-filter.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #2563eb; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; text-align: center; width: 100%; display: block; }
        .btn-danger { background-color: #ef4444; color: white; }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background: #2563eb; border-radius: 50%; display: flex; align-items: center; justifyContent: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 50; cursor: pointer; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 999; flex-direction: column;}
        .hidden { display: none !important; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        /* ç…§ç‰‡é è¦½ */
        .photo-grid { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .photo-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="page-list">
        <div class="bg-white p-4 sticky top-0 z-10 shadow-sm">
            <h1 class="text-xl font-bold text-center mb-3 text-gray-800">ğŸ’§ æ¿¾èŠ¯ä¿é¤Šç³»çµ±</h1>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <span class="material-icons">search</span>
                </span>
                <input type="text" id="search-input" placeholder="æœå°‹å§“åã€é›»è©±æˆ–å‚™è¨»..." class="pl-10 mb-0">
            </div>
        </div>
        <div id="customer-list" class="p-4">
            <div class="text-center text-gray-400 mt-10">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="fab" onclick="showAddCustomerModal()">
            <span class="material-icons" style="font-size: 32px;">add</span>
        </div>
    </div>

    <div id="page-detail" class="hidden min-h-screen bg-gray-50">
        <div class="bg-white p-3 shadow-sm flex items-center sticky top-0 z-10">
            <button onclick="goBack()" class="p-2 mr-2 text-gray-600"><span class="material-icons">arrow_back</span></button>
            <h2 id="detail-name" class="text-lg font-bold flex-1">å®¢æˆ¶è©³æƒ…</h2>
            <button onclick="showEditCustomerModal()" class="text-blue-600 font-bold px-3">ç·¨è¼¯</button>
        </div>
        
        <div class="p-4">
            <div class="card">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-gray-500 mb-2">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h3>
                    <div id="customer-install-photo" class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden cursor-pointer" onclick="viewImage(this.src)"></div>
                </div>
                <p id="detail-phone" class="text-lg font-mono mb-1"></p>
                <p id="detail-address" class="text-gray-600 mb-1"></p>
                <p id="detail-machine" class="text-gray-600"></p>
                <p id="detail-filter" class="text-gray-600"></p>
                <p id="detail-note" class="text-orange-500 text-sm mt-2"></p>
            </div>

            <div class="card bg-blue-50 border border-blue-100">
                <h3 class="font-bold text-blue-800 mb-3">â• æ–°å¢ä¿é¤Šç´€éŒ„</h3>
                <input type="date" id="record-date">
                <input type="text" id="record-items" placeholder="æ›´æ›é …ç›® (å¦‚: PP, æ´»æ€§ç¢³)">
                <input type="number" id="record-amount" placeholder="é‡‘é¡ (NT$)" inputmode="numeric">
                <input type="text" id="record-note" placeholder="å‚™è¨»">
                
                <div class="flex items-center gap-2 mb-3">
                    <label class="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg cursor-pointer flex items-center gap-1 shadow-sm">
                        <span class="material-icons text-sm">photo_camera</span> æ‹ç…§
                        <input type="file" id="record-photo-input" accept="image/*" multiple class="hidden" onchange="handlePhotoSelect(this)">
                    </label>
                    <span id="photo-count" class="text-sm text-gray-500">æœªé¸æ“‡ç…§ç‰‡</span>
                </div>
                <div id="new-record-photos" class="photo-grid mb-3"></div>

                <button onclick="saveRecord()" class="btn-primary">å„²å­˜ç´€éŒ„</button>
            </div>

            <h3 class="font-bold text-gray-700 ml-1 mb-2">ğŸ“œ æ­·å²ç´€éŒ„</h3>
            <div id="record-list">
                </div>
        </div>
    </div>

    <div id="customer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-5 max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-center">æ–°å¢å®¢æˆ¶</h2>
            <input type="hidden" id="cust-id">
            <label class="text-sm text-gray-500">å§“å</label>
            <input type="text" id="cust-name">
            <label class="text-sm text-gray-500">é›»è©±</label>
            <input type="tel" id="cust-phone">
            <label class="text-sm text-gray-500">åœ°å€</label>
            <input type="text" id="cust-address">
            <label class="text-sm text-gray-500">å‚™è¨» (å…¶ä»–è¯çµ¡äºº)</label>
            <textarea id="cust-note" rows="2" class="w-full p-2 border rounded mb-2"></textarea>
            <label class="text-sm text-gray-500">æ©Ÿå™¨å‹è™Ÿ</label>
            <input type="text" id="cust-machine">
            <label class="text-sm text-gray-500">æ¿¾èŠ¯è¦æ ¼</label>
            <input type="text" id="cust-filter">
            
            <label class="text-sm text-gray-500 block mb-1">å®‰è£ç…§ç‰‡</label>
            <input type="file" id="cust-photo-input" accept="image/*" class="mb-3">
            
            <div class="flex gap-2 mt-4">
                <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg">å–æ¶ˆ</button>
                <button onclick="saveCustomer()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg">å„²å­˜</button>
            </div>
            <button id="btn-delete-customer" onclick="deleteCustomer()" class="w-full mt-3 text-red-500 text-sm hidden">åˆªé™¤æ­¤å®¢æˆ¶</button>
        </div>
    </div>

    <div id="loading" class="loading-overlay hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-3"></div>
        <p class="text-gray-600 font-bold">è³‡æ–™è™•ç†ä¸­...</p>
    </div>

    <script>
        // âš ï¸ è«‹æŠŠä¸‹é¢é€™è¡Œæ›æˆä½ çš„ Apps Script ç¶²å€ï¼
        const API_URL = "https://script.google.com/macros/s/AKfycbyqNNmOA2r2UmbYWStobysExwYHuiDQOeEfFY66qKG2dpuVvq0cET0vsFTlOqIcUMU6/exec"; 

        let customers = [];
        let currentCustomer = null;
        let selectedPhotos = []; // æš«å­˜æ–°å¢ç´€éŒ„çš„ç…§ç‰‡ (base64)

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            fetchCustomers();
            // è¨­å®šæ—¥æœŸé è¨­ç‚ºä»Šå¤©
            document.getElementById('record-date').valueAsDate = new Date();
        };

        // --- API å‘¼å« ---
        async function apiCall(action, payload = {}, method = 'POST') {
            showLoading(true);
            try {
                if (method === 'GET') {
                    // Apps Script çš„ GET éœ€è¦ç”¨ query string
                    const query = new URLSearchParams({ action, ...payload }).toString();
                    const res = await fetch(`${API_URL}?${query}`);
                    return await res.json();
                } else {
                    // POST è«‹æ±‚ (ä½¿ç”¨ no-cors æ¨¡å¼æœƒæ‹¿ä¸åˆ°å›æ‡‰ï¼Œæ‰€ä»¥æˆ‘å€‘ç”¨æ¨™æº– fetchï¼Œä½† Apps Script è¦è¨­å®šå¥½å›æ‡‰æ¨™é ­)
                    // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘ç”¨ text/plain å‚³é€ JSON é¿å… CORS é æª¢ (Simple Request)
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action, ...payload })
                    });
                    return await res.json();
                }
            } catch (e) {
                alert("é€£ç·šéŒ¯èª¤: " + e.message);
                console.error(e);
            } finally {
                showLoading(false);
            }
        }

        // --- å®¢æˆ¶åˆ—è¡¨åŠŸèƒ½ ---
        async function fetchCustomers() {
            const data = await apiCall('getCustomers', {}, 'GET');
            if (Array.isArray(data)) {
                customers = data;
                renderList(customers);
            }
        }

        function renderList(list) {
            const container = document.getElementById('customer-list');
            container.innerHTML = '';
            
            if (list.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-10">æ²’æœ‰è³‡æ–™</div>';
                return;
            }

            list.forEach(c => {
                const div = document.createElement('div');
                div.className = 'card flex justify-between items-center active:bg-gray-50 cursor-pointer';
                div.onclick = () => openDetail(c);
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-lg">${c.name}</div>
                        <div class="text-gray-500 font-mono">${c.phone}</div>
                        ${c.note ? `<div class="text-orange-500 text-xs mt-1">ğŸ“ ${c.note}</div>` : ''}
                    </div>
                    <span class="material-icons text-gray-300">chevron_right</span>
                `;
                container.appendChild(div);
            });
        }

        // æœå°‹åŠŸèƒ½
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(term) || 
                String(c.phone).includes(term) ||
                (c.note && c.note.toLowerCase().includes(term))
            );
            renderList(filtered);
        });

        // --- è©³æƒ…é åŠŸèƒ½ ---
        async function openDetail(customer) {
            currentCustomer = customer;
            document.getElementById('page-list').classList.add('hidden');
            document.getElementById('page-detail').classList.remove('hidden');
            window.scrollTo(0, 0);

            // å¡«å…¥è³‡æ–™
            document.getElementById('detail-name').innerText = customer.name;
            document.getElementById('detail-phone').innerText = customer.phone;
            document.getElementById('detail-address').innerText = `ğŸ  ${customer.address || 'ç„¡åœ°å€'}`;
            document.getElementById('detail-note').innerText = customer.note ? `ğŸ“ ${customer.note}` : '';
            document.getElementById('detail-machine').innerText = `âš™ï¸ ${customer.machine || 'æœªå¡«å¯«'}`;
            document.getElementById('detail-filter').innerText = `ğŸ“ ${customer.filter || 'æœªå¡«å¯«'}`;
            
            const photoDiv = document.getElementById('customer-install-photo');
            if (customer.photo) {
                photoDiv.style.backgroundImage = `url('${customer.photo}')`;
                photoDiv.style.backgroundSize = 'cover';
                photoDiv.onclick = () => window.open(customer.photo, '_blank');
            } else {
                photoDiv.style.background = '#eee';
                photoDiv.onclick = null;
            }

            // è¼‰å…¥ç´€éŒ„
            await fetchRecords(customer.id);
        }

        function goBack() {
            document.getElementById('page-detail').classList.add('hidden');
            document.getElementById('page-list').classList.remove('hidden');
            currentCustomer = null;
            // æ¸…ç©ºæ–°å¢ç´€éŒ„æ¬„ä½
            document.getElementById('record-items').value = '';
            document.getElementById('record-amount').value = '';
            document.getElementById('record-note').value = '';
            selectedPhotos = [];
            renderPhotoPreview();
        }

        // --- ç´€éŒ„åŠŸèƒ½ ---
        async function fetchRecords(custId) {
            const listDiv = document.getElementById('record-list');
            listDiv.innerHTML = '<div class="text-center py-4">è¼‰å…¥ç´€éŒ„ä¸­...</div>';
            
            const records = await apiCall('getRecords', { customerId: custId }, 'GET');
            listDiv.innerHTML = '';

            if (!records || records.length === 0) {
                listDiv.innerHTML = '<div class="text-gray-400 text-center py-4">å°šç„¡ä¿é¤Šç´€éŒ„</div>';
                return;
            }

            records.forEach(r => {
                const photos = r.photos ? JSON.parse(r.photos) : [];
                const div = document.createElement('div');
                div.className = 'card border-l-4 border-blue-500';
                div.innerHTML = `
                    <div class="flex justify-between">
                        <div class="font-bold text-lg">${r.date.split('T')[0]}</div>
                        ${r.amount ? `<div class="text-green-600 font-bold">$${r.amount}</div>` : ''}
                    </div>
                    <div class="text-blue-800 my-1">${r.items}</div>
                    ${r.note ? `<div class="text-gray-500 text-sm mb-2">å‚™è¨»: ${r.note}</div>` : ''}
                    
                    ${photos.length > 0 ? `
                        <div class="photo-grid mt-2">
                            ${photos.map(url => `<img src="${url}" class="photo-thumb" onclick="window.open('${url}')">`).join('')}
                        </div>
                    ` : ''}
                    <div class="text-right mt-2">
                        <button onclick="deleteRecord('${r.id}')" class="text-red-400 text-sm">åˆªé™¤</button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        async function saveRecord() {
            if (!currentCustomer) return;
            const items = document.getElementById('record-items').value;
            if (!items) return alert("è«‹è¼¸å…¥é …ç›®");

            // å…ˆä¸Šå‚³ç…§ç‰‡ (å¦‚æœæœ‰)
            let photoUrls = [];
            if (selectedPhotos.length > 0) {
                showLoading(true); // å¼·åˆ¶é¡¯ç¤º loading
                for (let base64 of selectedPhotos) {
                    // ä¸Šå‚³æ¯å¼µç…§ç‰‡åˆ° Apps Script
                    const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                    if (res.status === 'success') {
                        photoUrls.push(res.url);
                    }
                }
            }

            const payload = {
                customerId: currentCustomer.id,
                date: document.getElementById('record-date').value,
                items: items,
                amount: document.getElementById('record-amount').value,
                note: document.getElementById('record-note').value,
                photos: photoUrls
            };

            const res = await apiCall('addRecord', payload);
            if (res.status === 'success') {
                alert("ç´€éŒ„æ–°å¢æˆåŠŸï¼");
                document.getElementById('record-items').value = '';
                document.getElementById('record-amount').value = '';
                document.getElementById('record-note').value = '';
                selectedPhotos = [];
                renderPhotoPreview();
                fetchRecords(currentCustomer.id);
            } else {
                alert("å¤±æ•—");
            }
        }

        async function deleteRecord(id) {
            if (!confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) return;
            await apiCall('deleteRecord', { id });
            fetchRecords(currentCustomer.id);
        }

        // --- ç…§ç‰‡è™•ç† ---
        function handlePhotoSelect(input) {
            const files = input.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // å£“ç¸®åœ–ç‰‡ (éå¸¸é‡è¦ï¼Œä¸ç„¶ Excel æœƒçˆ†) - é€™è£¡æˆ‘å€‘é›–ç„¶å­˜é›²ç«¯ï¼Œä½†ç¸®å°ä¸€é»ä¸Šå‚³æ¯”è¼ƒå¿«
                    resizeImage(e.target.result, 800, (resizedBase64) => {
                        selectedPhotos.push(resizedBase64);
                        renderPhotoPreview();
                    });
                };
                reader.readAsDataURL(file);
            });
            input.value = ''; // é‡ç½®
        }

        function renderPhotoPreview() {
            const div = document.getElementById('new-record-photos');
            const countSpan = document.getElementById('photo-count');
            div.innerHTML = '';
            countSpan.innerText = selectedPhotos.length ? `å·²é¸ ${selectedPhotos.length} å¼µ` : 'æœªé¸æ“‡ç…§ç‰‡';
            
            selectedPhotos.forEach((src, idx) => {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'relative flex-shrink-0';
                imgContainer.innerHTML = `
                    <img src="${src}" class="photo-thumb">
                    <button onclick="removePhoto(${idx})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">Ã—</button>
                `;
                div.appendChild(imgContainer);
            });
        }

        function removePhoto(idx) {
            selectedPhotos.splice(idx, 1);
            renderPhotoPreview();
        }

        // åœ–ç‰‡å£“ç¸®å‡½å¼
        function resizeImage(base64, maxWidth, callback) {
            const img = new Image();
            img.src = base64;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', 0.7)); // 0.7 å“è³ª
            };
        }

        // --- æ–°å¢/ç·¨è¼¯å®¢æˆ¶ Modal ---
        function showAddCustomerModal() {
            document.getElementById('modal-title').innerText = 'æ–°å¢å®¢æˆ¶';
            document.getElementById('cust-id').value = '';
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-phone').value = '';
            document.getElementById('cust-address').value = '';
            document.getElementById('cust-note').value = '';
            document.getElementById('cust-machine').value = '';
            document.getElementById('cust-filter').value = '';
            document.getElementById('cust-photo-input').value = '';
            document.getElementById('btn-delete-customer').classList.add('hidden');
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        function showEditCustomerModal() {
            if (!currentCustomer) return;
            document.getElementById('modal-title').innerText = 'ç·¨è¼¯è³‡æ–™';
            document.getElementById('cust-id').value = currentCustomer.id;
            document.getElementById('cust-name').value = currentCustomer.name;
            document.getElementById('cust-phone').value = currentCustomer.phone;
            document.getElementById('cust-address').value = currentCustomer.address;
            document.getElementById('cust-note').value = currentCustomer.note;
            document.getElementById('cust-machine').value = currentCustomer.machine;
            document.getElementById('cust-filter').value = currentCustomer.filter;
            document.getElementById('btn-delete-customer').classList.remove('hidden');
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('customer-modal').classList.add('hidden');
        }

        async function saveCustomer() {
            const id = document.getElementById('cust-id').value;
            const photoInput = document.getElementById('cust-photo-input');
            
            let photoUrl = "";
            // å¦‚æœæœ‰é¸æ–°ç…§ç‰‡ï¼Œå…ˆä¸Šå‚³
            if (photoInput.files.length > 0) {
                showLoading(true);
                const file = photoInput.files[0];
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resizeImage(e.target.result, 800, resolve);
                    reader.readAsDataURL(file);
                });
                const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                if (res.status === 'success') photoUrl = res.url;
            }

            const payload = {
                id: id, // å¦‚æœæ˜¯ç©ºçš„å°±æ˜¯æ–°å¢
                name: document.getElementById('cust-name').value,
                phone: document.getElementById('cust-phone').value,
                address: document.getElementById('cust-address').value,
                note: document.getElementById('cust-note').value,
                machine: document.getElementById('cust-machine').value,
                filter: document.getElementById('cust-filter').value,
                photo: photoUrl || (currentCustomer ? currentCustomer.photo : "") // æœ‰æ–°åœ–ç”¨æ–°åœ–ï¼Œæ²’æ–°åœ–ç”¨èˆŠåœ–
            };

            const action = id ? 'updateCustomer' : 'addCustomer';
            const res = await apiCall(action, payload);
            
            if (res.status === 'success') {
                alert("å„²å­˜æˆåŠŸï¼");
                closeModal();
                fetchCustomers();
                if (id && currentCustomer) {
                    // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œæ›´æ–°ç•¶å‰é¡¯ç¤º
                    openDetail({ ...currentCustomer, ...payload }); 
                }
            } else {
                alert("å„²å­˜å¤±æ•—");
            }
        }

        async function deleteCustomer() {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶å—ï¼Ÿ(ç„¡æ³•å¾©åŸ)")) return;
            const id = document.getElementById('cust-id').value;
            await apiCall('deleteCustomer', { id });
            alert("å·²åˆªé™¤");
            closeModal();
            goBack();
            fetchCustomers();
        }

        function showLoading(show) {
            const el = document.getElementById('loading');
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }
    </script>
</body>
</html>

