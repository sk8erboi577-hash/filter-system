<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>濾芯保養系統 Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/water-filter.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#ecfeff',
                            100: '#cffafe',
                            400: '#22d3ee',
                            500: '#06b6d4', // 水藍主色
                            600: '#0891b2',
                            800: '#155e75',
                            900: '#0e7490',
                        },
                        surface: '#F3F4F6',
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'glow': '0 0 20px rgba(6, 182, 212, 0.5)',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #F3F4F6; 
            padding-bottom: 120px; 
            -webkit-font-smoothing: antialiased; 
            color: #1f2937;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUpModal 0.35s cubic-bezier(0.16, 1, 0.3, 1); }

        .input-field {
            width: 100%; padding: 16px 20px; border-radius: 16px;
            background-color: #ffffff; border: 1px solid #e5e7eb;
            color: #1f2937; font-size: 16px; transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .input-field:focus {
            border-color: #06b6d4; box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.15); outline: none;
        }
        
        /* 藍色卡片內的輸入框樣式 */
        .blue-card-input {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            transition: all 0.2s;
        }
        .blue-card-input::placeholder { color: rgba(255, 255, 255, 0.6); }
        .blue-card-input:focus {
            background-color: rgba(255, 255, 255, 0.25);
            outline: none;
            border-color: white;
        }

        .fab {
            position: fixed; bottom: 32px; right: 24px; width: 64px; height: 64px;
            background: linear-gradient(135deg, #22d3ee 0%, #0891b2 100%);
            border-radius: 24px; display: flex; align-items: center; justify-content: center;
            color: white; box-shadow: 0 12px 30px -8px rgba(6, 182, 212, 0.6);
            z-index: 50; cursor: pointer; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        label { font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block; margin-left: 4px; }
    </style>
</head>
<body>

    <div id="page-list" class="animate-fade-in-up">
        <div class="pt-14 pb-4 px-6 sticky top-0 z-20 bg-[#F3F4F6]/80 backdrop-blur-xl border-b border-gray-200/50">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">濾芯保養</h1>
                    <p class="text-gray-500 text-sm font-medium mt-1">管理您的客戶與紀錄</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
                    <span class="material-icons-round">water_drop</span>
                </div>
            </div>
            
            <div class="relative group">
                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400 group-focus-within:text-primary-500 transition-colors">
                    <span class="material-icons-round">search</span>
                </span>
                <input type="text" id="search-input" placeholder="搜尋客戶名稱、電話..." 
                       class="w-full pl-12 pr-4 py-3.5 bg-white border-none rounded-2xl shadow-soft focus:ring-2 focus:ring-primary-400/50 transition-all text-gray-700 text-lg placeholder-gray-400">
            </div>
        </div>

        <div id="customer-list" class="px-5 pt-4 pb-24 space-y-4 max-w-2xl mx-auto">
            <div class="flex flex-col items-center justify-center py-20 text-gray-400">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500 mb-4"></div>
                <p>資料讀取中...</p>
            </div>
        </div>
        
        <div class="fab" onclick="showAddCustomerModal()">
            <span class="material-icons-round text-3xl">add</span>
        </div>
    </div>

    <div id="page-detail" class="hidden min-h-screen bg-[#F3F4F6]">
        <div class="pt-12 pb-2 px-4 flex items-center sticky top-0 z-20 bg-[#F3F4F6]/90 backdrop-blur-xl">
            <button onclick="goBack()" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-gray-700 active:scale-90 transition-transform">
                <span class="material-icons-round">arrow_back</span>
            </button>
            <div class="flex-1 text-center font-bold text-lg text-gray-800 opacity-0 transition-opacity duration-300" id="detail-header-title">客戶詳情</div>
            <button onclick="showEditCustomerModal()" class="text-primary-600 font-bold text-sm px-4 py-2 bg-primary-50 rounded-full active:bg-primary-100 transition-colors">
                編輯
            </button>
        </div>
        
        <div class="px-5 pb-10 max-w-2xl mx-auto space-y-6 animate-fade-in-up">
            
            <div class="bg-white rounded-3xl p-6 shadow-soft relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-primary-50 rounded-full blur-2xl opacity-60"></div>
                <div class="relative z-10">
                    <h2 id="detail-name" class="text-3xl font-extrabold text-gray-800 mb-1"></h2>
                    <a id="detail-phone-link" class="inline-flex items-center text-xl font-bold text-primary-600 mb-6">
                        <span id="detail-phone"></span>
                        <span class="ml-2 w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center">
                            <span class="material-icons-round text-sm">call</span>
                        </span>
                    </a>
                    <div id="customer-photos-container" class="flex gap-3 overflow-x-auto pb-4 no-scrollbar -mx-6 px-6 mb-2"></div>
                    <div class="grid grid-cols-1 gap-4 mt-2">
                        <div class="flex items-start p-3 bg-gray-50 rounded-2xl">
                            <span class="material-icons-round text-gray-400 mt-0.5 mr-3">calendar_today</span>
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">安裝日期</p>
                                <p id="detail-install-date" class="text-gray-800 font-medium"></p>
                            </div>
                        </div>
                        <div class="flex items-start p-3 bg-gray-50 rounded-2xl">
                            <span class="material-icons-round text-gray-400 mt-0.5 mr-3">location_on</span>
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">地址</p>
                                <p id="detail-address" class="text-gray-800 font-medium leading-relaxed"></p>
                            </div>
                        </div>
                        <div class="flex items-start p-3 bg-gray-50 rounded-2xl">
                            <span class="material-icons-round text-gray-400 mt-0.5 mr-3">settings_suggest</span>
                            <div class="flex-1">
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">設備規格</p>
                                <div id="detail-machine" class="text-gray-800 font-bold"></div>
                                <div id="detail-filter" class="text-sm text-gray-500 mt-0.5"></div>
                            </div>
                        </div>
                        <div id="note-container" class="hidden flex items-start p-3 bg-yellow-50 rounded-2xl border border-yellow-100">
                            <span class="material-icons-round text-yellow-500 mt-0.5 mr-3">sticky_note_2</span>
                            <div>
                                <p class="text-xs font-bold text-yellow-600 uppercase tracking-wide">備註</p>
                                <p id="detail-note" class="text-gray-800"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rounded-3xl p-1 bg-gradient-to-br from-primary-400 to-blue-600 shadow-lg text-white">
                <div class="bg-gray-900/10 backdrop-blur-sm p-5 rounded-[20px]">
                    <h3 class="font-bold mb-4 flex items-center text-lg">
                        <span class="bg-white/20 p-1.5 rounded-lg mr-2 flex items-center"><span class="material-icons-round text-lg">post_add</span></span>
                        新增保養紀錄
                    </h3>
                    
                    <div class="grid grid-cols-12 gap-3">
                        <div class="col-span-12">
                            <input type="date" id="record-date" class="blue-card-input">
                        </div>
                        <div class="col-span-12">
                            <input type="text" id="record-items" placeholder="更換項目 (如: 活性碳...)" class="blue-card-input">
                        </div>
                        <div class="col-span-5">
                            <input type="number" id="record-amount" placeholder="金額" inputmode="numeric" class="blue-card-input text-right font-bold text-green-300">
                        </div>
                        <div class="col-span-7">
                            <input type="text" id="record-note" placeholder="備註 (選填)" class="blue-card-input">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="flex items-center gap-2 text-sm font-medium text-white/80 mb-2 cursor-pointer w-fit hover:text-white transition-colors">
                            <span class="material-icons-round">add_a_photo</span>
                            拍照紀錄
                            <input type="file" id="record-photo-input" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)">
                        </label>
                        <div id="new-record-photos" class="flex gap-2 flex-wrap"></div>
                    </div>
                    
                    <button onclick="saveRecord()" class="mt-5 w-full bg-white text-primary-600 py-3.5 rounded-xl font-bold text-lg shadow-lg active:scale-[0.98] transition-transform flex items-center justify-center gap-2">
                        <span>確認儲存</span>
                        <span class="material-icons-round text-sm">send</span>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-gray-800 text-xl mb-4 ml-1 flex items-center">
                    <span class="w-1 h-6 bg-primary-500 rounded-full mr-3"></span>
                    歷史紀錄
                </h3>
                <div id="record-list" class="space-y-4"></div>
            </div>
            <div class="h-10"></div>
        </div>
    </div>

    <div id="customer-modal" class="fixed inset-0 bg-gray-900/60 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-surface w-full max-w-lg rounded-t-[32px] sm:rounded-3xl max-h-[95vh] overflow-hidden flex flex-col shadow-2xl animate-slide-up">
            
            <div class="bg-white px-6 py-4 flex justify-between items-center shrink-0 border-b border-gray-100">
                <button onclick="closeModal('customer-modal')" class="text-gray-500 font-medium hover:text-gray-700 p-2">取消</button>
                <h2 id="modal-title" class="text-lg font-bold text-gray-800">新增客戶</h2>
                <div class="w-10"></div> 
            </div>
            
            <div class="p-6 overflow-y-auto space-y-5 no-scrollbar flex-1">
                <input type="hidden" id="cust-id">
                
                <div class="bg-white rounded-2xl p-5 shadow-sm space-y-4">
                    <h4 class="text-xs font-bold text-gray-400 uppercase">基本資料</h4>
                    <div><label>客戶姓名 <span class="text-red-400">*</span></label><input type="text" id="cust-name" placeholder="請輸入姓名" class="input-field"></div>
                    <div><label>電話號碼 <span class="text-red-400">*</span></label><input type="tel" id="cust-phone" placeholder="09xx-xxx-xxx" inputmode="tel" class="input-field font-mono font-medium"></div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm space-y-4">
                    <h4 class="text-xs font-bold text-gray-400 uppercase">安裝資訊</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2"><label>地址</label><input type="text" id="cust-address" class="input-field" placeholder="縣市/區域..."></div>
                        <div class="col-span-2"><label>安裝日期</label><input type="date" id="cust-install-date" class="input-field"></div>
                        <div><label>機器型號</label><input type="text" id="cust-machine" class="input-field"></div>
                        <div><label>濾芯規格</label><input type="text" id="cust-filter" class="input-field"></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <label>備註</label>
                    <textarea id="cust-note" rows="2" class="input-field bg-yellow-50/50 border-yellow-100 focus:border-yellow-400" placeholder="選填..."></textarea>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <label class="block text-center cursor-pointer py-6 border-2 border-dashed border-gray-200 rounded-xl hover:bg-gray-50 hover:border-primary-300 transition-all group">
                        <span class="material-icons-round text-gray-300 group-hover:text-primary-500 text-4xl mb-2 transition-colors">add_photo_alternate</span>
                        <div class="text-gray-500 font-medium">上傳機器照片</div>
                        <input type="file" id="cust-photo-input" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
                    </label>
                    <div id="cust-photo-preview" class="flex flex-wrap gap-2 mt-4 justify-center"></div>
                </div>
                
                <button id="btn-delete-customer" onclick="deleteCustomer()" class="w-full text-red-500 py-3 rounded-2xl font-bold bg-red-50 hover:bg-red-100 hidden transition-colors mb-2">刪除此客戶</button>

                <button onclick="saveCustomer()" class="w-full bg-primary-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-[0.98] transition-transform mb-6">
                    儲存資料
                </button>
                <div class="h-10"></div> 
            </div>
        </div>
    </div>

    <div id="record-modal" class="fixed inset-0 bg-gray-900/60 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-surface w-full max-w-lg rounded-t-[32px] sm:rounded-3xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl animate-slide-up">
            
            <div class="bg-white px-6 py-4 flex justify-between items-center shrink-0 border-b border-gray-100">
                <button onclick="closeModal('record-modal')" class="text-gray-500 font-medium p-2">取消</button>
                <h2 class="text-lg font-bold text-gray-800">修改紀錄</h2>
                <div class="w-10"></div>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-5 flex-1">
                <input type="hidden" id="edit-record-id">
                <div class="bg-white rounded-2xl p-5 shadow-sm space-y-4">
                    <div><label>保養日期</label><input type="date" id="edit-record-date" class="input-field"></div>
                    <div><label>項目</label><input type="text" id="edit-record-items" class="input-field font-medium"></div>
                    <div><label>金額</label><input type="number" id="edit-record-amount" inputmode="numeric" class="input-field text-green-600 font-bold text-right"></div>
                    <div><label>備註</label><textarea id="edit-record-note" rows="2" class="input-field"></textarea></div>
                </div>
                
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <label class="block text-center cursor-pointer py-4 border-2 border-dashed border-gray-200 rounded-xl hover:bg-gray-50">
                        <span class="material-icons-round text-primary-300 text-3xl mb-1">add_a_photo</span>
                        <div class="text-gray-400 text-sm">加傳照片</div>
                        <input type="file" id="edit-record-photo-input" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
                    </label>
                    <div id="edit-record-photo-preview" class="flex flex-wrap gap-2 mt-3 justify-center"></div>
                </div>

                <button onclick="saveEditedRecord()" class="w-full bg-primary-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-[0.98] transition-transform mt-6 mb-6">
                    完成修改
                </button>
                <div class="h-6"></div>
            </div>
        </div>
    </div>

    <div id="loading" class="fixed inset-0 z-[999] bg-white/50 backdrop-blur-sm hidden flex items-center justify-center">
        <div class="bg-white/90 p-8 rounded-3xl shadow-2xl flex flex-col items-center border border-white">
            <div class="animate-spin rounded-full h-10 w-10 border-[3px] border-gray-200 border-t-primary-500 mb-4"></div>
            <p class="text-gray-600 font-bold tracking-wide text-sm">資料同步中...</p>
        </div>
    </div>

    <script>
        // ⚠️⚠️⚠️ 請確認這裡的 API 網址是正確的 ⚠️⚠️⚠️
        const API_URL = "https://script.google.com/macros/s/AKfycby0TrkaHnLe0UaZIGQ7DFKnq_1q_QbHWJsjxQ4YCstZ5i_U_OszwLnENXxUlSq_k_NT/exec"; 

        let customers = [];
        let currentRecords = []; // 新增：用來儲存當前客戶的紀錄
        let currentCustomer = null;
        let selectedRecordPhotos = [];
        let selectedCustPhotos = [];
        let selectedEditRecordPhotos = [];

        window.onload = () => {
            fetchCustomers();
            document.getElementById('record-date').valueAsDate = new Date();
        };

        async function apiCall(action, payload = {}, method = 'POST') {
            showLoading(true);
            try {
                if (payload.phone) payload.phone = String(payload.phone);
                const url = method === 'GET' 
                    ? `${API_URL}?${new URLSearchParams({ action, ...payload })}` 
                    : API_URL;
                const options = method === 'GET' ? {} : { method: 'POST', body: JSON.stringify({ action, ...payload }) };
                const res = await fetch(url, options);
                return await res.json();
            } catch (e) { alert("連線錯誤，請檢查網路"); } finally { showLoading(false); }
        }

        async function fetchCustomers() {
            const data = await apiCall('getCustomers', {}, 'GET');
            if (Array.isArray(data)) { customers = data; renderList(customers); }
        }

        function renderList(list) {
            const container = document.getElementById('customer-list');
            container.innerHTML = '';
            if (list.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 mt-20">尚無資料</div>'; return; }
            
            list.forEach(c => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-2xl p-4 flex items-center cursor-pointer active:scale-[0.98] transition-all shadow-sm hover:shadow-md border border-gray-100';
                div.onclick = () => openDetail(c);
                div.innerHTML = `
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary-100 to-primary-50 text-primary-600 flex items-center justify-center font-bold text-xl mr-4 flex-shrink-0 shadow-inner">
                        ${c.name.charAt(0)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-lg text-gray-800 truncate">${c.name}</div>
                        <div class="text-gray-400 text-sm font-mono">${c.phone}</div>
                    </div>
                    <span class="material-icons-round text-gray-300">chevron_right</span>`;
                container.appendChild(div);
            });
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderList(customers.filter(c => c.name.toLowerCase().includes(term) || String(c.phone).includes(term) || (c.note && c.note.toLowerCase().includes(term))));
        });

        async function openDetail(customer) {
            currentCustomer = customer;
            document.getElementById('page-list').classList.add('hidden');
            document.getElementById('page-detail').classList.remove('hidden');
            window.scrollTo(0, 0);

            setTimeout(() => document.getElementById('detail-header-title').classList.remove('opacity-0'), 100);

            document.getElementById('detail-name').innerText = customer.name;
            document.getElementById('detail-phone').innerText = customer.phone;
            document.getElementById('detail-phone-link').href = `tel:${customer.phone}`;
            
            const dateEl = document.getElementById('detail-install-date');
            dateEl.innerText = customer.installDate ? customer.installDate.split('T')[0] : '無紀錄';
            dateEl.className = customer.installDate ? "text-gray-800 font-medium" : "text-gray-400 italic";

            setText('detail-address', customer.address);
            setText('detail-machine', customer.machine);
            setText('detail-filter', customer.filter);
            
            const noteContainer = document.getElementById('note-container');
            if (customer.note) {
                document.getElementById('detail-note').innerText = customer.note;
                noteContainer.classList.remove('hidden');
                noteContainer.classList.add('flex');
            } else { noteContainer.classList.add('hidden'); noteContainer.classList.remove('flex'); }
            
            const photoContainer = document.getElementById('customer-photos-container');
            photoContainer.innerHTML = '';
            let photos = [];
            if (customer.photos && Array.isArray(customer.photos)) photos = customer.photos;
            else if (customer.photos && customer.photos.startsWith('[')) try { photos = JSON.parse(customer.photos); } catch(e) { photos = [customer.photos]; }
            else if (customer.photos) photos = [customer.photos];

            if (photos.length > 0) {
                photoContainer.classList.remove('hidden');
                photos.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url; 
                    img.className = 'w-32 h-32 flex-shrink-0 rounded-2xl object-cover shadow-sm border border-gray-100 bg-gray-50';
                    img.onclick = () => window.open(url, '_blank');
                    photoContainer.appendChild(img);
                });
            } else {
                photoContainer.classList.add('hidden');
            }

            await fetchRecords(customer.id);
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            el.innerText = value || '未填寫';
            el.className = value ? "text-gray-800 font-medium" : "text-gray-400 italic";
        }

        function goBack() {
            document.getElementById('page-detail').classList.add('hidden');
            document.getElementById('page-list').classList.remove('hidden');
            document.getElementById('detail-header-title').classList.add('opacity-0');
            currentCustomer = null;
            selectedRecordPhotos = [];
            renderRecordPhotoPreview();
        }

        async function fetchRecords(custId) {
            const listDiv = document.getElementById('record-list');
            listDiv.innerHTML = '<div class="text-center py-6 text-gray-400 text-sm">紀錄讀取中...</div>';
            const records = await apiCall('getRecords', { customerId: custId }, 'GET');
            
            currentRecords = records; // ⚠️ 將紀錄存入全域變數，修正按鈕無效問題

            listDiv.innerHTML = '';

            if (!records || records.length === 0) {
                listDiv.innerHTML = '<div class="text-center py-8 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-200">尚無保養紀錄</div>'; return;
            }

            records.forEach(r => {
                const photos = r.photos ? JSON.parse(r.photos) : [];
                // ⚠️ 注意：這裡不再直接傳遞 JSON 字串，而是傳遞 ID
                
                const div = document.createElement('div');
                div.className = 'bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3 pb-3 border-b border-gray-50">
                        <div class="flex items-center gap-2">
                            <span class="material-icons-round text-primary-500 text-lg">event_available</span>
                            <div class="font-bold text-lg text-gray-800">${r.date.split('T')[0]}</div>
                        </div>
                        ${r.amount ? `<div class="text-green-600 font-bold font-mono text-lg bg-green-50 px-2 py-0.5 rounded-lg">NT$${r.amount}</div>` : ''}
                    </div>
                    <div class="mb-3">
                        <div class="text-xs text-gray-400 font-bold uppercase mb-1 tracking-wider">更換項目</div>
                        <div class="text-lg font-bold text-gray-700 leading-snug">${r.items}</div>
                    </div>
                    ${r.note ? `
                        <div class="mb-3 bg-yellow-50 p-3 rounded-xl border border-yellow-100/50">
                             <div class="text-yellow-600/70 text-xs font-bold uppercase mb-1">備註</div>
                             <div class="text-sm text-yellow-800 font-medium">${r.note}</div>
                        </div>` : ''}
                    
                    ${photos.length > 0 ? `<div class="flex flex-wrap gap-2 mb-3 pt-1">${photos.map(url => `<img src="${url}" class="w-16 h-16 rounded-lg object-cover cursor-pointer border border-gray-200" onclick="window.open('${url}')">`).join('')}</div>` : ''}
                    
                    <div class="flex justify-end gap-2 mt-2">
                        <button onclick="openEditRecordModal('${r.id}')" class="text-gray-500 px-3 py-1.5 bg-gray-50 hover:bg-gray-100 rounded-lg font-bold text-sm transition-colors">編輯</button>
                        <button onclick="deleteRecord('${r.id}')" class="text-red-400 px-3 py-1.5 bg-red-50 hover:bg-red-100 rounded-lg font-bold text-sm transition-colors">刪除</button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        // ⚠️ 修正：透過 ID 查找資料，解決按鈕無反應問題
        function openEditRecordModal(id) {
            const record = currentRecords.find(r => r.id === id);
            if (!record) return alert("找不到該紀錄");

            document.getElementById('edit-record-id').value = record.id;
            document.getElementById('edit-record-date').value = record.date.split('T')[0];
            document.getElementById('edit-record-items').value = record.items;
            document.getElementById('edit-record-amount').value = record.amount;
            document.getElementById('edit-record-note').value = record.note;
            selectedEditRecordPhotos = []; 
            document.getElementById('edit-record-photo-preview').innerHTML = '';
            document.getElementById('record-modal').classList.remove('hidden');
        }

        async function saveEditedRecord() {
            const id = document.getElementById('edit-record-id').value;
            const items = document.getElementById('edit-record-items').value;
            if (!items) return alert("請輸入項目");

            let photoUrls = [];
            if (selectedEditRecordPhotos.length > 0) {
                showLoading(true);
                for (let base64 of selectedEditRecordPhotos) {
                    const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                    if (res.status === 'success') photoUrls.push(res.url);
                }
            }

            const payload = {
                id: id,
                date: document.getElementById('edit-record-date').value,
                items: items,
                amount: document.getElementById('edit-record-amount').value,
                note: document.getElementById('edit-record-note').value,
                photos: photoUrls 
            };

            const res = await apiCall('updateRecord', payload);
            if (res.status === 'success') {
                closeModal('record-modal');
                fetchRecords(currentCustomer.id);
            } else { alert("修改失敗"); }
        }

        function handleEditRecordPhotoSelect(input) {
            const files = input.files; if (!files.length) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedEditRecordPhotos.push(res); renderPhotoList('edit-record-photo-preview', selectedEditRecordPhotos); });
                reader.readAsDataURL(file);
            });
            input.value = '';
        }

        async function saveRecord() {
            if (!currentCustomer) return;
            const items = document.getElementById('record-items').value;
            if (!items) return alert("請輸入項目");

            let photoUrls = [];
            if (selectedRecordPhotos.length > 0) {
                showLoading(true);
                for (let base64 of selectedRecordPhotos) {
                    const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                    if (res.status === 'success') photoUrls.push(res.url);
                }
            }

            const payload = {
                customerId: currentCustomer.id,
                date: document.getElementById('record-date').value,
                items: items,
                amount: document.getElementById('record-amount').value,
                note: document.getElementById('record-note').value,
                photos: photoUrls
            };

            const res = await apiCall('addRecord', payload);
            if (res.status === 'success') {
                document.getElementById('record-items').value = '';
                document.getElementById('record-amount').value = '';
                document.getElementById('record-note').value = '';
                selectedRecordPhotos = [];
                renderRecordPhotoPreview();
                fetchRecords(currentCustomer.id);
                document.getElementById('record-list').scrollIntoView({ behavior: 'smooth' });
            } else { alert("失敗"); }
        }

        async function deleteRecord(id) {
            if (confirm("確定刪除此紀錄？")) {
                await apiCall('deleteRecord', { id });
                fetchRecords(currentCustomer.id);
            }
        }

        function resizeImage(base64, maxWidth, callback) {
            const img = new Image(); img.src = base64;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width; let height = img.height;
                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', 0.8));
            };
        }

        function handleRecordPhotoSelect(input) {
            const files = input.files; if (!files.length) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedRecordPhotos.push(res); renderRecordPhotoPreview(); });
                reader.readAsDataURL(file);
            });
            input.value = '';
        }
        function renderRecordPhotoPreview() {
            renderPhotoList('new-record-photos', selectedRecordPhotos);
        }
        
        function handleCustPhotoSelect(input) {
            const files = input.files; if (!files.length) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => resizeImage(e.target.result, 1024, res => { selectedCustPhotos.push(res); renderPhotoList('cust-photo-preview', selectedCustPhotos); });
                reader.readAsDataURL(file);
            });
            input.value = '';
        }

        function renderPhotoList(divId, photoArray) {
            const div = document.getElementById(divId);
            div.innerHTML = photoArray.map((src, idx) => `
                <div class="relative flex-shrink-0 w-16 h-16 group">
                    <img src="${src}" class="w-full h-full object-cover rounded-lg border border-white/50 shadow-sm">
                    <button onclick="removePhoto('${divId}', ${idx})" class="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md border border-white">×</button>
                </div>
            `).join('');
        }

        function removePhoto(divId, idx) {
            if (divId === 'new-record-photos') { selectedRecordPhotos.splice(idx, 1); renderRecordPhotoPreview(); }
            else if (divId === 'cust-photo-preview') { selectedCustPhotos.splice(idx, 1); renderPhotoList('cust-photo-preview', selectedCustPhotos); }
            else if (divId === 'edit-record-photo-preview') { selectedEditRecordPhotos.splice(idx, 1); renderPhotoList('edit-record-photo-preview', selectedEditRecordPhotos); }
        }

        function showAddCustomerModal() {
            document.getElementById('modal-title').innerText = '新增客戶';
            document.getElementById('cust-id').value = '';
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-phone').value = '';
            document.getElementById('cust-address').value = '';
            document.getElementById('cust-note').value = '';
            document.getElementById('cust-machine').value = '';
            document.getElementById('cust-filter').value = '';
            document.getElementById('cust-install-date').value = new Date().toISOString().split('T')[0];
            selectedCustPhotos = []; renderPhotoList('cust-photo-preview', []);
            document.getElementById('btn-delete-customer').classList.add('hidden');
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        function showEditCustomerModal() {
            if (!currentCustomer) return;
            document.getElementById('modal-title').innerText = '編輯資料';
            document.getElementById('cust-id').value = currentCustomer.id;
            document.getElementById('cust-name').value = currentCustomer.name;
            document.getElementById('cust-phone').value = currentCustomer.phone;
            document.getElementById('cust-address').value = currentCustomer.address;
            document.getElementById('cust-note').value = currentCustomer.note;
            document.getElementById('cust-machine').value = currentCustomer.machine;
            document.getElementById('cust-filter').value = currentCustomer.filter;
            document.getElementById('cust-install-date').value = currentCustomer.installDate ? currentCustomer.installDate.split('T')[0] : '';
            selectedCustPhotos = []; renderPhotoList('cust-photo-preview', []);
            document.getElementById('btn-delete-customer').classList.remove('hidden');
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        async function saveCustomer() {
            const id = document.getElementById('cust-id').value;
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            if (!name || !phone) return alert("姓名電話必填");

            let photoUrls = [];
            if (id && currentCustomer && currentCustomer.photos) {
                 if (Array.isArray(currentCustomer.photos)) photoUrls = [...currentCustomer.photos];
                 else try { photoUrls = JSON.parse(currentCustomer.photos); } catch(e) { photoUrls = [currentCustomer.photos]; }
            }
            if (selectedCustPhotos.length > 0) {
                showLoading(true);
                for (let base64 of selectedCustPhotos) {
                    const res = await apiCall('uploadImage', { base64: base64, type: 'image/jpeg' });
                    if (res.status === 'success') photoUrls.push(res.url);
                }
            }

            const payload = {
                id: id, name: name, phone: phone,
                address: document.getElementById('cust-address').value,
                note: document.getElementById('cust-note').value,
                machine: document.getElementById('cust-machine').value,
                filter: document.getElementById('cust-filter').value,
                installDate: document.getElementById('cust-install-date').value,
                photos: photoUrls 
            };

            const action = id ? 'updateCustomer' : 'addCustomer';
            const res = await apiCall(action, payload);
            
            if (res.status === 'success') {
                closeModal('customer-modal'); fetchCustomers();
                if (id && currentCustomer) openDetail({ ...currentCustomer, ...payload, photos: photoUrls });
            } else { alert("失敗"); }
        }

        async function deleteCustomer() {
            if (confirm("確定刪除此客戶？")) {
                await apiCall('deleteCustomer', { id: document.getElementById('cust-id').value });
                closeModal('customer-modal'); goBack(); fetchCustomers();
            }
        }

        function showLoading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }
        document.getElementById('customer-modal').addEventListener('click', e => { if (e.target.id === 'customer-modal') closeModal('customer-modal'); });
        document.getElementById('record-modal').addEventListener('click', e => { if (e.target.id === 'record-modal') closeModal('record-modal'); });
    </script>
</body>
</html>
