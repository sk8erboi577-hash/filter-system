<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>æ¿¾èŠ¯ä¿é¤Šç³»çµ±</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --primary: #007AFF;
      --primary-light: #64A8FF;
      --milk-bg: #F5EFE7;
      --milk-card: #FFFFFF;
      --milk-border: #E6E2DA;
      --milk-input: #F9F7F2;
      --text-main: #3A342E;
      --text-secondary: #6E655C;
      --nav-bg: rgba(255,255,255,0.92);
      --chip-bg: #EFEDE7;
    }

    body.dark-mode {
      --primary: #0A84FF;
      --primary-light: #64A8FF;
      --milk-bg: #121212;
      --milk-card: #1C1C1E;
      --milk-border: #2C2C2E;
      --milk-input: #2C2C2E;
      --text-main: #F2F2F7;
      --text-secondary: #8E8E93;
      --nav-bg: rgba(28,28,30,0.92);
      --chip-bg: #2C2C2E;
    }

    /* å¼·åˆ¶è¦†è“‹ Tailwind */
    body.dark-mode .bg-white { background-color: var(--milk-card) !important; color: var(--text-main); }
    body.dark-mode .bg-gray-50 { background-color: #000000 !important; }
    body.dark-mode .text-navy-900 { color: var(--text-main) !important; }
    body.dark-mode .text-gray-700 { color: #D1D1D6 !important; }
    body.dark-mode .text-gray-800 { color: #E5E5EA !important; }
    body.dark-mode input, body.dark-mode textarea, body.dark-mode select {
        background-color: var(--milk-input) !important;
        border-color: var(--milk-border) !important;
        color: var(--text-main) !important;
    }

    html { font-size: 18px; }
    body {
      background: var(--milk-bg);
      margin: 0;
      padding-bottom: 100px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC",
        Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-main);
      transition: background 0.3s, color 0.3s;
    }

    .ios-nav-bar {
      position: sticky; top: 0; padding: 12px 16px; padding-top: env(safe-area-inset-top, 16px);
      background: var(--nav-bg); backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--milk-border); z-index: 50;
      display:flex; justify-content:space-between; align-items:center;
      transition: background 0.3s;
    }
    .ios-nav-left, .ios-nav-right { display:flex; align-items:center; color:var(--primary); font-size:16px; gap:4px; cursor:pointer; }
    .ios-nav-title { font-size:18px; font-weight:600; color:var(--text-main); }

    .search-bar {
      background: var(--milk-card); border-radius: 14px; padding: 10px; display:flex; align-items:center; gap:8px; border:1px solid var(--milk-border);
    }
    .search-bar input { width:100%; border:none; background:transparent; font-size:16px; outline:none; color: var(--text-main); }

    /* å„€è¡¨æ¿ */
    .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .stat-card {
      background: var(--milk-card); padding: 12px; border-radius: 16px; border: 1px solid var(--milk-border);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: 0.2s;
    }
    .stat-card:active { transform: scale(0.97); opacity: 0.8; }
    .stat-card.active-filter { border: 2px solid var(--primary); background: var(--milk-input); }
    .stat-value { font-size: 24px; font-weight: 800; line-height: 1.2; color: var(--text-main); }
    .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
    .text-red-alert { color: #ff453a !important; }
    .text-orange-alert { color: #ff9f0a !important; }

    /* é»æ€§æ¨™é¡Œ */
    .section-header {
        font-size: 14px; font-weight: 700; color: var(--text-secondary);
        padding: 12px 4px; margin: 0; display: flex; align-items: center;
        position: sticky; top: -1px; background: var(--milk-bg); z-index: 20;
        transition: background 0.3s;
        /* âœ¨ å‹•ç•«ï¼šæ¨™é¡Œä¹Ÿè¦æœ‰é€²å ´æ•ˆæœ */
        animation: slideUpFade 0.4s ease-out forwards;
    }
    .section-header::after {
        content: ""; flex: 1; height: 1px; background: var(--milk-border); margin-left: 10px;
    }

    .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; margin-top: 12px; -webkit-overflow-scrolling: touch; }
    .filter-scroll::-webkit-scrollbar { display: none; }
    .filter-chip {
      padding: 6px 14px; background: var(--chip-bg); border: 1px solid var(--milk-border);
      border-radius: 20px; font-size: 14px; color: var(--text-secondary);
      white-space: nowrap; cursor: pointer; transition: all 0.2s;
    }
    .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }

    /* å¡ç‰‡èˆ‡é€²åº¦æ¢æ¨£å¼ */
    .dashboard-card {
      background: var(--milk-card); border-radius: 18px; border:1px solid var(--milk-border);
      padding: 16px 14px 12px 14px; 
      display:flex; flex-direction: column; 
      box-shadow:0 6px 16px rgba(0,0,0,0.06); cursor:pointer; transition:.12s;
      position: relative; overflow: hidden; 
      /* âœ¨ å‹•ç•«ï¼šé è¨­éš±è—ï¼Œç­‰å¾…å‹•ç•«è§¸ç™¼ */
      opacity: 0; 
      transform: translateY(20px);
    }
    /* âœ¨ å®šç¾©å‹•ç•«é—œéµå½±æ ¼ */
    @keyframes slideUpFade {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* âœ¨ å¥—ç”¨å‹•ç•«çš„ class */
    .animate-enter {
        animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .dashboard-card:active { transform:scale(.97); }
    .card-content-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    
    .dashboard-name { font-size:20px; font-weight:700; color: var(--text-main); }
    .dashboard-tag {
      display:inline-flex; padding:3px 10px; background:var(--chip-bg); border:1px solid var(--milk-border);
      border-radius:999px; font-size:12px; color:var(--text-secondary); margin:4px 0;
    }
    .dashboard-chevron { width:32px; height:32px; background:var(--milk-input); border-radius:50%; display:flex; align-items:center; justify-content:center; color: var(--text-secondary); }

    /* é€²åº¦æ¢æ¨£å¼ */
    .progress-track {
        height: 4px; width: 100%; background: #F2F2F7; border-radius: 2px; margin-top: 12px;
        overflow: hidden; display: flex;
    }
    body.dark-mode .progress-track { background: #3a3a3c; }
    .progress-bar { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
    .bar-green { background-color: #30D158; }
    .bar-yellow { background-color: #FF9F0A; }
    .bar-red { background-color: #FF453A; }

    .timeline-item { position:relative; margin-bottom:18px; padding-left:20px; }
    .timeline-item::before { content:""; position:absolute; left:9px; top:0; bottom:-8px; width:2px; background:var(--milk-border); }
    .timeline-dot { position:absolute; left:4px; top:8px; width:12px; height:12px; background:var(--milk-card); border:3px solid var(--primary); border-radius:50%; }
    .record-card { background:var(--milk-card); border:1px solid var(--milk-border); padding:14px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
    .record-date { font-weight:600; color: var(--text-main); }
    .record-amount { color:#30D158; font-weight:700; }

    .tag-selector, .chip-container { display:flex; flex-wrap:wrap; gap:8px; }
    .tag, .item-chip {
      padding:6px 12px; background:var(--chip-bg); border:1px solid var(--milk-border);
      border-radius:999px; font-size:14px; cursor:pointer; transition:0.15s;
      user-select:none; color:var(--text-secondary);
    }
    .tag.active { background:var(--primary); border-color:var(--primary); color:white; }
    .item-chip { background-color: rgba(10, 132, 255, 0.15); color: var(--primary); border-color: var(--primary-light); font-weight: 600; margin-top: 4px; }
    .item-chip:active { background-color: var(--primary); color: white; }

    .photo-thumb { width:90px; height:90px; object-fit:cover; border-radius:12px; border:1px solid var(--milk-border); background:#E5E2DC; }

    .loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.65); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:999; }
    body.dark-mode .loading-overlay { background:rgba(0,0,0,0.65); }

    .sheet-backdrop { background: rgba(0,0,0,0.4); backdrop-filter:blur(2px); }
    .sheet { background: var(--milk-card); max-height: 90vh; display: flex; flex-direction: column; color: var(--text-main); }
    .sheet-grabber { width: 40px; height: 5px; background: #E0E0E0; border-radius: 99px; margin: 10px auto 0; }
    body.dark-mode .sheet-grabber { background: #48484A; }
    .sheet-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-bottom: 1px solid var(--milk-border); }
    .sheet-title { font-weight: 700; font-size: 18px; color: var(--text-main); }
    .sheet-btn-text { color: var(--primary); font-size: 16px; }
    .sheet-body { padding: 16px; overflow-y: auto; background-color: var(--milk-bg); }
     
    input, textarea, select { -webkit-appearance: none; appearance: none; }
    .hidden { display: none !important; }
    .danger-btn { width: 100%; color: #ff453a; background: rgba(255, 69, 58, 0.15); padding: 12px; border-radius: 12px; font-weight: 600; margin-top: 10px; }

    .toast {
      visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 17px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
    }
    .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    
    .photo-wrapper { position: relative; display: inline-block; margin-right: 8px; flex-shrink: 0; }
    .photo-thumb-edit { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid var(--milk-border); }
    .btn-remove-photo {
      position: absolute; top: -6px; right: -6px;
      background: #ff453a; color: white;
      border-radius: 50%; width: 22px; height: 22px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
    }
    
    .btn-line {
      background-color: #30D158; color: white;
      border: none; padding: 6px 12px; border-radius: 99px;
      font-size: 13px; font-weight: 600; display: inline-flex; align-items: center;
      gap: 4px; cursor: pointer; text-decoration: none;
    }
    .btn-line:active { background-color: #24a544; }
    
    .finish-modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
      display: flex; align-items: center; justify-content: center;
    }

    .lightbox-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .lightbox-overlay.active { opacity: 1; pointer-events: auto; }
    .lightbox-img { max-width: 100vw; max-height: 100vh; object-fit: contain; }
    .lightbox-close {
        position: absolute; top: 20px; right: 20px; color: white;
        background: rgba(255,255,255,0.2); border-radius: 50%;
        width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        font-size: 24px; cursor: pointer; z-index: 3001;
    }
    
    .theme-toggle {
        padding: 8px; border-radius: 50%; background: var(--milk-input); color: var(--text-secondary);
        display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--milk-border);
    }

    .fab-btn {
        position: fixed;
        right: 24px;
        width: 56px; 
        height: 56px;
        border-radius: 50%;
        background: var(--primary); 
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 40;
        transition: transform 0.2s, opacity 0.3s;
        border: none;
    }
    .fab-btn:active { transform: scale(0.95); }

    #btn-add-customer { 
        bottom: 30px; 
    }
    #scroll-to-top {
        bottom: 100px; 
        opacity: 0;
        pointer-events: none;
        transform: translateY(10px);
    }
    #scroll-to-top.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
    }
  </style>
</head>

<body>

<div id="page-list" class="min-h-screen transition-colors duration-300">
  <div class="pt-10 pb-4 px-4 max-w-md mx-auto">
    <div class="flex justify-between items-center mb-3">
        <div class="text-3xl font-semibold">æ¿¾èŠ¯ä¿é¤Šç³»çµ±</div>
        <button class="theme-toggle" onclick="toggleDarkMode()">
            <span id="theme-icon" class="material-icons">dark_mode</span>
        </button>
    </div>

    <div class="stats-container">
      <div id="card-overdue" class="stat-card" onclick="toggleDashboardFilter('overdue')">
        <div id="stat-overdue-val" class="stat-value text-red-alert">0</div>
        <div class="stat-label">ğŸ”´ é€¾æœŸæœªä¿é¤Š</div>
      </div>
      <div id="card-month" class="stat-card" onclick="toggleDashboardFilter('month')">
        <div id="stat-month-val" class="stat-value text-orange-alert">0</div>
        <div class="stat-label">ğŸŸ¡ æœ¬æœˆéœ€ä¿é¤Š</div>
      </div>
    </div>

    <div class="search-bar">
      <span class="material-icons text-gray-400">search</span>
      <input id="search-input" type="text" placeholder="æœå°‹å®¢æˆ¶åç¨±ã€é›»è©±ã€åœ°å€æˆ–å‚™è¨»â€¦" oninput="renderList(customers)">
    </div>
    <div id="filter-container" class="filter-scroll"></div>
  </div>

  <div id="customer-list" class="max-w-md mx-auto px-4 pt-2 pb-20">
    <div class="text-center text-gray-400 mt-20">è¼‰å…¥ä¸­â€¦</div>
  </div>

  <button id="scroll-to-top" class="fab-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
      <span class="material-icons">arrow_upward</span>
  </button>

  <button id="btn-add-customer" class="fab-btn" onclick="showAddCustomerModal()">
    <span class="material-icons">add</span>
  </button>
</div>

<div id="page-detail" class="hidden min-h-screen">
  <div class="ios-nav-bar">
    <div class="ios-nav-left" onclick="goBack()">
      <span class="material-icons">arrow_back_ios</span> è¿”å›
    </div>
    <div class="ios-nav-title">å®¢æˆ¶è³‡æ–™</div>
    <div class="ios-nav-right" onclick="showEditCustomerModal()">ç·¨è¼¯</div>
  </div>

  <div class="pb-4 px-4 max-w-md mx-auto">
    <div class="mt-4 mb-4">
      <div id="customer-photos-container" class="flex gap-3 overflow-x-auto"></div>
    </div>

    <div class="record-card mb-4">
      <div class="font-bold mb-2 text-gray-500 text-xs tracking-widest">åŸºæœ¬è³‡æ–™</div>
      <div class="flex py-1"><span class="w-20 text-secondary">å§“å</span><span id="detail-name"></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">é›»è©±</span><span><a id="detail-phone-link" class="text-blue-600 font-medium flex items-center"><span class="material-icons mr-1 text-base">phone</span><span id="detail-phone"></span></a></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">å®‰è£æ—¥æœŸ</span><span id="detail-install-date" class="text-gray-400 italic">ç„¡ç´€éŒ„</span></div>
      
      <div class="flex py-1"><span class="w-20 text-secondary">ç´¯ç©æ¶ˆè²»</span><span id="detail-total-spend" class="font-bold text-primary">è¨ˆç®—ä¸­...</span></div>
      
      <div class="flex py-1 items-start"><span class="w-20 text-secondary pt-1">æ¨™ç±¤</span><div id="detail-tags" class="flex flex-wrap gap-2 flex-1"></div></div>
      <div class="flex py-1"><span class="w-20 text-secondary">ä¿é¤Šé€±æœŸ</span><span id="detail-cycle" class="text-gray-800"></span></div>
    </div>

    <div class="record-card mb-4">
      <div class="font-bold mb-2 text-gray-500 text-xs tracking-widest">è¨­å‚™è³‡è¨Š</div>
      <div class="flex py-1 items-center">
        <span class="w-20 text-secondary flex-shrink-0">åœ°å€</span>
        <div class="flex-1 flex items-center justify-between">
           <span id="detail-address"></span>
           <a id="detail-map-link" target="_blank" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-sm font-bold flex items-center ml-2 hidden no-underline">
              <span class="material-icons text-base mr-1">near_me</span>å°èˆª
           </a>
        </div>
      </div>
      <div class="flex py-1"><span class="w-20 text-secondary">æ©Ÿå™¨</span><span id="detail-machine"></span></div>
      <div class="flex py-1"><span class="w-20 text-secondary">æ¿¾èŠ¯</span><span id="detail-filter"></span></div>
      <div id="note-container" class="flex py-1 hidden"><span class="w-20 text-secondary">å‚™è¨»</span><span id="detail-note"></span></div>
    </div>

    <div class="record-card mb-4">
      <div class="font-bold mb-3 text-gray-500 text-xs tracking-widest">æ–°å¢ä¿é¤Šç´€éŒ„</div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div><div class="text-secondary text-sm mb-1">æ—¥æœŸ</div><input type="date" id="record-date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2"></div>
        <div><div class="text-secondary text-sm mb-1">é‡‘é¡</div><input type="number" id="record-amount" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2" placeholder="0"></div>
      </div>
      
      <div id="new-record-price-chips" class="chip-container mb-3"></div>
      
      <div class="mb-3">
        <div class="text-secondary text-sm mb-1">æ›´æ›é …ç›®</div>
        <input id="record-items" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2" placeholder="ä¾‹å¦‚ï¼šPPã€æ´»æ€§ç¢³">
        <div id="new-record-item-chips" class="chip-container"></div>
      </div>
      
      <div class="mb-3">
        <div class="text-secondary text-sm mb-1">å‚™è¨»</div>
        <input id="record-note" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2" placeholder="å‚™è¨»...">
        <div id="new-record-note-chips" class="chip-container mt-2"></div>
      </div>

      <div class="flex gap-3 mb-3 items-center">
        <label class="bg-gray-100 text-blue-600 px-3 py-1 rounded cursor-pointer flex items-center font-medium">
          <span class="material-icons mr-1">camera_alt</span>æ‹ç…§
          <input id="record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)">
        </label>
        <span id="record-photo-count" class="text-sm text-secondary">0 å¼µ</span>
      </div>
      <div id="new-record-photos" class="flex gap-2 overflow-x-auto mb-3"></div>
      <button class="w-full bg-blue-600 text-white rounded-xl py-3 text-lg font-semibold shadow active:scale-95 transition-transform" onclick="saveRecord()">å„²å­˜ç´€éŒ„</button>
    </div>

    <div>
      <div class="font-bold text-gray-500 text-xs tracking-widest mb-2">æ­·å²ç´€éŒ„</div>
      <div id="record-list" class="mt-3"></div>
    </div>
  </div>
</div>

<div id="customer-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col rounded-t-2xl sm:rounded-2xl">
    <div class="sheet-grabber"></div>
    <div class="sheet-header">
      <button onclick="closeModal('customer-modal')" class="sheet-btn-text">å–æ¶ˆ</button>
      <h2 id="modal-title" class="sheet-title">æ–°å¢å®¢æˆ¶</h2>
      <button onclick="saveCustomer()" class="sheet-btn-text font-semibold">å„²å­˜</button>
    </div>
    <div class="sheet-body space-y-4 bg-gray-50">
      <input type="hidden" id="cust-id">
       
      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div><label>å§“å <span class="text-red-500">*</span></label><input id="cust-name" type="text" class="w-full p-2 border rounded"></div>
        <div><label>é›»è©± <span class="text-red-500">*</span></label><input id="cust-phone" type="tel" class="w-full p-2 border rounded"></div>
        <div><label>å®‰è£æ—¥æœŸ</label><input id="cust-install-date" type="date" class="w-full p-2 border rounded"></div>
      </div>

      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div>
            <label>ä¿é¤Šé€±æœŸ</label>
            <select id="cust-cycle" class="w-full p-2 border rounded bg-white">
                <option value="">æœªè¨­å®š</option>
                <option value="3">3 å€‹æœˆ</option>
                <option value="6">6 å€‹æœˆ</option>
                <option value="9">9 å€‹æœˆ</option>
                <option value="12">1 å¹´</option>
                <option value="24">2 å¹´</option>
            </select>
        </div>
        <div><label>åœ°å€</label><input id="cust-address" type="text" class="w-full p-2 border rounded"></div>
        <div><label>æ©Ÿå™¨å‹è™Ÿ</label><input id="cust-machine" type="text" class="w-full p-2 border rounded"></div>
        <div><label>æ¿¾èŠ¯è¦æ ¼</label><input id="cust-filter" type="text" class="w-full p-2 border rounded"></div>
      </div>

      <div class="space-y-2 bg-white rounded-xl p-4 shadow-sm">
        <label>æ¨™ç±¤ï¼ˆå¯å¤šé¸ï¼‰</label>
        <div id="cust-tag-selector" class="tag-selector"></div>
      </div>

      <div class="bg-white rounded-xl p-4 shadow-sm">
        <label>å‚™è¨»</label>
        <textarea id="cust-note" rows="2" class="w-full p-2 border rounded"></textarea>
      </div>

      <div class="bg-white rounded-xl p-4 shadow-sm text-center">
        <label class="text-blue-600 font-medium flex items-center justify-center cursor-pointer p-2 border-2 border-dashed border-blue-200 rounded-lg">
          <span class="material-icons mr-2">add_photo_alternate</span> é¸æ“‡æ©Ÿå™¨ç…§ç‰‡
          <input id="cust-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
        </label>
        <div id="cust-photo-preview" class="flex gap-2 overflow-x-auto mt-2 justify-center"></div>
      </div>

      <button id="btn-delete-customer" onclick="deleteCustomer()" class="danger-btn hidden">åˆªé™¤æ­¤å®¢æˆ¶</button>
      <div class="h-10"></div>
    </div>
  </div>
</div>

<div id="record-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col rounded-t-2xl sm:rounded-2xl">
    <div class="sheet-grabber"></div>
    <div class="sheet-header">
      <button onclick="closeModal('record-modal')" class="sheet-btn-text">å–æ¶ˆ</button>
      <h2 class="sheet-title">ä¿®æ”¹ç´€éŒ„</h2>
      <button onclick="saveEditedRecord()" class="sheet-btn-text font-semibold">å®Œæˆ</button>
    </div>
    <div class="sheet-body space-y-4 bg-gray-50">
      <input type="hidden" id="edit-record-id">
      <div class="space-y-3 bg-white rounded-xl p-4 shadow-sm">
        <div><label>æ—¥æœŸ</label><input id="edit-record-date" type="date" class="w-full p-2 border rounded"></div>
        <div>
          <label>é …ç›®</label>
          <input id="edit-record-items" type="text" class="w-full p-2 border rounded font-medium">
          <div id="edit-record-item-chips" class="chip-container"></div>
        </div>
        <div><label>é‡‘é¡</label><input id="edit-record-amount" type="number" class="w-full p-2 border rounded text-green-600 font-bold"></div>
        
        <div id="edit-record-price-chips" class="chip-container mb-3"></div>

        <div>
          <label>å‚™è¨»</label>
          <textarea id="edit-record-note" rows="2" class="w-full p-2 border rounded"></textarea>
          <div id="edit-record-note-chips" class="chip-container mt-2"></div>
        </div>

      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm">
        <label class="text-blue-600 font-medium flex items-center justify-center cursor-pointer p-2 border-2 border-dashed border-blue-200 rounded-lg">
          <span class="material-icons mr-2">add_a_photo</span> åŠ å‚³ç…§ç‰‡
          <input id="edit-record-photo-input" type="file" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
        </label>
        <div id="edit-record-photo-preview" class="photo-grid mt-2 justify-center flex gap-2 overflow-x-auto"></div>
      </div>
      <div class="h-10"></div>
    </div>
  </div>
</div>

<div id="lightbox" class="lightbox-overlay" onclick="closeLightbox()">
    <div class="lightbox-close">Ã—</div>
    <img id="lightbox-img" class="lightbox-img" src="">
</div>

<div id="loading" class="loading-overlay hidden">
  <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-300 border-t-blue-600"></div>
  <p id="loading-text" class="mt-3 text-secondary font-medium">è™•ç†ä¸­â€¦</p>
</div>
<div id="toast" class="toast"></div>

<script>
// âš ï¸âš ï¸âš ï¸ è«‹å‹™å¿…ç¢ºèªé€™è£¡æ˜¯ä½ æœ€æ–°çš„ Google Apps Script ç¶²å€ âš ï¸âš ï¸âš ï¸
const API_URL = "https://script.google.com/macros/s/AKfycbyOzg78yqgVwWkKkQM2V67Gmaicrh-ilnZ5SZ1FXq449cO4iO1nU46i5tO1xiyVZ9s/exec";

// æ¨™ç±¤é¸é …
const TAG_OPTIONS = ["å…¨éƒ¨", "å»šä¸‹å‹", "é£²æ°´æ©Ÿ", "å…¨æˆ¶å¼", "å·¥æ¥­å•†æ¥­", "å”®æœ", "å…¶ä»–"];
// å¸¸ç”¨ç¶­ä¿®é …ç›®
const ITEM_OPTIONS = ["PP", "UDFC","CTO","UDFR", "ROè†œ","å¤§T", "å°T", "ä¿é¤Š","ä»£æ›´æ›", "ç¶­ä¿®"];
// å¸¸ç”¨å‚™è¨»é¸é …
const NOTE_OPTIONS = ["æ°´å£“æ­£å¸¸", "ç®¡ç·šæ›´æ–°", "æ›´æ›æ¥é ­", "æ¼æ°´è™•ç†", "ç„¡äººåœ¨å®¶", "å®¢æˆ¶æŒ‡å®šæ™‚é–“"];
// å¸¸ç”¨é‡‘é¡é¸é …
const PRICE_OPTIONS = ["500", "1000", "1800", "2500", "3500"];

let currentFilter = "å…¨éƒ¨";
let dashboardFilter = null; 

let customers = [];
let currentCustomer = null;

let selectedCustPhotos = [];
let selectedRecordPhotos = [];
let selectedEditRecordPhotos = [];

window.currentRecords = [];

let lastScrollY = 0;

let existingCustPhotos = [];
let existingRecordPhotos = [];

window.onscroll = function() {
    const btn = document.getElementById("scroll-to-top");
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
        btn.classList.add("show");
    } else {
        btn.classList.remove("show");
    }
};

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    document.getElementById('theme-icon').innerText = isDark ? 'light_mode' : 'dark_mode';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

function checkTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-icon').innerText = 'light_mode';
    }
}

function openLightbox(url) {
    document.getElementById('lightbox-img').src = url;
    document.getElementById('lightbox').classList.add('active');
}
function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    setTimeout(() => { document.getElementById('lightbox-img').src = ""; }, 200);
}

function renderPhotoEditor(containerId, existingArr, newArr, type) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  existingArr.forEach((url, index) => {
    const wrap = document.createElement("div");
    wrap.className = "photo-wrapper";
    wrap.innerHTML = `
      <img src="${url}" class="photo-thumb-edit" onclick="openLightbox('${url}')">
      <div class="btn-remove-photo" onclick="removeExistingPhoto('${type}', ${index})">Ã—</div>
    `;
    container.appendChild(wrap);
  });

  newArr.forEach((base64, index) => {
    const wrap = document.createElement("div");
    wrap.className = "photo-wrapper";
    wrap.innerHTML = `
      <img src="${base64}" class="photo-thumb-edit" onclick="openLightbox('${base64}')">
      <div class="btn-remove-photo" onclick="removeNewPhoto('${type}', ${index})">Ã—</div>
    `;
    container.appendChild(wrap);
  });
}

function removeExistingPhoto(type, index) {
  if (type === 'cust') {
    existingCustPhotos.splice(index, 1);
    renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust');
  } else if (type === 'record') {
    existingRecordPhotos.splice(index, 1);
    renderPhotoEditor("edit-record-photo-preview", existingRecordPhotos, selectedEditRecordPhotos, 'record');
  }
}

function removeNewPhoto(type, index) {
  if (type === 'cust') {
    selectedCustPhotos.splice(index, 1);
    renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust');
  } else if (type === 'record') {
    selectedEditRecordPhotos.splice(index, 1);
    renderPhotoEditor("edit-record-photo-preview", existingRecordPhotos, selectedEditRecordPhotos, 'record');
  } else if (type === 'newRecord') {
     selectedRecordPhotos.splice(index, 1);
     renderPreview("new-record-photos", selectedRecordPhotos); 
     document.getElementById("record-photo-count").innerText = `${selectedRecordPhotos.length} å¼µ`;
  }
}

function normalizeDateStr(v){
  if (!v) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const d = new Date(v);
  if (!isNaN(d)) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  return v.split(" ")[0];
}

async function apiCall(action, payload={}, method="POST"){
  if(!document.getElementById("loading").classList.contains("hidden") && document.getElementById("loading-text").innerText.includes("ä¸Šå‚³")) {
  } else {
      showLoading(true, "è™•ç†ä¸­â€¦");
  }
  
  try {
    const url = method==="GET" ? `${API_URL}?${new URLSearchParams({action, ...payload})}` : API_URL;
    const res = await fetch(url, {
      method,
      body: method==="POST" ? JSON.stringify({action, ...payload}) : null
    });
    const json = await res.json();
    return json;
  } catch(e){
    alert("é€£ç·šéŒ¯èª¤");
    return null;
  } finally {
    if(!payload.photos && action !== "uploadImage") { 
        showLoading(false); 
    }
  }
}

async function fetchCustomers(){
  const data = await apiCall("getCustomers", {}, "GET");
  if (!Array.isArray(data)){
    document.getElementById("customer-list").innerHTML =
      `<div class="text-center text-gray-400 mt-20">è®€å–å¤±æ•—</div>`;
    showLoading(false); 
    return;
  }
  customers = data;
  updateDashboard(customers); 
  renderFilterBar();
  renderList(customers);
  showLoading(false);
}

function updateDashboard(list) {
  let overdueCount = 0;
  let thisMonthCount = 0;
  const currentMonth = new Date().getMonth();

  list.forEach(c => {
    const status = getServiceStatus(c.lastRecordDate, c.cycle);
    if (status.type === 'overdue') {
      overdueCount++;
    } else {
      const nextD = new Date(status.nextDate);
      if (nextD.getMonth() === currentMonth) {
        thisMonthCount++;
      }
    }
  });

  document.getElementById("stat-overdue-val").innerText = overdueCount;
  document.getElementById("stat-month-val").innerText = thisMonthCount;
}

function toggleDashboardFilter(type) {
    const overdueCard = document.getElementById("card-overdue");
    const monthCard = document.getElementById("card-month");

    if (dashboardFilter === type) {
        dashboardFilter = null;
        overdueCard.classList.remove("active-filter");
        monthCard.classList.remove("active-filter");
    } else {
        dashboardFilter = type;
        overdueCard.classList.remove("active-filter");
        monthCard.classList.remove("active-filter");
        
        if (type === 'overdue') overdueCard.classList.add("active-filter");
        if (type === 'month') monthCard.classList.add("active-filter");
    }
    renderList(customers);
}


function renderFilterBar() {
    const container = document.getElementById("filter-container");
    container.innerHTML = TAG_OPTIONS.map(tag => 
        `<div class="filter-chip ${tag === currentFilter ? 'active' : ''}" onclick="filterByTag('${tag}')">${tag}</div>`
    ).join('');
}

function filterByTag(tag) {
    currentFilter = tag;
    dashboardFilter = null;
    document.getElementById("card-overdue").classList.remove("active-filter");
    document.getElementById("card-month").classList.remove("active-filter");

    renderFilterBar(); 
    renderList(customers);
}

function renderItemChips(containerId, inputId) {
    const container = document.getElementById(containerId);
    container.innerHTML = ITEM_OPTIONS.map(item => 
        `<div class="item-chip" onclick="addItemToInput('${inputId}', '${item}')">${item}</div>`
    ).join('');
}

function renderNoteChips(containerId, inputId) {
    const container = document.getElementById(containerId);
    container.innerHTML = NOTE_OPTIONS.map(item => 
        `<div class="item-chip" onclick="addItemToInput('${inputId}', '${item}')">${item}</div>`
    ).join('');
}

function renderPriceChips(containerId, inputId) {
    const container = document.getElementById(containerId);
    container.innerHTML = PRICE_OPTIONS.map(price => 
        `<div class="item-chip" onclick="setPriceInput('${inputId}', '${price}')">$${price}</div>`
    ).join('');
}

function setPriceInput(inputId, price) {
    document.getElementById(inputId).value = price;
}

function addItemToInput(inputId, itemText) {
    const input = document.getElementById(inputId);
    if (input.value) {
        input.value += `, ${itemText}`;
    } else {
        input.value = itemText;
    }
}

function sendLineReminder(e, name, nextDate) {
  if(e) e.stopPropagation(); 
  
  const text = `è¦ªæ„›çš„ ${name} æ‚¨å¥½ï¼š%0D%0A` +
               `æ‚¨çš„éæ¿¾å™¨è¨­å‚™é è¨ˆæ–¼ ${nextDate} éœ€è¦é€²è¡Œä¿é¤Šæ›´æ›ã€‚%0D%0A` +
               `ç‚ºäº†ç¢ºä¿é£²æ°´å“è³ªï¼Œå»ºè­°æ‚¨è¿‘æœŸå®‰æ’æ™‚é–“ã€‚%0D%0A` +
               `è‹¥éœ€é ç´„è«‹ç›´æ¥å›è¦†æ­¤è¨Šæ¯ï¼Œè¬è¬ï¼`;
               
  window.location.href = `https://line.me/R/msg/text/?${text}`;
}

function sendLineReport(name, date, items, amount, nextDate) {
  const text = `ã€ä¿é¤Šå®Œå·¥é€šçŸ¥ã€‘%0D%0A` +
               `è¦ªæ„›çš„ ${name} æ‚¨å¥½ï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒï¼%0D%0A` +
               `------------------%0D%0A` +
               `ğŸ“… æ—¥æœŸï¼š${date}%0D%0A` +
               `ğŸ› ï¸ é …ç›®ï¼š${items}%0D%0A` +
               `ğŸ’° é‡‘é¡ï¼š${amount} å…ƒ%0D%0A` +
               `------------------%0D%0A` +
               `ä¸‹æ¬¡ä¿é¤Šé è¨ˆï¼š${nextDate}%0D%0A` +
               `é™„ä¸Šæœ¬æ¬¡ä¿é¤Šç…§ç‰‡ä¾›æ‚¨ç•™å­˜ã€‚`;

  window.location.href = `https://line.me/R/msg/text/?${text}`;
}

function renderList(list){
  const container = document.getElementById("customer-list");
  container.innerHTML = "";

  let filtered = list;
  
  if (currentFilter !== "å…¨éƒ¨") {
      filtered = filtered.filter(c => c.tags && c.tags.includes(currentFilter));
  }
   
  const searchTerm = document.getElementById("search-input").value.toLowerCase();
  if (searchTerm) {
      filtered = filtered.filter(c => 
        c.name.toLowerCase().includes(searchTerm) || 
        c.phone.includes(searchTerm) || 
        (c.address && c.address.includes(searchTerm)) || 
        (c.note && c.note.toLowerCase().includes(searchTerm))
      );
  }

  if (dashboardFilter === 'overdue') {
      filtered = filtered.filter(c => getServiceStatus(c.lastRecordDate, c.cycle).type === 'overdue');
  } else if (dashboardFilter === 'month') {
      const currentMonth = new Date().getMonth();
      filtered = filtered.filter(c => {
          const status = getServiceStatus(c.lastRecordDate, c.cycle);
          if (status.type === 'overdue') return false; 
          return new Date(status.nextDate).getMonth() === currentMonth;
      });
  }

  filtered.sort((a, b) => {
      const statusA = getServiceStatus(a.lastRecordDate, a.cycle).score;
      const statusB = getServiceStatus(b.lastRecordDate, b.cycle).score;
      return statusB - statusA; 
  });

  if (!filtered.length){
    container.innerHTML = `<div class="text-center text-gray-400 mt-20">æš«ç„¡è³‡æ–™</div>`;
    return;
  }

  const isSearching = searchTerm || dashboardFilter;
  
  const groups = { overdue: [], soon: [], normal: [] };
  
  if (!isSearching) {
      filtered.forEach(c => {
          const type = getServiceStatus(c.lastRecordDate, c.cycle).type;
          if (type === 'overdue') groups.overdue.push(c);
          else if (type === 'soon') groups.soon.push(c);
          else groups.normal.push(c);
      });
      
      renderSection(container, "ğŸ”´ é€¾æœŸæœªä¿é¤Š", groups.overdue);
      renderSection(container, "ğŸŸ¡ å³å°‡åˆ°æœŸ (14å¤©å…§)", groups.soon);
      renderSection(container, "ğŸŸ¢ æ­£å¸¸", groups.normal);
  } else {
      renderSection(container, "", filtered);
  }
}

function renderSection(container, title, items) {
    if (items.length === 0) return;

    if (title) {
        const header = document.createElement("div");
        header.className = "section-header";
        header.innerText = `${title} (${items.length})`;
        container.appendChild(header);
    }

    const wrap = document.createElement("div");
    wrap.className = "space-y-3";

    // âœ¨âœ¨âœ¨ é€™è£¡åŠ å…¥å¡ç‰‡ç”Ÿæˆé‚è¼¯ âœ¨âœ¨âœ¨
    items.forEach((c, index) => {
        const status = getServiceStatus(c.lastRecordDate, c.cycle);
        const last = c.lastRecordDate ? normalizeDateStr(c.lastRecordDate) : "å°šç„¡ç´€éŒ„";
        const machine = c.machine || "æœªå¡«å¯«æ©Ÿå‹";

        let cardClass = "dashboard-card border-l-4 animate-enter"; // âœ¨ åŠ ä¸Šå‹•ç•« class
        let statusHtml = "";
        let btnHtml = ""; 
        let progressHtml = ""; 

        let progressWidth = 0;
        let progressColor = "bar-green";
        
        if (c.cycle && c.lastRecordDate) {
            const today = new Date();
            const lastDate = new Date(c.lastRecordDate);
            const cycleDays = c.cycle * 30; 
            const daysPassed = (today - lastDate) / (1000 * 60 * 60 * 24);
            
            progressWidth = Math.min((daysPassed / cycleDays) * 100, 100);
            
            if (status.type === 'overdue') {
                progressColor = "bar-red";
                progressWidth = 100; 
            } else if (status.type === 'soon') {
                progressColor = "bar-yellow";
            }
            
            progressHtml = `<div class="progress-track"><div class="progress-bar ${progressColor}" style="width: ${progressWidth}%"></div></div>`;
        }

        if (status.type === 'overdue') {
            cardClass += " border-l-red-500 bg-red-50/30"; 
            statusHtml = `<div class="text-red-600 font-bold text-sm bg-red-100 px-2 py-1 rounded-md flex items-center">
                            <span class="material-icons text-sm mr-1">warning</span>éæœŸ ${status.days} å¤©
                          </div>`;
            btnHtml = `<button class="btn-line ml-2 flex-shrink-0" onclick="sendLineReminder(event, '${c.name}', '${status.nextDate}')">
                         <span class="material-icons text-sm">chat</span> æé†’
                       </button>`;

        } else if (status.type === 'soon') {
            cardClass += " border-l-yellow-500 bg-yellow-50/30";
            statusHtml = `<div class="text-yellow-700 font-bold text-sm bg-yellow-100 px-2 py-1 rounded-md flex items-center">
                            <span class="material-icons text-sm mr-1">schedule</span>å‰© ${status.days} å¤©
                          </div>`;
             btnHtml = `<button class="btn-line ml-2 flex-shrink-0" onclick="sendLineReminder(event, '${c.name}', '${status.nextDate}')">
                         <span class="material-icons text-sm">chat</span> æé†’
                       </button>`;
        } else {
            cardClass += " border-l-transparent hover:border-l-primary";
            if (c.cycle) {
                 statusHtml = `<div class="text-gray-400 text-xs">ä¸‹æ¬¡: ${status.nextDate}</div>`;
            }
        }

        const card = document.createElement("div");
        card.className = cardClass;
        card.style.animationDelay = `${index * 0.05}s`; // âœ¨ åŠ ä¸Šå‹•ç•«å»¶é²
        card.onclick = ()=> openDetail(c);

        card.innerHTML = `
          <div class="card-content-row grow min-w-0 mb-1">
            <div class="flex items-center gap-2 min-w-0 flex-1">
                <div class="dashboard-name truncate text-navy-900 leading-tight">${c.name}</div>
                ${btnHtml} 
            </div>
            <div class="flex-shrink-0 ml-2">
                ${statusHtml} 
            </div>
          </div>

          <div class="flex gap-2 flex-wrap my-1 text-sm text-secondary">
            ${c.tags ? c.tags.split(",").map(t=>`<div class="dashboard-tag">${t}</div>`).join("") : ""}
          </div>

          <div class="card-content-row mt-1">
             <div class="text-sm text-secondary font-medium flex items-center gap-1 min-w-0">
                <span class="material-icons text-base text-gray-400">settings</span>
                <span class="truncate">${machine}</span>
             </div>
             <div class="text-right flex-shrink-0">
                 <div class="text-xs text-gray-400">ä¸Šæ¬¡ä¿é¤Š</div>
                 <div class="font-medium ${status.type === 'overdue' ? 'text-red-500' : 'text-gray-700'}">${last}</div>
             </div>
          </div>
          
          <div class="card-content-row text-sm text-secondary mt-1">
             <a href="tel:${c.phone}" class="flex items-center gap-1 min-w-0 text-blue-600 no-underline" onclick="event.stopPropagation()">
                <span class="material-icons text-base flex-shrink-0">phone_iphone</span>
                <span class="truncate font-medium">${c.phone}</span>
             </a>
             <div class="dashboard-chevron"><span class="material-icons">arrow_forward_ios</span></div>
          </div>

          ${progressHtml} 
        `;
        wrap.appendChild(card);
    });

    container.appendChild(wrap);
}

function getServiceStatus(lastDateStr, cycleMonths) {
    if (!lastDateStr || !cycleMonths) return { type: 'normal', score: 1 };
    
    const lastDate = new Date(lastDateStr);
    const nextDate = new Date(lastDate);
    nextDate.setMonth(nextDate.getMonth() + parseInt(cycleMonths));
    
    const today = new Date();
    today.setHours(0,0,0,0);
    
    const diffTime = nextDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const nextDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth()+1).padStart(2,'0')}-${String(nextDate.getDate()).padStart(2,'0')}`;

    if (diffDays < 0) {
        return { type: 'overdue', days: Math.abs(diffDays), nextDate: nextDateStr, score: 3 }; 
    } else if (diffDays <= 14) {
        return { type: 'soon', days: diffDays, nextDate: nextDateStr, score: 2 }; 
    } else {
        return { type: 'normal', days: diffDays, nextDate: nextDateStr, score: 1 }; 
    }
}

async function openDetail(c){
  lastScrollY = window.scrollY; 
  
  currentCustomer = c;
  document.getElementById("page-list").classList.add("hidden");
  document.getElementById("page-detail").classList.remove("hidden");
  window.scrollTo(0,0);

  document.getElementById("detail-name").innerText = c.name;
  document.getElementById("detail-phone").innerText = c.phone;
  document.getElementById("detail-phone-link").href = `tel:${c.phone}`;
  document.getElementById("detail-install-date").innerText = c.installDate ? normalizeDateStr(c.installDate) : "ç„¡ç´€éŒ„";
  
  // é‡ç½®é‡‘é¡çµ±è¨ˆ
  document.getElementById("detail-total-spend").innerText = "è¨ˆç®—ä¸­...";

  const cycleText = c.cycle ? `${c.cycle} å€‹æœˆ` : "æœªè¨­å®š";
  document.getElementById("detail-cycle").innerText = cycleText;

  const addr = c.address || "";
  document.getElementById("detail-address").innerText = addr || "æœªå¡«å¯«";
  const mapLink = document.getElementById("detail-map-link");
  if (addr) {
      mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
      mapLink.classList.remove("hidden");
  } else {
      mapLink.classList.add("hidden");
  }

  document.getElementById("detail-machine").innerText = c.machine || "æœªå¡«å¯«";
  document.getElementById("detail-filter").innerText = c.filter || "æœªå¡«å¯«";

  const tagBox = document.getElementById("detail-tags");
  tagBox.innerHTML = c.tags ? c.tags.split(",").map(t=>`<div class="dashboard-tag">${t}</div>`).join("") : `<span class="text-secondary">æœªè¨­å®š</span>`;

  if (c.note){
    document.getElementById("detail-note").innerText = c.note;
    document.getElementById("note-container").classList.remove("hidden");
  } else {
    document.getElementById("note-container").classList.add("hidden");
  }

  const photoDiv = document.getElementById("customer-photos-container");
  photoDiv.innerHTML = "";
  let photos = [];
  if (Array.isArray(c.photos)) photos = c.photos;
  else if (typeof c.photos==="string" && c.photos.startsWith("[")) { try { photos = JSON.parse(c.photos); } catch {} }
   
  if (photos.length){
    photos.forEach(url=>{
      const img = document.createElement("img"); img.src = url; img.className = "photo-thumb cursor-pointer";
      img.onclick = ()=>openLightbox(url); 
      photoDiv.appendChild(img);
    });
  } else { photoDiv.innerHTML = `<div class="text-secondary text-sm">ç„¡ç…§ç‰‡</div>`; }

  await fetchRecords(c.id);
}

function goBack(){
  document.getElementById("page-detail").classList.add("hidden");
  document.getElementById("page-list").classList.remove("hidden");
  window.scrollTo(0, lastScrollY);
}

async function fetchRecords(id){
  const box = document.getElementById("record-list");
  box.innerHTML = `<div class="text-center text-secondary py-4">è®€å–ä¸­â€¦</div>`;
  const records = await apiCall("getRecords", {customerId:id}, "GET");
  if (!records.length){ 
      box.innerHTML = `<div class="text-secondary">å°šç„¡ç´€éŒ„</div>`; 
      document.getElementById("detail-total-spend").innerText = "NT$0 (0æ¬¡)"; 
      return; 
  }
  window.currentRecords = records;
  box.innerHTML = "";
  records.sort((a,b)=>new Date(b.date)-new Date(a.date));
  
  // VIP çµ±è¨ˆ
  let total = 0;
  records.forEach(r => {
      total += parseInt(r.amount) || 0;
  });
  document.getElementById("detail-total-spend").innerText = `NT$${total.toLocaleString()} (å…± ${records.length} æ¬¡)`;
   
  records.forEach(r=>{
    const photos = Array.isArray(r.photos) ? r.photos : [];
    const item = document.createElement("div"); item.className = "timeline-item";
    item.innerHTML = `
      <div class="timeline-dot"></div>
      <div class="record-card">
        <div class="flex justify-between mb-2">
          <div class="record-date">${normalizeDateStr(r.date)}</div>
          <div class="record-amount">${r.amount ? "NT$"+r.amount : ""}</div>
        </div>
        <div class="font-medium mb-1">${r.items}</div>
        ${r.note ? `<div class="text-secondary text-sm mb-2">å‚™è¨»ï¼š${r.note}</div>` : ""}
        ${photos.length ? `<div class="flex gap-2 overflow-x-auto mb-2">${photos.map(p=>`<img class="photo-thumb cursor-pointer" src="${p}" onclick="openLightbox('${p}')">`).join("")}</div>` : ""}
        <div class="flex justify-end gap-3 text-primary mt-2 text-sm">
          <span class="cursor-pointer" onclick="openEditRecordModal('${r.id}')">ç·¨è¼¯</span>
          <span class="text-red-600 cursor-pointer" onclick="deleteRecord('${r.id}')">åˆªé™¤</span>
        </div>
      </div>`;
    box.appendChild(item);
  });
}

function openEditRecordModal(id){
  const r = window.currentRecords.find(x=>x.id==id);
  if (!r){ alert("æ‰¾ä¸åˆ°ç´€éŒ„"); return; }
  document.getElementById("edit-record-id").value = r.id;
  document.getElementById("edit-record-date").value = normalizeDateStr(r.date);
  document.getElementById("edit-record-items").value = r.items;
  document.getElementById("edit-record-amount").value = r.amount || "";
  document.getElementById("edit-record-note").value = r.note || "";
   
  existingRecordPhotos = [];
  if (r.photos && Array.isArray(r.photos)) {
      existingRecordPhotos = [...r.photos];
  }
  selectedEditRecordPhotos = [];
  renderPhotoEditor("edit-record-photo-preview", existingRecordPhotos, selectedEditRecordPhotos, 'record');

  document.getElementById("record-modal").classList.remove("hidden");
}

async function saveEditedRecord(){
  const id = document.getElementById("edit-record-id").value;
  const items = document.getElementById("edit-record-items").value.trim();
  const date = document.getElementById("edit-record-date").value;
  if (!items){ alert("è«‹è¼¸å…¥é …ç›®"); return; }
   
  let photoUrls = [...existingRecordPhotos]; 

  let uploadedCount = 0;
  const totalUpload = selectedEditRecordPhotos.length;
  if(totalUpload > 0) showLoading(true, `æº–å‚™ä¸Šå‚³ ${totalUpload} å¼µç…§ç‰‡...`);

  for (let base64 of selectedEditRecordPhotos){
    uploadedCount++;
    showLoading(true, `æ­£åœ¨ä¸Šå‚³ç…§ç‰‡ (${uploadedCount}/${totalUpload})...`);
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }

  showLoading(true, "å„²å­˜è³‡æ–™ä¸­...");
  const payload = {
    id, date, items,
    amount: document.getElementById("edit-record-amount").value,
    note: document.getElementById("edit-record-note").value,
    photos: photoUrls
  };
  const res = await apiCall("updateRecord", payload);
  showLoading(false);

  if (res?.status==="success"){
    closeModal("record-modal"); await fetchRecords(currentCustomer.id); renderList(customers);
  }
}

async function saveRecord(){
  if (!currentCustomer) return;
  const items = document.getElementById("record-items").value.trim();
  if (!items){ alert("è«‹è¼¸å…¥é …ç›®"); return; }
  
  let photoUrls = [];

  let uploadedCount = 0;
  const totalUpload = selectedRecordPhotos.length;
  if(totalUpload > 0) showLoading(true, `æº–å‚™ä¸Šå‚³ ${totalUpload} å¼µç…§ç‰‡...`);

  for (let base64 of selectedRecordPhotos){
    uploadedCount++;
    showLoading(true, `æ­£åœ¨ä¸Šå‚³ç…§ç‰‡ (${uploadedCount}/${totalUpload})...`);
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status==="success") photoUrls.push(res.url);
  }

  showLoading(true, "å„²å­˜è³‡æ–™ä¸­...");
  const payload = {
    customerId: currentCustomer.id,
    date: document.getElementById("record-date").value,
    items,
    amount: document.getElementById("record-amount").value,
    note: document.getElementById("record-note").value,
    photos: photoUrls
  };
  const res = await apiCall("addRecord", payload);
  showLoading(false);

  if (res?.status==="success"){
    selectedRecordPhotos = [];
    document.getElementById("new-record-photos").innerHTML = "";
    document.getElementById("record-items").value=""; 
    document.getElementById("record-amount").value=""; 
    document.getElementById("record-note").value="";
    document.getElementById("record-photo-count").innerText = "0 å¼µ";

    await fetchRecords(currentCustomer.id);
    await fetchCustomers(); 

    let nextDateStr = "æœªè¨­å®š";
    if (currentCustomer.cycle) {
        const status = getServiceStatus(payload.date, currentCustomer.cycle);
        nextDateStr = status.nextDate;
    }
    
    setTimeout(() => {
        if(confirm("âœ… ç´€éŒ„å·²å„²å­˜ï¼\n\nè¦å‚³é€ã€Œå®Œå·¥çµæ¡ˆå ±å‘Šã€çµ¦å®¢æˆ¶å—ï¼Ÿ\n(å°‡é–‹å•Ÿ LINE è‡ªå‹•è²¼ä¸Šæ–‡å­—)")) {
            sendLineReport(
                currentCustomer.name, 
                payload.date, 
                payload.items, 
                payload.amount,
                nextDateStr 
            );
        } else {
            showToast("å„²å­˜æˆåŠŸ");
        }
    }, 100);
  }
}

async function deleteRecord(id){
  if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
  await apiCall("deleteRecord", {id});
  await fetchRecords(currentCustomer.id);
}

async function saveCustomer(){
  const id = document.getElementById("cust-id").value;
  const name = document.getElementById("cust-name").value.trim();
  const phone = document.getElementById("cust-phone").value.trim();
   
  if (!name || !phone){ 
      alert("å§“åã€é›»è©±å¿…å¡«"); 
      return; 
  }

  let safeExisting = Array.isArray(existingCustPhotos) ? existingCustPhotos : [];
  let photoUrls = [...safeExisting]; 

  let uploadedCount = 0;
  const totalUpload = selectedCustPhotos.length;
  if(totalUpload > 0) showLoading(true, `æº–å‚™ä¸Šå‚³ ${totalUpload} å¼µç…§ç‰‡...`);

  for (let base64 of selectedCustPhotos){
    uploadedCount++;
    showLoading(true, `æ­£åœ¨ä¸Šå‚³ç…§ç‰‡ (${uploadedCount}/${totalUpload})...`);
    const res = await apiCall("uploadImage", {base64, type:"image/jpeg"});
    if (res?.status === "success") {
        photoUrls.push(res.url);
    }
  }

  showLoading(true, "å„²å­˜è³‡æ–™ä¸­...");
  const tags = getSelectedTags("cust-tag-selector");
   
  const payload = {
    id, 
    name, 
    phone,
    address: document.getElementById("cust-address").value,
    note: document.getElementById("cust-note").value,
    machine: document.getElementById("cust-machine").value,
    filter: document.getElementById("cust-filter").value,
    installDate: document.getElementById("cust-install-date").value,
    cycle: document.getElementById("cust-cycle").value,
    photos: photoUrls, 
    tags
  };

  const act = id ? "updateCustomer" : "addCustomer";
   
  const res = await apiCall(act, payload);
  showLoading(false);
   
  if (res?.status === "success"){
    showToast("å„²å­˜æˆåŠŸ");
    closeModal("customer-modal"); 
    await fetchCustomers();
    if(id && currentCustomer) {
        openDetail({...currentCustomer, ...payload, photos: photoUrls});
    }
  } else {
    alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦");
  }
}

function showAddCustomerModal(){
  document.getElementById("modal-title").innerText = "æ–°å¢å®¢æˆ¶";
  document.getElementById("cust-id").value = "";
  document.getElementById("cust-name").value = "";
  document.getElementById("cust-phone").value = "";
  document.getElementById("cust-address").value = "";
  document.getElementById("cust-note").value = "";
  document.getElementById("cust-machine").value = "";
  document.getElementById("cust-filter").value = "";
  document.getElementById("cust-cycle").value = ""; 

  const d = new Date();
  document.getElementById("cust-install-date").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
   
  selectedCustPhotos = []; 
  existingCustPhotos = []; 
  renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust');

  renderTagSelector("cust-tag-selector", []);
  document.getElementById("btn-delete-customer").classList.add("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}
   
function showEditCustomerModal(){
  const c = currentCustomer;
  document.getElementById("modal-title").innerText = "ç·¨è¼¯è³‡æ–™";
  document.getElementById("cust-id").value = c.id;
  document.getElementById("cust-name").value = c.name;
  document.getElementById("cust-phone").value = c.phone;
  document.getElementById("cust-address").value = c.address || "";
  document.getElementById("cust-note").value = c.note || "";
  document.getElementById("cust-machine").value = c.machine || "";
  document.getElementById("cust-filter").value = c.filter || "";
  document.getElementById("cust-cycle").value = c.cycle || "";
  document.getElementById("cust-install-date").value = c.installDate ? normalizeDateStr(c.installDate) : "";
   
  existingCustPhotos = [];
  if (c.photos) {
      if (Array.isArray(c.photos)) existingCustPhotos = [...c.photos];
      else try { existingCustPhotos = JSON.parse(c.photos); } catch { existingCustPhotos = []; }
  }
  selectedCustPhotos = []; 
  renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust');

  renderTagSelector("cust-tag-selector", c.tags ? c.tags.split(",") : []);
  document.getElementById("btn-delete-customer").classList.remove("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

async function deleteCustomer(){
  if (!confirm("ç¢ºå®šåˆªé™¤æ­¤å®¢æˆ¶ï¼Ÿ")) return;
  await apiCall("deleteCustomer", {id: document.getElementById("cust-id").value});
  closeModal("customer-modal"); goBack(); fetchCustomers();
}

function renderTagSelector(containerId, selected=[]){
  const box = document.getElementById(containerId); box.innerHTML = "";
  TAG_OPTIONS.forEach(t=>{
    const div = document.createElement("div"); div.className = "tag" + (selected.includes(t) ? " active" : "");
    div.dataset.tag = t; div.innerText = t; div.onclick = ()=> div.classList.toggle("active");
    box.appendChild(div);
  });
}
function getSelectedTags(containerId){ return [...document.querySelectorAll(`#${containerId} .tag.active`)].map(x=>x.dataset.tag).join(","); }

function handleCustPhotoSelect(input){ 
    handlePhotoSelect(input, selectedCustPhotos, null, null, () => {
        renderPhotoEditor("cust-photo-preview", existingCustPhotos, selectedCustPhotos, 'cust');
    }); 
}
   
function handleRecordPhotoSelect(input){ handlePhotoSelect(input, selectedRecordPhotos, "new-record-photos", "record-photo-count"); }
   
function handleEditRecordPhotoSelect(input){ 
    handlePhotoSelect(input, selectedEditRecordPhotos, null, null, () => {
        renderPhotoEditor("edit-record-photo-preview", existingRecordPhotos, selectedEditRecordPhotos, 'record');
    }); 
}

function handlePhotoSelect(input, arr, previewId, countId, callback){
  [...input.files].forEach(file=>{
    const reader = new FileReader();
    reader.onload = e => resizeImage(e.target.result, 900, out=>{
      arr.push(out); 
       
      if (previewId) {
          renderPreview(previewId, arr);
      } else if (callback) {
          callback();
      }
       
      if(countId) document.getElementById(countId).innerText = `${arr.length} å¼µ`;
    });
    reader.readAsDataURL(file);
  });
  input.value = ""; 
}
   
function renderPreview(id, arr){ 
    document.getElementById(id).innerHTML = arr.map(src => 
        `<img class="photo-thumb" src="${src}" onclick="openLightbox('${src}')">`
    ).join(""); 
}

function resizeImage(base64, maxW, cb){
  const img = new Image(); img.src = base64;
  img.onload = ()=>{
    let w = img.width, h = img.height; if (w > maxW){ h *= maxW/w; w = maxW; }
    const c = document.createElement("canvas"); c.width = w; c.height = h;
    c.getContext("2d").drawImage(img,0,0,w,h); cb(c.toDataURL("image/jpeg",0.8));
  };
}

function closeModal(id){ document.getElementById(id).classList.add("hidden"); }
document.getElementById("customer-modal").addEventListener("click", e=>{ if (e.target.id==="customer-modal") closeModal("customer-modal"); });
document.getElementById("record-modal").addEventListener("click", e=>{ if (e.target.id==="record-modal") closeModal("record-modal"); });

// âœ¨âœ¨âœ¨ ä¿®æ”¹ï¼šæ”¯æ´é¡¯ç¤ºæ–‡å­— âœ¨âœ¨âœ¨
function showLoading(show, text="è™•ç†ä¸­â€¦"){ 
    const loader = document.getElementById("loading");
    document.getElementById("loading-text").innerText = text;
    loader.classList.toggle("hidden", !show); 
}

function showToast(message) {
    const x = document.getElementById("toast"); x.innerText = message; x.className = "toast show";
    setTimeout(function(){ x.className = "toast"; }, 3000);
}

window.onload = () => {
  // âœ¨ è¼‰å…¥æ™‚æª¢æŸ¥ä¸»é¡Œ
  checkTheme();
  fetchCustomers();
  const rd = document.getElementById("record-date");
  if (rd){ const d = new Date(); rd.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  
  renderItemChips("new-record-item-chips", "record-items");
  renderNoteChips("new-record-note-chips", "record-note"); 
  renderPriceChips("new-record-price-chips", "record-amount"); 
  renderPriceChips("edit-record-price-chips", "edit-record-amount");

  renderItemChips("edit-record-item-chips", "edit-record-items");
  renderNoteChips("edit-record-note-chips", "edit-record-note"); 
};
</script>

</body>
</html>
