<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>濾芯保養系統</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --primary: #007AFF;
      --milk-bg: #F5EFE7;
      --milk-card: #FFFFFF;
      --milk-border: #E6E2DA;
      --text-main: #3A342E;
      --text-secondary: #6E655C;
    }

    html { font-size: 16px; }
    body {
      background: var(--milk-bg);
      margin: 0;
      padding-bottom: 100px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-main);
      -webkit-tap-highlight-color: transparent;
    }

    /* iOS Navigation Bar */
    .ios-nav-bar {
      position: sticky; top: 0; padding: 12px 16px;
      padding-top: env(safe-area-inset-top, 16px);
      background: rgba(255,255,255,0.92); backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--milk-border); z-index: 50;
      display:flex; justify-content:space-between; align-items:center;
    }
    .ios-nav-left, .ios-nav-right { display:flex; align-items:center; color:var(--primary); font-size:16px; gap:4px; cursor:pointer; }
    .ios-nav-title { font-size:18px; font-weight:600; color:var(--text-main); }

    /* 搜尋與篩選 */
    .search-bar {
      background: #FFF; border-radius: 14px; padding: 10px;
      display:flex; align-items:center; gap:8px; border:1px solid var(--milk-border);
    }
    .search-bar input { width:100%; border:none; background:transparent; font-size:16px; outline:none; }

    .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; -webkit-overflow-scrolling: touch; }
    .filter-scroll::-webkit-scrollbar { display: none; }
    .filter-chip {
      padding: 6px 14px; background: #EFEDE7; border: 1px solid var(--milk-border);
      border-radius: 20px; font-size: 14px; color: var(--text-secondary);
      white-space: nowrap; cursor: pointer; transition: all 0.2s;
    }
    .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }

    /* 列表卡片優化版 */
    .dashboard-card {
      background: var(--milk-card); border-radius: 18px; border:1px solid var(--milk-border);
      padding: 16px; position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03); cursor:pointer; transition:.1s;
      margin-bottom: 12px;
    }
    .dashboard-card:active { transform:scale(0.98); }
    
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .card-name { font-size: 1.25rem; font-weight: 800; color: #2d2d2d; line-height: 1.2; }
    
    /* 下次保養區塊 (右上角) */
    .next-service-box {
      text-align: right; background: #F0F9FF; padding: 6px 10px; 
      border-radius: 12px; border: 1px solid #BAE6FD;
      min-width: 100px;
    }
    .next-label { font-size: 0.7rem; color: #0284C7; font-weight: 600; margin-bottom: 2px; }
    .next-date { font-size: 1rem; font-weight: 800; color: #0369A1; }
    
    .card-tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom: 8px; }
    .mini-tag { font-size: 0.75rem; padding: 2px 8px; background: #F3F4F6; border-radius: 6px; color: #666; }

    .card-info-row { display: flex; align-items: center; gap: 4px; color: #555; font-size: 0.9rem; margin-top: 4px; }
    .card-footer { 
      margin-top: 12px; padding-top: 10px; border-top: 1px dashed #EEE; 
      display: flex; justify-content: space-between; align-items: flex-end;
    }
    .last-service-label { font-size: 0.75rem; color: #999; }
    .last-service-date { font-size: 0.95rem; font-weight: 600; color: #059669; }

    /* 通用樣式 */
    .photo-thumb { width:90px; height:90px; object-fit:cover; border-radius:12px; background:#E5E2DC; border:1px solid #ddd; }
    .photo-wrapper { position: relative; display: inline-block; }
    .photo-delete-btn {
      position: absolute; top: -6px; right: -6px; width: 22px; height: 22px;
      background: #EF4444; color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: bold; border: 2px solid white; cursor: pointer;
    }

    /* Modal & Sheet */
    .sheet-backdrop { background: rgba(0,0,0,0.4); backdrop-filter:blur(3px); }
    .sheet { background: #fff; max-height: 90vh; display: flex; flex-direction: column; }
    .sheet-body { padding: 16px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    
    /* Input & Buttons */
    input, select, textarea { 
        width: 100%; background: #F9FAFB; border: 1px solid #E5E7EB; 
        border-radius: 10px; padding: 10px; font-size: 16px; outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); background: #fff; }
    
    .chip-container { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .item-chip { background: #EFF6FF; color: #1D4ED8; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; }
    .item-chip:active { background: #2563EB; color: white; }

    .tag-selector { display:flex; flex-wrap:wrap; gap:8px; margin-bottom: 12px; }
    .tag-option { padding: 6px 14px; border: 1px solid #DDD; border-radius: 20px; color: #666; font-size: 14px; cursor: pointer; }
    .tag-option.active { background: var(--primary); color: white; border-color: var(--primary); }

    .btn-primary { width: 100%; background: var(--primary); color: white; padding: 14px; border-radius: 14px; font-weight: 600; font-size: 16px; margin-top: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .btn-primary:active { transform: scale(0.98); }

    .loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.7); backdrop-filter:blur(4px); display:flex; justify-content:center; align-items:center; z-index:999; flex-direction: column; color: #666; }
    .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1000; }
    .toast.show { opacity: 1; bottom: 60px; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="page-list" class="min-h-screen pb-24">
  <div class="pt-10 px-4 max-w-md mx-auto">
    <div class="flex justify-between items-center mb-4">
        <div class="text-3xl font-bold tracking-tight text-gray-900">濾芯保養系統</div>
        <button onclick="fetchCustomers()" class="w-10 h-10 bg-white rounded-full shadow-sm border border-gray-200 flex items-center justify-center text-blue-600 active:scale-90 transition-transform">
          <span class="material-icons">refresh</span>
        </button>
    </div>

    <div class="search-bar mb-3">
      <span class="material-icons text-gray-400">search</span>
      <input id="search-input" type="text" placeholder="搜尋客戶、電話...">
    </div>
    <div id="filter-container" class="filter-scroll"></div>
  </div>

  <div id="customer-list" class="max-w-md mx-auto px-4 mt-2">
    <div class="text-center text-gray-400 mt-20">載入中...</div>
  </div>

  <div class="fixed right-6 bottom-8 bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-xl cursor-pointer z-40 active:scale-90 transition-transform" onclick="showAddCustomerModal()">
    <span class="material-icons" style="font-size: 28px;">add</span>
  </div>
</div>

<div id="page-detail" class="hidden min-h-screen bg-white">
  <div class="ios-nav-bar">
    <div class="ios-nav-left" onclick="goBack()"><span class="material-icons">arrow_back_ios</span>返回</div>
    <div class="ios-nav-title">客戶資料</div>
    <div class="ios-nav-right" onclick="showEditCustomerModal()">編輯</div>
  </div>

  <div class="pb-8 px-4 max-w-md mx-auto">
    <div class="py-4 overflow-x-auto whitespace-nowrap" id="detail-photos"></div>

    <div class="bg-gray-50 rounded-2xl p-4 mb-4 border border-gray-100">
      <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">基本資訊</h3>
      <div class="flex justify-between py-1"><span class="text-gray-500">姓名</span><span id="detail-name" class="font-medium text-gray-900"></span></div>
      <div class="flex justify-between py-1"><span class="text-gray-500">電話</span><a id="detail-phone-link" class="text-blue-600 font-bold flex items-center"><span class="material-icons text-sm mr-1">call</span><span id="detail-phone"></span></a></div>
      <div class="flex justify-between py-1"><span class="text-gray-500">地址</span><span id="detail-address" class="text-right max-w-[60%]"></span></div>
      <div class="mt-2 flex gap-2 justify-end">
          <a id="detail-map-link" target="_blank" class="hidden text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold">開啟導航</a>
      </div>
    </div>

    <div class="bg-gray-50 rounded-2xl p-4 mb-4 border border-gray-100">
       <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">設備規格</h3>
       <div class="flex justify-between py-1"><span class="text-gray-500">機型</span><span id="detail-machine"></span></div>
       <div class="flex justify-between py-1"><span class="text-gray-500">濾芯</span><span id="detail-filter"></span></div>
       <div class="flex justify-between py-1"><span class="text-gray-500">週期</span><span id="detail-cycle" class="font-bold text-blue-600"></span></div>
       <div class="mt-3 pt-3 border-t border-gray-200 block">
           <span class="text-gray-500 text-sm block mb-1">備註</span>
           <p id="detail-note" class="text-gray-800 text-sm leading-relaxed"></p>
       </div>
    </div>

    <div class="bg-white border-2 border-blue-50 rounded-2xl p-4 mb-6 shadow-sm">
      <h3 class="text-sm font-bold text-blue-600 mb-3 flex items-center"><span class="material-icons text-base mr-1">post_add</span>新增保養紀錄</h3>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div><label class="text-xs text-gray-400 block mb-1">日期</label><input type="date" id="record-date"></div>
        <div><label class="text-xs text-gray-400 block mb-1">金額</label><input type="number" id="record-amount" placeholder="0"></div>
      </div>
      <div class="mb-3">
        <label class="text-xs text-gray-400 block mb-1">項目</label>
        <input type="text" id="record-items" placeholder="更換項目">
        <div id="new-record-chips" class="chip-container"></div>
      </div>
      <div class="mb-3">
        <input type="text" id="record-note" placeholder="備註 (選填)">
      </div>
      
      <div class="flex items-center gap-3 mb-4">
        <label class="bg-gray-100 px-3 py-2 rounded-lg cursor-pointer flex items-center text-sm font-medium text-gray-600">
            <span class="material-icons text-lg mr-1">camera_alt</span>拍照
            <input type="file" id="record-photo-input" accept="image/*" multiple class="hidden" onchange="handleRecordPhotoSelect(this)">
        </label>
        <span id="record-photo-count" class="text-xs text-gray-400">0 張</span>
      </div>
      <div id="record-new-photos" class="flex gap-2 overflow-x-auto mb-3"></div>

      <button onclick="saveRecord()" class="btn-primary">儲存紀錄</button>
    </div>

    <div>
      <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">歷史紀錄</h3>
      <div id="record-list" class="space-y-4"></div>
    </div>
  </div>
</div>

<div id="customer-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md rounded-t-2xl sm:rounded-2xl overflow-hidden">
    <div class="bg-gray-50 border-b px-4 py-3 flex justify-between items-center">
      <button onclick="closeModal('customer-modal')" class="text-gray-500">取消</button>
      <h3 id="modal-title" class="font-bold text-lg">新增客戶</h3>
      <button onclick="saveCustomer()" class="text-blue-600 font-bold">儲存</button>
    </div>
    <div class="sheet-body bg-gray-50 space-y-4 pb-10">
      <input type="hidden" id="cust-id">
      
      <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
        <div><label class="text-xs text-gray-500">姓名 *</label><input id="cust-name" type="text"></div>
        <div><label class="text-xs text-gray-500">電話 *</label><input id="cust-phone" type="tel"></div>
        <div><label class="text-xs text-gray-500">安裝日期</label><input id="cust-install-date" type="date"></div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
        <div><label class="text-xs text-gray-500">地址</label><input id="cust-address" type="text"></div>
        <div class="flex gap-2">
            <div class="flex-1"><label class="text-xs text-gray-500">機型</label><input id="cust-machine" type="text"></div>
            <div class="flex-1"><label class="text-xs text-gray-500">保養週期</label>
                <select id="cust-cycle">
                    <option value="">未設定</option>
                    <option value="3">3 個月</option>
                    <option value="6">6 個月</option>
                    <option value="9">9 個月</option>
                    <option value="12">1 年</option>
                    <option value="24">2 年</option>
                </select>
            </div>
        </div>
        <div><label class="text-xs text-gray-500">濾芯規格</label><input id="cust-filter" type="text"></div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm">
        <label class="text-xs text-gray-500 block mb-2">標籤</label>
        <div id="cust-tag-selector" class="tag-selector"></div>
        <label class="text-xs text-gray-500 block mt-3 mb-1">備註</label>
        <textarea id="cust-note" rows="2"></textarea>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm">
        <div class="text-xs text-gray-500 mb-2">機器照片</div>
        
        <div id="cust-existing-photos" class="flex gap-3 overflow-x-auto mb-3 pb-2 border-b border-gray-100"></div>
        
        <label class="border-2 border-dashed border-blue-200 bg-blue-50 rounded-lg p-3 flex items-center justify-center text-blue-600 font-bold cursor-pointer">
            <span class="material-icons mr-2">add_photo_alternate</span> 加傳照片
            <input type="file" id="cust-photo-input" accept="image/*" multiple class="hidden" onchange="handleCustPhotoSelect(this)">
        </label>
        <div id="cust-new-photos" class="flex gap-2 overflow-x-auto mt-3"></div>
      </div>

      <button id="btn-delete-customer" onclick="deleteCustomer()" class="w-full bg-red-50 text-red-500 py-3 rounded-xl font-bold mt-2 hidden">刪除此客戶</button>
    </div>
  </div>
</div>

<div id="record-modal" class="fixed inset-0 sheet-backdrop hidden z-50 flex items-end sm:items-center justify-center">
  <div class="sheet w-full max-w-md rounded-t-2xl sm:rounded-2xl overflow-hidden">
    <div class="bg-gray-50 border-b px-4 py-3 flex justify-between items-center">
      <button onclick="closeModal('record-modal')" class="text-gray-500">取消</button>
      <h3 class="font-bold text-lg">修改紀錄</h3>
      <button onclick="saveEditedRecord()" class="text-blue-600 font-bold">完成</button>
    </div>
    <div class="sheet-body bg-gray-50 space-y-4 pb-10">
      <input type="hidden" id="edit-record-id">
      <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
        <div><label class="text-xs text-gray-500">日期</label><input id="edit-record-date" type="date"></div>
        <div>
            <label class="text-xs text-gray-500">項目</label>
            <input id="edit-record-items" type="text" class="font-bold">
            <div id="edit-record-chips" class="chip-container"></div>
        </div>
        <div><label class="text-xs text-gray-500">金額</label><input id="edit-record-amount" type="number" class="text-green-600 font-bold"></div>
        <div><label class="text-xs text-gray-500">備註</label><textarea id="edit-record-note" rows="2"></textarea></div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-sm">
         <label class="border-2 border-dashed border-gray-200 rounded-lg p-3 flex items-center justify-center text-gray-500 cursor-pointer">
            <span class="material-icons mr-2">add_a_photo</span> 新增照片
            <input type="file" id="edit-record-photo-input" accept="image/*" multiple class="hidden" onchange="handleEditRecordPhotoSelect(this)">
        </label>
        <div id="edit-record-photos" class="flex gap-2 overflow-x-auto mt-3"></div>
      </div>
    </div>
  </div>
</div>

<div id="loading" class="loading-overlay hidden">
  <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-blue-600 mb-3"></div>
  <div class="font-medium">處理中...</div>
</div>
<div id="toast" class="toast">儲存成功</div>

<script>
// ⚠️ 請確認這是你的 Apps Script URL
const API_URL = "https://script.google.com/macros/s/AKfycbyOzg78yqgVwWkKkQM2V67Gmaicrh-ilnZ5SZ1FXq449cO4iO1nU46i5tO1xiyVZ9s/exec";

const TAG_OPTIONS = ["全部", "廚下型", "飲水機", "全戶式", "工業商業", "售服", "其他"];
const ITEM_OPTIONS = ["PP", "UDFC","CTO","UDFR", "RO膜","大T", "小T", "保養","代更換", "維修"];

let customers = [];
let currentCustomer = null;
let currentFilter = "全部";
let editingCustPhotos = []; // 暫存編輯中的舊照片列表

// 上傳暫存
let selectedCustNewPhotos = [];
let selectedRecordPhotos = [];
let selectedEditRecordPhotos = [];

// 全域紀錄快取
window.currentRecords = [];

// --- 工具函式 ---
function normalizeDateStr(v){
  if (!v) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const d = new Date(v);
  if (!isNaN(d)) {
    return d.toISOString().split('T')[0];
  }
  return v.split(" ")[0];
}

// 計算下次保養日期
function getNextServiceDate(lastDateStr, cycleMonths) {
    if (!lastDateStr || !cycleMonths) return null;
    const d = new Date(lastDateStr);
    if (isNaN(d.getTime())) return null;
    d.setMonth(d.getMonth() + parseInt(cycleMonths));
    return normalizeDateStr(d.toISOString());
}

// 狀態計算
function getServiceStatus(lastDateStr, cycleMonths) {
    if (!lastDateStr || !cycleMonths) return { type: 'normal', score: 1 };
    const lastDate = new Date(lastDateStr);
    const nextDate = new Date(lastDate);
    nextDate.setMonth(nextDate.getMonth() + parseInt(cycleMonths));
    
    const today = new Date(); today.setHours(0,0,0,0);
    const diffDays = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));

    if (diffDays < 0) return { type: 'overdue', days: Math.abs(diffDays), score: 3 }; 
    else if (diffDays <= 14) return { type: 'soon', days: diffDays, score: 2 }; 
    else return { type: 'normal', days: diffDays, score: 1 }; 
}

// API 呼叫
async function apiCall(action, payload={}, method="POST"){
  document.getElementById("loading").classList.remove("hidden");
  try {
    const url = method==="GET" ? `${API_URL}?${new URLSearchParams({action, ...payload})}` : API_URL;
    const res = await fetch(url, {
      method,
      body: method==="POST" ? JSON.stringify({action, ...payload}) : null
    });
    return await res.json();
  } catch(e){
    alert("連線錯誤：" + e);
    return null;
  } finally {
    document.getElementById("loading").classList.add("hidden");
  }
}

// --- 主要邏輯 ---

async function fetchCustomers(){
  const data = await apiCall("getCustomers", {}, "GET");
  if (Array.isArray(data)){
      customers = data;
      renderFilterBar();
      renderList(customers);
  } else {
      document.getElementById("customer-list").innerHTML = `<div class="text-center text-gray-400 mt-20">讀取失敗</div>`;
  }
}

function renderFilterBar() {
    document.getElementById("filter-container").innerHTML = TAG_OPTIONS.map(tag => 
        `<div class="filter-chip ${tag === currentFilter ? 'active' : ''}" onclick="filterByTag('${tag}')">${tag}</div>`
    ).join('');
}

function filterByTag(tag) {
    currentFilter = tag;
    renderFilterBar(); 
    renderList(customers);
}

function renderList(list){
  const container = document.getElementById("customer-list");
  container.innerHTML = "";

  let filtered = list;
  if (currentFilter !== "全部") filtered = filtered.filter(c => c.tags && c.tags.includes(currentFilter));
  
  const term = document.getElementById("search-input").value.toLowerCase();
  if (term) {
      filtered = filtered.filter(c => 
        c.name.toLowerCase().includes(term) || c.phone.includes(term) || (c.note && c.note.toLowerCase().includes(term))
      );
  }

  // 排序
  filtered.sort((a, b) => {
      const sA = getServiceStatus(a.lastRecordDate, a.cycle).score;
      const sB = getServiceStatus(b.lastRecordDate, b.cycle).score;
      return sB - sA;
  });

  if (!filtered.length){ container.innerHTML = `<div class="text-center text-gray-400 mt-20">暫無資料</div>`; return; }

  filtered.forEach(c=>{
    const status = getServiceStatus(c.lastRecordDate, c.cycle);
    const last = c.lastRecordDate ? normalizeDateStr(c.lastRecordDate) : "無紀錄";
    const nextDate = getNextServiceDate(c.lastRecordDate, c.cycle);
    
    // 下次保養日期的 HTML
    let nextDateHtml = "";
    if (nextDate) {
        let colorClass = "text-blue-600";
        if (status.type === 'overdue') colorClass = "text-red-600";
        if (status.type === 'soon') colorClass = "text-yellow-600";
        
        nextDateHtml = `
          <div class="next-service-box ${status.type === 'overdue' ? 'bg-red-50 border-red-200' : ''}">
             <div class="next-label ${status.type === 'overdue' ? 'text-red-500' : ''}">下次保養</div>
             <div class="next-date ${colorClass}">${nextDate}</div>
          </div>
        `;
    }

    // 標籤
    const tagsHtml = c.tags ? c.tags.split(",").map(t=>`<span class="mini-tag">${t}</span>`).join("") : "";

    const card = document.createElement("div");
    card.className = "dashboard-card";
    card.onclick = ()=> openDetail(c);
    
    card.innerHTML = `
      <div class="card-header">
         <div class="card-name">${c.name}</div>
         ${nextDateHtml}
      </div>
      
      <div class="card-tags">${tagsHtml}</div>
      
      <div class="card-info-row">
         <span class="material-icons text-base text-gray-400">settings</span>
         <span class="font-medium">${c.machine || '未填寫機型'}</span>
      </div>
      <div class="card-info-row">
         <span class="material-icons text-base text-gray-400">phone_iphone</span>
         <span>${c.phone}</span>
      </div>

      <div class="card-footer">
          <span class="material-icons text-gray-300">arrow_forward_ios</span>
          <div class="text-right">
             <div class="last-service-label">上次保養</div>
             <div class="last-service-date">${last}</div>
          </div>
      </div>
    `;
    container.appendChild(card);
  });
}

// --- 詳細頁面 ---
async function openDetail(c){
  currentCustomer = c;
  document.getElementById("page-list").classList.add("hidden");
  document.getElementById("page-detail").classList.remove("hidden");
  window.scrollTo(0,0);

  // 填寫基本資料
  document.getElementById("detail-name").innerText = c.name;
  document.getElementById("detail-phone").innerText = c.phone;
  document.getElementById("detail-phone-link").href = `tel:${c.phone}`;
  document.getElementById("detail-address").innerText = c.address || "未填寫";
  
  const mapLink = document.getElementById("detail-map-link");
  if(c.address) {
     mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address)}`;
     mapLink.classList.remove("hidden");
  } else { mapLink.classList.add("hidden"); }

  document.getElementById("detail-machine").innerText = c.machine || "-";
  document.getElementById("detail-filter").innerText = c.filter || "-";
  document.getElementById("detail-cycle").innerText = c.cycle ? `${c.cycle} 個月` : "未設定";
  document.getElementById("detail-note").innerText = c.note || "無";

  // 渲染照片
  const photoDiv = document.getElementById("detail-photos");
  photoDiv.innerHTML = "";
  let photos = [];
  try { photos = JSON.parse(c.photos || "[]"); } catch { photos = []; }
  if(!Array.isArray(photos)) photos = [];
  
  if (photos.length){
    photos.forEach(url=>{
      const img = document.createElement("img"); 
      img.src = url; 
      img.className = "photo-thumb inline-block mr-2 cursor-pointer";
      img.onclick = ()=>window.open(url); 
      photoDiv.appendChild(img);
    });
  } else { photoDiv.innerHTML = `<span class="text-sm text-gray-400 pl-1">無照片</span>`; }

  // 重置新增紀錄表單
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("record-date").value = today;
  document.getElementById("record-amount").value = "";
  document.getElementById("record-items").value = "";
  document.getElementById("record-note").value = "";
  document.getElementById("record-new-photos").innerHTML = "";
  document.getElementById("record-photo-count").innerText = "0 張";
  selectedRecordPhotos = [];

  await fetchRecords(c.id);
}

function goBack(){
  document.getElementById("page-detail").classList.add("hidden");
  document.getElementById("page-list").classList.remove("hidden");
  renderList(customers);
}

// --- 紀錄相關 ---
async function fetchRecords(cid){
  const list = document.getElementById("record-list");
  list.innerHTML = `<div class="text-center text-gray-400 py-4">讀取紀錄中...</div>`;
  const records = await apiCall("getRecords", {customerId: cid}, "GET");
  window.currentRecords = records; // 存入全域變數
  
  list.innerHTML = "";
  if (!records.length){ list.innerHTML = `<div class="text-center text-gray-400 py-4">尚無紀錄</div>`; return; }

  records.sort((a,b)=> new Date(b.date) - new Date(a.date));

  records.forEach(r => {
     const rPhotos = r.photos || [];
     const itemDiv = document.createElement("div");
     itemDiv.className = "bg-white border border-gray-100 rounded-xl p-4 shadow-sm relative pl-6";
     // 時間軸線條
     itemDiv.innerHTML = `
        <div class="absolute left-2 top-0 bottom-0 w-0.5 bg-gray-100"></div>
        <div class="absolute left-[3px] top-5 w-3 h-3 bg-blue-500 rounded-full border-2 border-white"></div>
        
        <div class="flex justify-between items-start mb-2">
           <div>
              <div class="font-bold text-gray-800 text-lg">${normalizeDateStr(r.date)}</div>
              <div class="text-green-600 font-bold mt-1">${r.amount ? '$'+r.amount : ''}</div>
           </div>
           <div class="flex gap-2">
              <button onclick="openEditRecordModal('${r.id}')" class="text-gray-400 hover:text-blue-600"><span class="material-icons text-lg">edit</span></button>
              <button onclick="deleteRecord('${r.id}')" class="text-gray-400 hover:text-red-500"><span class="material-icons text-lg">delete</span></button>
           </div>
        </div>
        
        <div class="text-gray-800 font-medium text-lg mb-2">${r.items}</div>
        ${r.note ? `<div class="text-gray-500 text-sm bg-gray-50 p-2 rounded mb-2">${r.note}</div>` : ""}
        
        ${rPhotos.length ? `<div class="flex gap-2 overflow-x-auto mt-2 pt-2 border-t border-gray-50">${rPhotos.map(p=>`<img src="${p}" class="w-16 h-16 object-cover rounded border cursor-pointer" onclick="window.open('${p}')">`).join("")}</div>` : ""}
     `;
     list.appendChild(itemDiv);
  });
}

// 修正後的編輯紀錄開啟函式
function openEditRecordModal(id){
  const r = window.currentRecords.find(x => x.id === id);
  if (!r) return alert("找不到紀錄");

  document.getElementById("edit-record-id").value = r.id;
  document.getElementById("edit-record-date").value = normalizeDateStr(r.date);
  document.getElementById("edit-record-items").value = r.items;
  document.getElementById("edit-record-amount").value = r.amount;
  document.getElementById("edit-record-note").value = r.note;
  
  selectedEditRecordPhotos = [];
  document.getElementById("edit-record-photos").innerHTML = "";
  
  document.getElementById("record-modal").classList.remove("hidden");
}

async function saveRecord(){
  if (!currentCustomer) return;
  const items = document.getElementById("record-items").value.trim();
  if(!items){ alert("請輸入保養項目"); return; }
  
  let photoUrls = [];
  for (let b64 of selectedRecordPhotos) {
     const res = await apiCall("uploadImage", {base64: b64, type:"image/jpeg"});
     if(res && res.url) photoUrls.push(res.url);
  }

  const payload = {
    customerId: currentCustomer.id,
    date: document.getElementById("record-date").value,
    amount: document.getElementById("record-amount").value,
    items: items,
    note: document.getElementById("record-note").value,
    photos: photoUrls
  };
  
  const res = await apiCall("addRecord", payload);
  if(res && res.status==="success"){
     showToast("紀錄已儲存");
     // 更新頁面上的上次保養日
     currentCustomer.lastRecordDate = payload.date;
     // 重新讀取
     openDetail(currentCustomer);
  }
}

async function saveEditedRecord(){
  const id = document.getElementById("edit-record-id").value;
  let photoUrls = []; // 簡化版：編輯暫時不支援保留舊照片混和上傳，只支援新增
  
  // 實際上要做的應該是：保留舊的？這裡邏輯較複雜，先假設編輯是 append
  // 為了簡單起見，這裡只處理文字更新，若要加照片，會附加進去
  const r = window.currentRecords.find(x=>x.id===id);
  let finalPhotos = r.photos || [];
  
  for (let b64 of selectedEditRecordPhotos) {
     const res = await apiCall("uploadImage", {base64: b64, type:"image/jpeg"});
     if(res && res.url) finalPhotos.push(res.url);
  }

  const payload = {
    id: id,
    date: document.getElementById("edit-record-date").value,
    amount: document.getElementById("edit-record-amount").value,
    items: document.getElementById("edit-record-items").value,
    note: document.getElementById("edit-record-note").value,
    photos: finalPhotos
  };
  
  const res = await apiCall("updateRecord", payload);
  if(res && res.status==="success"){
      closeModal("record-modal");
      fetchRecords(currentCustomer.id);
  }
}

async function deleteRecord(id){
  if(!confirm("確定刪除此紀錄？")) return;
  await apiCall("deleteRecord", {id});
  fetchRecords(currentCustomer.id);
}

// --- 客戶新增/編輯 (含照片刪除邏輯) ---

function showAddCustomerModal(){
  document.getElementById("modal-title").innerText = "新增客戶";
  document.getElementById("cust-id").value = "";
  document.getElementById("cust-name").value = "";
  document.getElementById("cust-phone").value = "";
  document.getElementById("cust-address").value = "";
  document.getElementById("cust-machine").value = "";
  document.getElementById("cust-filter").value = "";
  document.getElementById("cust-note").value = "";
  document.getElementById("cust-cycle").value = "";
  document.getElementById("cust-install-date").value = new Date().toISOString().split('T')[0];
  
  renderTagSelector("cust-tag-selector", []);
  
  // 清空照片區
  editingCustPhotos = [];
  selectedCustNewPhotos = [];
  document.getElementById("cust-existing-photos").innerHTML = "";
  document.getElementById("cust-new-photos").innerHTML = "";
  
  document.getElementById("btn-delete-customer").classList.add("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

function showEditCustomerModal(){
  const c = currentCustomer;
  document.getElementById("modal-title").innerText = "編輯客戶";
  document.getElementById("cust-id").value = c.id;
  document.getElementById("cust-name").value = c.name;
  document.getElementById("cust-phone").value = c.phone;
  document.getElementById("cust-address").value = c.address || "";
  document.getElementById("cust-machine").value = c.machine || "";
  document.getElementById("cust-filter").value = c.filter || "";
  document.getElementById("cust-note").value = c.note || "";
  document.getElementById("cust-cycle").value = c.cycle || "";
  document.getElementById("cust-install-date").value = c.installDate ? normalizeDateStr(c.installDate) : "";
  
  renderTagSelector("cust-tag-selector", c.tags ? c.tags.split(",") : []);

  // 處理照片 (這是重點修改部分)
  try { editingCustPhotos = JSON.parse(c.photos || "[]"); } catch { editingCustPhotos = []; }
  if(!Array.isArray(editingCustPhotos)) editingCustPhotos = [];
  renderEditCustPhotos();
  
  selectedCustNewPhotos = [];
  document.getElementById("cust-new-photos").innerHTML = "";

  document.getElementById("btn-delete-customer").classList.remove("hidden");
  document.getElementById("customer-modal").classList.remove("hidden");
}

function renderEditCustPhotos(){
  const box = document.getElementById("cust-existing-photos");
  box.innerHTML = "";
  if(editingCustPhotos.length === 0) {
      box.style.display = "none";
      return;
  }
  box.style.display = "flex";
  
  editingCustPhotos.forEach((url, idx) => {
      const wrap = document.createElement("div");
      wrap.className = "photo-wrapper flex-shrink-0";
      wrap.innerHTML = `
         <img src="${url}" class="photo-thumb">
         <div class="photo-delete-btn" onclick="removeCustPhoto(${idx})">×</div>
      `;
      box.appendChild(wrap);
  });
}

function removeCustPhoto(index){
    if(confirm("確定移除這張照片？(儲存後生效)")){
        editingCustPhotos.splice(index, 1);
        renderEditCustPhotos();
    }
}

async function saveCustomer(){
  const id = document.getElementById("cust-id").value;
  const name = document.getElementById("cust-name").value;
  const phone = document.getElementById("cust-phone").value;
  if(!name || !phone) { alert("姓名與電話必填"); return; }

  // 上傳新照片
  let newPhotoUrls = [];
  for (let b64 of selectedCustNewPhotos) {
     const res = await apiCall("uploadImage", {base64: b64, type:"image/jpeg"});
     if(res && res.url) newPhotoUrls.push(res.url);
  }

  // 合併舊照片與新照片
  const finalPhotos = [...editingCustPhotos, ...newPhotoUrls];

  const payload = {
     id: id,
     name: name,
     phone: phone,
     address: document.getElementById("cust-address").value,
     machine: document.getElementById("cust-machine").value,
     filter: document.getElementById("cust-filter").value,
     note: document.getElementById("cust-note").value,
     cycle: document.getElementById("cust-cycle").value,
     installDate: document.getElementById("cust-install-date").value,
     tags: getSelectedTags("cust-tag-selector"),
     photos: finalPhotos
  };

  const action = id ? "updateCustomer" : "addCustomer";
  const res = await apiCall(action, payload);
  
  if(res && res.status === "success"){
      showToast("儲存成功");
      closeModal("customer-modal");
      fetchCustomers(); // 刷新列表
      
      // 如果是在詳情頁編輯，更新目前顯示
      if(id && currentCustomer && currentCustomer.id == id){
          // 這裡需要把新的 photos 結構更新回 currentCustomer
          // 為了確保資料一致，可以直接讓 openDetail 重新讀取
          // 但因為 fetchCustomers 已經更新了 customers 陣列，我們需要從那裡抓最新的
          setTimeout(()=>{
              const updatedC = customers.find(c=>c.id == id);
              if(updatedC) openDetail(updatedC);
          }, 500);
      }
  }
}

async function deleteCustomer(){
    if(!confirm("確定刪除此客戶？")) return;
    const id = document.getElementById("cust-id").value;
    await apiCall("deleteCustomer", {id});
    closeModal("customer-modal");
    goBack();
    fetchCustomers();
}

// --- 圖片與標籤處理 ---
function renderTagSelector(id, selected){
    const box = document.getElementById(id);
    box.innerHTML = TAG_OPTIONS.map(t => 
       `<div class="tag-option ${selected.includes(t)?'active':''}" onclick="this.classList.toggle('active')" data-val="${t}">${t}</div>`
    ).join("");
}
function getSelectedTags(id){
    return Array.from(document.querySelectorAll(`#${id} .tag-option.active`)).map(el => el.dataset.val).join(",");
}

function handleCustPhotoSelect(input) { handlePhotoSelect(input, selectedCustNewPhotos, "cust-new-photos"); }
function handleRecordPhotoSelect(input) { 
    handlePhotoSelect(input, selectedRecordPhotos, "record-new-photos"); 
    document.getElementById("record-photo-count").innerText = (input.files.length + selectedRecordPhotos.length) + " 張";
}
function handleEditRecordPhotoSelect(input) { handlePhotoSelect(input, selectedEditRecordPhotos, "edit-record-photos"); }

function handlePhotoSelect(input, arr, containerId) {
    const box = document.getElementById(containerId);
    Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            resizeImage(e.target.result, 800, (resized) => {
                arr.push(resized);
                const img = document.createElement("img");
                img.src = resized;
                img.className = "photo-thumb flex-shrink-0";
                box.appendChild(img);
            });
        };
        reader.readAsDataURL(file);
    });
}

function resizeImage(base64, maxW, cb){
  const img = new Image();
  img.src = base64;
  img.onload = () => {
     let w=img.width, h=img.height;
     if(w > maxW){ h = h * (maxW/w); w = maxW; }
     const cvs = document.createElement("canvas");
     cvs.width = w; cvs.height = h;
     cvs.getContext("2d").drawImage(img, 0, 0, w, h);
     cb(cvs.toDataURL("image/jpeg", 0.7));
  }
}

// --- 介面控制 ---
function closeModal(id) { document.getElementById(id).classList.add("hidden"); }
document.getElementById("search-input").addEventListener("input", ()=> renderList(customers));

// init chips
function initChips(){
    const createChips = (pid, iid) => {
        document.getElementById(pid).innerHTML = ITEM_OPTIONS.map(opt => 
           `<span class="item-chip" onclick="addChip('${iid}', '${opt}')">${opt}</span>`
        ).join("");
    };
    createChips("new-record-chips", "record-items");
    createChips("edit-record-chips", "edit-record-items");
}
function addChip(iid, val){
    const inp = document.getElementById(iid);
    inp.value = inp.value ? inp.value + ", " + val : val;
}
function showToast(msg){
    const t = document.getElementById("toast");
    t.innerText = msg; t.classList.add("show");
    setTimeout(()=> t.classList.remove("show"), 3000);
}

window.onload = () => {
    fetchCustomers();
    initChips();
};
</script>

</body>
</html>
